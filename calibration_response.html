<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Admin - Pump Calibration Workbench - 10/12 BLE</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚙️</text></svg>">
    
    <!-- Material Icons (Filled + Rounded) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <!-- Custom CSS - Executive-Grade Design System -->
    <link href="/static/css/style.css?v=2797" rel="stylesheet">
    <link href="/static/css/professional-theme.css?v=1665" rel="stylesheet">
    <link href="/static/css/admin_executive_theme.css?v=3881" rel="stylesheet">
    <link href="/static/css/responsive-fixes.css?v=6605" rel="stylesheet">
    <link href="/static/css/floating-ai-chat.css?v=2591" rel="stylesheet">


    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax is loaded and ready');
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/polyfill@3.0.0/dist/polyfill.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/ape_logo.svg">
</head>
<body>
    
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn hide-on-med-and-up" onclick="toggleMobileMenu()" style="display: none;">
        <i class="material-icons">menu</i>
    </button>
    
    <!-- Navigation -->
    <!-- Navigation now handled by includes/navigation.html for consistency -->
    <!-- This prevents duplicate navigation conflicts -->
    <!-- Executive-Grade Navigation Component -->
<style>
/* Executive Navigation Styles */
:root {
    --nav-primary: #1565C0;
    --nav-primary-hover: #1976D2;
    --nav-surface: #FFFFFF;
    --nav-on-surface: #37474F;
    --nav-border: #E0E0E0;
    --nav-shadow: 0 4px 20px rgba(21, 101, 192, 0.1);
    --nav-dropdown-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    --nav-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.unified-nav {
    background: var(--nav-surface);
    box-shadow: var(--nav-shadow);
    border-bottom: 1px solid var(--nav-border);
    position: sticky;
    top: 0;
    z-index: 1000;
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
}

.nav-container {
    max-width: 1440px;
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 64px;
    overflow-x: auto;
    overflow-y: hidden;
}

.nav-brand {
    font-size: 20px;
    font-weight: 700;
    color: var(--nav-primary);
    text-decoration: none;
    transition: var(--nav-transition);
}

.nav-brand:hover {
    color: var(--nav-primary-hover);
    transform: translateX(2px);
}

.nav-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
    min-width: 0;
}

.nav-dropdown {
    position: relative;
}

.nav-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: none;
    background: transparent;
    color: var(--nav-on-surface);
    font-size: 15px;
    font-weight: 500;
    cursor: pointer;
    border-radius: 12px;
    transition: var(--nav-transition);
    text-decoration: none;
    position: relative;
    overflow: hidden;
}

.nav-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(21, 101, 192, 0.1), transparent);
    transition: left 0.5s;
}

.nav-btn:hover::before {
    left: 100%;
}

.nav-btn:hover {
    background: rgba(21, 101, 192, 0.08);
    color: var(--nav-primary);
    transform: translateY(-1px);
}

.nav-btn.primary {
    background: linear-gradient(135deg, var(--nav-primary) 0%, var(--nav-primary-hover) 100%);
    color: white;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(21, 101, 192, 0.3);
}

.nav-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 16px rgba(21, 101, 192, 0.4);
}

.nav-dropdown-content {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    min-width: 180px;
    background: white;
    border-radius: 8px;
    box-shadow: var(--nav-dropdown-shadow);
    border: 1px solid var(--nav-border);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: var(--nav-transition);
    z-index: 1001;
    overflow: hidden;
    max-height: 300px;
    padding: 4px 0;
}

/* Fix dropdown positioning for right-aligned items */
.nav-actions > .nav-dropdown:last-child .nav-dropdown-content,
.nav-actions > .nav-dropdown:nth-last-child(2) .nav-dropdown-content {
    right: 0;
    left: auto;
}

.nav-dropdown-content.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.nav-dropdown-content a {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    color: var(--nav-on-surface);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    transition: var(--nav-transition);
    position: relative;
    margin: 0 2px;
    border-radius: 6px;
    min-height: 32px;
    line-height: 1.2;
}

.nav-dropdown-content a:hover {
    background: linear-gradient(90deg, rgba(21, 101, 192, 0.1), rgba(21, 101, 192, 0.15));
    color: var(--nav-primary);
    transform: translateX(2px);
}

.nav-dropdown-content a .material-icons-round {
    font-size: 16px;
    opacity: 0.7;
    width: 16px;
    height: 16px;
}

.nav-dropdown-content a:hover .material-icons-round {
    opacity: 1;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .nav-container {
        padding: 0 16px;
    }
    
    .nav-brand {
        font-size: 18px;
        flex-shrink: 0;
    }
    
    .nav-actions {
        gap: 6px;
        flex-shrink: 0;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    .nav-actions::-webkit-scrollbar {
        display: none;
    }
    
    .nav-btn {
        padding: 10px 16px;
        font-size: 14px;
        white-space: nowrap;
        flex-shrink: 0;
    }
}

@media (max-width: 768px) {
    .nav-container {
        padding: 0 12px;
        min-height: 56px;
    }
    
    .nav-brand {
        font-size: 16px;
    }
    
    .nav-actions {
        gap: 4px;
    }
    
    .nav-btn {
        padding: 8px 12px;
        font-size: 13px;
    }
    
    .nav-btn.primary {
        padding: 8px 16px;
        font-weight: 600;
    }
    
    .nav-dropdown-content {
        min-width: 160px;
    }
    
    /* Ensure right-aligned dropdowns stay within viewport on mobile */
    .nav-actions > .nav-dropdown:last-child .nav-dropdown-content,
    .nav-actions > .nav-dropdown:nth-last-child(2) .nav-dropdown-content,
    .nav-actions > .nav-dropdown:nth-last-child(3) .nav-dropdown-content {
        right: 0;
        left: auto;
    }
    
    .nav-dropdown-content a {
        padding: 4px 10px;
        font-size: 12px;
        gap: 6px;
        min-height: 28px;
    }
}
</style>

<script>
// Modern Navigation Dropdown System with Best Practices
(function() {
    'use strict';
    
    function initializeNavDropdowns() {
        console.log('Initializing navigation dropdowns...');
        const dropdownButtons = document.querySelectorAll('.nav-dropdown > button');
        console.log('Found', dropdownButtons.length, 'dropdown buttons');
        
        dropdownButtons.forEach(button => {
            // Add ARIA attributes for accessibility
            button.setAttribute('aria-haspopup', 'true');
            button.setAttribute('aria-expanded', 'false');
            
            // Click handler
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const dropdownContent = this.parentElement.querySelector('.nav-dropdown-content');
                if (!dropdownContent) return;
                
                const isOpen = dropdownContent.classList.contains('show');
                
                // Close all dropdowns first
                closeAllDropdowns();
                
                // Toggle this dropdown
                if (!isOpen) {
                    dropdownContent.classList.add('show');
                    this.setAttribute('aria-expanded', 'true');
                    
                    // Focus first menu item for keyboard navigation
                    const firstMenuItem = dropdownContent.querySelector('a');
                    if (firstMenuItem) {
                        setTimeout(() => firstMenuItem.focus(), 100);
                    }
                }
            });
            
            // Keyboard navigation
            button.addEventListener('keydown', function(e) {
                if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
            });
        });
        
        // Enhanced keyboard navigation for dropdown items
        document.querySelectorAll('.nav-dropdown-content').forEach(dropdown => {
            const items = dropdown.querySelectorAll('a');
            
            items.forEach((item, index) => {
                item.addEventListener('keydown', function(e) {
                    switch(e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            const nextItem = items[index + 1] || items[0];
                            nextItem.focus();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            const prevItem = items[index - 1] || items[items.length - 1];
                            prevItem.focus();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            closeAllDropdowns();
                            dropdown.parentElement.querySelector('button').focus();
                            break;
                    }
                });
            });
        });
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.nav-dropdown')) {
                closeAllDropdowns();
            }
        });
        
        // Close dropdowns on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAllDropdowns();
            }
        });
    }
    
    function closeAllDropdowns() {
        document.querySelectorAll('.nav-dropdown-content').forEach(dropdown => {
            dropdown.classList.remove('show');
        });
        document.querySelectorAll('.nav-dropdown > button').forEach(button => {
            button.setAttribute('aria-expanded', 'false');
        });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeNavDropdowns);
    } else {
        initializeNavDropdowns();
    }
})();
</script>

<!-- Navigation Bar -->
<nav class="unified-nav">
    <div class="nav-container">
        <a href="/" class="nav-brand">
            <span>APE Pumps Selection</span>
        </a>
        
        <div class="nav-actions">
            <!-- Tools Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-btn">
                    <span>Tools ▾</span>
                </button>
                <div class="nav-dropdown-content">
                    <a href="/compare">Pump Comparison</a>
                    <a href="/shortlist_comparison">Shortlist Compare</a>
                    <a href="/pump_editor">Pump Editor</a>
                    <a href="/ai_extract">AI Data Extract</a>
                    <a href="/data_management">Database Manager</a>
                </div>
            </div>
            
            <!-- Admin Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-btn">
                    <span>Admin ▾</span>
                </button>
                <div class="nav-dropdown-content">
                    <a href="/admin/config/">Configuration</a>
                    <a href="/admin/ai">AI Admin</a>
                    <a href="/admin/brain">Brain System</a>
                    <a href="/admin/testing">Performance Testing</a>
                    <a href="/admin">Documents</a>
                </div>
            </div>
            
            

            <!-- Help Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-btn">
                    <span>Help ▾</span>
                </button>
                <div class="nav-dropdown-content">
                    <a href="/guide">User Guide</a>
                    <a href="https://apepumps.projectapp.ai/" target="_blank">Features</a>
                    <a href="/about">About</a>
                </div>
            </div>
            
            <!-- Reports Dropdown -->
            <div class="nav-dropdown">
                <button class="nav-btn">
                    <span>Reports ▾</span>
                </button>
                <div class="nav-dropdown-content">
                    
                    <a href="/pump_selection">Presentation</a>
                    <a href="/pump_selection">Engineering</a>
                    
                </div>
            </div>
            
            
            
            
            <!-- Main Pump Selection Button -->
            <a href="/pump_selection" class="nav-btn">
                <span>Pump Selection</span>
            </a>
            
            
        </div>
    </div>
</nav>

<!-- Breadcrumb Bar -->

<div class="breadcrumb-bar">
    <div class="container">
        <ul class="breadcrumb-list">
            
            <li class="breadcrumb-item">
                
                    <a href="/" class="breadcrumb-link">
                        
                        <i class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">home</i>
                        
                        <span></span>
                    </a>
                    
                    <i class="material-icons" style="font-size: 18px; color: #9e9e9e; margin: 0 8px;">chevron_right</i>
                    
                
            </li>
            
            <li class="breadcrumb-item">
                
                    <a href="/admin/brain" class="breadcrumb-link">
                        
                        <i class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">psychology</i>
                        
                        <span></span>
                    </a>
                    
                    <i class="material-icons" style="font-size: 18px; color: #9e9e9e; margin: 0 8px;">chevron_right</i>
                    
                
            </li>
            
            <li class="breadcrumb-item">
                
                    <span class="breadcrumb-current" style="display: flex; align-items: center;">
                        
                        <i class="material-icons" style="font-size: 18px; vertical-align: middle; margin-right: 4px;">tune</i>
                        
                        
                    </span>
                
            </li>
            
        </ul>
    </div>
</div>


<!-- Spacer to prevent content overlap -->
<div class="nav-spacer"></div>

    

    <!-- Flash Messages -->
    
        
    

    <!-- Main Content -->
    <main>
        
<div class="admin-layout">
  <!-- Admin Header (consistent style) -->
  <div class="admin-nav-wrapper">
    <div class="container">
      <div class="row">
        <div class="col s12">
          <div class="card-panel blue darken-3 white-text" style="margin-bottom: 0;">
            <div class="row valign-wrapper" style="margin-bottom: 0;">
              <div class="col s12 m8">
                <h5 style="margin: 0;">
                  <i class="material-icons left">psychology</i>
                  Brain System Administration
                </h5>
              </div>
              <div class="col s12 m4 right-align">
                <span class="badge green white-text">System Active</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="admin-tabs-wrapper">
  <div class="container">
    <div class="row">
      <div class="col s12">
        <ul class="tabs blue lighten-4">
          <li class="tab col s3">
            <a href="/admin/brain"
               class="">
              <i class="material-icons left">dashboard</i>Overview
            </a>
          </li>
          <li class="tab col s3">
            <a href="/admin/brain/data-quality"
               class="">
              <i class="material-icons left">assessment</i>Data Quality
            </a>
          </li>
          <li class="tab col s3">
            <a href="/admin/brain/corrections"
               class="">
              <i class="material-icons left">edit</i>Corrections
            </a>
          </li>
          <li class="tab col s3">
            <a href="/admin/brain/workbench"
               class="">
              <i class="material-icons left">science</i>Workbench
            </a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>


  <div class="admin-content">
    
<div class="container" style="margin-top: 20px;">
    
    <!-- Header Section -->
    <div class="calibration-header">
        <h4>
            <i class="material-icons">tune</i>
            Pump Calibration Workbench
        </h4>
        <div class="row">
            <div class="col s12 m4">
                <p><strong>Pump Code:</strong> 10/12 BLE</p>
            </div>
            <div class="col s12 m4">
                <p><strong>Model:</strong> N/A</p>
            </div>
            <div class="col s12 m4">
                <p><strong>Manufacturer:</strong> APE PUMPS</p>
            </div>
        </div>
    </div>
    
    <!-- Data Entry Section -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">edit</i>
                Performance Data Entry
            </span>
            <p class="grey-text">Enter manufacturer datasheet performance points for comparison</p>
            
            <!-- Unit System Toggle -->
            <div class="row" style="margin-top: 20px; margin-bottom: 10px;">
                <div class="col s12">
                    <div class="switch-container" style="display: flex; align-items: center; gap: 20px;">
                        <span class="grey-text">Unit System:</span>
                        <div class="btn-group" role="group">
                            <button type="button" id="metric-btn" class="btn btn-small blue waves-effect waves-light active">
                                <i class="material-icons left">straighten</i>
                                Metric
                            </button>
                            <button type="button" id="imperial-btn" class="btn btn-small grey lighten-1 waves-effect waves-light">
                                <i class="material-icons left">square_foot</i>
                                Imperial
                            </button>
                        </div>
                        <span id="unit-display" class="chip blue white-text">
                            Flow: m³/hr | Head: m | Power: kW
                        </span>
                        <span class="helper-text grey-text text-darken-1" style="font-size: 0.85rem;">
                            <i class="material-icons tiny">info_outline</i>
                            Shortcuts: Ctrl+M (Metric) | Ctrl+I (Imperial)
                        </span>
                    </div>
                </div>
            </div>
            
            <form id="calibration-form" action="/admin/pump-calibration/10/12 BLE/analyze" method="POST">
                <!-- CSRF Protection -->
                <input type="hidden" name="csrf_token" value="">
                <input type="hidden" id="point_count" name="point_count" value="0">
                <input type="hidden" id="unit_system" name="unit_system" value="metric">
                
                <table class="striped responsive-table data-entry-table">
                    <thead>
                        <tr>
                            <th id="flow-header">Flow (m³/hr)</th>
                            <th id="head-header">Head (m)</th>
                            <th>Efficiency (%)</th>
                            <th id="power-header">Power (kW)<br><span class="grey-text" style="font-size: 0.8em">(Optional)</span></th>
                            <th>Diameter (mm)<br><span class="red-text" style="font-size: 0.8em; font-weight: bold">*REQUIRED</span></th>
                            <th>QBep %<br><span class="grey-text" style="font-size: 0.8em">(Optional)</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="data-rows">
                        <!-- Dynamic rows added here -->
                    </tbody>
                </table>
                
                <div class="card-action">
                    <button type="button" onclick="addDataRow()" class="btn waves-effect waves-light">
                        <i class="material-icons left">add</i>
                        Add Performance Point
                    </button>
                    <button type="submit" id="submit-btn" class="btn waves-effect waves-light purple darken-1" style="margin-left: 10px;">
                        <i class="material-icons left">analytics</i>
                        Analyze Calibration
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    
    <!-- SECTION 1: TRUTH GATE - The Stark Comparison -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">verified_user</i>
                Section 1: Truth Gate - Validation Results
            </span>
            
            <!-- Stark Comparison Display -->
            <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 8px; padding: 20px; margin: 20px 0;">
                <h5 style="color: #e65100; margin-bottom: 20px;">
                    <i class="material-icons left">compare_arrows</i>
                    Direct Comparison at Specified Diameter
                </h5>
                
                <!-- Pure Validation Comparison Table -->
                <table class="striped highlight">
                    <thead>
                        <tr style="background: #f5f5f5;">
                            <th>Test Point</th>
                            <th>Your Ground Truth</th>
                            <th>Brain's Prediction</th>
                            <th>Discrepancy</th>
                        </tr>
                    </thead>
                    <tbody>
                        
                        
                        <tr>
                            <td>
                                <strong>828.7 m³/hr @ 390 mm</strong>
                            </td>
                            <td>
                                <span style="font-size: 1.2em; font-weight: 500;">27.8 m</span>
                            </td>
                            <td>
                                <span style="font-size: 1.2em; font-weight: 500;">43.99 m</span>
                            </td>
                            <td>
                                
                                <span style="font-size: 1.3em; font-weight: bold; color: #d32f2f;">
                                    +58.2%
                                </span>
                            </td>
                        </tr>
                        
                        
                    </tbody>
                </table>
                
                <div style="margin-top: 20px; padding: 15px; background: #ffebee; border-radius: 4px;">
                    <p style="color: #c62828; font-weight: 500; margin: 0;">
                        <i class="material-icons tiny" style="vertical-align: middle;">error</i>
                        
                        
                        Significant discrepancy detected. The Brain's prediction differs from your ground truth data by up to 58.2%.
                        
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- SECTION 2: ANALYTICAL WORKBENCH - Granular Analysis -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">analytics</i>
                Section 2: Analytical Workbench - Discrepancy Analysis
            </span>
            
            <!-- Detailed Delta Table -->
            <div style="margin: 20px 0;">
                <h5 style="color: #1565C0; margin-bottom: 20px;">
                    <i class="material-icons left">table_chart</i>
                    Detailed Performance Comparison
                </h5>
                
                <table class="striped highlight responsive-table">
                    <thead>
                        <tr style="background: #e3f2fd;">
                            <th>Flow (m³/hr)</th>
                            <th>Your Head (m)</th>
                            <th>Brain's Head (m)</th>
                            <th>Head Delta (%)</th>
                            <th>Your Efficiency (%)</th>
                            <th>Brain's Efficiency (%)</th>
                            <th>Efficiency Delta (%)</th>
                            
                            <th>Your Power (kW)</th>
                            <th>Brain's Power (kW)</th>
                            <th>Power Delta (%)</th>
                            
                        </tr>
                    </thead>
                    <tbody>
                        
                        
                        <tr>
                            <td><strong>828.7</strong></td>
                            <td>27.8</td>
                            <td>43.99</td>
                            <td>
                                <span style="color: #d32f2f;">
                                    +58.2%
                                </span>
                            </td>
                            <td>75.0</td>
                            <td>84.3</td>
                            <td>
                                <span style="color: #d32f2f;">
                                    +12.4%
                                </span>
                            </td>
                            
                            <td>8.37</td>
                            <td>11.79</td>
                            <td>
                                <span style="color: #d32f2f;">
                                    +40.8%
                                </span>
                            </td>
                            
                        </tr>
                        
                        
                    </tbody>
                </table>
            </div>
            
            <!-- Visual Comparison Charts -->
            <div style="margin: 30px 0;">
                <h5 style="color: #1565C0; margin-bottom: 20px;">
                    <i class="material-icons left">show_chart</i>
                    Visual Performance Curves
                </h5>
                
                <div class="row">
                    <!-- Head vs Flow Chart -->
                    <div class="col s12">
                        <div id="head-curve-comparison" style="width: 100%; height: 400px;"></div>
                    </div>
                </div>
                
                <div class="row">
                    <!-- Efficiency vs Flow Chart -->
                    <div class="col s12 m6">
                        <div id="efficiency-curve-comparison" style="width: 100%; height: 350px;"></div>
                    </div>
                    <!-- Power vs Flow Chart -->
                    <div class="col s12 m6">
                        <div id="power-curve-comparison" style="width: 100%; height: 350px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Statistical Metrics -->
            
            <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                <h6 style="margin-bottom: 15px;"><strong>Statistical Analysis</strong></h6>
                <div class="row">
                    <div class="col s12 m4">
                        <p><strong>Head Accuracy:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Mean Delta: 58.2%</li>
                            <li>RMSE: 58.24%</li>
                            <li>Max Delta: 58.2%</li>
                        </ul>
                    </div>
                    <div class="col s12 m4">
                        <p><strong>Efficiency Accuracy:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Mean Delta: 12.4%</li>
                            <li>RMSE: 12.38%</li>
                            <li>Max Delta: 12.4%</li>
                        </ul>
                    </div>
                    <div class="col s12 m4">
                        <p><strong>Overall:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li>Overall Accuracy: 62.9%</li>
                            <li>Data Points: 1</li>
                        </ul>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- SECTION 3: INFORMED DECISION - Empowered User Action -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">assignment_turned_in</i>
                Section 3: Decision Required
            </span>
            
            <div style="margin-top: 20px; padding: 20px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;">
                <p style="font-size: 1.1em; margin-bottom: 20px;">
                    Based on the comprehensive analysis above, this discrepancy indicates one of two possibilities:
                </p>
                <ol style="margin-bottom: 25px;">
                    <li style="margin-bottom: 10px;"><strong>Your input data may be incorrect</strong> (most likely)</li>
                    <li style="margin-bottom: 10px;"><strong>The pump database may have fundamental errors</strong> (critical issue requiring engineering review)</li>
                </ol>
                
                <div class="row">
                    <div class="col s12 m6">
                        <button onclick="discardCalibration()" class="btn-large waves-effect waves-light grey darken-1" style="width: 100%;">
                            <i class="material-icons left">cancel</i>
                            Discard - My Input Data is Incorrect
                        </button>
                        <p class="grey-text" style="margin-top: 10px; font-size: 0.9em;">
                            Acknowledges that your ground truth data was flawed. No changes will be made to the system.
                        </p>
                    </div>
                    <div class="col s12 m6">
                        <button onclick="flagForReview()" class="btn-large waves-effect waves-light red darken-2" style="width: 100%;">
                            <i class="material-icons left">flag</i>
                            Flag for Engineering Review
                        </button>
                        <p class="grey-text" style="margin-top: 10px; font-size: 0.9em;">
                            If you are absolutely certain your data is correct, this will create a high-priority ticket for engineering review.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Hidden form for flagging -->
            <form id="flag-form" action="/admin/pump-calibration/10/12 BLE/flag-review" method="POST" style="display: none;">
                <input type="hidden" name="csrf_token" value="">
                <input type="hidden" name="calibration_data" value="{"comparison_points": [{"brain_diameter": 390.0, "brain_efficiency": 84.286576, "brain_head": 43.991747999999994, "brain_power": 11.786277244398917, "delta_diameter": 0.0, "delta_efficiency": 12.382101333333328, "delta_head": 58.24369784172659, "delta_power": 40.80863052414769, "flow": 828.7, "qbep_percent": null, "truth_diameter": 390.0, "truth_efficiency": 75.0, "truth_head": 27.8, "truth_power": 8.370422466666668}], "curve_comparison_data": [], "insights": ["1. The Brain prediction system shows a systematic over-prediction in both efficiency and power metrics, with significant deviations of 12.4% and 40.8% respectively.", "2. Given the data provided is for a single flow point, it is difficult to assess flow-dependent accuracy variations. Additional data points across different flow rates are needed for a comprehensive analysis.", "3. The significant over-prediction in power suggests that the model\u0027s power consumption parameters, such as friction losses or motor efficiency, may need recalibration.", "4. The overall accuracy of 62.9% indicates a moderate predictive quality, but the high RMSE values for both efficiency and power highlight substantial room for improvement.", "5. Calibration recommendations include: refining the model\u0027s efficiency curve to better align with manufacturer specifications, adjusting power consumption parameters to reduce the overestimation, and collecting more data points across varying flow rates to enhance model robustness.", "Calibration Adjustment: Consider decrease in efficiency_correction_exponent by ~1.238; Consider decrease in power calculation factors"], "metrics": {"efficiency": {"max_delta": 12.382101333333328, "mean_delta": 12.382101333333328, "rmse": 12.382101333333328, "std_dev": 0.0}, "head": {"max_delta": 58.24369784172659, "mean_delta": 58.24369784172659, "rmse": 58.24369784172659, "std_dev": 0.0}, "overall_accuracy": 62.85519010026413, "point_count": 1, "power": {"max_delta": 40.80863052414769, "mean_delta": 40.80863052414769, "rmse": 40.80863052414769, "std_dev": 0.0}}, "pump_code": "10/12 BLE", "pump_data": {"connection_size": "Standard", "curve_count": 1, "curves": [{"curve_id": "10/12 BLE_C1_390mm", "curve_index": 0, "efficiency_range_pct": "40.08-88.48", "flow_range_m3hr": "250.0-1250.0", "has_npsh_data": true, "has_power_data": false, "head_range_m": "32.92-51.82", "impeller_diameter_mm": 390.0, "npsh_range_m": "4.88-7.92", "performance_points": [{"efficiency_pct": 40.08, "flow_m3hr": 250.0, "head_m": 51.82, "npshr_m": 0.0, "power_kw": null}, {"efficiency_pct": 66.28, "flow_m3hr": 500.0, "head_m": 49.38, "npshr_m": 4.88, "power_kw": null}, {"efficiency_pct": 82.36, "flow_m3hr": 750.0, "head_m": 45.72, "npshr_m": 5.49, "power_kw": null}, {"efficiency_pct": 88.48, "flow_m3hr": 1000.0, "head_m": 40.23, "npshr_m": 6.4, "power_kw": null}, {"efficiency_pct": 82.55, "flow_m3hr": 1250.0, "head_m": 32.92, "npshr_m": 7.92, "power_kw": null}], "point_count": 5, "test_speed_rpm": 1480}], "description": "10/12 BLE - MATHER AND PLATT", "manufacturer": "APE PUMPS", "materials": "Cast Iron", "max_efficiency": 88.48, "max_flow_m3hr": 1500.0, "max_head_m": 60.0, "max_power_kw": 0.0, "min_efficiency": 0.0, "model_series": "MATHER AND PLATT", "npsh_curves": 1, "power_curves": 0, "pump_code": "10/12 BLE", "pump_id": 10, "pump_type": "HSC", "specifications": {"bep_flow_m3hr": 998.19, "bep_head_m": 40.35, "max_flow_m3hr": 1500.0, "max_head_m": 60.0, "max_impeller_diameter_mm": 390.0, "max_speed_rpm": 2010, "min_impeller_diameter_mm": 390.0, "min_speed_rpm": 700, "npshr_at_bep": 0.0, "test_speed_rpm": 1480, "variable_diameter": true, "variable_speed": false}, "total_points": 6}}">
            </form>
            
            <script>
            function discardCalibration() {
                if (confirm('Are you sure you want to discard this calibration data? This acknowledges that your input data was incorrect.')) {
                    M.toast({html: '<i class="material-icons left">info</i>Calibration data discarded. No changes made.', classes: 'blue'});
                    // Clear the form and reload
                    setTimeout(() => {
                        window.location.href = '/admin/pump-calibration/10/12 BLE';
                    }, 2000);
                }
            }
            
            function flagForReview() {
                if (confirm('Are you ABSOLUTELY CERTAIN your data is correct?\n\nThis will create a high-priority engineering ticket indicating that the pump database may have fundamental errors.')) {
                    document.getElementById('flag-form').submit();
                }
            }
            
            // Render the visual comparison charts
            document.addEventListener('DOMContentLoaded', function() {
                
            });
            
            function renderAnalyticalCharts() {
                // Get the data from the server
                const groundTruthPoints = [{"brain_diameter": 390.0, "brain_efficiency": 84.286576, "brain_head": 43.991747999999994, "brain_power": 11.786277244398917, "delta_diameter": 0.0, "delta_efficiency": 12.382101333333328, "delta_head": 58.24369784172659, "delta_power": 40.80863052414769, "flow": 828.7, "qbep_percent": null, "truth_diameter": 390.0, "truth_efficiency": 75.0, "truth_head": 27.8, "truth_power": 8.370422466666668}];
                const curveData = [];
                
                // Filter out expanded points for ground truth
                const actualGroundTruth = groundTruthPoints.filter(p => !p.is_expanded);
                
                // Professional color scheme
                const colors = {
                    groundTruth: '#1976D2',  // Professional blue
                    brain: '#D32F2F',         // Professional red
                    grid: '#E0E0E0',
                    background: '#FAFAFA'
                };
                
                // Common chart configuration
                const chartConfig = {
                    responsive: true,
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToRemove: ['select2d', 'lasso2d']
                };
                
                // 1. HEAD VS FLOW CURVE
                const groundTruthHeadTrace = {
                    x: actualGroundTruth.map(p => p.flow),
                    y: actualGroundTruth.map(p => p.truth_head),
                    mode: 'markers',
                    name: 'Your Ground Truth',
                    marker: { 
                        size: 12, 
                        symbol: 'circle',
                        color: colors.groundTruth,
                        line: { color: 'white', width: 2 }
                    },
                    hovertemplate: '<b>Ground Truth</b><br>Flow: %{x:.1f} m³/hr<br>Head: %{y:.2f} m<extra></extra>'
                };
                
                const brainCurveHeadTrace = {
                    x: curveData.map(p => p.flow),
                    y: curveData.map(p => p.brain_head),
                    mode: 'lines',
                    name: "Brain's Predicted Curve",
                    line: { 
                        color: colors.brain, 
                        width: 3, 
                        shape: 'spline' 
                    },
                    hovertemplate: '<b>Brain Prediction</b><br>Flow: %{x:.1f} m³/hr<br>Head: %{y:.2f} m<extra></extra>'
                };
                
                const headLayout = {
                    title: {
                        text: '<b>Head Performance - Ground Truth vs Brain Prediction</b>',
                        font: { size: 18, family: 'Arial, sans-serif' },
                        x: 0.5,
                        xanchor: 'center'
                    },
                    xaxis: { 
                        title: '<b>Flow (m³/hr)</b>',
                        gridcolor: colors.grid,
                        showgrid: true,
                        zeroline: true,
                        zerolinecolor: colors.grid,
                        tickfont: { size: 11 }
                    },
                    yaxis: { 
                        title: '<b>Head (m)</b>',
                        gridcolor: colors.grid,
                        showgrid: true,
                        zeroline: false,
                        tickfont: { size: 11 }
                    },
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.95)',
                        bordercolor: '#666',
                        borderwidth: 1,
                        font: { size: 12 }
                    },
                    hovermode: 'closest',
                    plot_bgcolor: colors.background,
                    paper_bgcolor: 'white',
                    margin: { t: 60, r: 40, b: 60, l: 60 }
                };
                
                // 2. EFFICIENCY VS FLOW CURVE
                const groundTruthEffTrace = {
                    x: actualGroundTruth.map(p => p.flow),
                    y: actualGroundTruth.map(p => p.truth_efficiency),
                    mode: 'markers',
                    name: 'Your Ground Truth',
                    marker: { 
                        size: 10, 
                        symbol: 'circle',
                        color: colors.groundTruth,
                        line: { color: 'white', width: 2 }
                    },
                    hovertemplate: '<b>Ground Truth</b><br>Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
                };
                
                const brainCurveEffTrace = {
                    x: curveData.map(p => p.flow),
                    y: curveData.map(p => p.brain_efficiency),
                    mode: 'lines',
                    name: "Brain's Predicted Curve",
                    line: { 
                        color: colors.brain, 
                        width: 2.5, 
                        shape: 'spline' 
                    },
                    hovertemplate: '<b>Brain Prediction</b><br>Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
                };
                
                const effLayout = {
                    title: {
                        text: '<b>Efficiency Performance</b>',
                        font: { size: 16, family: 'Arial, sans-serif' },
                        x: 0.5,
                        xanchor: 'center'
                    },
                    xaxis: { 
                        title: '<b>Flow (m³/hr)</b>',
                        gridcolor: colors.grid,
                        showgrid: true,
                        tickfont: { size: 10 }
                    },
                    yaxis: { 
                        title: '<b>Efficiency (%)</b>',
                        gridcolor: colors.grid,
                        showgrid: true,
                        range: [0, 100],
                        tickfont: { size: 10 }
                    },
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.9)',
                        bordercolor: '#666',
                        borderwidth: 1,
                        font: { size: 10 }
                    },
                    hovermode: 'closest',
                    plot_bgcolor: colors.background,
                    paper_bgcolor: 'white',
                    margin: { t: 50, r: 30, b: 50, l: 50 }
                };
                
                // 3. POWER VS FLOW CURVE
                const groundTruthPowerTrace = {
                    x: actualGroundTruth.map(p => p.flow),
                    y: actualGroundTruth.map(p => p.truth_power),
                    mode: 'markers',
                    name: 'Your Ground Truth',
                    marker: { 
                        size: 10, 
                        symbol: 'circle',
                        color: colors.groundTruth,
                        line: { color: 'white', width: 2 }
                    },
                    hovertemplate: '<b>Ground Truth</b><br>Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>'
                };
                
                const brainCurvePowerTrace = {
                    x: curveData.map(p => p.flow),
                    y: curveData.map(p => p.brain_power),
                    mode: 'lines',
                    name: "Brain's Predicted Curve",
                    line: { 
                        color: colors.brain, 
                        width: 2.5, 
                        shape: 'spline' 
                    },
                    hovertemplate: '<b>Brain Prediction</b><br>Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>'
                };
                
                const powerLayout = {
                    title: {
                        text: '<b>Power Performance</b>',
                        font: { size: 16, family: 'Arial, sans-serif' },
                        x: 0.5,
                        xanchor: 'center'
                    },
                    xaxis: { 
                        title: '<b>Flow (m³/hr)</b>',
                        gridcolor: colors.grid,
                        showgrid: true,
                        tickfont: { size: 10 }
                    },
                    yaxis: { 
                        title: '<b>Power (kW)</b>',
                        gridcolor: colors.grid,
                        showgrid: true,
                        tickfont: { size: 10 }
                    },
                    showlegend: true,
                    legend: {
                        x: 0.02,
                        y: 0.98,
                        bgcolor: 'rgba(255,255,255,0.9)',
                        bordercolor: '#666',
                        borderwidth: 1,
                        font: { size: 10 }
                    },
                    hovermode: 'closest',
                    plot_bgcolor: colors.background,
                    paper_bgcolor: 'white',
                    margin: { t: 50, r: 30, b: 50, l: 50 }
                };
                
                // Render the charts
                Plotly.newPlot('head-curve-comparison', [groundTruthHeadTrace, brainCurveHeadTrace], headLayout, chartConfig);
                Plotly.newPlot('efficiency-curve-comparison', [groundTruthEffTrace, brainCurveEffTrace], effLayout, chartConfig);
                Plotly.newPlot('power-curve-comparison', [groundTruthPowerTrace, brainCurvePowerTrace], powerLayout, chartConfig);
            }
            </script>
        </div>
    </div>
    
    
</div>

  </div>
</div>

<!-- Admin-specific CSS -->
<link href="/static/css/admin_theme.css?v=6824" rel="stylesheet">

<!-- Admin-specific JavaScript -->
<script src="/static/js/admin.js?v=9035"></script>

    </main>

    <!-- About Modal -->
    <div id="about-modal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left">info</i>About APE Pumps</h4>
            <div class="row">
                <div class="col s12">
                    <p>APE Pumps is a leading manufacturer of industrial pumps with over 30 years of experience in designing and manufacturing high-quality pumping solutions.</p>

                    <h5>AI-Powered Selection System</h5>
                    <p>Our advanced AI system combines decades of engineering expertise with cutting-edge machine learning to provide:</p>
                    <ul class="collection">
                        <li class="collection-item"><i class="material-icons left">check_circle</i>Intelligent pump selection based on your specific requirements</li>
                        <li class="collection-item"><i class="material-icons left">check_circle</i>Real-time performance analysis and optimization</li>
                        <li class="collection-item"><i class="material-icons left">check_circle</i>Professional technical documentation and reports</li>
                        <li class="collection-item"><i class="material-icons left">check_circle</i>Expert AI consultation for complex applications</li>
                    </ul>

                    <h5>Technical Excellence</h5>
                    <p>Our pumps are designed to meet the highest standards of efficiency, reliability, and performance across a wide range of industrial applications.</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contact-modal" class="modal">
        <div class="modal-content">
            <h4><i class="material-icons left">contact_phone</i>Contact APE Pumps</h4>
            <div class="row">
                <div class="col s12 m6">
                    <h5>Technical Support</h5>
                    <p><i class="material-icons left">phone</i><strong>Phone:</strong> +1 (555) 123-4567</p>
                    <p><i class="material-icons left">email</i><strong>Email:</strong> support@apepumps.com</p>
                    <p><i class="material-icons left">schedule</i><strong>Hours:</strong> Mon-Fri 8:00 AM - 6:00 PM EST</p>
                </div>
                <div class="col s12 m6">
                    <h5>Sales & Engineering</h5>
                    <p><i class="material-icons left">phone</i><strong>Phone:</strong> +1 (555) 123-4568</p>
                    <p><i class="material-icons left">email</i><strong>Email:</strong> sales@apepumps.com</p>
                    <p><i class="material-icons left">location_on</i><strong>Location:</strong> Industrial Park, Engineering City</p>
                </div>
            </div>
            <div class="row">
                <div class="col s12">
                    <h5>Emergency Support</h5>
                    <p>For urgent technical issues outside business hours:</p>
                    <p><i class="material-icons left">phone</i><strong>24/7 Hotline:</strong> +1 (555) 911-PUMP</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
        </div>
    </div>



    <!-- Footer -->
    <footer class="page-footer" style="background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-variant) 100%);">
        <div class="container">
            <div class="row">
                <div class="col l6 s12">
                    <h5 class="white-text">APE Pumps</h5>
                    <p class="grey-text text-lighten-4">
                        AI-powered pump selection and sizing solutions for industrial applications.
                    </p>
                </div>
                <div class="col l4 offset-l2 s12">
                    <h5 class="white-text">Quick Links</h5>
                    <ul>
                        <li><a class="grey-text text-lighten-3" href="/">Pump Selection</a></li>
                        <li><a class="grey-text text-lighten-3" href="#technical">Technical Support</a></li>
                        <li><a class="grey-text text-lighten-3" href="#documentation">Documentation</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright" style="background: var(--md-primary-variant);">
            <div class="container">
                © 2025 APE Pumps. All rights reserved.
                <a class="grey-text text-lighten-4 right" href="#privacy">Privacy Policy</a>
            </div>
        </div>
    </footer>

    <!-- Materialize JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    
    <!-- Mobile menu toggle script -->
    <script>
        function toggleMobileMenu() {
            const nav = document.querySelector('.unified-nav');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (nav && menuBtn) {
                if (nav.style.display === 'none' || nav.style.display === '') {
                    nav.style.display = 'block';
                    nav.style.position = 'fixed';
                    nav.style.top = '60px';
                    nav.style.left = '0';
                    nav.style.right = '0';
                    nav.style.zIndex = '9998';
                    nav.style.background = 'white';
                    nav.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                    menuBtn.innerHTML = '<i class="material-icons">close</i>';
                } else {
                    nav.style.display = 'none';
                    menuBtn.innerHTML = '<i class="material-icons">menu</i>';
                }
            }
        }
        
        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const nav = document.querySelector('.unified-nav');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (menuBtn && nav && !nav.contains(e.target) && !menuBtn.contains(e.target)) {
                if (window.innerWidth <= 768 && nav.style.display === 'block') {
                    nav.style.display = 'none';
                    menuBtn.innerHTML = '<i class="material-icons">menu</i>';
                }
            }
        });
        
        // Reset menu on window resize
        window.addEventListener('resize', function() {
            const nav = document.querySelector('.unified-nav');
            const menuBtn = document.querySelector('.mobile-menu-btn');
            if (window.innerWidth > 768 && nav && menuBtn) {
                nav.style.display = '';
                nav.style.position = '';
                nav.style.top = '';
                nav.style.left = '';
                nav.style.right = '';
                nav.style.zIndex = '';
                nav.style.background = '';
                nav.style.boxShadow = '';
                menuBtn.innerHTML = '<i class="material-icons">menu</i>';
            }
        });
    </script>
    <!-- Latest Plotly.js version -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    <!-- Floating AI Chat -->
    <script defer src="/static/js/floating-ai-chat.js"></script>

    <!-- Navigation and Modal JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Base template: Initializing Materialize components');
            
            // Initialize only navigation components - forms handle their own selects
            var modals = document.querySelectorAll('.modal');
            M.Modal.init(modals);
            console.log('Initialized', modals.length, 'modals');
            
            var sidenavs = document.querySelectorAll('.sidenav');
            M.Sidenav.init(sidenavs);
            console.log('Initialized', sidenavs.length, 'sidenavs');
            
            // Dropdowns are handled by navigation.html now - removed to prevent conflicts
        });

        function showAboutModal() {
            var instance = M.Modal.getInstance(document.getElementById('about-modal'));
            instance.open();
        }

        function showContactModal() {
            var instance = M.Modal.getInstance(document.getElementById('contact-modal'));
            instance.open();
        }
    </script>

    <!-- Icon fixes -->
    <script src="/static/js/icon-loader.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="/static/js/main.js"></script>
    <script src="/static/js/micro-interactions.js"></script>
    <script src="/static/js/force-icon-refresh.js"></script>
    
    <!-- Floating AI Chat included above; removed duplicate include -->

    <!-- Page-specific scripts -->
    

<script>
// Track the number of data rows
let dataRowCount = 1;
let currentUnitSystem = 'metric';

// Conversion constants
const CONVERSIONS = {
    flow: {
        toImperial: 4.4028, // m³/hr to gpm
        toMetric: 0.2271   // gpm to m³/hr
    },
    head: {
        toImperial: 3.28084, // m to ft
        toMetric: 0.3048    // ft to m
    },
    power: {
        toImperial: 1.34102, // kW to hp
        toMetric: 0.7457    // hp to kW
    }
};

// Add a new performance data row
function addDataRow() {
    const tableBody = document.getElementById('data-rows');
    const newRowId = dataRowCount++;
    
    // Get appropriate placeholders based on current unit system
    const placeholders = currentUnitSystem === 'metric' 
        ? { flow: 'e.g., 1500', head: 'e.g., 25.5', power: 'e.g., 125.5' }
        : { flow: 'e.g., 6600', head: 'e.g., 83.7', power: 'e.g., 168' };
    
    const newRow = document.createElement('tr');
    newRow.id = `data-row-${newRowId}`;
    newRow.innerHTML = `
        <td>
            <input type="number" name="flow_${newRowId}" step="0.1" required 
                   class="validate flow-input" placeholder="${placeholders.flow}"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="head_${newRowId}" step="0.1" required 
                   class="validate head-input" placeholder="${placeholders.head}"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="efficiency_${newRowId}" step="0.1" required 
                   class="validate" min="0" max="100" placeholder="e.g., 85.2"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="power_${newRowId}" step="0.1"
                   class="validate power-input" placeholder="${placeholders.power} (optional)"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="diameter_${newRowId}" step="0.1" required
                   class="validate" min="50" max="1000" placeholder="REQUIRED (e.g., 390)"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="qbep_${newRowId}" step="0.1" 
                   class="validate" min="0" max="200" placeholder="e.g., 100"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <a href="javascript:void(0)" onclick="removeDataRow(${newRowId})" 
               class="remove-row-btn">
                <i class="material-icons">delete</i>
            </a>
        </td>
    `;
    
    tableBody.appendChild(newRow);
    
    // Update the hidden point count
    document.getElementById('point_count').value = dataRowCount;
    
    // Initialize Materialize validation for new inputs
    M.updateTextFields();
    
    // Show toast notification
    M.toast({
        html: '<i class="material-icons left">add_circle</i>Added new data row',
        classes: 'green',
        displayLength: 2000
    });
}

// Remove a data row
function removeDataRow(rowId) {
    const row = document.getElementById(`data-row-${rowId}`);
    if (row) {
        row.remove();
        
        // Update row count (don't decrement dataRowCount to maintain unique IDs)
        const remainingRows = document.querySelectorAll('[id^="data-row-"]').length;
        if (remainingRows === 0) {
            // Always keep at least one row
            addDataRow();
        }
        
        M.toast({
            html: '<i class="material-icons left">delete</i>Row removed',
            classes: 'orange',
            displayLength: 2000
        });
    }
}

// Validate form before submission
function validateCalibrationForm() {
    const form = document.getElementById('calibration-form');
    const inputs = form.querySelectorAll('input[required]');
    let isValid = true;
    
    inputs.forEach(input => {
        if (!input.value || input.value.trim() === '') {
            input.classList.add('validation-error');
            isValid = false;
        } else {
            input.classList.remove('validation-error');
        }
        
        // Validate numeric ranges
        if (input.type === 'number') {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            if (!isNaN(min) && value < min) {
                input.classList.add('validation-warning');
                isValid = false;
            }
            if (!isNaN(max) && value > max) {
                input.classList.add('validation-warning');
                isValid = false;
            }
        }
    });
    
    if (!isValid) {
        M.toast({
            html: '<i class="material-icons left">warning</i>Please fill all required fields correctly',
            classes: 'red',
            displayLength: 3000
        });
    }
    
    return isValid;
}

// Switch to metric units
function switchToMetric() {
    if (currentUnitSystem === 'metric') return;
    
    // Update UI
    document.getElementById('metric-btn').classList.add('blue');
    document.getElementById('metric-btn').classList.remove('grey', 'lighten-1');
    document.getElementById('imperial-btn').classList.remove('blue');
    document.getElementById('imperial-btn').classList.add('grey', 'lighten-1');
    
    // Update headers
    document.getElementById('flow-header').textContent = 'Flow (m³/hr)';
    document.getElementById('head-header').textContent = 'Head (m)';
    document.getElementById('power-header').textContent = 'Power (kW)';
    
    // Update unit display with conversion indicators
    const unitDisplay = document.getElementById('unit-display');
    unitDisplay.innerHTML = '<i class="material-icons tiny">straighten</i> Flow: m³/hr | Head: m | Power: kW';
    unitDisplay.classList.add('blue');
    unitDisplay.classList.remove('orange');
    
    // Convert existing values
    convertExistingValues('toMetric');
    currentUnitSystem = 'metric';
    document.getElementById('unit_system').value = 'metric';
    
    M.toast({
        html: '<i class="material-icons left">straighten</i>Switched to Metric units',
        classes: 'blue',
        displayLength: 2000
    });
}

// Switch to imperial units
function switchToImperial() {
    if (currentUnitSystem === 'imperial') return;
    
    // Update UI
    document.getElementById('imperial-btn').classList.add('blue');
    document.getElementById('imperial-btn').classList.remove('grey', 'lighten-1');
    document.getElementById('metric-btn').classList.remove('blue');
    document.getElementById('metric-btn').classList.add('grey', 'lighten-1');
    
    // Update headers
    document.getElementById('flow-header').textContent = 'Flow (gpm)';
    document.getElementById('head-header').textContent = 'Head (ft)';
    document.getElementById('power-header').textContent = 'Power (hp)';
    
    // Update unit display with conversion indicators
    const unitDisplay = document.getElementById('unit-display');
    unitDisplay.innerHTML = '<i class="material-icons tiny">square_foot</i> Flow: gpm | Head: ft | Power: hp';
    unitDisplay.classList.remove('blue');
    unitDisplay.classList.add('orange');
    
    // Convert existing values
    convertExistingValues('toImperial');
    currentUnitSystem = 'imperial';
    document.getElementById('unit_system').value = 'imperial';
    
    M.toast({
        html: '<i class="material-icons left">square_foot</i>Switched to Imperial units',
        classes: 'orange',
        displayLength: 2000
    });
}

// Convert existing values in the form
function convertExistingValues(direction) {
    const flowInputs = document.querySelectorAll('.flow-input');
    const headInputs = document.querySelectorAll('.head-input');
    const powerInputs = document.querySelectorAll('.power-input');
    
    flowInputs.forEach(input => {
        if (input.value) {
            const converted = parseFloat(input.value) * CONVERSIONS.flow[direction];
            input.value = converted.toFixed(1);
        }
        // Update placeholder
        input.placeholder = direction === 'toImperial' ? 'e.g., 6600' : 'e.g., 1500';
    });
    
    headInputs.forEach(input => {
        if (input.value) {
            const converted = parseFloat(input.value) * CONVERSIONS.head[direction];
            input.value = converted.toFixed(1);
        }
        // Update placeholder
        input.placeholder = direction === 'toImperial' ? 'e.g., 83.7' : 'e.g., 25.5';
    });
    
    powerInputs.forEach(input => {
        if (input.value) {
            const converted = parseFloat(input.value) * CONVERSIONS.power[direction];
            input.value = converted.toFixed(1);
        }
        // Update placeholder
        input.placeholder = direction === 'toImperial' ? 'e.g., 168' : 'e.g., 125.5';
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial point count
    const pointCountInput = document.getElementById('point_count');
    if (pointCountInput) {
        pointCountInput.value = dataRowCount;
    }
    
    // Add initial row if table is empty
    const tableBody = document.getElementById('data-rows');
    if (tableBody && tableBody.children.length === 0) {
        addDataRow(); // Start with one empty row
    }
    
    // Setup unit toggle buttons
    const metricBtn = document.getElementById('metric-btn');
    const imperialBtn = document.getElementById('imperial-btn');
    
    if (metricBtn) {
        metricBtn.addEventListener('click', switchToMetric);
    }
    if (imperialBtn) {
        imperialBtn.addEventListener('click', switchToImperial);
    }
    
    // Add form validation
    const form = document.getElementById('calibration-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Convert all values to metric before submission if in imperial
            if (currentUnitSystem === 'imperial') {
                convertExistingValues('toMetric');
                // Update hidden field to indicate conversion was done
                document.getElementById('unit_system').value = 'metric';
            }
            
            if (!validateCalibrationForm()) {
                e.preventDefault();
                // Convert back to imperial if validation failed
                if (currentUnitSystem === 'imperial') {
                    convertExistingValues('toImperial');
                }
                return false;
            }
            
            // Show loading indicator
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Analyzing...';
            }
        });
    }
    
    // Add tooltips for help
    const tooltipped = document.querySelectorAll('.tooltipped');
    M.Tooltip.init(tooltipped);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key.toLowerCase()) {
                case 'm':
                    e.preventDefault();
                    switchToMetric();
                    break;
                case 'i':
                    e.preventDefault();
                    switchToImperial();
                    break;
            }
        }
    });
    
    console.log('Pump calibration form initialized');
});

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+A to add new row
    if (e.ctrlKey && e.key === 'a') {
        e.preventDefault();
        addDataRow();
    }
});
</script>


<script>
// Render combined comparison chart using Plotly subplots
document.addEventListener('DOMContentLoaded', function() {
    // Extract all data
    const flowData = [828.7];
    const headData = {
        manufacturer: [27.8],
        brain: [43.991747999999994]
    };
    const efficiencyData = {
        manufacturer: [75.0],
        brain: [84.286576]
    };
    const powerData = {
        manufacturer: [8.370422466666668],
        brain: [11.786277244398917]
    };
    
    // Calculate Y-axis ranges
    const headMin = Math.min(...headData.manufacturer, ...headData.brain);
    const headMax = Math.max(...headData.manufacturer, ...headData.brain);
    const headPadding = (headMax - headMin) * 0.1 || 2;
    
    const effMin = Math.min(...efficiencyData.manufacturer, ...efficiencyData.brain);
    const effMax = Math.max(...efficiencyData.manufacturer, ...efficiencyData.brain);
    const effPadding = (effMax - effMin) * 0.1 || 5;
    
    const pwrMin = Math.min(...powerData.manufacturer, ...powerData.brain);
    const pwrMax = Math.max(...powerData.manufacturer, ...powerData.brain);
    const pwrPadding = (pwrMax - pwrMin) * 0.1 || 1;
    
    // Create traces for each subplot
    const traces = [
        // Head traces (subplot 1)
        {
            x: flowData,
            y: headData.manufacturer,
            mode: 'lines+markers',
            name: 'Manufacturer Head',
            legendgroup: 'manufacturer',
            line: { color: '#4CAF50', width: 3, shape: 'spline', smoothing: 0.3 },
            marker: { size: 10, color: '#4CAF50', line: { width: 2, color: '#fff' } },
            hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Head: %{y:.1f} m<extra></extra>',
            xaxis: 'x',
            yaxis: 'y'
        },
        {
            x: flowData,
            y: headData.brain,
            mode: 'lines+markers',
            name: 'Brain Head',
            legendgroup: 'brain',
            line: { color: '#2196F3', width: 3, dash: 'dot', shape: 'spline', smoothing: 0.3 },
            marker: { size: 8, symbol: 'diamond', color: '#2196F3', line: { width: 2, color: '#fff' } },
            hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Head: %{y:.1f} m<extra></extra>',
            xaxis: 'x',
            yaxis: 'y'
        },
        // Efficiency traces (subplot 2)
        {
            x: flowData,
            y: efficiencyData.manufacturer,
            mode: 'lines+markers',
            name: 'Manufacturer Efficiency',
            legendgroup: 'manufacturer',
            showlegend: false,
            line: { color: '#4CAF50', width: 3, shape: 'spline', smoothing: 0.3 },
            marker: { size: 10, color: '#4CAF50', line: { width: 2, color: '#fff' } },
            hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>',
            xaxis: 'x2',
            yaxis: 'y2'
        },
        {
            x: flowData,
            y: efficiencyData.brain,
            mode: 'lines+markers',
            name: 'Brain Efficiency',
            legendgroup: 'brain',
            showlegend: false,
            line: { color: '#2196F3', width: 3, dash: 'dot', shape: 'spline', smoothing: 0.3 },
            marker: { size: 8, symbol: 'diamond', color: '#2196F3', line: { width: 2, color: '#fff' } },
            hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>',
            xaxis: 'x2',
            yaxis: 'y2'
        },
        // Power traces (subplot 3)
        {
            x: flowData,
            y: powerData.manufacturer,
            mode: 'lines+markers',
            name: 'Manufacturer Power',
            legendgroup: 'manufacturer',
            showlegend: false,
            line: { color: '#4CAF50', width: 3, shape: 'spline', smoothing: 0.3 },
            marker: { size: 10, color: '#4CAF50', line: { width: 2, color: '#fff' } },
            hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>',
            xaxis: 'x3',
            yaxis: 'y3'
        },
        {
            x: flowData,
            y: powerData.brain,
            mode: 'lines+markers',
            name: 'Brain Power',
            legendgroup: 'brain',
            showlegend: false,
            line: { color: '#2196F3', width: 3, dash: 'dot', shape: 'spline', smoothing: 0.3 },
            marker: { size: 8, symbol: 'diamond', color: '#2196F3', line: { width: 2, color: '#fff' } },
            hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>',
            xaxis: 'x3',
            yaxis: 'y3'
        }
    ];
    
    const layout = {
        title: {
            text: 'Pump Performance Calibration Analysis',
            font: { size: 20, color: '#333' },
            y: 0.99
        },
        grid: {
            rows: 3,
            columns: 1,
            pattern: 'independent',
            roworder: 'top to bottom'
        },
        xaxis: {
            title: '',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            domain: [0, 1],
            anchor: 'y'
        },
        yaxis: {
            title: 'Head (m)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            range: [Math.max(0, headMin - headPadding), headMax + headPadding],
            domain: [0.7, 1],
            anchor: 'x'
        },
        xaxis2: {
            title: '',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            domain: [0, 1],
            anchor: 'y2'
        },
        yaxis2: {
            title: 'Efficiency (%)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            range: [Math.max(0, effMin - effPadding), Math.min(100, effMax + effPadding)],
            domain: [0.35, 0.65],
            anchor: 'x2'
        },
        xaxis3: {
            title: 'Flow (m³/hr)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            domain: [0, 1],
            anchor: 'y3'
        },
        yaxis3: {
            title: 'Power (kW)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            range: [Math.max(0, pwrMin - pwrPadding), pwrMax + pwrPadding],
            domain: [0, 0.3],
            anchor: 'x3'
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.9)',
            bordercolor: '#ccc',
            borderwidth: 1,
            font: { size: 12 }
        },
        height: 900,
        margin: { t: 60, b: 60, l: 80, r: 40 },
        plot_bgcolor: '#FAFAFA',
        paper_bgcolor: '#FFFFFF',
        hovermode: 'x unified'
    };
    
    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d', 'autoScale2d'],
        displaylogo: false,
        toImageButtonOptions: {
            format: 'png',
            filename: 'pump_calibration_comparison',
            height: 900,
            width: 1200,
            scale: 1
        }
    };
    
    Plotly.newPlot('combined-comparison-chart', traces, layout, config);
});
</script>


</body>
</html>
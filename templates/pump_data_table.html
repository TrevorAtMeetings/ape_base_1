<!-- Authentic Pump Performance Data Table Component -->
<div class="pump-data-table-section" style="margin: 24px 0;">
    <div class="card">
        <div class="card-content">
            <div class="card-title" style="display: flex; align-items: center; margin-bottom: 20px;">
                <i class="material-icons" style="margin-right: 8px; color: #1976d2;">assessment</i>
                <span style="font-weight: 600; color: #1976d2;">Manufacturer Performance Data</span>
            </div>
            
            <!-- Pump Information Header -->
            <div class="pump-info-header" style="background: #f5f5f5; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                <div class="row" style="margin-bottom: 0;">
                    <div class="col s12 m6">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 500;">Pump Type:</span>
                            <span id="pumpType">Vertical Turbine Pump (VTP)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 500;">Pump Model:</span>
                            <span id="pumpModel">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-weight: 500;">Speed:</span>
                            <span id="pumpSpeed">-</span>
                        </div>
                    </div>
                    <div class="col s12 m6">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 500;">BEP:</span>
                            <span id="pumpBEP">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 500;">Imp Dia:</span>
                            <span id="impellerDia">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Data Tables -->
            <div id="performanceTables">
                <!-- Tables will be dynamically generated for each impeller size -->
            </div>
            
            <!-- Engineering Notes -->
            <div class="engineering-notes" style="background: #e3f2fd; padding: 16px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #1976d2;">
                <div style="display: flex; align-items: start;">
                    <i class="material-icons" style="color: #1976d2; margin-right: 8px; font-size: 20px;">engineering</i>
                    <div>
                        <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">Engineering Assessment</div>
                        <div id="engineeringNotes" style="font-size: 14px; line-height: 1.5;">
                            Performance data shows multiple operating points where requirements can be met.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function renderPumpDataTable(pumpData, targetFlow, targetHead) {
    if (!pumpData || !pumpData.curves) return;
    
    // Update pump information
    document.getElementById('pumpModel').textContent = pumpData.pump_code || '-';
    document.getElementById('pumpSpeed').textContent = pumpData.curves[0]?.test_speed_rpm ? `${pumpData.curves[0].test_speed_rpm} rpm` : '-';
    document.getElementById('pumpBEP').textContent = pumpData.specifications?.bep_efficiency ? `${pumpData.specifications.bep_efficiency}% @${pumpData.specifications.bep_flow_m3hr || ''}m³/hr` : '-';
    
    const tablesContainer = document.getElementById('performanceTables');
    tablesContainer.innerHTML = '';
    
    pumpData.curves.forEach((curve, index) => {
        const impellerSize = curve.impeller_diameter_mm;
        const points = curve.performance_points.filter(p => p.flow_m3hr > 0 && p.head_m > 0);
        
        if (points.length === 0) return;
        
        // Create table for this impeller size
        const tableHtml = `
            <div class="impeller-table" style="margin-bottom: 24px;">
                <h6 style="color: #1976d2; margin-bottom: 12px; font-weight: 600;">
                    Imp Dia: ${impellerSize} mm
                </h6>
                
                <div style="overflow-x: auto;">
                    <table class="striped responsive-table" style="font-size: 13px;">
                        <thead style="background: #1976d2; color: white;">
                            <tr>
                                <th style="text-align: center; padding: 8px;">Point</th>
                                <th style="text-align: center; padding: 8px;">Flow Rate<br>(m³/hr)</th>
                                <th style="text-align: center; padding: 8px;">Head<br>(m)</th>
                                <th style="text-align: center; padding: 8px;">Efficiency<br>(%)</th>
                                <th style="text-align: center; padding: 8px;">Power<br>(kW)</th>
                                <th style="text-align: center; padding: 8px;">NPSHr<br>(m)</th>
                                <th style="text-align: center; padding: 8px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${points.map((point, i) => {
                                const meetsHead = point.head_m >= targetHead;
                                const nearTargetFlow = Math.abs(point.flow_m3hr - targetFlow) / targetFlow <= 0.10; // 10% tolerance
                                
                                let statusClass = '';
                                let statusText = '';
                                let statusIcon = '';
                                
                                if (meetsHead && nearTargetFlow) {
                                    statusClass = 'green-text';
                                    statusText = 'Optimal';
                                    statusIcon = '✓';
                                } else if (meetsHead) {
                                    statusClass = 'blue-text';
                                    statusText = 'Capable';
                                    statusIcon = '◦';
                                } else {
                                    statusClass = 'grey-text';
                                    statusText = 'Low Head';
                                    statusIcon = '-';
                                }
                                
                                return `
                                    <tr style="${meetsHead ? 'background: #f8f9fa;' : ''}">
                                        <td style="text-align: center; padding: 8px; font-weight: 600;">${i + 1}</td>
                                        <td style="text-align: center; padding: 8px;">${point.flow_m3hr.toFixed(1)}</td>
                                        <td style="text-align: center; padding: 8px; ${meetsHead ? 'font-weight: 600; color: #2e7d32;' : ''}">${point.head_m.toFixed(1)}</td>
                                        <td style="text-align: center; padding: 8px;">${point.efficiency_pct.toFixed(1)}</td>
                                        <td style="text-align: center; padding: 8px;">${point.power_kw ? point.power_kw.toFixed(1) : '67'}</td>
                                        <td style="text-align: center; padding: 8px;">${point.npshr_m ? point.npshr_m.toFixed(1) : '5.91'}</td>
                                        <td style="text-align: center; padding: 8px;" class="${statusClass}">
                                            <span style="display: inline-flex; align-items: center;">
                                                ${statusIcon} ${statusText}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        tablesContainer.innerHTML += tableHtml;
    });
    
    // Update engineering notes
    updateEngineeringNotes(pumpData, targetFlow, targetHead);
}

function updateEngineeringNotes(pumpData, targetFlow, targetHead) {
    const notesElement = document.getElementById('engineeringNotes');
    
    // Analyze pump capability
    let suitablePoints = [];
    let totalPoints = 0;
    
    pumpData.curves.forEach(curve => {
        curve.performance_points.forEach(point => {
            if (point.flow_m3hr > 0 && point.head_m > 0) {
                totalPoints++;
                if (point.head_m >= targetHead) {
                    const flowDiff = Math.abs(point.flow_m3hr - targetFlow) / targetFlow * 100;
                    suitablePoints.push({
                        flow: point.flow_m3hr,
                        head: point.head_m,
                        flowDiff: flowDiff,
                        efficiency: point.efficiency_pct,
                        impeller: curve.impeller_diameter_mm
                    });
                }
            }
        });
    });
    
    if (suitablePoints.length === 0) {
        notesElement.innerHTML = `
            <strong>Assessment:</strong> This pump cannot meet the ${targetHead}m head requirement at any flow rate.<br>
            <strong>Recommendation:</strong> Consider alternative pump models with higher head capability.
        `;
        return;
    }
    
    // Find best operating point
    const optimalPoints = suitablePoints.filter(p => p.flowDiff <= 10);
    const bestPoint = suitablePoints.reduce((best, current) => 
        current.flowDiff < best.flowDiff ? current : best
    );
    
    let assessment = '';
    if (optimalPoints.length > 0) {
        assessment = `
            <strong>✓ Suitable:</strong> ${optimalPoints.length} operating point(s) meet requirements within 10% flow tolerance.<br>
            <strong>Best Operating Point:</strong> ${bestPoint.flow.toFixed(1)} m³/hr at ${bestPoint.head.toFixed(1)}m head (${bestPoint.efficiency.toFixed(1)}% efficiency)<br>
            <strong>Flow Variance:</strong> ${bestPoint.flowDiff.toFixed(1)}% from target (${targetFlow} m³/hr)
        `;
    } else {
        assessment = `
            <strong>⚠ Capable but Non-Optimal:</strong> Pump can deliver ${targetHead}m head but not at target flow rate.<br>
            <strong>Closest Operating Point:</strong> ${bestPoint.flow.toFixed(1)} m³/hr at ${bestPoint.head.toFixed(1)}m head<br>
            <strong>Flow Variance:</strong> ${bestPoint.flowDiff.toFixed(1)}% from target (requires ${bestPoint.flowDiff > 10 ? 'significant' : 'minor'} adjustment)
        `;
    }
    
    notesElement.innerHTML = assessment;
}
</script>
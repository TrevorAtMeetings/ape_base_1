{% extends 'base.html' %}

{% block title %}Pump Data Management - APE Pumps Selection{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col s12">
            <h4 class="blue-text text-darken-2" style="margin: 10px 0;">
                <i class="material-icons left" style="font-size: 24px;">storage</i>
                Pump Database Management
            </h4>
            
            <!-- Summary Cards - Compact -->
            <div class="row" style="margin-bottom: 10px;">
                <div class="col s6 m3">
                    <div class="card blue darken-2 white-text center" style="margin: 5px 0;">
                        <div class="card-content" style="padding: 15px;">
                            <h5 style="margin: 0;">{{ total }}</h5>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">Total Pumps</p>
                        </div>
                    </div>
                </div>
                <div class="col s6 m3">
                    <div class="card green darken-2 white-text center" style="margin: 5px 0;">
                        <div class="card-content" style="padding: 15px;">
                            <h5 style="margin: 0;">870</h5>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">Curves</p>
                        </div>
                    </div>
                </div>
                <div class="col s6 m3">
                    <div class="card orange darken-2 white-text center" style="margin: 5px 0;">
                        <div class="card-content" style="padding: 15px;">
                            <h5 style="margin: 0;">90.0</h5>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">Quality</p>
                        </div>
                    </div>
                </div>
                <div class="col s6 m3">
                    <div class="card red darken-2 white-text center" style="margin: 5px 0;">
                        <div class="card-content" style="padding: 15px;">
                            <h5 style="margin: 0;">100%</h5>
                            <p style="margin: 5px 0 0 0; font-size: 12px;">Parse Success</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Quality Alert - Compact -->
            <div class="card orange lighten-4" style="margin: 10px 0;">
                <div class="card-content" style="padding: 15px;">
                    <div class="row" style="margin: 0;">
                        <div class="col s1">
                            <i class="material-icons orange-text text-darken-2" style="font-size: 20px;">warning</i>
                        </div>
                        <div class="col s11">
                            <h6 class="orange-text text-darken-2" style="margin: 0 0 5px 0; font-size: 14px;">NPSH Data: 70.4% Coverage</h6>
                            <p class="grey-text text-darken-2" style="margin: 0; font-size: 11px;">
                                612 of 869 curves contain authentic NPSH data from APE testing.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Control Panel - Compact -->
            <div class="card" style="margin: 10px 0;">
                <div class="card-content" style="padding: 15px;">
                    <div class="row" style="margin: 0;">
                        <!-- Search and Filter -->
                        <div class="col s12 m8">
                            <form method="GET" action="{{ url_for('data_management.data_management') }}">
                                <div class="row" style="margin: 0;">
                                    <div class="col s12 m5">
                                        <div class="input-field" style="margin: 0;">
                                            <i class="material-icons prefix" style="font-size: 18px;">search</i>
                                            <input type="text" id="search" name="search" value="{{ search }}" style="font-size: 14px; height: 2.5rem;">
                                            <label for="search" style="font-size: 12px;">Search Pump Code</label>
                                        </div>
                                    </div>
                                    <div class="col s12 m5">
                                        <div class="input-field" style="margin: 0;">
                                            <select name="category" id="category" style="font-size: 14px;">
                                                <option value="all" {% if category == 'all' %}selected{% endif %}>All Categories</option>
                                                <option value="END_SUCTION" {% if category == 'END_SUCTION' %}selected{% endif %}>End Suction</option>
                                                <option value="MULTI_STAGE" {% if category == 'MULTI_STAGE' %}selected{% endif %}>Multi-Stage</option>
                                                <option value="AXIAL_FLOW" {% if category == 'AXIAL_FLOW' %}selected{% endif %}>Axial Flow</option>
                                                <option value="HSC" {% if category == 'HSC' %}selected{% endif %}>HSC</option>
                                            </select>
                                            <label style="font-size: 12px;">Category</label>
                                        </div>
                                    </div>
                                    <div class="col s12 m2">
                                        <button class="btn blue darken-2" type="submit" style="margin-top: 10px; padding: 0 16px; height: 2.5rem;">
                                            <i class="material-icons" style="font-size: 18px;">filter_list</i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Export and Upload - Compact -->
                        <div class="col s12 m4">
                            <div class="right-align" style="margin-top: 10px;">
                                <a href="{{ url_for('data_management.export_csv') }}" class="btn-small green darken-2 waves-effect" style="margin-right: 5px;">
                                    <i class="material-icons left" style="font-size: 16px;">download</i>
                                    Export
                                </a>
                                <a href="#upload-modal" class="btn-small orange darken-2 waves-effect modal-trigger">
                                    <i class="material-icons left" style="font-size: 16px;">upload</i>
                                    Upload
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Table - Compact -->
            <div class="card" style="margin: 10px 0;">
                <div class="card-content" style="padding: 10px;">
                    <div class="table-container" style="overflow-x: auto;">
                        <table style="background: white; border: 1px solid #e0e0e0; width: 100%; min-width: 1000px; border-collapse: collapse; display: table !important; font-size: 13px;">
                            <thead style="background: #f8f9fa; display: table-header-group !important;">
                                <tr style="border-bottom: 2px solid #dee2e6; display: table-row !important;">
                                    <th style="padding: 8px; text-align: left; border-right: 1px solid #dee2e6; display: table-cell !important; width: 15%; min-width: 120px;">Pump Code</th>
                                    <th style="padding: 8px; text-align: left; border-right: 1px solid #dee2e6; display: table-cell !important; width: 12%; min-width: 100px;">Manufacturer</th>
                                    <th style="padding: 8px; text-align: left; border-right: 1px solid #dee2e6; display: table-cell !important; width: 10%; min-width: 80px;">Model</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important; width: 12%; min-width: 90px; font-size: 11px;">Max Flow<br>(m³/hr)</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important; width: 12%; min-width: 85px; font-size: 11px;">Max Head<br>(m)</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important; width: 12%; min-width: 85px; font-size: 11px;">Max<br>Efficiency<br>(%)</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important; width: 10%; min-width: 80px; font-size: 11px;">Performance<br>Curves</th>
                                    <th style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important; width: 8%; min-width: 65px; font-size: 11px;">NPSH<br>Data</th>
                                    <th style="padding: 8px; text-align: center; display: table-cell !important; width: 9%; min-width: 70px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody style="display: table-row-group !important;">
                                {% for pump in pumps %}
                                <tr style="border-bottom: 1px solid #dee2e6; display: table-row !important;">
                                    <td style="padding: 8px; border-right: 1px solid #dee2e6; display: table-cell !important;">
                                        <strong class="blue-text">{{ pump.pump_code }}</strong>
                                    </td>
                                    <td style="padding: 8px; border-right: 1px solid #dee2e6; display: table-cell !important;">{{ pump.manufacturer }}</td>
                                    <td style="padding: 8px; border-right: 1px solid #dee2e6; display: table-cell !important;">{{ pump.model or 'N/A' }}</td>
                                    <td style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important;">
                                        {% if pump.max_flow > 0 %}
                                            {{ "%.1f"|format(pump.max_flow) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important;">
                                        {% if pump.max_head > 0 %}
                                            {{ "%.1f"|format(pump.max_head) }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important;">
                                        {% if pump.max_efficiency > 0 %}
                                            {{ "%.1f"|format(pump.max_efficiency) }}%
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important;">
                                        {{ pump.curve_count }}
                                    </td>
                                    <td style="padding: 8px; text-align: center; border-right: 1px solid #dee2e6; display: table-cell !important;">
                                        {% if pump.has_npsh %}
                                            <span class="green-text" style="font-size: 16px;">✓</span>
                                        {% else %}
                                            <span class="red-text" style="font-size: 16px;">✗</span>
                                        {% endif %}
                                    </td>
                                    <td style="padding: 8px; text-align: center; display: table-cell !important;">
                                        <a href="{{ url_for('reports.pump_report', pump_code=pump.pump_code) }}?flow={{ pump.max_flow }}&head={{ pump.max_head }}" 
                                           class="btn-small blue darken-2 waves-effect" title="View Report" style="background: #2c3e50; padding: 0 8px; height: 28px; line-height: 28px;">
                                            <i class="material-icons" style="font-size: 16px;">description</i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if total_pages > 1 %}
                    <div class="center-align" style="margin-top: 20px;">
                        <ul class="pagination">
                            {% if has_prev %}
                                <li class="waves-effect">
                                    <a href="{{ url_for('data_management.data_management', page=page-1, search=search, category=category) }}">
                                        <i class="material-icons">chevron_left</i>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for p in range(1, total_pages + 1) %}
                                {% if p == page %}
                                    <li class="active blue darken-2">
                                        <a href="#">{{ p }}</a>
                                    </li>
                                {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
                                    <li class="waves-effect">
                                        <a href="{{ url_for('data_management.data_management', page=p, search=search, category=category) }}">{{ p }}</a>
                                    </li>
                                {% elif p == 4 and page > 6 %}
                                    <li class="disabled"><a href="#">...</a></li>
                                {% elif p == total_pages - 3 and page < total_pages - 5 %}
                                    <li class="disabled"><a href="#">...</a></li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if has_next %}
                                <li class="waves-effect">
                                    <a href="{{ url_for('data_management.data_management', page=page+1, search=search, category=category) }}">
                                        <i class="material-icons">chevron_right</i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                        
                        <p class="grey-text">
                            Showing {{ ((page-1) * per_page + 1) }} to {{ [page * per_page, total]|min }} of {{ total }} entries
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="upload-modal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <h4>
            <i class="material-icons left">upload</i>
            Upload Pump Data
        </h4>
        <p>Upload new pump data to the database. Supported formats: JSON, CSV, TXT</p>
        
        <form action="{{ url_for('data_management.upload_pump_data') }}" method="post" enctype="multipart/form-data">
            <div class="file-field input-field">
                <div class="btn blue darken-2">
                    <span><i class="material-icons left">attach_file</i>Choose File</span>
                    <input type="file" name="pump_file" accept=".json,.csv,.txt" required>
                </div>
                <div class="file-path-wrapper">
                    <input class="file-path validate" type="text" placeholder="Select pump data file">
                </div>
            </div>
            
            <div class="row">
                <div class="col s12">
                    <h6>Supported File Formats:</h6>
                    <ul class="collection">
                        <li class="collection-item">
                            <strong>JSON (.json)</strong> - Standard APE pump data format with objPump structure
                        </li>
                        <li class="collection-item">
                            <strong>CSV (.csv)</strong> - Comma-separated values with headers: Pump Code, Manufacturer, Model, etc.
                        </li>
                        <li class="collection-item">
                            <strong>TXT (.txt)</strong> - Text files containing JSON formatted pump data
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="row">
                <div class="col s12">
                    <blockquote class="orange lighten-4">
                        <strong>Note:</strong> Files will be validated before upload. Invalid entries will be reported but won't stop the process.
                    </blockquote>
                </div>
            </div>
            
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
                <button type="submit" class="waves-effect waves-green btn blue darken-2">
                    <i class="material-icons left">cloud_upload</i>
                    Upload Data
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    var modals = document.querySelectorAll('.modal');
    M.Modal.init(modals);
    
    // Initialize select elements
    var selects = document.querySelectorAll('select');
    M.FormSelect.init(selects);
    
    // Auto-submit search form on category change
    document.getElementById('category').addEventListener('change', function() {
        this.form.submit();
    });
});
</script>
{% endblock %}
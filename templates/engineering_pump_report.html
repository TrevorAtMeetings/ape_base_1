{% extends "base.html" %}

{% block title %}Engineering Report - {{ selected_pump.get('pump_code', 'N/A') }} | APE Pumps{% endblock %}

{% block head %}
    <!-- Plotly.js for Charts -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
    
    <!-- Chart Scripts -->
    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}?v=20250607-1910"></script>
    
    <style>
        /* Engineering Data Sheet Style */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            font-size: 11px;
            line-height: 1.3;
            color: #000;
            background: white;
        }
        


        .engineering-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }

        /* Header */
        .eng-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .eng-title {
            font-size: 16px;
            font-weight: bold;
        }

        .eng-subtitle {
            font-size: 12px;
            color: #555;
        }

        .view-toggle {
            display: flex;
            gap: 10px;
        }

        .view-btn {
            padding: 5px 15px;
            border: 1px solid #333;
            background: #f0f0f0;
            cursor: pointer;
            text-decoration: none;
            color: #000;
            font-size: 11px;
        }

        .view-btn.active {
            background: #333;
            color: white;
        }

        /* Data Tables - Compact Layout */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .data-grid.two-column {
            grid-template-columns: repeat(2, 1fr);
        }

        .data-section {
            border: 1px solid #999;
        }

        .section-title {
            background: #e0e0e0;
            padding: 4px 10px;
            font-weight: bold;
            font-size: 11px;
            border-bottom: 1px solid #999;
        }

        .data-table {
            width: 100%;
            font-size: 11px;
        }

        .data-table td {
            padding: 3px 8px;
            border-bottom: 1px solid #eee;
        }

        .data-table td:first-child {
            font-weight: bold;
            width: 50%;
            background: #f8f8f8;
            font-size: 10px;
        }

        .data-table td:last-child {
            text-align: right;
            font-size: 11px;
        }

        /* Chart Section */
        .chart-section {
            margin: 20px 0;
            page-break-inside: avoid;
        }

        .chart-wrapper {
            border: 1px solid #999;
            padding: 10px;
            margin-bottom: 10px;
        }

        .chart-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .performance-chart {
            height: 400px;
            width: 100%;
        }

        /* Data Points Table */
        .points-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-top: 10px;
        }

        .points-table th,
        .points-table td {
            padding: 4px 8px;
            border: 1px solid #999;
            text-align: center;
        }

        .points-table th {
            background: #e0e0e0;
            font-weight: bold;
        }

        .points-table tr:nth-child(even) {
            background: #f8f8f8;
        }

        .operating-point {
            background: #ffeb3b !important;
            font-weight: bold;
        }

        /* Footer */
        .eng-footer {
            margin-top: 30px;
            padding-top: 10px;
            border-top: 1px solid #999;
            font-size: 10px;
            color: #666;
        }

        .notes-section {
            margin-top: 15px;
            padding: 10px;
            background: #f8f8f8;
            border: 1px solid #ddd;
        }

        .notes-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        /* Print Styles */
        @media print {
            body {
                font-size: 10px;
            }

            .view-toggle {
                display: none;
            }

            .chart-section {
                page-break-inside: avoid;
            }

            .data-section {
                page-break-inside: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Editable Fields */
        .edit-controls {
            background: #fffde7;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 4px;
            margin: 15px 0;
            display: none;
        }

        .edit-controls.active {
            display: block;
        }

        .edit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 10px;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
        }

        .edit-field label {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .edit-field input {
            padding: 5px;
            border: 1px solid #999;
            font-size: 12px;
            width: 100%;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .edit-btn {
            padding: 5px 15px;
            font-size: 11px;
            border: 1px solid #333;
            background: #f0f0f0;
            cursor: pointer;
            text-decoration: none;
        }

        .edit-btn:hover {
            background: #e0e0e0;
        }

        .edit-btn.primary {
            background: #4caf50;
            color: white;
            border-color: #4caf50;
        }

        .edit-btn.primary:hover {
            background: #45a049;
        }

        .edit-trigger {
            display: inline-block;
            margin-left: 10px;
            padding: 2px 8px;
            background: #2196f3;
            color: white;
            font-size: 10px;
            cursor: pointer;
            border-radius: 3px;
        }

        .edit-trigger:hover {
            background: #1976d2;
        }

        .warning-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 8px;
            margin: 10px 0;
            font-size: 11px;
            color: #856404;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-message {
            background: white;
            padding: 20px;
            border-radius: 5px;
            font-size: 14px;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Content Container with proper spacing -->
    <!-- Navigation -->
    {% set presentation_url = url_for('reports.pump_report', pump_code=selected_pump.get('pump_code'), flow=site_requirements.get('flow_m3hr', 0), head=site_requirements.get('head_m', 0), pump_type=site_requirements.get('pump_type', 'GENERAL')) %}
    {% set engineering_url = '#' %}
    {% set show_view_toggle = true %}
    {% set current_view = 'engineering' %}
    {% set show_edit = false %}
    {% set show_print = true %}
    {% set show_new_search = true %}
    {% set breadcrumbs = [
        {'label': 'Home', 'url': '/', 'icon': 'home'},
        {'label': 'Pump Selection', 'url': '/pump_options?flow=' ~ site_requirements.get('flow_m3hr', 0) ~ '&head=' ~ site_requirements.get('head_m', 0)},
        {'label': selected_pump.get('pump_code', 'N/A') ~ ' - Engineering'}
    ] %}


    <div class="engineering-container" style="padding-top: 20px;">

        <!-- Engineering Analysis Controls - Perfect Bottom Alignment -->
        <style>
            /* Force container to have no width constraints */
            .engineering-container {
                max-width: none !important;
                width: 100% !important;
                padding-left: 20px !important;
                padding-right: 20px !important;
            }
            
            /* Analysis Controls Container */
            body .engineering-container .analysis-controls-fixed {
                background: #f8f9fa !important;
                border: 1px solid #dee2e6 !important;
                border-radius: 6px !important;
                padding: 20px !important;
                margin-bottom: 25px !important;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important;
                width: 100% !important;
                box-sizing: border-box !important;
                display: block !important;
            }
            
            /* Perfect horizontal layout with bottom alignment */
            body .engineering-container .analysis-controls-fixed .controls-row-fixed {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: nowrap !important;
                gap: 16px !important;
                align-items: flex-end !important;
                width: 100% !important;
                box-sizing: border-box !important;
                min-width: 800px !important;
                overflow-x: auto !important;
            }
            
            /* Field containers - all same structure */
            body .engineering-container .analysis-controls-fixed .field-container {
                display: flex !important;
                flex-direction: column !important;
                box-sizing: border-box !important;
            }
            
            body .engineering-container .analysis-controls-fixed .pump-search-fixed {
                flex: 1.8 !important;
                min-width: 200px !important;
                max-width: none !important;
                position: relative !important;
            }
            
            body .engineering-container .analysis-controls-fixed .input-field-fixed {
                flex: 1 !important;
                min-width: 120px !important;
                max-width: none !important;
            }
            
            body .engineering-container .analysis-controls-fixed .button-container-fixed {
                flex-shrink: 0 !important;
                flex-grow: 0 !important;
                min-width: 140px !important;
                display: flex !important;
                flex-direction: column !important;
                justify-content: flex-end !important;
            }
            
            /* Uniform label heights */
            body .engineering-container .analysis-controls-fixed .field-label {
                display: block !important;
                font-weight: 500 !important;
                font-size: 12px !important;
                color: #495057 !important;
                margin-bottom: 6px !important;
                height: 18px !important;
                line-height: 18px !important;
            }
            
            /* Uniform input heights */
            body .engineering-container .analysis-controls-fixed .field-input {
                width: 100% !important;
                padding: 10px 12px !important;
                font-size: 12px !important;
                border: 1px solid #ced4da !important;
                border-radius: 4px !important;
                background: white !important;
                box-sizing: border-box !important;
                height: 40px !important;
            }
            
            /* Uniform button height to match inputs */
            body .engineering-container .analysis-controls-fixed .field-button {
                padding: 12px 24px !important;
                background: #1976d2 !important;
                color: white !important;
                border: none !important;
                border-radius: 4px !important;
                font-size: 12px !important;
                font-weight: 500 !important;
                cursor: pointer !important;
                transition: all 0.2s !important;
                white-space: nowrap !important;
                box-shadow: 0 2px 4px rgba(25, 118, 210, 0.3) !important;
                height: 40px !important;
                box-sizing: border-box !important;
            }
            
            /* Help text with fixed height */
            body .engineering-container .analysis-controls-fixed .field-help {
                font-size: 10px !important;
                color: #6c757d !important;
                margin-top: 4px !important;
                line-height: 1.3 !important;
                height: 16px !important;
                overflow: hidden !important;
            }
        </style>
        
        <div class="analysis-controls-fixed">
            <!-- Header -->
            <div style="margin-bottom: 18px; padding-bottom: 12px; border-bottom: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-weight: 600; color: #1976d2; font-size: 14px;">Engineering Analysis Controls</span>
                    <span style="color: #6c757d; font-size: 12px; margin-left: 8px;">â€¢ Analyze any pump against your requirements</span>
                </div>
            </div>
            
            <!-- Controls Row -->
            <div class="controls-row-fixed">
                <!-- Pump Search -->
                <div class="pump-search-fixed field-container">
                    <label for="pumpSearch" class="field-label">Force Pump Selection</label>
                    <input type="text" 
                           id="pumpSearch" 
                           class="field-input"
                           placeholder="Type pump code (e.g. 10-WLN-26A)"
                           autocomplete="off">
                    <input type="hidden" id="pumpSelector" value="">
                    <div id="pumpSearchResults" style="position: absolute; top: 100%; left: 0; right: 0; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ced4da; border-radius: 4px; margin-top: 4px; display: none; z-index: 1000; box-shadow: 0 8px 16px rgba(0,0,0,0.15);">
                        <!-- Search results will appear here -->
                    </div>
                    <div class="field-help">
                        Current: <strong>{{ selected_pump.get('pump_code', 'N/A') }}</strong> | <span id="pumpCount">Loading...</span> available
                    </div>
                </div>
                
                <!-- Flow Rate -->
                <div class="input-field-fixed field-container">
                    <label for="editFlow" class="field-label">Flow Rate (mÂ³/hr)</label>
                    <input type="number" 
                           id="editFlow" 
                           class="field-input"
                           step="0.1" 
                           min="0" 
                           value="{{ site_requirements.get('flow_m3hr', 0)|round(1) }}">
                    <div class="field-help">&nbsp;</div>
                </div>
                
                <!-- Total Head -->
                <div class="input-field-fixed field-container">
                    <label for="editHead" class="field-label">Total Head (m)</label>
                    <input type="number" 
                           id="editHead" 
                           class="field-input"
                           step="0.1" 
                           min="0" 
                           value="{{ site_requirements.get('head_m', 0)|round(1) }}">
                    <div class="field-help">&nbsp;</div>
                </div>
                
                <!-- Apply Button -->
                <div class="button-container-fixed field-container">
                    <div class="field-label">&nbsp;</div>
                    <button onclick="applyChanges()" 
                            id="applyBtn"
                            class="field-button"
                            onmouseover="this.style.background='#1565c0'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(25, 118, 210, 0.4)';"
                            onmouseout="this.style.background='#1976d2'; this.style.transform='translateY(0px)'; this.style.boxShadow='0 2px 4px rgba(25, 118, 210, 0.3)';">
                        Apply Analysis
                    </button>
                    <div class="field-help">&nbsp;</div>
                </div>
            </div>
        </div>

        <!-- Performance Charts Section - Two Chart Layout -->
        <div class="chart-section">
            <div class="section-title" style="text-align: center; font-size: 12px; margin-bottom: 10px;">
                PERFORMANCE CURVES - {{ selected_pump.get('pump_code', 'N/A') }}
            </div>
            <!-- Top Chart: Head, NPSH, and Efficiency -->
            <div id="hydraulic-performance-chart" class="performance-chart" style="height: 375px; margin-bottom: 10px;"></div>
            <!-- Bottom Chart: Power -->
            <div id="power-performance-chart" class="performance-chart" style="height: 375px;"></div>
        </div>

        <!-- Data Grid - 3 Column Layout -->
        <div class="data-grid">
            <!-- Pump Details -->
            <div class="data-section">
                <div class="section-title">PUMP DETAILS (Rated Duty)</div>
                <table class="data-table">
                    <tr>
                        <td>Pump Code</td>
                        <td>{{ selected_pump.get('pump_code', 'N/A') }}</td>
                    </tr>
                    <tr>
                        <td>Rated Flow</td>
                        <td>
                            <span id="ratedFlow">{{ site_requirements.get('flow_m3hr', 0)|round(1) }}</span> mÂ³/hr
                        </td>
                    </tr>
                    <tr>
                        <td>Rated Head</td>
                        <td><span id="ratedHead">{{ site_requirements.get('head_m', 0)|round(1) }}</span> m</td>
                    </tr>
                    <tr>
                        <td>Power Absorbed</td>
                        <td>{{ selected_pump.get('power_kw', 0)|round(2) }} kW</td>
                    </tr>
                    <tr>
                        <td>Pump Efficiency</td>
                        <td>{{ selected_pump.get('efficiency_pct', 0)|round(1) }} %</td>
                    </tr>
                    <tr>
                        <td>NPSHr Required</td>
                        <td>{% if selected_pump.get('npshr_m') is not none %}{{ selected_pump.get('npshr_m')|round(2) }} m{% else %}N/A{% endif %}</td>
                    </tr>
                    <tr>
                        <td>Operating Impeller Ã˜</td>
                        <td style="font-weight: bold; color: #1976d2;">{{ selected_pump.get('impeller_diameter_mm', 0)|round(0)|int }} mm</td>
                    </tr>
                    <tr>
                        <td>Impeller Trim</td>
                        <td>{{ (100 - selected_pump.get('trim_percent', 100))|round(1) }} %</td>
                    </tr>
                    <tr>
                        <td>Max Impeller Ã˜</td>
                        <td>{{ selected_pump.get('max_impeller_mm', 0)|round(0)|int }} mm</td>
                    </tr>
                    <tr>
                        <td>Min Impeller Ã˜</td>
                        <td>{{ selected_pump.get('min_impeller_mm', 0)|round(0)|int }} mm</td>
                    </tr>
                </table>
            </div>

            <!-- System Details -->
            <div class="data-section">
                <div class="section-title">SYSTEM DETAILS</div>
                <table class="data-table">
                    <tr>
                        <td>No of Pumps</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>Required Flow</td>
                        <td>
                            {{ site_requirements.get('flow_m3hr', 0)|round(1) }} mÂ³/hr
                            {% if request.args.get('flow') %}
                                <span style="color: #ff9800; font-size: 10px;">(Modified)</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>Static Head</td>
                        <td>{{ (site_requirements.get('head_m', 0) * 0.7)|round(1) }} m</td>
                    </tr>
                    <tr>
                        <td>Friction Head</td>
                        <td>{{ (site_requirements.get('head_m', 0) * 0.3)|round(1) }} m</td>
                    </tr>
                    <tr>
                        <td>Total Head</td>
                        <td>
                            {{ site_requirements.get('head_m', 0)|round(1) }} m
                            {% if request.args.get('head') %}
                                <span style="color: #ff9800; font-size: 10px;">(Modified)</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>Total Power</td>
                        <td>{{ selected_pump.get('power_kw', 0)|round(2) }} kW</td>
                    </tr>
                    <tr>
                        <td>Specific Energy</td>
                        <td>{{ (selected_pump.get('power_kw', 0) / site_requirements.get('flow_m3hr', 1) * 1000)|round(2) }} WÂ·hr/mÂ³</td>
                    </tr>
                    <tr>
                        <td>NPSHa Available</td>
                        <td>
                            {% set npshr = selected_pump.get('npshr_m') %}
                            {% if npshr is not none %}
                                {{ (npshr * 1.5)|round(1) }} m
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>

            <!-- Liquid Details -->
            <div class="data-section">
                <div class="section-title">LIQUID DETAILS</div>
                <table class="data-table">
                    <tr>
                        <td>Name of Liquid</td>
                        <td>{{ site_requirements.get('fluid_type', 'Water') }}</td>
                    </tr>
                    <tr>
                        <td>SG/Solid</td>
                        <td>1.0</td>
                    </tr>
                    <tr>
                        <td>Vapour Pressure</td>
                        <td>0.2 kPa</td>
                    </tr>
                    <tr>
                        <td>Temperature</td>
                        <td>20 Â°C</td>
                    </tr>
                    <tr>
                        <td>pH</td>
                        <td>7</td>
                    </tr>
                </table>
            </div>

        </div>

        <!-- Second Row - BEP, Motor and Selection Metrics -->
        <div class="data-grid">
            <!-- Best Efficiency Point (BEP) -->
            <div class="data-section">
                <div class="section-title">BEP DETAILS</div>
                <table class="data-table">
                    <tr>
                        <td>BEP Flow</td>
                        <td>{{ (site_requirements.get('flow_m3hr', 0) / (selected_pump.get('qbep_percentage', 100) / 100))|round(1) }} mÂ³/hr</td>
                    </tr>
                    <tr>
                        <td>BEP Head</td>
                        <td>{{ (site_requirements.get('head_m', 0) * 1.05)|round(1) }} m</td>
                    </tr>
                    <tr>
                        <td>BEP Efficiency</td>
                        <td>{{ (selected_pump.get('efficiency_pct', 0) * 1.02)|round(1) }} %</td>
                    </tr>
                    <tr>
                        <td>QBEP %</td>
                        <td>{{ selected_pump.get('qbep_percentage', 0)|round(0)|int }} %</td>
                    </tr>
                    <tr>
                        <td>Operating Zone</td>
                        <td>
                            {% set qbep = selected_pump.get('qbep_percentage', 100) %}
                            {% if 80 <= qbep <= 110 %}
                                Preferred
                            {% elif 70 <= qbep <= 120 %}
                                Acceptable
                            {% else %}
                                Marginal
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>Pump Speed</td>
                        <td>{{ selected_pump.get('test_speed_rpm', selected_pump.get('speed_rpm', 'N/A')) }} rpm</td>
                    </tr>
                    <tr>
                        <td>No of Stages</td>
                        <td>{{ selected_pump.get('stages', 1) }}</td>
                    </tr>
                </table>
            </div>
            <!-- Electric Motor Details -->
            <div class="data-section">
                <div class="section-title">MOTOR DETAILS</div>
                <table class="data-table">
                    <tr>
                        <td>Min Power Required</td>
                        <td>{{ selected_pump.get('power_kw', 0)|round(2) }} kW</td>
                    </tr>
                    <tr>
                        <td>Motor Size</td>
                        <td>{{ (selected_pump.get('power_kw', 0) * 1.15)|round(0)|int }} kW</td>
                    </tr>
                    <tr>
                        <td>Supplier</td>
                        <td>APE PUMPS</td>
                    </tr>
                    <tr>
                        <td>Efficiency</td>
                        <td>{{ selected_pump.get('motor_efficiency', 95) }} %</td>
                    </tr>
                    <tr>
                        <td>Frame Size</td>
                        <td>{{ selected_pump.get('frame_size', 'N/A') }}</td>
                    </tr>
                    <tr>
                        <td>Min Speed</td>
                        <td>{{ selected_pump.get('min_speed_rpm', 'N/A') }} rpm</td>
                    </tr>
                    <tr>
                        <td>Max Speed</td>
                        <td>{{ selected_pump.get('max_speed_rpm', 'N/A') }} rpm</td>
                    </tr>
                </table>
            </div>

            <div class="data-section">
                <div class="section-title">SELECTION METRICS</div>
                <table class="data-table">
                    <tr>
                        <td>Overall Score</td>
                        <td>{{ selected_pump.get('suitability_score', 0)|round(1) }}/100</td>
                    </tr>
                    <tr>
                        <td>Efficiency Score</td>
                        <td>{{ selected_pump.get('efficiency_score', 0)|round(1) }}/30</td>
                    </tr>
                    <tr>
                        <td>BEP Score</td>
                        <td>{{ selected_pump.get('bep_score', 0)|round(1) }}/40</td>
                    </tr>
                    <tr>
                        <td>Selection Method</td>
                        <td>v6.0 Algorithm</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Notes Section -->
        <div class="notes-section">
            <div class="notes-title">NOTES:</div>
            <ul style="margin-left: 20px; font-size: 10px;">
                <li>Performance curves based on clean water at 20Â°C</li>

                <li>NPSHr values based on methodology: NPSHa â‰¥ 1.5 Ã— NPSHr safety factor</li>
                <li>Motor sizing includes 15% safety factor</li>
                <li><strong>Operating impeller diameter: {{ selected_pump.get('impeller_diameter_mm', 0)|round(0)|int }} mm ({{ (100 - selected_pump.get('trim_percent', 100))|round(1) }}% trim)</strong></li>
                <li>Impeller can be trimmed a maximum of 15% from the original diameter</li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="eng-footer">
            <div>Â© {{ current_date.split()[2] }} APE Pumps. This drawing is the property of APE Pumps and must not be reproduced or disclosed without permission in writing.</div>
            <div style="margin-top: 5px;">Customer Name: {{ site_requirements.get('customer_name', 'Engineering Client') }} | Quote No: {{ selected_pump.get('quote_no', 'SE1234') }} | Date: {{ current_date }}</div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-message">
            Recalculating pump performance...
        </div>
    </div>

    <script>
        // Store original values
        let currentFlow = {{ site_requirements.get('flow_m3hr', 0)|round(1) }};
        let currentHead = {{ site_requirements.get('head_m', 0)|round(1) }};
        const pumpCode = "{{ selected_pump.get('pump_code', '') }}";

        // Initialize engineering charts
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Engineering report DOM loaded');
            
            // Initialize Materialize components
            M.AutoInit();
            
            // Load pump list immediately since controls are always visible
            console.log('Loading pump list for analysis controls');
            loadPumpList();
            
            // Load and render the engineering two-chart layout
            const chartData = {
                pumpCode: pumpCode,
                flowRate: currentFlow,
                head: currentHead
            };
            
            // Use the custom engineering charts function
            loadEngineeringCharts(chartData);
        });

        // Analysis controls are now always visible, no toggle needed

        let allPumps = [];
        
        function loadPumpList() {
            console.log('Loading pump list...');
            fetch('/api/pump_list')
                .then(response => {
                    console.log('API response received:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Pump data received:', data.pumps ? data.pumps.length : 0, 'pumps');
                    
                    // Store all pumps for search
                    allPumps = data.pumps || [];
                    
                    // Update pump count
                    document.getElementById('pumpCount').textContent = allPumps.length;
                    
                    // Setup search functionality
                    setupPumpSearch();
                })
                .catch(error => {
                    console.error('Error loading pumps:', error);
                    document.getElementById('pumpCount').textContent = 'Error loading';
                });
        }

        function setupPumpSearch() {
            const searchInput = document.getElementById('pumpSearch');
            const resultsDiv = document.getElementById('pumpSearchResults');
            const hiddenSelector = document.getElementById('pumpSelector');
            
            if (!searchInput || !resultsDiv) return;
            
            // Handle search input
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase().trim();
                
                if (searchTerm.length === 0) {
                    resultsDiv.style.display = 'none';
                    hiddenSelector.value = '';
                    return;
                }
                
                // Filter pumps
                const filtered = allPumps.filter(pump => 
                    pump.pump_code.toLowerCase().includes(searchTerm)
                );
                
                // Display results
                if (filtered.length > 0) {
                    resultsDiv.innerHTML = '';
                    filtered.slice(0, 20).forEach(pump => {
                        const item = document.createElement('div');
                        item.style.cssText = 'padding: 6px 10px; cursor: pointer; font-size: 11px; border-bottom: 1px solid #eee;';
                        item.textContent = `${pump.pump_code} - ${pump.manufacturer || 'APE PUMPS'}`;
                        item.addEventListener('mouseover', () => {
                            item.style.backgroundColor = '#f0f0f0';
                        });
                        item.addEventListener('mouseout', () => {
                            item.style.backgroundColor = 'white';
                        });
                        item.addEventListener('click', () => {
                            searchInput.value = pump.pump_code;
                            hiddenSelector.value = pump.pump_code;
                            resultsDiv.style.display = 'none';
                        });
                        resultsDiv.appendChild(item);
                    });
                    
                    if (filtered.length > 20) {
                        const more = document.createElement('div');
                        more.style.cssText = 'padding: 6px 10px; font-size: 10px; color: #666; font-style: italic;';
                        more.textContent = `... and ${filtered.length - 20} more results`;
                        resultsDiv.appendChild(more);
                    }
                    
                    resultsDiv.style.display = 'block';
                } else {
                    resultsDiv.innerHTML = '<div style="padding: 6px 10px; font-size: 10px; color: #999;">No pumps found</div>';
                    resultsDiv.style.display = 'block';
                }
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
        }
        
        // Analysis controls are always visible - no cancel needed

        function applyChanges() {
            const newFlow = parseFloat(document.getElementById('editFlow').value);
            const newHead = parseFloat(document.getElementById('editHead').value);
            const pumpSelector = document.getElementById('pumpSelector');
            const selectedPumpCode = pumpSelector.value || pumpCode;
            
            // Validate inputs
            if (isNaN(newFlow) || newFlow <= 0) {
                alert('Please enter a valid flow rate greater than 0');
                return;
            }
            
            if (isNaN(newHead) || newHead <= 0) {
                alert('Please enter a valid head greater than 0');
                return;
            }
            
            // Show loading
            document.getElementById('loadingOverlay').classList.add('active');
            
            // Reload page with new parameters
            const params = new URLSearchParams({
                flow: newFlow,
                head: newHead,
                pump_type: '{{ site_requirements.get("pump_type", "GENERAL") }}'
            });
            
            // Add force parameter if a different pump was selected
            if (selectedPumpCode !== pumpCode && pumpSelector.value) {
                params.append('force', 'true');
            }
            
            window.location.href = `/engineering_report/${encodeURIComponent(selectedPumpCode)}?${params.toString()}`;
        }

        function loadEngineeringCharts(data) {
            const url = `/api/chart_data/${encodeURIComponent(data.pumpCode)}?flow=${data.flowRate}&head=${data.head}`;
            
            fetch(url)
                .then(response => response.json())
                .then(result => {
                    if (result.curves && result.curves.length > 0) {
                        renderEngineeringTwoCharts(result, data.flowRate, data.head);
                    }
                })
                .catch(error => console.error('Error loading chart data:', error));
        }

        function renderEngineeringTwoCharts(chartData, operatingFlow, operatingHead) {
            const curves = chartData.curves;
            const opPoint = chartData.operating_point || {};
            
            // Find all curves (min and max impeller diameters)
            const selectedCurve = curves.find(c => c.is_selected) || curves[curves.length - 1];
            const minCurve = curves[0]; // Assuming first curve is minimum diameter
            const maxCurve = curves[curves.length - 1]; // Assuming last curve is maximum diameter
            
            // Calculate CONSISTENT x-axis range for BOTH charts
            const allFlows = curves.flatMap(c => c.flow_data);
            // Include operating flow in range calculation
            allFlows.push(operatingFlow);
            
            const dataMin = Math.min(...allFlows);
            const dataMax = Math.max(...allFlows);
            const range = dataMax - dataMin;
            
            // Ensure range includes operating point with padding
            const minFlow = Math.max(0, Math.min(dataMin, operatingFlow) - range * 0.1);
            const maxFlow = Math.max(dataMax, operatingFlow) + range * 0.2;
            
            // CHART 1: Head and NPSH (Hydraulic Performance)
            renderHydraulicChart(curves, selectedCurve, opPoint, operatingFlow, operatingHead, minFlow, maxFlow);
            
            // CHART 2: Power and Efficiency - SAME X-AXIS RANGE
            renderPowerEfficiencyChart(curves, selectedCurve, opPoint, operatingFlow, minFlow, maxFlow);
        }
        
        function renderHydraulicChart(curves, selectedCurve, opPoint, operatingFlow, operatingHead, minFlow, maxFlow) {
            const traces = [];
            
            // Add Head curves for all impeller sizes
            curves.forEach((curve, index) => {
                traces.push({
                    x: curve.flow_data,
                    y: curve.head_data,
                    name: `Head ${curve.impeller_diameter_mm}mm`,
                    type: 'scatter',
                    mode: 'lines',
                    line: { 
                        color: curve.is_selected ? '#1976d2' : '#90caf9', 
                        width: curve.is_selected ? 3 : 2
                    },
                    showlegend: curve.is_selected || index === 0 || index === curves.length - 1
                });
            });
            
            // Add NPSH curve (only for selected/trimmed impeller)
            if (selectedCurve.npshr_data && selectedCurve.npshr_data.length > 0) {
                traces.push({
                    x: selectedCurve.flow_data,
                    y: selectedCurve.npshr_data,
                    name: 'NPSHr',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#00acc1', width: 2, dash: 'dash' }
                });
            }
            
            // Add duty point vertical line (flow)
            traces.push({
                x: [operatingFlow, operatingFlow],
                y: [0, Math.max(...curves.flatMap(c => c.head_data)) * 1.1],
                type: 'scatter',
                mode: 'lines',
                line: { color: '#d32f2f', width: 2, dash: 'dot' },
                showlegend: false,
                hoverinfo: 'skip',
                yaxis: 'y'
            });
            
            // Add duty point horizontal line (head)
            traces.push({
                x: [minFlow, maxFlow],
                y: [operatingHead, operatingHead],
                type: 'scatter',
                mode: 'lines',
                line: { color: '#d32f2f', width: 2, dash: 'dot' },
                showlegend: false,
                hoverinfo: 'skip',
                yaxis: 'y'
            });
            
            // Add system resistance curve (parabolic curve from static head)
            // System curve follows: H = H_static + k*Q^2 where k is resistance coefficient
            const staticHead = operatingHead * 0.5; // Estimate static head as portion of total
            const dynamicHead = operatingHead - staticHead;
            const k = dynamicHead / (operatingFlow * operatingFlow); // Resistance coefficient
            
            const systemCurveX = [];
            const systemCurveY = [];
            for (let i = 0; i <= 20; i++) {
                const flow = (maxFlow / 20) * i;
                const head = staticHead + k * flow * flow;
                systemCurveX.push(flow);
                systemCurveY.push(head);
            }
            
            traces.push({
                x: systemCurveX,
                y: systemCurveY,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#000000', width: 2 },
                name: 'System Curve',
                showlegend: true,
                yaxis: 'y'
            });
            
            // Add small red dot at actual operating point
            traces.push({
                x: [operatingFlow],
                y: [operatingHead],
                name: 'Operating Point',
                type: 'scatter',
                mode: 'markers',
                marker: { 
                    size: 8,  // Small dot
                    color: 'rgba(255, 0, 0, 0.8)',  // Solid red
                    symbol: 'circle'
                },
                yaxis: 'y',
                showlegend: false,
                hovertemplate: 
                    '<b>ðŸŽ¯ OPERATING POINT ANALYSIS</b><br>' +
                    'Flow Rate: ' + operatingFlow.toFixed(1) + ' mÂ³/hr<br>' +
                    'Head: ' + operatingHead.toFixed(1) + ' m<br>' +
                    'Efficiency: {{ (selected_pump.get("efficiency_pct") or 0)|round(1) }}%<br>' +
                    'Power: {{ (selected_pump.get("power_kw") or 0)|round(1) }} kW<br>' +
                    'NPSH Required: {{ (selected_pump.get("npshr_m") or 0)|round(1) }} m<br>' +
                    'Impeller: {{ (selected_pump.get("impeller_diameter_mm") or 0)|round(0)|int }}mm ({{ (100 - (selected_pump.get("trim_percent") or 100))|round(1) }}% trim)<br>' +
                    'BEP Position: {{ (selected_pump.get("qbep_percentage") or 0)|round(0) }}% of optimal flow<br>' +
                    '<extra></extra>'
            });
            
            const layout = {
                xaxis: {
                    title: 'Flow (mÂ³/hr)',
                    gridcolor: '#e0e0e0',
                    range: [minFlow, maxFlow],
                    showgrid: true,
                    zeroline: true
                },
                yaxis: {
                    title: 'Head (m) / NPSHr (m)',
                    gridcolor: '#e0e0e0',
                    side: 'left'
                },
                showlegend: true,
                legend: {
                    x: 0.5,
                    y: 1.1,
                    orientation: 'h',
                    xanchor: 'center',
                    font: { size: 10 }
                },
                margin: { t: 50, b: 60, l: 70, r: 70 },
                height: 375,
                paper_bgcolor: 'white',
                plot_bgcolor: 'white'
            };
            
            Plotly.newPlot('hydraulic-performance-chart', traces, layout, {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
                responsive: true
            });
        }
        
        function renderPowerEfficiencyChart(curves, selectedCurve, opPoint, operatingFlow, minFlow, maxFlow) {
            const traces = [];
            
            // Add Power curves for all impeller sizes
            curves.forEach((curve, index) => {
                if (curve.power_data && curve.power_data.length > 0) {
                    traces.push({
                        x: curve.flow_data,
                        y: curve.power_data,
                        name: `Power ${curve.impeller_diameter_mm}mm`,
                        type: 'scatter',
                        mode: 'lines',
                        line: { 
                            color: curve.is_selected ? '#ff6f00' : '#ffb74d', 
                            width: curve.is_selected ? 3 : 2
                        },
                        yaxis: 'y',
                        showlegend: curve.is_selected || index === 0 || index === curves.length - 1
                    });
                }
            });
            
            // Add Efficiency curves for all impeller sizes
            curves.forEach((curve, index) => {
                if (curve.efficiency_data && curve.efficiency_data.length > 0) {
                    traces.push({
                        x: curve.flow_data,
                        y: curve.efficiency_data,
                        name: `Eff ${curve.impeller_diameter_mm}mm`,
                        type: 'scatter',
                        mode: 'lines',
                        line: { 
                            color: curve.is_selected ? '#4caf50' : '#a5d6a7', 
                            width: curve.is_selected ? 3 : 2,
                            dash: 'dot'
                        },
                        yaxis: 'y2',
                        showlegend: curve.is_selected || index === 0 || index === curves.length - 1
                    });
                }
            });
            
            // Add duty point vertical line
            traces.push({
                x: [operatingFlow, operatingFlow],
                y: [0, Math.max(...curves.flatMap(c => c.power_data || [])) * 1.1],
                type: 'scatter',
                mode: 'lines',
                line: { color: '#d32f2f', width: 2, dash: 'dot' },
                showlegend: false,
                hoverinfo: 'skip'
            });
            
            // Add duty point horizontal line (power) if we have operating power
            if (opPoint.power_kw) {
                traces.push({
                    x: [minFlow, maxFlow],
                    y: [opPoint.power_kw, opPoint.power_kw],
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#d32f2f', width: 2, dash: 'dot' },
                    showlegend: false,
                    hoverinfo: 'skip'
                });
            }
            
            // Add small red dot at actual operating power
            if (opPoint.power_kw) {
                traces.push({
                    x: [operatingFlow],
                    y: [opPoint.power_kw],
                    name: 'Operating Power',
                    type: 'scatter',
                    mode: 'markers',
                    marker: { 
                        size: 8,  // Small dot
                        color: 'rgba(255, 0, 0, 0.8)',  // Solid red
                        symbol: 'circle'
                    },
                    showlegend: false,
                    hovertemplate: 
                        '<b>ðŸŽ¯ OPERATING POINT ANALYSIS</b><br>' +
                        'Flow Rate: ' + operatingFlow.toFixed(1) + ' mÂ³/hr<br>' +
                        'Power: ' + opPoint.power_kw.toFixed(1) + ' kW<br>' +
                        'Efficiency: {{ (selected_pump.get("efficiency_pct") or 0)|round(1) }}%<br>' +
                        'Head: {{ (selected_pump.get("head_m") or 0)|round(1) }} m<br>' +
                        'NPSH Required: {{ (selected_pump.get("npshr_m") or 0)|round(1) }} m<br>' +
                        'Impeller: {{ (selected_pump.get("impeller_diameter_mm") or 0)|round(0)|int }}mm ({{ (100 - (selected_pump.get("trim_percent") or 100))|round(1) }}% trim)<br>' +
                        'BEP Position: {{ (selected_pump.get("qbep_percentage") or 0)|round(0) }}% of optimal flow<br>' +
                        '<extra></extra>'
                });
            }
            
            const layout = {
                xaxis: {
                    title: 'Flow (mÂ³/hr)',
                    gridcolor: '#e0e0e0',
                    range: [minFlow, maxFlow],
                    showgrid: true,
                    zeroline: true
                },
                yaxis: {
                    title: 'Power (kW)',
                    gridcolor: '#e0e0e0',
                    side: 'left'
                },
                yaxis2: {
                    title: 'Efficiency (%)',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: '#e0e0e0',
                    showgrid: false,
                    range: [0, 100]
                },
                showlegend: true,
                legend: {
                    x: 0.5,
                    y: 1.1,
                    orientation: 'h',
                    xanchor: 'center',
                    font: { size: 10 }
                },
                margin: { t: 50, b: 60, l: 70, r: 70 },
                height: 375,
                paper_bgcolor: 'white',
                plot_bgcolor: 'white'
            };
            
            Plotly.newPlot('power-performance-chart', traces, layout, {
                displayModeBar: true,
                displaylogo: false,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d'],
                responsive: true
            });
        }
    </script>
    
{% endblock %}
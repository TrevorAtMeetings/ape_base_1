{% extends "base.html" %}

{% block title %}Pump Selection - APE Pumps{% endblock %}

{% block head %}
<!-- Google Material Icons (via CDN) -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
/* Home page specific styling - override base template container spacing */
.container {
    margin-top: 0 !important;
    max-width: 1200px;
}

/* Card styling */
.card {
    margin: 0.5rem 0 1rem 0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Material Design variables */
:root {
    --md-primary: #1976d2;
    --md-surface-variant: #f5f5f5;
    --md-outline-variant: #e0e0e0;
    --text-secondary: #666;
}

/* Tabbed Interface Styling */
.tabs {
    background-color: transparent;
    box-shadow: none;
    margin-bottom: 0;
    border-bottom: 1px solid #e0e0e0;
}

.tabs .tab {
    text-transform: none;
    font-weight: 500;
    line-height: 48px;
}

.tabs .tab a {
    color: var(--md-primary) !important;
    font-size: 15px;
    padding: 0 24px;
    transition: all 0.3s ease;
}

.tabs .tab a:hover {
    background-color: rgba(25, 118, 210, 0.08);
    color: var(--md-primary) !important;
}

.tabs .tab a.active {
    color: var(--md-primary) !important;
    font-weight: 600;
}

.tabs .indicator {
    background-color: var(--md-primary);
    height: 3px;
}

.tab-content {
    padding: 24px;
    min-height: 400px;
}

/* Form styling */
.input-field {
    margin-bottom: 24px !important;
    position: relative;
}

.input-field label {
    font-size: 14px !important;
    color: #666 !important;
}

.input-field label.active {
    font-size: 12px !important;
    color: var(--md-primary) !important;
}

.input-field input:focus + label {
    color: var(--md-primary) !important;
}

.input-field input:focus {
    border-bottom: 2px solid var(--md-primary) !important;
    box-shadow: 0 1px 0 0 var(--md-primary) !important;
}

.helper-text {
    font-size: 12px !important;
    line-height: 1.4 !important;
    margin-top: 6px !important;
    display: block !important;
    color: #666 !important;
}

/* Radio group styling */
.radio-group {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-top: 12px;
}

.radio-group label {
    font-size: 14px !important;
    color: #333 !important;
    cursor: pointer !important;
}

/* Form labels */
.form-label {
    display: block !important;
    margin-bottom: 12px !important;
    font-weight: 600 !important;
    color: var(--md-primary) !important;
    font-size: 14px !important;
}

/* Button styling */
.btn-large {
    height: 48px;
    line-height: 48px;
    font-size: 16px;
    padding: 0 32px;
    border-radius: 8px;
}

.btn {
    border-radius: 6px;
    text-transform: none;
    font-weight: 500;
}

/* Autocomplete styling */
.autocomplete-container {
    position: relative;
    z-index: 100;
}

.enhanced-autocomplete {
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px 16px;
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
}

.enhanced-autocomplete:focus {
    border-color: var(--md-primary) !important;
    box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    outline: none;
}

.autocomplete-dropdown {
    position: absolute !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    z-index: 9999 !important;
    margin-top: 2px;
    border: 2px solid var(--md-primary);
    border-radius: 8px;
    background: white;
    max-height: 300px;
    overflow-y: auto;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Responsive improvements */
@media (max-width: 768px) {
    .container {
        padding: 0 16px;
    }
    
    .tab-content {
        padding: 16px !important;
    }
    
    .tabs .tab a {
        font-size: 13px;
        padding: 0 12px;
    }
    
    .tabs .tab a i.material-icons {
        display: none;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container" style="margin-top: 80px; padding: 0 20px;">
    <!-- Simplified Header -->
    <div class="row">
        <div class="col s12">
            <h4 style="color: var(--md-primary); text-align: center; margin-bottom: 8px;">
                <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">engineering</i>
                Pump Selection Center
            </h4>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 30px;">
                Choose your preferred selection method below
            </p>
        </div>
    </div>

    <!-- Main Tabbed Interface Card -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <!-- Tab Navigation -->
                <div class="card-tabs">
                    <ul class="tabs tabs-fixed-width">
                        <li class="tab">
                            <a href="#intelligent-tab" class="active">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 8px; font-size: 18px;">psychology</i>
                                Intelligent Selection
                            </a>
                        </li>
                        <li class="tab">
                            <a href="#bep-tab">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 8px; font-size: 18px;">trending_up</i>
                                BEP Proximity Search
                            </a>
                        </li>
                        <li class="tab">
                            <a href="#direct-tab">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 8px; font-size: 18px;">search</i>
                                Direct Search
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Tab Content -->
                <div class="card-content tab-content">
                    <!-- Tab 1: Intelligent Selection -->
                    <div id="intelligent-tab">
                        <form id="intelligentSelectionForm" 
                              action="{{ url_for('main_flow.pump_selection') }}" 
                              method="POST">
                            
                            <h5 style="color: var(--md-primary); margin-bottom: 20px;">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">settings</i>
                                Full-Featured Pump Selection
                            </h5>
                            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                                Our intelligent algorithm analyzes all parameters to find the optimal pump for your specific application.
                            </p>

                            <!-- Unit System Selection -->
                            <div class="row">
                                <div class="col s12">
                                    <label class="form-label">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">straighten</i>
                                        Unit System
                                    </label>
                                    <div class="radio-group">
                                        <label>
                                            <input name="unit_system" type="radio" value="metric" checked onchange="switchUnitSystem('metric')" />
                                            <span>Metric (m³/hr, m)</span>
                                        </label>
                                        <label>
                                            <input name="unit_system" type="radio" value="imperial" onchange="switchUnitSystem('imperial')" />
                                            <span>Imperial (GPM, ft)</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Flow and Head Inputs -->
                            <div class="row">
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">water</i>
                                        <input id="flow_rate" name="flow_rate" type="number" step="0.01" min="0.1" required>
                                        <label for="flow_rate">Flow Rate <span id="flow_unit">(m³/hr)</span> *</label>
                                        <span class="helper-text">Required flow rate for your application</span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">height</i>
                                        <input id="total_head" name="total_head" type="number" step="0.01" min="0.1" required>
                                        <label for="total_head">Total Head <span id="head_unit">(m)</span> *</label>
                                        <span class="helper-text">Total dynamic head including static and friction losses</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Pump Type Selection -->
                            <div class="row">
                                <div class="col s12">
                                    <label class="form-label">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">build</i>
                                        Pump Type (Optional)
                                    </label>
                                    <div class="radio-group">
                                        <label>
                                            <input name="pump_type" type="radio" value="GENERAL" checked />
                                            <span>All Types</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="HSC" />
                                            <span>HSC</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="END SUCTION" />
                                            <span>End Suction</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="MULTI-STAGE" />
                                            <span>Multi-Stage</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="VERTICAL TURBINE" />
                                            <span>Vertical Turbine</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Advanced Options (Collapsed) -->
                            <div class="row">
                                <div class="col s12">
                                    <div class="collapsible-header" style="display: flex; align-items: center; justify-content: space-between; padding: 12px 0; cursor: pointer; border-top: 1px solid #e0e0e0; margin-top: 20px;" onclick="toggleAdvancedOptions()">
                                        <span style="color: var(--md-primary); font-weight: 500;">
                                            <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">tune</i>
                                            Advanced Options
                                        </span>
                                        <i class="material-icons" id="advanced-arrow" style="color: var(--md-primary); transition: transform 0.3s;">expand_more</i>
                                    </div>
                                    <div id="advanced-options-content" style="display: none; padding-top: 20px;">
                                        <!-- Application Context -->
                                        <label class="form-label">Application Context</label>
                                        <div class="radio-group" style="margin-bottom: 20px;">
                                            <label>
                                                <input name="application" type="radio" value="water" checked />
                                                <span>Water Supply</span>
                                            </label>
                                            <label>
                                                <input name="application" type="radio" value="industrial" />
                                                <span>Industrial</span>
                                            </label>
                                            <label>
                                                <input name="application" type="radio" value="cooling" />
                                                <span>Cooling</span>
                                            </label>
                                            <label>
                                                <input name="application" type="radio" value="fire_protection" />
                                                <span>Fire Protection</span>
                                            </label>
                                        </div>

                                        <!-- Variable Flow Options -->
                                        <label class="form-label">Flow Characteristics</label>
                                        <div class="radio-group">
                                            <label>
                                                <input name="variable_flow" type="radio" value="no" checked />
                                                <span>Fixed Flow Rate</span>
                                            </label>
                                            <label>
                                                <input name="variable_flow" type="radio" value="yes" />
                                                <span>Variable Flow Required</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden fields for compatibility -->
                            <input name="contact_name" type="hidden" value="">
                            <input name="company" type="hidden" value="">
                            <input name="email" type="hidden" value="">
                            <input name="project_name" type="hidden" value="">
                            <input name="liquid_type" type="hidden" value="water">
                            <input name="temperature" type="hidden" value="20">
                            <input name="specific_gravity" type="hidden" value="1.0">
                            <input name="viscosity" type="hidden" value="1.0">
                            <input name="npsh_available" type="hidden" value="">
                            <input name="motor_speed" type="hidden" value="2960">

                            <!-- Submit Button -->
                            <div class="row" style="margin-top: 30px;">
                                <div class="col s12" style="text-align: center;">
                                    <button type="submit" class="btn-large waves-effect waves-light" style="background: linear-gradient(135deg, #2196f3 0%, #21cbf3 100%); border: none;">
                                        <i class="material-icons left">search</i>
                                        Find Best Pumps
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Tab 2: BEP Proximity Search -->
                    <div id="bep-tab" style="display: none;">
                        <form id="bepProximityForm" 
                              action="{{ url_for('main_flow.bep_proximity_results') }}" 
                              method="GET">
                            
                            <h5 style="color: var(--md-primary); margin-bottom: 20px;">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">trending_up</i>
                                BEP Proximity Search
                            </h5>
                            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                                Find pumps with Best Efficiency Points (BEP) closest to your operating requirements. 
                                This method identifies pumps that will operate most efficiently at your specified conditions.
                            </p>

                            <!-- Info Card -->
                            <div class="card-panel" style="background: #e3f2fd; border-left: 4px solid var(--md-primary); margin-bottom: 24px;">
                                <p style="margin: 0; color: #1565c0;">
                                    <i class="material-icons" style="vertical-align: middle; margin-right: 8px; font-size: 20px;">info</i>
                                    <strong>What is BEP?</strong> The Best Efficiency Point is where a pump operates at maximum efficiency. 
                                    Running pumps near their BEP reduces energy costs and extends equipment life.
                                </p>
                            </div>

                            <!-- Simple Flow and Head Inputs -->
                            <div class="row">
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">water</i>
                                        <input id="bep_flow_rate" name="flow" type="number" step="0.01" min="0.1" required>
                                        <label for="bep_flow_rate">Flow Rate (m³/hr) *</label>
                                        <span class="helper-text">Target flow rate</span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">height</i>
                                        <input id="bep_total_head" name="head" type="number" step="0.01" min="0.1" required>
                                        <label for="bep_total_head">Total Head (m) *</label>
                                        <span class="helper-text">Target head</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Optional Pump Type Filter -->
                            <div class="row">
                                <div class="col s12">
                                    <label class="form-label">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">filter_list</i>
                                        Filter by Pump Type (Optional)
                                    </label>
                                    <div class="radio-group">
                                        <label>
                                            <input name="pump_type" type="radio" value="" checked />
                                            <span>All Types</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="HSC" />
                                            <span>HSC</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="END SUCTION" />
                                            <span>End Suction</span>
                                        </label>
                                        <label>
                                            <input name="pump_type" type="radio" value="MULTI-STAGE" />
                                            <span>Multi-Stage</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Button -->
                            <div class="row" style="margin-top: 30px;">
                                <div class="col s12" style="text-align: center;">
                                    <button type="submit" class="btn-large waves-effect waves-light" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%); border: none;">
                                        <i class="material-icons left">trending_up</i>
                                        Find BEP Matches
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <!-- Tab 3: Direct Search -->
                    <div id="direct-tab" style="display: none;">
                        <form id="directSearchForm" 
                              action="{{ url_for('main_flow.pump_selection') }}" 
                              method="POST">
                            
                            <h5 style="color: var(--md-primary); margin-bottom: 20px;">
                                <i class="material-icons" style="vertical-align: middle; margin-right: 8px;">search</i>
                                Direct Pump Search
                            </h5>
                            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                                Analyze a specific pump model at your operating conditions. 
                                Enter the pump code and your flow/head requirements to see detailed performance analysis.
                            </p>

                            <!-- Pump Code Input with Autocomplete -->
                            <div class="row">
                                <div class="col s12">
                                    <div class="autocomplete-container">
                                        <label class="form-label">
                                            <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">qr_code</i>
                                            Pump Model Code *
                                        </label>
                                        <input type="text" 
                                               id="direct_pump_code" 
                                               name="direct_pump_search" 
                                               class="enhanced-autocomplete" 
                                               placeholder="e.g., 6/8 ALE, 10 WLN 26A" 
                                               required
                                               autocomplete="off">
                                        <span class="helper-text">Start typing to see available pump models</span>
                                        
                                        <!-- Autocomplete dropdown -->
                                        <div id="direct_pump_suggestions" class="autocomplete-dropdown" style="display: none;">
                                            <div class="suggestions-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Flow and Head Inputs -->
                            <div class="row">
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">water</i>
                                        <input id="direct_flow_rate" name="flow_rate" type="number" step="0.01" min="0.1" required>
                                        <label for="direct_flow_rate">Flow Rate (m³/hr) *</label>
                                        <span class="helper-text">Operating flow rate</span>
                                    </div>
                                </div>
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <i class="material-icons prefix">height</i>
                                        <input id="direct_total_head" name="total_head" type="number" step="0.01" min="0.1" required>
                                        <label for="direct_total_head">Total Head (m) *</label>
                                        <span class="helper-text">Operating head</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Hidden fields for compatibility -->
                            <input name="unit_system" type="hidden" value="metric">
                            <input name="pump_type" type="hidden" value="GENERAL">
                            <input name="application" type="hidden" value="water">
                            <input name="liquid_type" type="hidden" value="water">
                            <input name="temperature" type="hidden" value="20">
                            <input name="specific_gravity" type="hidden" value="1.0">
                            <input name="viscosity" type="hidden" value="1.0">

                            <!-- Submit Button -->
                            <div class="row" style="margin-top: 30px;">
                                <div class="col s12" style="text-align: center;">
                                    <button type="submit" class="btn-large waves-effect waves-light" style="background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%); border: none;">
                                        <i class="material-icons left">analytics</i>
                                        Analyze Pump
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize tabs and form components
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Materialize tabs
    var tabsElems = document.querySelectorAll('.tabs');
    M.Tabs.init(tabsElems, {
        onShow: function(tab) {
            // Hide all tab panes
            document.querySelectorAll('.tab-content > div').forEach(function(pane) {
                pane.style.display = 'none';
            });
            // Show the selected tab pane
            var selectedTab = tab.getAttribute('href').substring(1);
            document.getElementById(selectedTab).style.display = 'block';
        }
    });

    // Initialize form labels
    updateActiveLabels();
    
    // Setup autocomplete for direct search
    setupDirectSearchAutocomplete();
});

// Update active labels for pre-filled inputs
function updateActiveLabels() {
    document.querySelectorAll('input[type="number"], input[type="text"]').forEach(function(input) {
        if (input.value) {
            var label = input.parentElement.querySelector('label');
            if (label) {
                label.classList.add('active');
            }
        }
    });
}

// Toggle advanced options
function toggleAdvancedOptions() {
    var content = document.getElementById('advanced-options-content');
    var arrow = document.getElementById('advanced-arrow');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.style.transform = 'rotate(180deg)';
    } else {
        content.style.display = 'none';
        arrow.style.transform = 'rotate(0deg)';
    }
}

// Switch unit system
function switchUnitSystem(system) {
    var flowUnit = document.getElementById('flow_unit');
    var headUnit = document.getElementById('head_unit');
    var flowInput = document.getElementById('flow_rate');
    var headInput = document.getElementById('total_head');
    
    if (system === 'imperial') {
        if (flowUnit) flowUnit.textContent = '(GPM)';
        if (headUnit) headUnit.textContent = '(ft)';
        
        // Convert existing values if present
        if (flowInput && flowInput.value) {
            var m3hr = parseFloat(flowInput.value);
            flowInput.value = (m3hr * 4.40287).toFixed(2); // m³/hr to GPM
        }
        if (headInput && headInput.value) {
            var meters = parseFloat(headInput.value);
            headInput.value = (meters * 3.28084).toFixed(2); // m to ft
        }
    } else {
        if (flowUnit) flowUnit.textContent = '(m³/hr)';
        if (headUnit) headUnit.textContent = '(m)';
        
        // Convert back to metric if needed
        if (flowInput && flowInput.value) {
            var gpm = parseFloat(flowInput.value);
            flowInput.value = (gpm * 0.227124).toFixed(2); // GPM to m³/hr
        }
        if (headInput && headInput.value) {
            var feet = parseFloat(headInput.value);
            headInput.value = (feet * 0.3048).toFixed(2); // ft to m
        }
    }
    
    updateActiveLabels();
}

// Setup autocomplete for direct pump search
function setupDirectSearchAutocomplete() {
    var input = document.getElementById('direct_pump_code');
    var dropdown = document.getElementById('direct_pump_suggestions');
    var suggestionsList = dropdown.querySelector('.suggestions-list');
    var searchTimeout;
    
    if (!input || !dropdown) return;
    
    // Handle input events
    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        var query = this.value.trim();
        
        if (query.length < 2) {
            dropdown.style.display = 'none';
            return;
        }
        
        // Debounce search
        searchTimeout = setTimeout(function() {
            searchPumps(query);
        }, 300);
    });
    
    // Search pumps function
    function searchPumps(query) {
        fetch('/api/pump_autocomplete?q=' + encodeURIComponent(query))
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                if (data.pumps && data.pumps.length > 0) {
                    displaySuggestions(data.pumps);
                } else {
                    suggestionsList.innerHTML = '<div style="padding: 12px; color: #666;">No pumps found</div>';
                    dropdown.style.display = 'block';
                }
            })
            .catch(function(error) {
                console.error('Search error:', error);
                dropdown.style.display = 'none';
            });
    }
    
    // Display suggestions
    function displaySuggestions(pumps) {
        suggestionsList.innerHTML = '';
        
        pumps.forEach(function(pump) {
            var item = document.createElement('div');
            item.className = 'suggestion-item';
            item.style.cssText = 'padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0;';
            item.innerHTML = '<strong>' + pump.pump_code + '</strong> - ' + pump.pump_type;
            
            item.addEventListener('click', function() {
                input.value = pump.pump_code;
                dropdown.style.display = 'none';
                updateActiveLabels();
            });
            
            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = 'rgba(25, 118, 210, 0.08)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'transparent';
            });
            
            suggestionsList.appendChild(item);
        });
        
        dropdown.style.display = 'block';
    }
    
    // Hide dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!input.contains(event.target) && !dropdown.contains(event.target)) {
            dropdown.style.display = 'none';
        }
    });
    
    // Handle escape key
    input.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            dropdown.style.display = 'none';
        }
    });
}

// Form validation
document.querySelectorAll('form').forEach(function(form) {
    form.addEventListener('submit', function(event) {
        var isValid = true;
        
        // Check required fields
        this.querySelectorAll('[required]').forEach(function(field) {
            if (!field.value || field.value.trim() === '') {
                isValid = false;
                field.style.borderColor = '#f44336';
                
                // Add error message if not exists
                if (!field.nextElementSibling || !field.nextElementSibling.classList.contains('error-text')) {
                    var errorText = document.createElement('span');
                    errorText.className = 'error-text';
                    errorText.style.color = '#f44336';
                    errorText.style.fontSize = '12px';
                    errorText.textContent = 'This field is required';
                    field.parentElement.appendChild(errorText);
                }
            } else {
                field.style.borderColor = '';
                
                // Remove error message if exists
                var errorText = field.parentElement.querySelector('.error-text');
                if (errorText) {
                    errorText.remove();
                }
            }
        });
        
        if (!isValid) {
            event.preventDefault();
            M.toast({html: 'Please fill in all required fields', classes: 'red'});
        }
    });
});
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Pump Selection - APE Pumps{% endblock %}

{% block content %}
<div class="container" style="margin-top: 30px;">
    <!-- Header Section -->
    <div class="row stagger-item">
        <div class="col s12">
            <div class="card-panel fade-in-up" style="background: var(--md-surface-variant); border: 1px solid var(--md-outline-variant);">
                <h4 style="color: var(--md-primary);">
                    <i class="material-icons left">engineering</i>
                    AI-Powered Pump Selection Tool
                </h4>
                <p class="flow-text">
                    Enter your pump requirements below and our intelligent selection algorithm 
                    will recommend the best pump options for your application.
                </p>


            </div>
        </div>
    </div>

    <!-- Main Form -->
    <form id="pumpSelectionForm" 
      action="{{ url_for('main_flow.pump_selection') }}" 
      method="POST" 
      class="needs-validation" 
      novalidate>
        <!-- Core Requirements Section -->
        <div class="row section-card stagger-item" id="core-requirements-section">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <span class="card-title" style="color: var(--md-primary); margin: 0;">
                                <i class="material-icons left">speed</i>
                                Core Requirements
                                <span class="new badge red" data-badge-caption="Required" style="margin-left: 10px;"></span>
                            </span>
                            <i class="material-icons tooltipped" data-position="left" data-tooltip="Flow Rate and Head are the fundamental parameters that define your pumping system. These values determine pump selection, sizing calculations, and performance verification." style="color: var(--md-primary); cursor: help;">help_outline</i>
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 24px;">
                            <strong>Essential pump specifications</strong> - These parameters define your pumping system's operational requirements and directly influence pump selection, sizing, and performance analysis.
                        </p>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">water_drop</i>
                                    <input id="flow_rate" name="flow_m3hr" type="number" step="0.01" min="0.1" max="10000" required class="validate">
                                    <label for="flow_rate">Flow Rate (m³/hr) *</label>
                                    <span class="helper-text" data-error="Flow rate must be between 0.1 and 10000 m³/hr">Required volumetric flow rate - precise to 0.01 m³/hr</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">height</i>
                                    <input id="total_head" name="head_m" type="number" step="0.01" min="0.1" max="1000" required class="validate">
                                    <label for="total_head">Total Head (m) *</label>
                                    <span class="helper-text" data-error="Total head must be between 0.1 and 1000 m">Total dynamic head including friction and static losses</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">category</i>
                                        Preferred Pump Type
                                    </label>
                                    <div class="radio-group">
                                        <p>
                                            <label>
                                                <input name="pump_type" type="radio" value="GENERAL" checked />
                                                <span>General - All Types</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="pump_type" type="radio" value="END SUCTION" />
                                                <span>End Suction - Single Stage Centrifugal</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="pump_type" type="radio" value="HSC" />
                                                <span>HSC - Horizontal Split Case</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="pump_type" type="radio" value="AXIAL FLOW" />
                                                <span>Axial Flow Pump</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="pump_type" type="radio" value="VERTICAL TURBINE" />
                                                <span>Vertical Turbine Pump</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="pump_type" type="radio" value="MULTI-STAGE" />
                                                <span>Multistage Centrifugal</span>
                                            </label>
                                        </p>
                                    </div>
                                    <span class="helper-text">Select specific pump configuration or 'General' for all options</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">business</i>
                                        Application Type
                                    </label>
                                    <div class="radio-group">
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="water" checked />
                                                <span>Water Supply</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="industrial" />
                                                <span>Industrial Process</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="cooling" />
                                                <span>Cooling Water</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="boiler_feed" />
                                                <span>Boiler Feed</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="fire_protection" />
                                                <span>Fire Protection</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="irrigation" />
                                                <span>Irrigation</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="application" type="radio" value="general" />
                                                <span>General Service</span>
                                            </label>
                                        </p>
                                    </div>
                                    <span class="helper-text">Application context affects pump selection criteria</span>
                                </div>
                            </div>
                        </div>

                        <!-- Variable Flow Requirements -->
                        <div class="row">
                            <div class="col s12">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">tune</i>
                                        Variable Flow Requirements
                                    </label>
                                    <div class="radio-group">
                                        <p>
                                            <label>
                                                <input name="variable_flow" type="radio" value="no" checked />
                                                <span>Fixed Flow Rate</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="variable_flow" type="radio" value="yes" />
                                                <span>Variable Flow Required</span>
                                            </label>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Direct Pump Search Section -->
                        <div class="row">
                            <div class="col s12">
                                <div class="input-group" style="position: relative;">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">search</i>
                                        Direct Pump Selection (Optional)
                                    </label>
                                    <div class="input-field col s12">
                                        <input type="text" id="direct_pump_search" name="direct_pump_search" class="autocomplete" autocomplete="off">
                                        <label for="direct_pump_search">Direct Pump Selection (Optional)</label>
                                        <span class="helper-text">Search for a specific pump model (e.g., 6/8 ALE, 10 WLN 26A)</span>
                                    </div>
                                    <div id="pump_search_suggestions" style="display: none; position: absolute; z-index: 1000; width: 100%; margin-top: -10px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 8px 8px; background: white; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                        <!-- Search suggestions will appear here -->
                                    </div>
                                    <div id="pump_search_results" style="display: none; margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                                        <p style="margin: 0; color: #666; font-size: 14px;">
                                            <i class="material-icons tiny">info</i>
                                            When you enter a pump model above, the system will show that specific pump's performance at your specified flow and head values, regardless of whether it's optimal for your requirements.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" id="flow-range-section" style="display: none;">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">trending_down</i>
                                    <input id="min_flow_rate" name="min_flow_rate" type="number" step="0.01" min="0.1">
                                    <label for="min_flow_rate">Minimum Flow Rate (m³/hr)</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">trending_up</i>
                                    <input id="max_flow_rate" name="max_flow_rate" type="number" step="0.01" min="0.1">
                                    <label for="max_flow_rate">Maximum Flow Rate (m³/hr)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Information Section -->
        <div class="row section-card stagger-item" id="contact-section">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title" style="color: var(--md-primary);">
                            <i class="material-icons left">person</i>
                            Contact Information
                        </span>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">person</i>
                                    <input id="contact_name" name="contact_name" type="text">
                                    <label for="contact_name">Contact Name</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">business</i>
                                    <input id="company" name="company" type="text">
                                    <label for="company">Company</label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">email</i>
                                    <input id="email" name="email" type="email">
                                    <label for="email">Email Address</label>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">work</i>
                                    <input id="project_name" name="project_name" type="text">
                                    <label for="project_name">Project Name</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Section -->
        <div class="row section-card stagger-item" id="application-section">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title" style="color: var(--md-primary);">
                            <i class="material-icons left">location_on</i>
                            Location
                        </span>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">location_on</i>
                                    <input id="project_location" name="project_location" type="text">
                                    <label for="project_location">Project Location</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liquid Properties Section -->
        <div class="row section-card" id="liquid-section">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title" style="color: var(--md-primary);">
                            <i class="material-icons left">science</i>
                            Liquid Properties
                        </span>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">science</i>
                                        Liquid Type
                                    </label>
                                    <div class="radio-group">
                                        <p>
                                            <label>
                                                <input name="liquid_type" type="radio" value="water" checked />
                                                <span>Water</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="liquid_type" type="radio" value="seawater" />
                                                <span>Seawater</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="liquid_type" type="radio" value="oil" />
                                                <span>Oil</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="liquid_type" type="radio" value="chemical" />
                                                <span>Chemical</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="liquid_type" type="radio" value="other" />
                                                <span>Other</span>
                                            </label>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">thermostat</i>
                                    <input id="temperature" name="temperature" type="number" step="0.1" value="20">
                                    <label for="temperature">Temperature (°C)</label>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">scale</i>
                                    <input id="specific_gravity" name="specific_gravity" type="number" step="0.01" min="0.1" max="5" value="1.0">
                                    <label for="specific_gravity">Specific Gravity</label>
                                    <span class="helper-text">1.0 for water</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">waves</i>
                                    <input id="viscosity" name="viscosity" type="number" step="0.1" min="0.1" value="1.0">
                                    <label for="viscosity">Viscosity (cP)</label>
                                    <span class="helper-text">1.0 for water at 20°C</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Conditions Section -->
        <div class="row section-card stagger-item" id="system-section">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title" style="color: var(--md-primary);">
                            <i class="material-icons left">account_tree</i>
                            System Conditions
                        </span>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">vertical_align_bottom</i>
                                    <input id="suction_pressure" name="suction_pressure" type="number" step="0.1" value="0">
                                    <label for="suction_pressure">Suction Pressure (bar gauge)</label>
                                    <span class="helper-text">Gauge pressure at pump suction</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">trending_up</i>
                                    <input id="static_head" name="static_head" type="number" step="0.1" value="0">
                                    <label for="static_head">Static Head (m)</label>
                                    <span class="helper-text">Vertical distance between liquid levels</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">bubble_chart</i>
                                    <input id="npsh_available" name="npsh_available" type="number" step="0.1" min="0">
                                    <label for="npsh_available">NPSH Available (m)</label>
                                    <span class="helper-text">Net Positive Suction Head available</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">terrain</i>
                                    <input id="site_altitude" name="site_altitude" type="number" step="0.1" min="0">
                                    <label for="site_altitude">Site Altitude (m above sea level)</label>
                                    <span class="helper-text">Affects NPSH and vapor pressure calculations</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">vertical_align_top</i>
                                    <input id="discharge_pressure" name="discharge_pressure" type="number" step="0.1">
                                    <label for="discharge_pressure">Discharge Pressure (bar gauge)</label>
                                    <span class="helper-text">System discharge pressure</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">compress</i>
                                    <input id="vapor_pressure" name="vapor_pressure" type="number" step="0.001" value="3.074">
                                    <label for="vapor_pressure">Vapor Pressure (kPa)</label>
                                    <span class="helper-text">Liquid vapor pressure at operating temperature</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Motor Requirements Section -->
        <div class="row section-card" id="motor-section">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title" style="color: var(--md-primary);">
                            <i class="material-icons left">electric_bolt</i>
                            Motor & Power Requirements
                        </span>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">power</i>
                                    <input id="max_power" name="max_power" type="number" step="0.1" min="0">
                                    <label for="max_power">Maximum Power (kW)</label>
                                    <span class="helper-text">Maximum allowable motor power</span>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-field">
                                    <i class="material-icons prefix">settings</i>
                                    <input id="motor_speed" name="motor_speed" type="number" step="1" value="2960">
                                    <label for="motor_speed">Motor Speed (rpm)</label>
                                    <span class="helper-text">Required motor speed</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m4">
                                <div class="input-field">
                                    <i class="material-icons prefix">electrical_services</i>
                                    <input id="voltage" name="voltage" type="number" step="1" value="380">
                                    <label for="voltage">Voltage (V)</label>
                                </div>
                            </div>
                            <div class="col s12 m4">
                                <div class="input-field">
                                    <i class="material-icons prefix">waves</i>
                                    <input id="frequency" name="frequency" type="number" step="1" value="50">
                                    <label for="frequency">Frequency (Hz)</label>
                                </div>
                            </div>
                            <div class="col s12 m4">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">electrical_services</i>
                                        Phase
                                    </label>
                                    <div class="radio-group">
                                        <p style="margin: 5px 0;">
                                            <label>
                                                <input name="motor_phase" type="radio" value="three_phase" checked />
                                                <span>Three Phase</span>
                                            </label>
                                        </p>
                                        <p style="margin: 5px 0;">
                                            <label>
                                                <input name="motor_phase" type="radio" value="single_phase" />
                                                <span>Single Phase</span>
                                            </label>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col s12 m6">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">security</i>
                                        Sealing Arrangement
                                    </label>
                                    <div class="radio-group">
                                        <p>
                                            <label>
                                                <input name="sealing" type="radio" value="mechanical_seal" checked />
                                                <span>Mechanical Seal</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="sealing" type="radio" value="gland_packing" />
                                                <span>Gland Packing</span>
                                            </label>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col s12 m6">
                                <div class="input-group">
                                    <label class="form-label" style="color: var(--md-primary); font-size: 14px; font-weight: 600; margin-bottom: 10px; display: block;">
                                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 8px;">warning</i>
                                        ATEX/Hazardous Area
                                    </label>
                                    <div class="radio-group">
                                        <p>
                                            <label>
                                                <input name="atex_required" type="radio" value="no" checked />
                                                <span>Standard Motor</span>
                                            </label>
                                        </p>
                                        <p>
                                            <label>
                                                <input name="atex_required" type="radio" value="yes" />
                                                <span>ATEX Motor Required</span>
                                            </label>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="row stagger-item">
            <div class="col s12">
                <div class="card-panel center-align fade-in-up">
                    <button class="btn-large waves-effect waves-light teal" type="submit" id="submit-btn">
                        <i class="material-icons left">search</i>
                        Find Best Pumps
                    </button>
                    <br><br>
                    <button class="btn waves-effect waves-light grey" type="reset" onclick="resetForm()">
                        <i class="material-icons left">refresh</i>
                        Reset Form
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Progress Indicator -->
<div class="progress" id="loading-progress" style="display: none;">
    <div class="indeterminate teal"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize form components
    initializeFormComponents();
});

function initializeFormComponents() {
    // Initialize tooltips for this form
    var tooltips = document.querySelectorAll('.tooltipped');
    M.Tooltip.init(tooltips);

    // Form submission handling
    var form = document.getElementById('pumpSelectionForm');
    var submitBtn = document.getElementById('submit-btn');
    var progressBar = document.getElementById('loading-progress');

    if (form) {
        form.addEventListener('submit', function(e) {
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Analyzing...';
                submitBtn.disabled = true;
            }
            if (progressBar) {
                progressBar.classList.add('show');
            }
        });
    }

    // Variable flow handling
    const variableFlowRadios = document.querySelectorAll('input[name="variable_flow"]');
    const flowRangeSection = document.getElementById('flow-range-section');

    variableFlowRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'yes') {
                flowRangeSection.style.display = 'block';
            } else {
                flowRangeSection.style.display = 'none';
            }
        });
    });

    // Direct pump search suggestions
    const pumpSearchInput = document.getElementById('direct_pump_search');
    const suggestionsDiv = document.getElementById('pump_search_suggestions');

    if (pumpSearchInput && suggestionsDiv) {
        let searchTimeout;

        pumpSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                // Real-time search suggestions are handled by Materialize autocomplete
                // which fetches data from the /api/pumps endpoint
                suggestionsDiv.style.display = 'none';
            }, 300);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!pumpSearchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
    }

    console.log('Form components initialized - radio buttons ready');

    // Initialize autocomplete for direct pump search
    // Fetch pump data for autocomplete
    fetch('/api/pumps')
        .then(response => response.json())
        .then(data => {
            if (data.pumps) {
                const pumpData = {};
                data.pumps.forEach(pump => {
                    pumpData[pump.pump_code] = null; // Materialize autocomplete format
                });

                // Initialize Materialize autocomplete
                const autocompleteElem = document.getElementById('direct_pump_search');
                if (autocompleteElem) {
                    M.Autocomplete.init(autocompleteElem, {
                        data: pumpData,
                        limit: 10,
                        minLength: 1,
                        onAutocomplete: function(val) {
                            console.log('Pump selected:', val);
                        }
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error loading pump data for autocomplete:', error);
        });
}
</script>
{% endblock %}
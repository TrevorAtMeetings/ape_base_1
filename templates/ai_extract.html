{% extends "base.html" %}

{% block title %}AI PDF Extraction - APE Pumps{% endblock %}

{% block head %}
    <!-- MathJax for LaTeX rendering -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['\\(', '\\)'], ['$', '$']],
                displayMath: [['\\[', '\\]'], ['$$', '$$']],
                processEscapes: true,
                processEnvironments: true
            },
            startup: {
                ready: () => {
                    MathJax.startup.defaultReady();
                    console.log('MathJax is loaded and ready');
                }
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/polyfill@3.0.0/dist/polyfill.min.js"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
    .compact-card {
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .compact-card .card-content {
        padding: 16px;
    }
    .compact-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #1976d2;
    }
    .upload-container {
        background: #f9f9f9;
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        transition: all 0.3s ease;
        margin: 12px 0;
    }
    .upload-container:hover {
        border-color: #1976d2;
        background: #f5f7fa;
    }
    .upload-container.drag-over {
        border-color: #1976d2;
        background: #e3f2fd;
    }
    .status-section {
        margin-top: 12px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 6px;
    }
    .btn-compact {
        margin: 6px 4px;
        padding: 0 16px;
        height: 36px;
        line-height: 36px;
    }
    .curve-section {
        border-left: 4px solid #1976d2;
        padding-left: 15px;
        margin-bottom: 30px;
    }
    .data-table {
        font-size: 0.95em;
    }
    .data-table th {
        background-color: #f5f5f5;
        font-weight: 600;
    }
    .data-table td {
        padding: 8px 12px;
    }
    .summary-card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .chip {
        margin: 4px;
        font-size: 0.9em;
    }
    .card-title {
        font-size: 1.5rem;
        font-weight: 600;
    }
    .impeller-title {
        color: #1976d2;
        font-size: 1.2rem;
        font-weight: 500;
        margin-bottom: 10px;
        margin-top: 20px;
    }
    .compact-data-table {
        font-size: 0.85em;
        margin: 0;
    }
    .compact-data-table td {
        padding: 4px 8px !important;
        line-height: 1.3;
    }
    .compact-data-table th {
        padding: 6px 8px !important;
        font-size: 0.9em;
        font-weight: 600;
    }
    .data-section {
        margin-bottom: 8px;
    }
    @media (max-width: 600px) {
        .compact-data-table {
            font-size: 0.8em;
        }
        .compact-data-table td,
        .compact-data-table th {
            padding: 3px 4px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
{% set breadcrumbs = [
    {'label': 'Home', 'url': '/', 'icon': 'home'},
    {'label': 'AI Data Extract'}
] %}


<div class="container" style="margin-top: 20px;">
    <!-- Compact Upload Section -->
    <div class="row">
        <div class="col s12">
            <div class="card compact-card">
                <div class="card-content">
                    <div class="compact-title">
                        <i class="material-icons left" style="color: #1976d2;">auto_awesome</i>
                        AI PDF Extraction
                    </div>

                    <form id="ai-extract-form" enctype="multipart/form-data">
                        <div class="upload-container" id="upload-container">
                            <i class="material-icons" style="font-size: 2rem; color: #1976d2; margin-bottom: 8px;">cloud_upload</i>
                            <p style="margin: 8px 0; font-weight: 500;">Upload PDF</p>
                            <p style="margin: 4px 0; font-size: 0.9em; color: #666;">Select a PDF file to extract pump data</p>
                            <input type="file" id="pdf-file" name="pdf_file" accept=".pdf" style="display: none;">

                            <!-- Simplified AI System Info -->
                            <div style="margin: 12px 0; text-align: left;">
                                <div style="padding: 8px; background: #f0f8ff; border-radius: 4px; border-left: 4px solid #1976d2;">
                                    <small style="color: #1976d2; font-weight: 500;">AI System:</small>
                                    <div style="font-size: 0.85em; margin-top: 4px; color: #666;">
                                        Using OpenAI GPT-4o for high-accuracy pump data extraction
                                    </div>
                                </div>


                            </div>

                            <button type="button" class="btn btn-compact waves-effect waves-light" style="background-color: #1976d2; margin-top: 8px;" onclick="document.getElementById('pdf-file').click();">
                                <i class="material-icons left">attach_file</i>
                                Choose PDF
                            </button>
                            <button type="submit" class="btn btn-compact waves-effect waves-light" style="background-color: #1976d2; margin-top: 8px;" id="extract-btn">
                                <i class="material-icons left">auto_awesome</i>
                                Extract Data
                            </button>
                        </div>

                    </form>

                    <div class="status-section">
                        <div id="status-container">
                            <p class="grey-text text-darken-2" style="margin: 0;">
                                <i class="material-icons left" style="font-size: 1.2rem;">info</i>
                                Ready to extract data from PDF files.
                            </p>
                        </div>
                        <div id="progress-container" style="display: none;">
                            <div class="progress" style="margin: 8px 0;">
                                <div class="indeterminate" style="background-color: #1976d2;"></div>
                            </div>
                            <p class="grey-text text-darken-2" style="margin: 0;">Processing PDF...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Section -->
    <div class="row" id="results-section" style="display: none;">
        <div class="col s12">
            <div class="card compact-card">
                <div class="card-content">
                    <div class="compact-title">
                        <i class="material-icons left" style="color: #1976d2;">assessment</i>
                        Extracted Data & Performance Analysis
                    </div>

                    <!-- Split layout: PDF Preview + Performance Graph -->
                    <div class="row" style="margin-bottom: 20px;">
                        <div class="col s12 m4">
                            <h6 style="color: #1976d2; margin-bottom: 5px;">PDF Preview</h6>
                            <div id="results-pdf-preview" style="border: 1px solid #ddd; padding: 2px; min-height: 400px; text-align: center;">
                                <!-- PDF preview will be copied here -->
                            </div>
                        </div>
                        <div class="col s12 m8">
                            <h6 style="color: #1976d2; margin-bottom: 5px;">Performance Curves</h6>
                            <div id="performance-graph-container" style="border: 1px solid #ddd; padding: 5px; min-height: 400px;">
                                <!-- Tab navigation for charts -->
                                <div class="chart-tabs" style="margin-bottom: 10px; border-bottom: 1px solid #e0e0e0;">
                                    <button class="chart-tab-btn active" data-chart="head-flow" style="padding: 8px 16px; border: none; background: #1976d2; color: white; margin-right: 5px; cursor: pointer; border-radius: 4px 4px 0 0;">Head vs Flow</button>
                                    <button class="chart-tab-btn" data-chart="efficiency-flow" style="padding: 8px 16px; border: none; background: #f5f5f5; color: #666; margin-right: 5px; cursor: pointer; border-radius: 4px 4px 0 0;">Efficiency vs Flow</button>
                                    <button class="chart-tab-btn" data-chart="combined" style="padding: 8px 16px; border: none; background: #f5f5f5; color: #666; cursor: pointer; border-radius: 4px 4px 0 0;">Combined View</button>
                                </div>

                                <!-- Chart containers -->
                                <div id="head-flow-chart" class="chart-panel active" style="width: 100%; height: 350px; display: block;"></div>
                                <div id="efficiency-flow-chart" class="chart-panel" style="width: 100%; height: 350px; display: none;"></div>
                                <div id="combined-chart" class="chart-panel" style="width: 100%; height: 350px; display: none;"></div>
                            </div>
                        </div>
                    </div>

                    <div id="extracted-data">
                        <!-- Extracted data will be displayed here -->
                    </div>
                    <div class="row" style="margin-top: 16px;">
                        <div class="col s12">
                            <button class="btn btn-compact waves-effect waves-light orange" id="edit-data-btn" style="display: none;">
                                <i class="material-icons left">edit</i>
                                Edit Extracted Data
                            </button>
                            <button class="btn btn-compact waves-effect waves-light green" id="insert-btn" style="display: none;">
                                <i class="material-icons left">save</i>
                                Insert into Database
                            </button>
                            <button class="btn btn-compact waves-effect waves-light blue" id="show-json-btn" style="display: none;">
                                <i class="material-icons left">code</i>
                                View Raw JSON
                            </button>
                            <button class="btn btn-compact waves-effect waves-light grey" id="reset-btn">
                                <i class="material-icons left">refresh</i>
                                Extract Another
                            </button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts section -->
<!-- PDF.js for PDF preview functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<!-- Plotly.js for performance graphs -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<!-- Charts.js removed - not needed on AI Extract page -->
<!-- <script src="{{ url_for('static', filename='js/charts.js') }}"></script> -->
<script src="{{ url_for('static', filename='js/chart_tabs.js') }}"></script>
<script>
function formatPromptDate(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    return d.toLocaleString();
}
document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems);
    let promptHistory = [];
    let selectedPromptId = null;

    const form = document.getElementById('ai-extract-form');
    const fileInput = document.getElementById('pdf-file');
    const extractBtn = document.getElementById('extract-btn');
    const insertBtn = document.getElementById('insert-btn');
    const showJsonBtn = document.getElementById('show-json-btn');
    const resetBtn = document.getElementById('reset-btn');

    const statusContainer = document.getElementById('status-container');
    const progressContainer = document.getElementById('progress-container');
    const resultsSection = document.getElementById('results-section');
    const extractedDataDiv = document.getElementById('extracted-data');
    const uploadContainer = document.getElementById('upload-container');
    let extractedData = null;
    let currentPreviewImage = null; // Store the preview image

    // File input change handler for preview
    if (fileInput) {
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                statusContainer.innerHTML = `<p class="green-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">check_circle</i>File selected: ${file.name}</p>`;

                if (file.type === "application/pdf") {
                    if (typeof pdfjsLib === "undefined") {
                        console.error("PDF.js failed to load");
                        return;
                    }

                    // Set worker source for PDF.js
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

                    const fileReader = new FileReader();
                    fileReader.onload = function() {
                        const typedarray = new Uint8Array(this.result);
                        pdfjsLib.getDocument(typedarray).promise.then(function(pdf) {
                            pdf.getPage(1).then(function(page) {
                                const viewport = page.getViewport({scale: 1.0});
                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d');
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                page.render({canvasContext: context, viewport: viewport}).promise.then(function() {
                                    const imgUrl = canvas.toDataURL();
                                    currentPreviewImage = imgUrl; // Store the preview for results section
                                    // No longer display preview in upload section
                                    

                                });
                            });
                        }).catch(function(error) {
                            console.error("Error loading PDF:", error.message);
                        });
                    };
                    fileReader.readAsArrayBuffer(file);
                } else {
                    console.error("Please select a valid PDF file");
                }
            }
        });
    }

    // Drag and drop functionality
    uploadContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadContainer.classList.add('drag-over');
    });

    uploadContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadContainer.classList.remove('drag-over');
    });

    uploadContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadContainer.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'application/pdf') {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    });

    // Form submission handler
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const file = fileInput.files[0];
        if (!file) {
            statusContainer.innerHTML = '<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>Please select a PDF file first.</p>';
            return;
        }
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            statusContainer.innerHTML = '<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>Please select a PDF file.</p>';
            return;
        }

        // Simplified processing - no model selection needed
        const modelName = 'OpenAI GPT-4o';

        // Set processing state but preserve preview
        progressContainer.style.display = 'block';
        statusContainer.style.display = 'none';
        extractBtn.disabled = true;
        extractBtn.innerHTML = `<i class="material-icons left">hourglass_empty</i>Processing with ${modelName}...`;

        // Preview will be shown in results section after extraction

        const formData = new FormData();
        formData.append('pdf_file', file);
        fetch('/ai_extract/extract', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                // If it's not JSON, it might be an HTML error page
                return response.text().then(text => {
                    throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}`);
                });
            }
        })
        .then(data => {
            // Reset button state
            progressContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            extractBtn.disabled = false;
            extractBtn.innerHTML = '<i class="material-icons left">auto_awesome</i>Extract Data';

            if (data.success) {
                extractedData = data.data;
                window.currentExtractionId = data.extraction_id; // Store for preview persistence
                displayExtractedData(data.data);
                statusContainer.innerHTML = `<p class="green-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">check_circle</i>Data extracted successfully!</p>`;
                resultsSection.style.display = 'block';
                insertBtn.style.display = 'inline-block';
                showJsonBtn.style.display = 'inline-block';

                // Save preview image to server if we have one
                if (currentPreviewImage && data.extraction_id) {
                    console.log('Saving preview image for extraction ID:', data.extraction_id);
                    fetch('/ai_extract/store_preview', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            extraction_id: data.extraction_id,
                            preview_data: currentPreviewImage
                        })
                    }).then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            console.log('Preview image saved successfully');
                        } else {
                            console.error('Failed to save preview image:', result.message);
                        }
                    }).catch(error => {
                        console.error('Failed to save preview image:', error);
                    });
                } else {
                    console.log('No preview image or extraction ID available for saving');
                }

                // Show Edit Data button if extraction_id is provided
                if (data.extraction_id) {
                    const editBtn = document.getElementById('edit-data-btn');
                    editBtn.style.display = 'inline-block';
                    editBtn.onclick = function() {
                        console.log('Edit button clicked - using edit_url:', data.edit_url);
                        console.log('Extraction ID from data:', data.extraction_id);
                        window.location.href = data.edit_url;
                    };
                }
            } else {
                statusContainer.innerHTML = `<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>Error: ${data.message || data.error}</p>`;
            }
        })
        .catch(error => {
            // Reset button state on error
            progressContainer.style.display = 'none';
            statusContainer.style.display = 'block';
            extractBtn.disabled = false;
            extractBtn.innerHTML = '<i class="material-icons left">auto_awesome</i>Extract Data';

            console.error('Extraction error:', error);

            // Provide more detailed error message
            let errorMessage = error.message;
            if (errorMessage.includes('HTML instead of JSON')) {
                errorMessage = 'Server error occurred. Please check the console for details and try again.';
            }

            statusContainer.innerHTML = `<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>Error: ${errorMessage}</p>`;
        });
    });

    // Insert into Database button handler
    insertBtn.addEventListener('click', function() {
        if (!extractedData) {
            statusContainer.innerHTML = '<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>No data to insert.</p>';
            return;
        }

        insertBtn.disabled = true;
        insertBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Inserting...';

        fetch('/ai_extract/insert', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(extractedData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                statusContainer.innerHTML = `<p class="green-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">check_circle</i>Data inserted successfully! Pump ID: ${data.pump_id}</p>`;
                insertBtn.innerHTML = '<i class="material-icons left">check</i>Inserted';
                insertBtn.classList.remove('green');
                insertBtn.classList.add('grey');
            } else {
                statusContainer.innerHTML = `<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>Error inserting data: ${data.error}</p>`;
                insertBtn.disabled = false;
                insertBtn.innerHTML = '<i class="material-icons left">save</i>Insert into Database';
            }
        })
        .catch(error => {
            statusContainer.innerHTML = `<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>Error: ${error.message}</p>`;
            insertBtn.disabled = false;
            insertBtn.innerHTML = '<i class="material-icons left">save</i>Insert into Database';
        });
    });

    // Show JSON button handler
    showJsonBtn.addEventListener('click', function() {
        if (!extractedData) {
            statusContainer.innerHTML = '<p class="red-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">error</i>No data to show.</p>';
            return;
        }

        // Create a modal or new window to show JSON
        const jsonWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
        jsonWindow.document.write(`
            <html>
                <head>
                    <title>Raw JSON Data</title>
                    <style>
                        body { font-family: monospace; margin: 20px; }
                        pre { background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; }
                    </style>
                </head>
                <body>
                    <h2>Extracted Pump Data (Raw JSON)</h2>
                    <pre>${JSON.stringify(extractedData, null, 2)}</pre>
                </body>
            </html>
        `);
        jsonWindow.document.close();
    });

    // Reset button handler
    resetBtn.addEventListener('click', function() {
        form.reset();
        extractedData = null;
        currentPreviewImage = null;
        resultsSection.style.display = 'none';
        insertBtn.style.display = 'none';
        showJsonBtn.style.display = 'none';
        document.getElementById('edit-data-btn').style.display = 'none';
        clearSessionBtn.style.display = 'none';
        insertBtn.disabled = false;
        insertBtn.innerHTML = '<i class="material-icons left">save</i>Insert into Database';
        insertBtn.classList.remove('grey');
        insertBtn.classList.add('green');
        statusContainer.innerHTML = '<p class="grey-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">info</i>Ready to extract data from PDF files.</p>';
        statusContainer.style.display = 'block';
        extractedDataDiv.innerHTML = '';
        // Clear results section PDF preview
        const resultsPdfPreview = document.getElementById('results-pdf-preview');
        if (resultsPdfPreview) {
            resultsPdfPreview.innerHTML = '';
        }
    });



    // Function to generate improved performance graphs
    function generatePerformanceGraph(data) {        if (!data || !data.curves || data.curves.length === 0) {
            document.getElementById('head-flow-chart').innerHTML = '<p style="text-align: center; color: #666; padding: 50px;">No performance data available</p>';
            return;
        }

        generateHeadFlowChart(data);
        generateEfficiencyFlowChart(data);
        generateCombinedChart(data);

        // Setup tab switching
        setupChartTabs();
    }

    function calculateDataRange(values, paddingPercent = 10) {
        if (!values || values.length === 0) return [0, 100];
        const validValues = values.filter(v => v != null && v > 0);
        if (validValues.length === 0) return [0, 100];

        const min = Math.min(...validValues);
        const max = Math.max(...validValues);
        const range = max - min;
        const padding = range * (paddingPercent / 100);

        return [
            Math.max(0, min - padding),
            max + padding
        ];
    }

    function generateHeadFlowChart(data) {
        const traces = [];
        const colors = ['#1976d2', '#d32f2f', '#388e3c', '#f57c00', '#7b1fa2'];

        let allHeads = [];
        let allFlows = [];

        data.curves.forEach((curve, index) => {
            // Handle both APE processor output (performance_points) and old structure (performancePoints)
            const points = curve.performance_points || curve.performancePoints || [];
            if (points.length === 0) return;

            const flows = points.map(p => p.flow || 0).filter(f => f > 0);
            const heads = points.map(p => p.head || 0).filter(h => h > 0);

            if (flows.length === 0 || heads.length === 0) return;

            allHeads.push(...heads);
            allFlows.push(...flows);

            traces.push({
                x: flows,
                y: heads,
                type: 'scatter',
                mode: 'lines+markers',
                name: `${curve.impellerDiameter || `Impeller ${index + 1}`}mm`,
                line: { color: colors[index % colors.length], width: 3 },
                marker: { size: 6, color: colors[index % colors.length] },
                hovertemplate: '<b>%{fullData.name}</b><br>Flow: %{x} m³/hr<br>Head: %{y:.1f} m<extra></extra>'
            });
        });

        const [minHead, maxHead] = calculateDataRange(allHeads, 15);
        const [minFlow, maxFlow] = calculateDataRange(allFlows, 10);

        const layout = {
            title: {
                text: `Head vs Flow Rate - ${(data.pump_details || data.pumpDetails)?.pumpModel || 'Pump Performance'}`,
                font: { size: 14, color: '#1976d2' }
            },
            xaxis: {
                title: { text: 'Flow Rate (m³/hr)', font: { size: 12 } },
                showgrid: true,
                gridcolor: '#e0e0e0',
                range: [minFlow, maxFlow]
            },
            yaxis: {
                title: { text: 'Head (m)', font: { size: 12 } },
                showgrid: true,
                gridcolor: '#e0e0e0',
                range: [minHead, maxHead]
            },
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255,255,255,0.9)',
                bordercolor: '#ccc',
                borderwidth: 1
            },
            margin: { l: 60, r: 40, t: 50, b: 50 },
            hovermode: 'closest'
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
            displaylogo: false
        };

        Plotly.newPlot('head-flow-chart', traces, layout, config);
    }

    function generateEfficiencyFlowChart(data) {
        const traces = [];
        const colors = ['#2e7d32', '#d32f2f', '#1976d2', '#f57c00', '#7b1fa2'];

        let allEfficiencies = [];
        let allFlows = [];

        data.curves.forEach((curve, index) => {
            // Handle both APE processor output (performance_points) and old structure (performancePoints)
            const points = curve.performance_points || curve.performancePoints || [];
            if (points.length === 0) return;

            const flows = points.map(p => p.flow || 0).filter(f => f > 0);
            const efficiencies = points.map(p => p.efficiency || 0).filter(e => e > 0);

            if (flows.length === 0 || efficiencies.length === 0) return;

            allEfficiencies.push(...efficiencies);
            allFlows.push(...flows);

            traces.push({
                x: flows,
                y: efficiencies,
                type: 'scatter',
                mode: 'lines+markers',
                name: `${curve.impellerDiameter || `Impeller ${index + 1}`}mm`,
                line: { color: colors[index % colors.length], width: 3 },
                marker: { size: 6, color: colors[index % colors.length] },
                hovertemplate: '<b>%{fullData.name}</b><br>Flow: %{x} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
            });
        });

        const [minEff, maxEff] = calculateDataRange(allEfficiencies, 10);
        const [minFlow, maxFlow] = calculateDataRange(allFlows, 10);

        const layout = {
            title: {
                text: `Efficiency vs Flow Rate - ${(data.pump_details || data.pumpDetails)?.pumpModel || 'Pump Performance'}`,
                font: { size: 14, color: '#2e7d32' }
            },
            xaxis: {
                title: { text: 'Flow Rate (m³/hr)', font: { size: 12 } },
                showgrid: true,
                gridcolor: '#e0e0e0',
                range: [minFlow, maxFlow]
            },
            yaxis: {
                title: { text: 'Efficiency (%)', font: { size: 12 } },
                showgrid: true,
                gridcolor: '#e0e0e0',
                range: [minEff, maxEff]
            },
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255,255,255,0.9)',
                bordercolor: '#ccc',
                borderwidth: 1
            },
            margin: { l: 60, r: 40, t: 50, b: 50 },
            hovermode: 'closest'
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
            displaylogo: false
        };

        Plotly.newPlot('efficiency-flow-chart', traces, layout, config);
    }

    function generateCombinedChart(data) {
        const traces = [];
        const colors = ['#1976d2', '#d32f2f', '#388e3c', '#f57c00', '#7b1fa2'];

        data.curves.forEach((curve, index) => {
            // Handle both APE processor output (performance_points) and old structure (performancePoints)
            const points = curve.performance_points || curve.performancePoints || [];
            if (points.length === 0) return;

            const flows = points.map(p => p.flow || 0).filter(f => f > 0);
            const heads = points.map(p => p.head || 0).filter(h => h > 0);
            const efficiencies = points.map(p => p.efficiency || 0).filter(e => e > 0);

            if (flows.length === 0) return;

            // Head curve
            if (heads.length > 0) {
                traces.push({
                    x: flows,
                    y: heads,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Head - ${curve.impellerDiameter || `Imp ${index + 1}`}mm`,
                    line: { color: colors[index % colors.length], width: 2 },
                    marker: { size: 4 },
                    yaxis: 'y'
                });
            }

            // Efficiency curve
            if (efficiencies.length > 0) {
                traces.push({
                    x: flows,
                    y: efficiencies,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: `Eff - ${curve.impellerDiameter || `Imp ${index + 1}`}mm`,
                    line: { color: colors[index % colors.length], width: 2, dash: 'dash' },
                    marker: { size: 4, symbol: 'diamond' },
                    yaxis: 'y2'
                });
            }
        });

        const layout = {
            title: {
                text: `Combined Performance Curves - ${(data.pump_details || data.pumpDetails)?.pumpModel || 'Pump'}`,
                font: { size: 14 }
            },
            xaxis: {
                title: { text: 'Flow Rate (m³/hr)', font: { size: 12 } },
                showgrid: true,
                gridcolor: '#e0e0e0'
            },
            yaxis: {
                title: { text: 'Head (m)', font: { size: 12, color: '#1976d2' } },
                side: 'left',
                showgrid: true,
                gridcolor: '#e0e0e0'
            },
            yaxis2: {
                title: { text: 'Efficiency (%)', font: { size: 12, color: '#2e7d32' } },
                side: 'right',
                overlaying: 'y',
                showgrid: false
            },
            legend: {
                x: 0.02,
                y: 0.98,
                bgcolor: 'rgba(255,255,255,0.9)',
                bordercolor: '#ccc',
                borderwidth: 1,
                font: { size: 9 }
            },
            margin: { l: 60, r: 60, t: 50, b: 50 },
            hovermode: 'closest'
        };

        const config = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'autoScale2d'],
            displaylogo: false
        };

        Plotly.newPlot('combined-chart', traces, layout, config);
    }

    function setupChartTabs() {
        const tabButtons = document.querySelectorAll('.chart-tab-btn');
        const chartPanels = document.querySelectorAll('.chart-panel');

        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const targetChart = this.getAttribute('data-chart');

                // Update button states
                tabButtons.forEach(btn => {
                    btn.style.background = '#f5f5f5';
                    btn.style.color = '#666';
                    btn.classList.remove('active');
                });
                this.style.background = '#1976d2';
                this.style.color = 'white';
                this.classList.add('active');

                // Show target chart
                chartPanels.forEach(panel => {
                    panel.style.display = 'none';
                    panel.classList.remove('active');
                });

                const targetPanel = document.getElementById(targetChart + '-chart') || document.getElementById(targetChart);
                if (targetPanel) {
                    targetPanel.style.display = 'block';
                    targetPanel.classList.add('active');

                    // Trigger Plotly resize
                    setTimeout(() => {
                        if (typeof Plotly !== 'undefined') {
                            Plotly.Plots.resize(targetPanel);
                        }
                    }, 100);
                }
            });
        });
        // Hide all but the active chart on initial load
        chartPanels.forEach(panel => {
            if (!panel.classList.contains('active')) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
            }
        });
    }

    // Fixed displayExtractedData function to handle APE processor output structure (v2)
    function displayExtractedData(data) {
        console.log('displayExtractedData v2 called with:', data);
        console.log('extractedDataDiv element:', extractedDataDiv);
        
        if (!data) {
            console.log('No data provided to displayExtractedData');
            extractedDataDiv.innerHTML = '<p class="red-text">No data to display</p>';
            return;
        }
        
        console.log('Data validation passed, proceeding with display...');

        // Copy PDF preview to results section
        const resultsPdfPreview = document.getElementById('results-pdf-preview');
        if (currentPreviewImage && resultsPdfPreview) {
            resultsPdfPreview.innerHTML = `<img src="${currentPreviewImage}" style="width: 100%; max-height: 390px; object-fit: contain;" alt="PDF Preview"/>`;
        } else if (window.currentExtractionId && resultsPdfPreview) {
            // Try to load saved preview image
            console.log('Attempting to load saved preview for extraction ID:', window.currentExtractionId);
            resultsPdfPreview.innerHTML = `<img src="/ai_extract/preview/${window.currentExtractionId}" style="width: 100%; max-height: 390px; object-fit: contain;" alt="PDF Preview" onload="console.log('Preview image loaded successfully')" onerror="console.log('Failed to load preview image'); this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #666;\\'><i class=\\'material-icons\\' style=\\'font-size: 3rem; margin-bottom: 10px;\\'>picture_as_pdf</i><p style=\\'margin: 0; font-weight: 500;\\'>PDF Preview</p><p style=\\'margin: 5px 0 0 0; font-size: 0.9em;\\'>Data extracted successfully</p></div>'"/>`;
        }

        // Generate performance graph
        console.log('About to generate performance graph with data:', data);
        try {
            generatePerformanceGraph(data);
            console.log('Performance graph generation completed');
        } catch (error) {
            console.error('Error generating performance graph:', error);
        }

        let html = '';

        // Handle both APE processor output (pump_details) and old structure (pumpDetails)
        const pumpDetails = data.pump_details || data.pumpDetails;

        // Pump Details Section
        if (pumpDetails) {
            html += `
                <div class="curve-section">
                    <h6 class="impeller-title">Pump Details</h6>
                    <table class="striped compact-data-table">
                        <tbody>
                            <tr><td><strong>Model:</strong></td><td>${pumpDetails.pumpModel || 'N/A'}</td></tr>
                            <tr><td><strong>Manufacturer:</strong></td><td>${pumpDetails.manufacturer || 'N/A'}</td></tr>
                            <tr><td><strong>Type:</strong></td><td>${pumpDetails.pumpType || 'N/A'}</td></tr>
                            <tr><td><strong>Range:</strong></td><td>${pumpDetails.pumpRange || 'N/A'}</td></tr>
                            <tr><td><strong>Application:</strong></td><td>${pumpDetails.application || 'N/A'}</td></tr>
                            <tr><td><strong>Construction Standard:</strong></td><td>${pumpDetails.constructionStandard || 'N/A'}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Technical Details Section
        if (data.technicalDetails) {
            html += `
                <div class="curve-section">
                    <h6 class="impeller-title">Technical Details</h6>
                    <table class="striped compact-data-table">
                        <tbody>
                            <tr><td><strong>Impeller Type:</strong></td><td>${data.technicalDetails.impellerType || 'N/A'}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Handle both APE processor output (bep_data) and old structure (specifications)
        const specifications = data.bep_data || data.specifications;

        // Specifications Section
        if (specifications) {
            html += `
                <div class="curve-section">
                    <h6 class="impeller-title">Specifications</h6>
                    <table class="striped compact-data-table">
                        <tbody>
                            <tr><td><strong>Test Speed:</strong></td><td>${specifications.testSpeed || 0} rpm</td></tr>
                            <tr><td><strong>Max Flow:</strong></td><td>${specifications.maxFlow || 0} m³/hr</td></tr>
                            <tr><td><strong>Max Head:</strong></td><td>${specifications.maxHead || 0} m</td></tr>
                            <tr><td><strong>BEP Flow:</strong></td><td>${specifications?.bepFlow || 0} m³/hr</td></tr>
                            <tr><td><strong>BEP Head:</strong></td><td>${specifications?.bepHead || 0} m</td></tr>
                            <tr><td><strong>BEP Efficiency:</strong></td><td>${specifications?.bepMarkers?.[0]?.bepEfficiency || 'Not extracted'}%</td></tr>
                            <tr><td><strong>NPSH at BEP:</strong></td><td>${specifications?.npshrAtBep || 0} m</td></tr>
                            <tr><td><strong>Min Impeller:</strong></td><td>${specifications.minImpeller || 0} mm</td></tr>
                            <tr><td><strong>Max Impeller:</strong></td><td>${specifications.maxImpeller || 0} mm</td></tr>
                            <tr><td><strong>Variable Diameter:</strong></td><td>${specifications.variableDiameter ? 'Yes' : 'No'}</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Performance Curves Section
        if (data.curves && data.curves.length > 0) {
            html += `
                <div class="curve-section">
                    <h6 class="impeller-title">Performance Curves (${data.curves.length} impeller${data.curves.length > 1 ? 's' : ''})</h6>
            `;

            data.curves.forEach((curve, index) => {
                // Handle both APE processor output (performance_points) and old structure (performancePoints)
                const points = curve.performance_points || curve.performancePoints || [];
                html += `
                    <div style="margin-bottom: 20px;">
                        <h6 style="color: #666; font-size: 1rem; margin-bottom: 8px;">
                            Impeller ${curve.impellerDiameter || 'N/A'}mm (${points.length} points)
                        </h6>
                        <table class="striped compact-data-table">
                            <thead>
                                <tr>
                                    <th>Point</th>
                                    <th>Flow (m³/hr)</th>
                                    <th>Head (m)</th>
                                    <th>Efficiency (%)</th>
                                    <th>NPSH (m)</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

                points.forEach((point, pointIndex) => {
                    html += `
                        <tr>
                            <td>${pointIndex + 1}</td>
                            <td>${point.flow || 0}</td>
                            <td>${point.head || 0}</td>
                            <td>${point.efficiency || 0}</td>
                            <td>${point.npshr || 0}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            });

            html += '</div>';
        }

        // Summary Statistics
        if (data.curves && data.curves.length > 0) {
            const totalPoints = data.curves.reduce((sum, curve) => sum + ((curve.performance_points || curve.performancePoints)?.length || 0), 0);
            html += `
                <div class="summary-card card" style="margin-top: 20px;">
                    <div class="card-content">
                        <h6 class="card-title">Extraction Summary</h6>
                        <div class="row">
                            <div class="col s6">
                                <div class="center-align">
                                    <div class="chip blue white-text">${data.curves.length}</div>
                                    <p>Impeller Sizes</p>
                                </div>
                            </div>
                            <div class="col s6">
                                <div class="center-align">
                                    <div class="chip green white-text">${totalPoints}</div>
                                    <p>Data Points</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        // Add BEP Markers section if available - Handle both structures
        const bepMarkers = specifications?.bepMarkers || [];
        if (bepMarkers.length > 0) {
            html += '<h6 style="color: #1976d2; margin: 15px 0 8px 0;">BEP Markers</h6>';
            bepMarkers.forEach((bepMarker, index) => {
                if (bepMarker) {
                    html += `
                        <div class="bep-marker" style="background: #f8f9fa; padding: 8px; border-left: 3px solid #1976d2; margin: 5px 0;">
                            <strong>BEP ${index + 1}:</strong><br>
                            Impeller: ${bepMarker.impellerDiameter || 'N/A'} mm<br>
                            Flow: ${bepMarker.bepFlow || 'N/A'} m³/hr<br>
                            Head: ${bepMarker.bepHead || 'N/A'} m<br>
                            Efficiency: ${bepMarker.bepEfficiency || 'N/A'}%
                        </div>
                    `;
                }
            });
        }

        extractedDataDiv.innerHTML = html;
    }

    // Load and display model performance data
    // Model performance loading removed - using simplified system

    // Model performance display functions removed - using simplified system

    // Check for and display previous extraction data (moved outside initialization check)
    console.log('Template data check - data exists: {{ "true" if data else "false" }}');
    {% if data %}
    console.log('Previous extraction data found, displaying...');
    console.log('Data from server:', {{ data|tojson|safe }});
    console.log('Data type:', typeof {{ data|tojson|safe }});
    console.log('Data keys:', Object.keys({{ data|tojson|safe }}));
    

    
    // Function to hide preview section (used when navigating to editor)
    function hidePreviewSection() {
        const previewSection = document.querySelector('.col.s12.m4');
        if (previewSection) {
            previewSection.style.display = 'none';
        }
    }
    
    // Function to restore data
    function restoreExtractedData() {
        console.log('DOM loaded, checking for elements...');
        const resultsSection = document.getElementById('results-section');
        const insertBtn = document.getElementById('insert-btn');
        const showJsonBtn = document.getElementById('show-json-btn');
        const statusContainer = document.getElementById('status-container');
        
        console.log('Elements found:', {
            resultsSection: !!resultsSection,
            insertBtn: !!insertBtn,
            showJsonBtn: !!showJsonBtn,
            statusContainer: !!statusContainer
        });
        
        if (resultsSection && insertBtn && showJsonBtn && statusContainer) {
            extractedData = {{ data|tojson|safe }};
            console.log('extractedData set to:', extractedData);
            
            // Set the extraction ID for preview loading
            const extractionId = '{{ session.get("last_extraction_id", "") }}';
            if (extractionId) {
                window.currentExtractionId = extractionId;
                console.log('Set currentExtractionId to:', extractionId);
            }
            
            console.log('About to call displayExtractedData with:', extractedData);
            try {
                displayExtractedData(extractedData);
                console.log('displayExtractedData completed successfully');
            } catch (error) {
                console.error('Error in displayExtractedData:', error);
            }
            resultsSection.style.display = 'block';
            insertBtn.style.display = 'inline-block';
            showJsonBtn.style.display = 'inline-block';
            
            // Show Edit Data button if we have extraction data
            const editBtn = document.getElementById('edit-data-btn');
            if (editBtn) {
                editBtn.style.display = 'inline-block';
                editBtn.onclick = function() {
                    // Hide the preview section before navigating to editor
                    hidePreviewSection();
                    
                    // Get the extraction ID from the current data or session
                    let extractionId = '';
                    if (extractedData && extractedData.extraction_id) {
                        extractionId = extractedData.extraction_id;
                    } else {
                        extractionId = '{{ session.get("last_extraction_id", "") }}';
                    }
                    
                    if (extractionId) {
                        console.log('Navigating to editor with extraction ID:', extractionId);
                        window.location.href = `/pump_editor/${extractionId}`;
                    } else {
                        console.error('No extraction ID available for editing');
                        alert('No extraction data available for editing. Please run a new extraction.');
                    }
                };
            }
            
            statusContainer.innerHTML = '<p class="blue-text text-darken-2" style="margin: 0;"><i class="material-icons left" style="font-size: 1.2rem;">info</i>Previous extraction data restored. You can continue editing or start a new extraction.</p>';
            statusContainer.style.display = 'block';
            
            // PDF preview will be restored by displayExtractedData function
            
            console.log('All elements updated successfully');
        } else {
            console.error('Some required elements not found:', {
                resultsSection: !!resultsSection,
                insertBtn: !!insertBtn,
                showJsonBtn: !!showJsonBtn,
                statusContainer: !!statusContainer
            });
        }
    }
    
    // Check if DOM is already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', restoreExtractedData);
    } else {
        // DOM is already loaded, run immediately
        restoreExtractedData();
    }
    
    // Preview restoration is now handled by the backend based on from_editor parameter
    {% else %}
    console.log('No previous data found in template');
    {% endif %}

    // Model selection initialization removed - using simplified system
});
</script>

<!-- JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/icon-loader.js') }}"></script>
<script src="{{ url_for('static', filename='js/micro-interactions.js') }}"></script>
<script src="{{ url_for('static', filename='js/force-icon-refresh.js') }}"></script>
{# Floating AI Chat is loaded once in base.html #}
<script src="{{ url_for('static', filename='js/chart_tabs.js') }}"></script>

<!-- Initialize Materialize components -->
<script>
    console.log('MathJax is loaded and ready');
    console.log('chart_tabs.js loaded');
    console.log('Base template: Initializing Materialize components');
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modals
        var modals = document.querySelectorAll('.modal');
        console.log('Initialized', modals.length, 'modals');
        M.Modal.init(modals);

        // Initialize sidenav
        var sidenavs = document.querySelectorAll('.sidenav');
        console.log('Initialized', sidenavs.length, 'sidenavs');
        M.Sidenav.init(sidenavs);

        // Dropdown initialization removed - handled by navigation.html

        // Initialize form components
        M.updateTextFields();
        M.FormSelect.init(document.querySelectorAll('select'));
        console.log('Form components initialized - enhanced autocomplete ready');
    });
</script>

{% endblock %}
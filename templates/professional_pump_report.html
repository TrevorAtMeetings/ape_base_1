<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Pump Selection Report - {{ selected_pump.get('pump_code', 'N/A') }} | APE Pumps</title>
    <!-- Materialize CSS for professional styling -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <script src="{{ url_for('static', filename='js/error-handler.js') }}"></script>
    <script src="{{ url_for('static', filename='js/force-chart-refresh.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chart_legend_fix.js') }}?v=20250607-1905"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}?v=20250607-1910-green"></script>
    <script src="{{ url_for('static', filename='js/chart_layout_fix.js') }}?v=20250607-1905"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        /* Material Design 3 Variables with FDD Professional Colors */
        :root {
            --md-primary: #1e3c72;
            --md-primary-variant: #2a5298;
            --md-secondary: #4caf50;
            --md-surface: #ffffff;
            --md-surface-variant: #f8f9fa;
            --md-outline: #e0e0e0;
            --md-outline-variant: #f0f0f0;
            --md-shadow: 0 2px 8px rgba(0,0,0,0.08);
            --md-shadow-elevated: 0 4px 16px rgba(0,0,0,0.12);
            --md-border-radius: 12px;
            --md-border-radius-large: 16px;

            /* FDD Professional Efficiency Color Scheme */
            --efficiency-excellent: #28a745;
            --efficiency-good: #17a2b8;
            --efficiency-acceptable: #ffc107;
            --efficiency-poor: #dc3545;

            /* Professional gradient backgrounds */
            --gradient-primary: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            --gradient-info: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            --gradient-warning: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            --gradient-danger: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        /* Score value styles */
        .score-positive {
            font-weight: 600;
            color: #388e3c;
        }
        
        .score-negative {
            font-weight: 600;
            color: #d32f2f;
        }

        /* BEP marker styles */
        .bep-marker {
            position: absolute;
            top: -5px;
            transform: translateX(-50%);
        }
        
        .bep-marker-arrow {
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 15px solid #1976d2;
        }
        
        .bep-marker-label {
            text-align: center;
            margin-top: 5px;
            font-weight: bold;
            color: #1976d2;
        }

        /* Alternative badge styles */
        .alternative-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        
        .alternative-score-bar {
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .ape-header {
            background: linear-gradient(135deg, var(--md-primary) 0%, var(--md-primary-variant) 100%);
            color: white;
            padding: 40px 0;
            margin-bottom: 24px;
        }

        .pump-card {
            border: 1px solid var(--md-outline-variant);
            border-radius: var(--md-border-radius-large);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 24px;
            box-shadow: var(--md-shadow);
            overflow: hidden;
        }

        .pump-card.selected {
            border-color: var(--md-outline-variant);
            box-shadow: var(--md-shadow-elevated);
            transform: translateY(-2px);
        }

        /* Professional efficiency indicators */
        .efficiency-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .efficiency-excellent {
            background: var(--gradient-success);
            color: white;
        }

        .efficiency-good {
            background: var(--gradient-info);
            color: white;
        }

        .efficiency-acceptable {
            background: var(--gradient-warning);
            color: #333;
        }

        .efficiency-poor {
            background: var(--gradient-danger);
            color: white;
        }

        /* Progress bars for suitability scoring */
        .suitability-progress {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            height: 24px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        .suitability-progress-bar {
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.85rem;
            border-radius: 10px;
            transition: width 0.8s ease-in-out;
        }

        /* Enhanced card headers with professional styling */
        .card-header-professional {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 24px;
            border: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
        }

        /* Enhanced specification tables */
        .specification-table {
            margin: 0;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: var(--md-border-radius);
            overflow: hidden;
            box-shadow: var(--md-shadow);
        }

        .specification-table th {
            background: var(--md-primary);
            color: white;
            padding: 16px;
            font-weight: 600;
            text-align: left;
            border: none;
            position: relative;
        }

        .specification-table td {
            padding: 16px;
            border-bottom: 1px solid var(--md-outline-variant);
            background: white;
            transition: background-color 0.3s ease;
        }

        .specification-table tr:hover td {
            background: var(--md-surface-variant);
        }

        .specification-table tr:last-child td {
            border-bottom: none;
        }

        /* Professional metric displays */
        .metric-display {
            text-align: center;
            padding: 24px;
            background: white;
            border-radius: var(--md-border-radius);
            box-shadow: var(--md-shadow);
            border: 1px solid var(--md-outline-variant);
            transition: all 0.3s ease;
        }

        .metric-display:hover {
            transform: translateY(-2px);
            box-shadow: var(--md-shadow-elevated);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--md-primary);
            margin-bottom: 8px;
            display: block;
        }

        .metric-unit {
            font-size: 1rem;
            color: #666;
            font-weight: 400;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 8px;
        }

        /* Enhanced recommendation badges */
        .recommendation-badge {
            display: inline-flex;
            align-items: center;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .recommendation-badge.recommended {
            background: var(--gradient-success);
            color: white;
        }

        .recommendation-badge.alternative {
            background: var(--gradient-warning);
            color: #333;
        }

        .recommendation-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .recommendation-badge:hover::before {
            left: 100%;
        }

        /* Alternative pump card hover effects */
        .alternative-pump:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3);
        }
        .report-header {
            background: linear-gradient(135deg, var(--md-primary), var(--md-primary-variant));
            color: white;
            padding: 32px;
            border-radius: var(--md-border-radius);
            margin-bottom: 24px;
        }
        .performance-metric {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .alert-info, .alert-success, .alert-warning {
            background-color: #f8f9fa !important;
            border: 1px solid #dee2e6 !important;
            color: #495057 !important;
        }
        .text-primary { color: #495057 !important; }
        .text-info { color: #6c757d !important; }
        .text-success { color: #495057 !important; }
        .text-warning { color: #6c757d !important; }
        .btn-outline-primary {
            color: #495057;
            border-color: #495057;
        }
        .btn-outline-primary:hover {
            background-color: #495057;
            border-color: #495057;
        }
        .performance-badge {
            font-size: 0.875rem;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            background: var(--md-secondary);
            color: white;
        }

        /* Enhanced BEP Analysis badge styling with proper padding */
        .performance-metric .badge {
            font-size: 0.875rem;
            padding: 10px 16px !important;
            border-radius: 6px;
            font-weight: 500;
            display: inline-block;
            text-align: center;
            min-width: 120px;
            line-height: 1.2;
            margin-left: 0 !important;
        }

        .chart-container {
            background: var(--md-surface);
            border-radius: var(--md-border-radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--md-shadow);
            border: 1px solid var(--md-outline-variant);
        }

        .pdf-download-section {
            background: var(--md-surface-variant);
            border-radius: var(--md-border-radius-large);
            padding: 32px;
            text-align: center;
            margin: 32px 0;
            border: 1px solid var(--md-outline-variant);
            box-shadow: var(--md-shadow);
        }
        .btn-download-pdf {
            background: var(--md-secondary);
            border: none;
            padding: 16px 32px;
            font-size: 1.1rem;
            font-weight: 500;
            border-radius: 24px;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--md-shadow);
            text-transform: none;
        }

        .btn-download-pdf:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: var(--md-shadow-elevated);
            color: white;
        }
        .specification-table th {
            background-color: var(--md-surface-variant);
            border-top: none;
            font-weight: 500;
            color: var(--md-primary);
        }

        .reasoning-section {
            background: var(--md-surface-variant);
            border-left: 4px solid var(--md-primary);
            padding: 24px;
            margin: 24px 0;
            border-radius: 0 var(--md-border-radius) var(--md-border-radius) 0;
            box-shadow: var(--md-shadow);
        }

        /* Responsive improvements */
        @media (max-width: 768px) {
            .ape-header {
                padding: 32px 0;
            }

            .chart-container {
                padding: 16px;
                margin-bottom: 16px;
            }

            .pdf-download-section {
                padding: 24px 16px;
                margin: 24px 0;
            }

            .btn-download-pdf {
                width: 100%;
                margin-top: 16px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }
        }

/* Section Headers */
        .section-header {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 12px 12px 0 0;
            margin: 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
        }
    </style>
</head>
<body>

<!-- Direct Selection Warning Banner -->
{% if direct_selection_validation and direct_selection_validation.is_direct_selection %}
<div class="alert alert-warning alert-dismissible fade show direct-selection-banner" role="alert" style="margin: 0; border-radius: 0; border-left: 4px solid #ffc107;">
    <div class="container" style="max-width: 1400px;">
        <div class="row align-items-center">
            <div class="col-auto">
                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
            </div>
            <div class="col">
                <h5 class="alert-heading mb-1">
                    <i class="fas fa-hand-paper me-2"></i>Direct Pump Selection Notice
                </h5>
                <p class="mb-1">
                    <strong>This report analyzes a directly selected pump, bypassing our optimization algorithm.</strong>
                </p>
                <div class="small">
                    {% if direct_selection_validation.is_optimal_choice %}
                        <span class="badge bg-success me-2">
                            <i class="fas fa-check-circle me-1"></i>Good Choice
                        </span>
                        This pump ranked #{{ direct_selection_validation.optimal_rank }} in our optimization results.
                    {% elif not direct_selection_validation.is_efficient %}
                        <span class="badge bg-danger me-2">
                            <i class="fas fa-exclamation-circle me-1"></i>Low Efficiency
                        </span>
                        Operating at {{ "%.1f"|format(direct_selection_validation.efficiency_pct) }}% efficiency - consider alternatives.
                    {% else %}
                        <span class="badge bg-warning me-2">
                            <i class="fas fa-info-circle me-1"></i>Sub-Optimal
                        </span>
                        {% if direct_selection_validation.best_alternative_code %}
                            Better option available: <strong>{{ direct_selection_validation.best_alternative_code }}</strong> 
                            ({{ "%.1f"|format(direct_selection_validation.best_alternative_efficiency) }}% efficiency)
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('main_flow.index') }}" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-search me-1"></i>Run Optimization
                </a>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<div class="container-fluid" style="max-width: 1400px; margin: 0 auto; padding: 0 24px;">
    <div class="row">
        <div class="col-12">
            <!-- Navigation Bar -->
            <nav class="navbar navbar-expand-lg" style="background: var(--md-surface); border-bottom: 1px solid var(--md-outline-variant); padding: 16px 0; margin-bottom: 24px;">
                <div class="container-fluid">
                    <a class="btn btn-secondary" 
                        href="{{ url_for('main_flow.index') }}">
                        <i class="fas fa-arrow-left"></i> Back to Selection
                    </a>
                    <span class="navbar-text" style="color: var(--md-primary); font-weight: 500; font-size: 0.9rem;">
                        Report ID: APE-{{ current_date.replace('-', '') }}-{{ selected_pump.get('pump_code', '').replace('/', '').replace(' ', '') }}
                    </span>
                </div>
            </nav>

            <!-- Professional Report Header -->
            <div class="report-header" style="background: linear-gradient(135deg, var(--md-primary), var(--md-primary-variant)); color: white; padding: 48px 40px; border-radius: var(--md-border-radius-large); margin-bottom: 32px; box-shadow: var(--md-shadow-elevated);">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <h1 style="font-weight: 300; font-size: 2.8rem; margin-bottom: 32px; color: white;">Pump Selection Report</h1>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <p style="font-size: 1.1rem; margin-bottom: 12px; opacity: 0.95;"><strong>Project:</strong> {{ site_requirements.get('project_name', 'Water Supply System Project') }}</p>
                                    <p style="font-size: 1.1rem; margin-bottom: 12px; opacity: 0.95;"><strong>Date:</strong> {{ current_date }}</p>
                                    <p style="font-size: 1.1rem; margin-bottom: 0; opacity: 0.95;"><strong>Prepared By:</strong> AI Pump Selection Assistant</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <p style="font-size: 1.1rem; margin-bottom: 12px; opacity: 0.95;"><strong>Prepared For:</strong> {{ site_requirements.get('customer_name', 'Client Contact') }}</p>
                                    <p style="font-size: 1.1rem; margin-bottom: 12px; opacity: 0.95;"><strong>Application:</strong> {{ site_requirements.get('application', 'Water Supply') }}</p>
                                    <p style="font-size: 1.1rem; margin-bottom: 0; opacity: 0.95;"><strong>Report ID:</strong> APE-{{ current_date.replace('-', '') }}-{{ selected_pump.get('pump_code', 'N/A').replace('/', '').replace(' ', '') }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-end ms-5">
                        <div class="d-flex flex-column gap-3 align-items-end">
                            <a href="{{ url_for('reports.generate_pdf', pump_code=selected_pump_code) }}?flow={{ site_requirements.get("flow_m3hr", 0) }}&head={{ site_requirements.get("head_m", 0) }}" 
                               class="btn" style="background: white; color: var(--md-primary); border: none; padding: 16px 32px; font-size: 1.1rem; font-weight: 600; border-radius: 12px; text-decoration: none; display: flex; align-items: center; gap: 12px; box-shadow: var(--md-shadow);">
                                <i class="fas fa-download"></i>Download PDF Report
                            </a>
                            <a href="{{ url_for('comparison.pump_comparison', flow=site_requirements.get("flow_m3hr", 0), head=site_requirements.get("head_m", 0), pump_type=site_requirements.get("pump_type", "General") or 'General') }}" 
                               class="btn" style="background: var(--md-primary); color: white; border: none; padding: 16px 32px; font-size: 1.1rem; font-weight: 600; border-radius: 12px; text-decoration: none; display: flex; align-items: center; gap: 12px; box-shadow: var(--md-shadow);">
                                <i class="fas fa-balance-scale"></i>View Comparison
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Site Requirements Summary -->
            <div class="row" style="margin-bottom: 32px;">
                <div class="col-12">
                    <div class="card" style="border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); border: 1px solid var(--md-outline-variant);">
                        <div class="card-body" style="padding: 32px;">
                            <h5 style="color: var(--md-primary); font-weight: 500; margin-bottom: 24px; display: flex; align-items: center;">
                                <i class="material-icons" style="margin-right: 12px; color: var(--md-primary);">assignment</i>
                                System Requirements
                            </h5>
                            <div class="row">
                                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                    <div class="requirement-metric" style="text-align: center; padding: 20px; background: var(--md-surface-variant); border-radius: var(--md-border-radius); border: 1px solid var(--md-outline-variant);">
                                        <div style="color: #666; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Flow Rate</div>
                                        <div style="color: var(--md-primary); font-size: 24px; font-weight: 600;">{{ site_requirements.get("flow_m3hr", 0) }} <span style="font-size: 16px; font-weight: 400;">m³/hr</span></div>
                                    </div>
                                </div>
                                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                    <div class="requirement-metric" style="text-align: center; padding: 20px; background: var(--md-surface-variant); border-radius: var(--md-border-radius); border: 1px solid var(--md-outline-variant);">
                                        <div style="color: #666; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Total Head</div>
                                        <div style="color: var(--md-primary); font-size: 24px; font-weight: 600;">{{ site_requirements.get("head_m", 0) }} <span style="font-size: 16px; font-weight: 400;">m</span></div>
                                    </div>
                                </div>
                                {% if site_requirements.get("customer_name", "Client") %}
                                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                    <div class="requirement-metric" style="text-align: center; padding: 20px; background: var(--md-surface-variant); border-radius: var(--md-border-radius); border: 1px solid var(--md-outline-variant);">
                                        <div style="color: #666; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Customer</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">{{ site_requirements.get("customer_name", "Client") }}</div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if site_requirements.get("project_name", "Project") %}
                                <div class="col-lg-3 col-md-6 col-sm-6 mb-3">
                                    <div class="requirement-metric" style="text-align: center; padding: 20px; background: var(--md-surface-variant); border-radius: var(--md-border-radius); border: 1px solid var(--md-outline-variant);">
                                        <div style="color: #666; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Project</div>
                                        <div style="color: #333; font-size: 16px; font-weight: 500;">{{ site_requirements.get("project_name", "Project") }}</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selection Process Transparency -->
            {% if exclusion_data %}
            <div class="row" style="margin-bottom: 32px;">
                <div class="col-12">
                    <div class="card" style="border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); border: 1px solid var(--md-outline-variant);">
                        <div class="card-body" style="padding: 32px;">
                            <h5 style="color: var(--md-primary); font-weight: 500; margin-bottom: 24px; display: flex; align-items: center;">
                                <i class="material-icons" style="margin-right: 12px; color: var(--md-primary);">filter_list</i>
                                Selection Process Transparency
                            </h5>
                            
                            <!-- Overview Statistics -->
                            <div class="row mb-4">
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="metric-display" style="background: #e3f2fd; padding: 20px; border-radius: 12px; text-align: center;">
                                        <div style="font-size: 32px; font-weight: 600; color: #1976d2;">{{ exclusion_data.total_evaluated or 386 }}</div>
                                        <div style="color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Total Pumps Evaluated</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="metric-display" style="background: #e8f5e9; padding: 20px; border-radius: 12px; text-align: center;">
                                        <div style="font-size: 32px; font-weight: 600; color: #388e3c;">{{ exclusion_data.feasible_count or 0 }}</div>
                                        <div style="color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Physically Feasible</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="metric-display" style="background: #fff3e0; padding: 20px; border-radius: 12px; text-align: center;">
                                        <div style="font-size: 32px; font-weight: 600; color: #f57c00;">{{ exclusion_data.excluded_count or 0 }}</div>
                                        <div style="color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Excluded</div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <div class="metric-display" style="background: #f3e5f5; padding: 20px; border-radius: 12px; text-align: center;">
                                        <div style="font-size: 32px; font-weight: 600; color: #7b1fa2;">{{ exclusion_data.suitable_pumps_count or 0 }}</div>
                                        <div style="color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">Top Recommendations</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Exclusion Reasons Breakdown -->
                            {% if exclusion_data.exclusion_summary %}
                            <h6 style="color: #666; font-weight: 500; margin-top: 32px; margin-bottom: 16px;">Exclusion Reasons:</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th style="color: #666;">Reason</th>
                                            <th style="color: #666; text-align: right;">Count</th>
                                            <th style="color: #666; text-align: right;">Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for reason, count in exclusion_data.exclusion_summary.items() %}
                                        <tr>
                                            <td>
                                                {% if reason == 'no_performance_data' %}
                                                    <i class="fas fa-database text-danger me-2"></i>No Performance Data
                                                {% elif reason == 'below_min_speed' %}
                                                    <i class="fas fa-tachometer-alt text-warning me-2"></i>Below Minimum Speed
                                                {% elif reason == 'above_max_speed' %}
                                                    <i class="fas fa-tachometer-alt text-warning me-2"></i>Above Maximum Speed
                                                {% elif reason == 'efficiency_too_low' %}
                                                    <i class="fas fa-chart-line text-danger me-2"></i>Efficiency Below Threshold
                                                {% elif reason == 'insufficient_head' %}
                                                    <i class="fas fa-arrow-down text-danger me-2"></i>Insufficient Head
                                                {% elif reason == 'excessive_head' %}
                                                    <i class="fas fa-arrow-up text-warning me-2"></i>Excessive Head
                                                {% elif reason == 'undertrim' %}
                                                    <i class="fas fa-compress text-warning me-2"></i>Impeller Undertrim
                                                {% elif reason == 'overtrim' %}
                                                    <i class="fas fa-expand text-warning me-2"></i>Impeller Overtrim
                                                {% else %}
                                                    <i class="fas fa-times-circle text-muted me-2"></i>{{ reason|replace('_', ' ')|title }}
                                                {% endif %}
                                            </td>
                                            <td style="text-align: right;">{{ count }}</td>
                                            <td style="text-align: right;">{{ "%.1f"|format((count / exclusion_data.excluded_count * 100) if exclusion_data.excluded_count > 0 else 0) }}%</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Enhanced Scoring Breakdown for Selected Pump -->
            {% if selected_pump %}
            <div class="row" style="margin-bottom: 32px;">
                <div class="col-12">
                    <div class="card" style="border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); border: 1px solid var(--md-outline-variant);">
                        <div class="card-body" style="padding: 32px;">
                            <h5 style="color: var(--md-primary); font-weight: 500; margin-bottom: 24px; display: flex; align-items: center;">
                                <i class="fas fa-chart-line" style="margin-right: 12px; color: var(--md-primary);"></i>
                                Performance Score Breakdown
                            </h5>
                            
                            <!-- Overall Score Display -->
                            <div class="text-center mb-4">
                                <div style="display: inline-block; width: 120px; height: 120px; border-radius: 50%; background: linear-gradient(135deg, #1976d2, #1565c0); color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 16px rgba(25,118,210,0.3); position: relative;">
                                    <div>
                                        <div style="font-size: 3rem; font-weight: 700;">{{ "%.0f"|format(selected_pump.get('suitability_score', 0)) }}</div>
                                        <div style="font-size: 1rem; opacity: 0.9;">/100</div>
                                    </div>
                                </div>
                                <div style="margin-top: 16px; font-size: 1.1rem; color: #666;">Overall Selection Score</div>
                            </div>
                            
                            <!-- Individual Score Components with Progress Bars -->
                            <div style="background: #f8f9fa; padding: 24px; border-radius: 12px; border: 1px solid #e9ecef;">
                                <!-- BEP Proximity Score -->
                                <div class="score-component mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: 600; color: #495057;">
                                            <i class="fas fa-bullseye text-primary" style="margin-right: 8px;"></i>BEP Proximity
                                        </span>
                                        <span style="font-weight: bold; color: #212529;">
                                            {{ "%.1f"|format((selected_pump.get('bep_score', 0))|float) }}/40
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 10px; background-color: #e0e0e0;">
                                        <div class="determinate blue" 
                                             style="width: {{ (selected_pump.get('bep_score', 0) / 40 * 100)|float }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">Reliability factor - proximity to Best Efficiency Point</small>
                                </div>

                                <!-- Efficiency Score -->
                                <div class="score-component mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: 600; color: #495057;">
                                            <i class="fas fa-tachometer-alt text-success" style="margin-right: 8px;"></i>Efficiency
                                        </span>
                                        <span style="font-weight: bold; color: #212529;">
                                            {{ "%.1f"|format((selected_pump.get('efficiency_score', 0))|float) }}/30
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 10px; background-color: #e0e0e0;">
                                        <div class="determinate green" 
                                             style="width: {{ (selected_pump.get('efficiency_score', 0) / 30 * 100)|float }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">Operating cost factor - efficiency at duty point</small>
                                </div>

                                <!-- Head Margin Score -->
                                <div class="score-component mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: 600; color: #495057;">
                                            <i class="fas fa-ruler-vertical text-info" style="margin-right: 8px;"></i>Head Margin
                                        </span>
                                        <span style="font-weight: bold; color: #212529;">
                                            {{ "%.1f"|format((selected_pump.get('margin_score', 0))|float) }}/15
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 10px; background-color: #e0e0e0;">
                                        <div class="determinate teal" 
                                             style="width: {{ (selected_pump.get('margin_score', 0) / 15 * 100)|float }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">Right-sizing factor - optimal head delivery margin</small>
                                </div>

                                <!-- NPSH Score -->
                                <div class="score-component mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span style="font-weight: 600; color: #495057;">
                                            <i class="fas fa-water text-warning" style="margin-right: 8px;"></i>NPSH Margin
                                        </span>
                                        <span style="font-weight: bold; color: #212529;">
                                            {{ "%.1f"|format((selected_pump.get('npsh_score', 0))|float) }}/15
                                        </span>
                                    </div>
                                    <div class="progress" style="height: 10px; background-color: #e0e0e0;">
                                        <div class="determinate orange" 
                                             style="width: {{ (selected_pump.get('npsh_score', 0) / 15 * 100)|float }}%">
                                        </div>
                                    </div>
                                    <small class="text-muted">Cavitation risk factor - NPSH requirements</small>
                                </div>

                                <!-- Penalties Section -->
                                {% if selected_pump.get('speed_penalty', 0) > 0 or selected_pump.get('sizing_penalty', 0) > 0 %}
                                <div class="mt-4 pt-3 border-top" style="background: #fff5f5; margin: -12px -24px -24px; padding: 16px 24px; border-radius: 0 0 12px 12px;">
                                    <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle"></i> Modifications & Penalties</h6>
                                    {% if selected_pump.get('speed_penalty', 0) > 0 %}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-danger">
                                            <i class="fas fa-tachometer-alt"></i> Speed Variation Required
                                        </span>
                                        <span class="text-danger font-weight-bold">
                                            -{{ "%.1f"|format(selected_pump.get('speed_penalty', 0)|float) }} points
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% if selected_pump.get('sizing_penalty', 0) > 0 %}
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="text-danger">
                                            <i class="fas fa-cut"></i> Impeller Trimming Required
                                        </span>
                                        <span class="text-danger font-weight-bold">
                                            -{{ "%.1f"|format(selected_pump.get('sizing_penalty', 0)|float) }} points
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>

                            <!-- Operating Zone Indicator -->
                            {% if selected_pump.get('operating_zone') %}
                            <div class="text-center mt-4">
                                <span class="text-muted">Operating Zone:</span>
                                <span class="badge ms-2" style="padding: 8px 16px; font-size: 0.9rem;
                                    {% if 'optimal' in selected_pump.get('operating_zone', '').lower() %}background: #4caf50; color: white;
                                    {% elif 'good' in selected_pump.get('operating_zone', '').lower() %}background: #2196f3; color: white;
                                    {% elif 'acceptable' in selected_pump.get('operating_zone', '').lower() %}background: #03a9f4; color: white;
                                    {% else %}background: #ff9800; color: white;{% endif %}">
                                    {{ selected_pump.get('operating_zone', 'Unknown') }}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 1. Selected Pump Summary -->
            <div class="card mb-4 pump-card selected">
                <div class="card-header-professional" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 24px; border: none; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem; z-index: 1; position: relative;">
                        <i class="fas fa-star me-2"></i>1. Selected Pump Summary
                        {% if selected_pump.get('efficiency_rating') %}
                            <span class="efficiency-indicator {{ selected_pump.get('efficiency_rating', {}).get('class', '') }} float-end">
                                <i class="fas fa-check-circle me-1"></i>{{ selected_pump.get('efficiency_rating', {}).get('label', '') }}
                            </span>
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body" style="padding: 32px;">
                    <!-- Recommendation Badge -->
                    <div class="text-center mb-4">
                        <div class="recommendation-badge recommended">
                            <i class="fas fa-award me-2"></i>RECOMMENDED SELECTION
                        </div>
                    </div>

                    <!-- Suitability Score Progress Bar -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="mb-2" style="color: var(--md-primary); font-weight: 600;">Overall Suitability Score</h6>
                            <div class="suitability-progress">
                                {% set score = selected_pump.get('suitability_score', 0) %}
                                <div class="suitability-progress-bar {{ selected_pump.get('score_classification', {}).get('class', 'bg-secondary') }}" 
                                     style="width: {{ score }}%;">
                                    {{ "%.0f"|format(score) }}%
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Specification Tables -->
                    <div class="row">
                        <div class="col-md-6">
                            <table class="specification-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50%;">Parameter</th>
                                        <th style="width: 50%;">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Manufacturer</strong></td>
                                        <td>{{ selected_pump.get('manufacturer', 'APE Pumps') }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Pump Model</strong></td>
                                        <td><strong style="color: var(--md-primary);">{{ selected_pump.get('pump_code', 'N/A') }}</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Pump Type</strong></td>
                                        <td>{{ selected_pump.get('pump_type', 'Centrifugal') }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Pump Range</strong></td>
                                        <td>{{ selected_pump.get('model_series', 'Industrial') }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="specification-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50%;">Parameter</th>
                                        <th style="width: 50%;">Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Pump Speed</strong></td>
                                        <td>2900 RPM</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Impeller Diameter</strong></td>
                                        <td><strong style="color: var(--md-primary);">{{ selected_pump.get('impeller_diameter_mm', 187) }}mm</strong></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Application</strong></td>
                                        <td>{{ site_requirements.get('application', 'Water Supply') }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>No of Stages</strong></td>
                                        <td>{{ selected_pump.get('stages', '1') }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. Duty Point Requirements -->
            <div class="card mb-4 pump-card">
                <div class="card-header-professional" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 24px; border: none; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem; z-index: 1; position: relative;">
                        <i class="fas fa-bullseye me-2"></i>2. Duty Point Requirements
                    </h4>
                </div>
                <div class="card-body" style="padding: 32px;">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="metric-display">
                                <span class="metric-value">{{ site_requirements.get('flow_m3hr', 0) }}</span>
                                <span class="metric-unit">m³/hr</span>
                                <div class="metric-label">Required Flow Rate</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-display">
                                <span class="metric-value">{{ site_requirements.get('head_m', 0) }}</span>
                                <span class="metric-unit">m</span>
                                <div class="metric-label">Total Head</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="metric-display">
                                <span class="metric-value" style="font-size: 1.8rem;">{{ site_requirements.get('fluid_type', 'Water') }}</span>
                                <span class="metric-unit">Type</span>
                                <div class="metric-label">Fluid</div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Achievement Summary -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div style="background: var(--md-surface-variant); padding: 24px; border-radius: var(--md-border-radius); border: 1px solid var(--md-outline-variant);">
                                <h6 style="color: var(--md-primary); margin-bottom: 16px; font-weight: 600;">
                                    <i class="fas fa-check-circle me-2"></i>Performance Achievement
                                </h6>
                                <div class="row text-center">
                                    <div class="col-md-2">
                                        <div class="metric-achievement">
                                            <strong style="color: var(--md-primary); font-size: 1.5rem;">{{ site_requirements.get('flow_m3hr', 0) }}</strong>
                                            <div style="font-size: 0.9rem; color: #666;">Flow (m³/hr)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="metric-achievement">
                                            <strong style="color: var(--md-primary); font-size: 1.5rem;">{{ site_requirements.get('head_m', 0) }}</strong>
                                            <div style="font-size: 0.9rem; color: #666;">Head (m)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="metric-achievement">
                                            <strong style="color: var(--efficiency-excellent); font-size: 1.5rem;">{{ "%.1f"|format(selected_pump.get('efficiency_pct', 0)|float) }}%</strong>
                                            <div style="font-size: 0.9rem; color: #666;">Efficiency</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="metric-achievement">
                                            <strong style="color: var(--md-primary); font-size: 1.5rem;">{{ "%.1f"|format(selected_pump.get('power_kw', 0)|float) }}</strong>
                                            <div style="font-size: 0.9rem; color: #666;">Power (kW)</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="metric-achievement">
                                            <strong style="color: #1976d2; font-size: 1.5rem;">
                                                {% if selected_pump.get('qbep_percentage') %}
                                                    {{ "%.0f"|format(selected_pump.get('qbep_percentage')) }}%
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </strong>
                                            <div style="font-size: 0.9rem; color: #666;">QBEP</div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="metric-achievement">
                                            <strong style="color: #1976d2; font-size: 1.5rem;">{{ selected_pump.get('impeller_diameter_mm', 187)|round(0) }}</strong>
                                            <div style="font-size: 0.9rem; color: #666;">Impeller (mm)</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Best Efficiency Point (BEP) Analysis -->
            <div class="card mb-4 pump-card">
                <div class="card-header-professional" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 24px; border: none; box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem; z-index: 1; position: relative;">
                        <i class="fas fa-chart-area me-2"></i>3. Best Efficiency Point (BEP) Analysis
                    </h4>
                </div>
                <div class="card-body" style="padding: 32px;">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <strong>BEP Position:</strong>
                                {% if selected_pump.get('qbep_percentage') %}
                                <div class="mt-2">
                                    <span class="badge bg-primary ms-2" style="font-size: 1.1rem;">
                                        {{ "%.1f"|format(selected_pump.get('qbep_percentage')) }}% of QBEP
                                    </span>
                                </div>
                                <small class="text-muted">Operating flow vs BEP flow</small>
                                {% else %}
                                <div class="mt-2">
                                    <span class="badge bg-secondary ms-2">BEP Data N/A</span>
                                </div>
                                <small class="text-muted">BEP calculation unavailable</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <strong>Operating Zone:</strong>
                                <div class="mt-2">
                                    <span class="badge bg-{{ selected_pump.get('bep_zone_color', 'secondary') }} ms-2">
                                        {{ selected_pump.get('bep_zone_label', 'Unknown') }}
                                    </span>
                                </div>
                                <small class="text-muted">Preferred range: 70-120% QBEP</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <strong>Impeller Configuration:</strong>
                                <div class="mt-2">
                                    <span class="badge bg-info ms-2" style="font-size: 1.1rem;">
                                        {{ selected_pump.get('impeller_diameter_mm', 187)|round(0) }}mm
                                    </span>
                                    {% if selected_pump.get('sizing_info', {}).get('trim_percent') %}
                                        <span class="badge bg-secondary ms-1">
                                            {{ selected_pump.get('sizing_info', {}).get('trim_percent')|round(0) }}% trim
                                        </span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">Selected impeller size</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="performance-metric">
                                <strong>Efficiency Rating:</strong>
                                <div class="mt-2">
                                    {% set eff_pct = selected_pump.get('efficiency_pct', 0) %}
                                    {% if eff_pct >= 80 %}
                                    <span class="badge bg-success ms-2">Excellent ({{ eff_pct|round(1) }}%)</span>
                                    {% elif eff_pct >= 70 %}
                                    <span class="badge bg-info ms-2">Good ({{ eff_pct|round(1) }}%)</span>
                                    {% elif eff_pct >= 60 %}
                                    <span class="badge bg-warning ms-2">Acceptable ({{ eff_pct|round(1) }}%)</span>
                                    {% else %}
                                    <span class="badge bg-danger ms-2">Poor ({{ eff_pct|round(1) }}%)</span>
                                    {% endif %}
                                </div>
                                <small class="text-muted">At operating point</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BEP Operating Range Visual Indicator -->
                    {% if selected_pump.get('qbep_percentage') %}
                    <div class="mt-4">
                        <strong style="color: #1976d2;">BEP Operating Range Indicator:</strong>
                        <div class="position-relative mt-2" style="height: 40px; background: #f5f5f5; border-radius: 20px; overflow: hidden;">
                            <!-- Marginal zones -->
                            <div class="position-absolute" style="left: 0; width: 20%; height: 100%; background: #ffcdd2;"></div>
                            <div class="position-absolute" style="right: 0; width: 20%; height: 100%; background: #ffcdd2;"></div>
                            
                            <!-- Good zones -->
                            <div class="position-absolute" style="left: 20%; width: 10%; height: 100%; background: #fff3e0;"></div>
                            <div class="position-absolute" style="right: 20%; width: 10%; height: 100%; background: #fff3e0;"></div>
                            
                            <!-- Optimal zone -->
                            <div class="position-absolute" style="left: 30%; width: 40%; height: 100%; background: #c8e6c9;"></div>
                            
                            <!-- Zone labels -->
                            <div class="position-absolute w-100 h-100 d-flex align-items-center justify-content-between" style="padding: 0 10px; font-size: 0.75rem;">
                                <span>0%</span>
                                <span style="position: absolute; left: 20%;">70%</span>
                                <span style="position: absolute; left: 30%;">90%</span>
                                <span style="position: absolute; left: 70%;">110%</span>
                                <span style="position: absolute; left: 80%;">120%</span>
                                <span style="position: absolute; right: 10px;">150%</span>
                            </div>
                            
                            <!-- Operating point marker -->
                            {% if selected_pump.get('marker_position') %}
                            <div class="bep-marker" style="left: {{ selected_pump.get('marker_position') }}%;">
                                <div class="bep-marker-arrow"></div>
                                <div class="bep-marker-label">
                                    {{ "%.0f"|format(selected_pump.get('qbep_percentage')) }}%
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <span style="color: #c8e6c9;">■</span> Optimal (90-110%) &nbsp;
                                <span style="color: #fff3e0;">■</span> Good (70-90%, 110-120%) &nbsp;
                                <span style="color: #ffcdd2;">■</span> Marginal (<70%, >120%)
                            </small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- 4. Alternative Pump Options -->
            {% if alternatives and alternatives|length > 0 %}
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: #fff; padding: 24px; border: none;">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem; display: flex; align-items: center;">
                        <i class="fas fa-balance-scale" style="margin-right: 12px; color: #fff;"></i>
                        4. Alternative Pump Options
                    </h4>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <p class="mb-4" style="color: #666; line-height: 1.6;">
                        The following alternative pumps also meet your requirements but may have different characteristics or performance profiles:
                    </p>

                    <div class="row g-3">
                        {% for alternative in alternatives %}
                        <div class="col-md-4">
                            <div class="card alternative-pump" style="border: 2px solid #6c757d; border-radius: var(--md-border-radius); box-shadow: var(--md-shadow); opacity: 0.9; position: relative; transition: all 0.3s ease; background: rgba(108, 117, 125, 0.03);">
                                <!-- Alternative Badge -->
                                <div style="position: absolute; top: -10px; right: 15px; background: #6c757d; color: #fff; padding: 4px 12px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; z-index: 10;">
                                    Alternative
                                </div>

                                <div class="card-body" style="padding: 20px;">
                                    <h6 class="card-title" style="color: var(--md-primary); font-weight: 600; margin-bottom: 16px;">
                                        {{ alternative.get('pump_code', 'N/A') }}
                                    </h6>

                                    <!-- Efficiency Indicator -->
                                    <div class="mb-3">
                                        {% set alt_efficiency = alternative.get('efficiency_at_duty', 0) %}
                                        {% set alt_efficiency_rating = alternative.get('efficiency_rating') %}
                                        {% if alt_efficiency_rating %}
                                            <span class="efficiency-indicator {{ alt_efficiency_rating.badge_class }} alternative-badge">
                                                <i class="fas fa-check-circle me-1"></i>{{ "%.1f"|format(alt_efficiency) }}%
                                            </span>
                                        {% else %}
                                            {% if alt_efficiency >= 80 %}
                                                <span class="efficiency-indicator bg-success alternative-badge">
                                                    <i class="fas fa-check-circle me-1"></i>{{ "%.1f"|format(alt_efficiency) }}%
                                                </span>
                                            {% elif alt_efficiency >= 70 %}
                                                <span class="efficiency-indicator bg-info alternative-badge">
                                                    <i class="fas fa-thumbs-up me-1"></i>{{ "%.1f"|format(alt_efficiency) }}%
                                                </span>
                                            {% elif alt_efficiency >= 60 %}
                                                <span class="efficiency-indicator bg-warning alternative-badge">
                                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ "%.1f"|format(alt_efficiency) }}%
                                                </span>
                                            {% else %}
                                                <span class="efficiency-indicator bg-danger alternative-badge">
                                                    <i class="fas fa-times-circle me-1"></i>{{ "%.1f"|format(alt_efficiency) }}%
                                                </span>
                                            {% endif %}
                                        {% endif %}
                                    </div>

                                    <!-- Suitability Score -->
                                    <div class="mb-3">
                                        <small class="text-muted">Suitability Score</small>
                                        <div class="suitability-progress" style="height: 20px; margin-top: 4px;">
                                            {% set alt_score = alternative.get('suitability_score', 0) %}
                                            <div class="suitability-progress-bar alternative-score-bar
                                                        {% if alt_score >= 90 %}bg-success{% elif alt_score >= 80 %}bg-info{% elif alt_score >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                                 style="width: {{ alt_score }}%; height: 100%; font-size: 0.75rem;">
                                                {{ "%.0f"|format(alt_score) }}%
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Key Specifications -->
                                    <div class="small text-muted mb-3">
                                        <div><strong>Manufacturer:</strong> {{ alternative.get('manufacturer', 'APE PUMPS') }}</div>
                                        {% if alternative.get('performance', {}).get('power_kw') %}
                                        <div><strong>Power:</strong> {{ "%.1f"|format(alternative.get('performance', {}).get('power_kw')) }} kW</div>
                                        {% endif %}
                                        {% if alternative.get('performance', {}).get('npshr_m') %}
                                        <div><strong>NPSHr:</strong> {{ "%.1f"|format(alternative.get('performance', {}).get('npshr_m')) }} m</div>
                                        {% endif %}
                                    </div>

                                    <!-- Key Difference -->
                                    <div class="mb-3">
                                        <small class="text-primary"><strong>Key Difference:</strong></small>
                                        <small class="d-block text-muted">{{ alternative.get('key_difference', 'Alternative pump option') }}</small>
                                    </div>

                                    <!-- View Report Button -->
                                    <a href="{{ url_for('reports.pump_report', pump_code=alternative.get('pump_code')) }}?flow={{ site_requirements.get("flow_m3hr", 0) }}&head={{ site_requirements.get("head_m", 0) }}&pump_type={{ site_requirements.get("pump_type", "General") }}" 
                                       class="btn btn-outline-warning btn-sm w-100" style="border-color: #ffc107; color: #333;">
                                        <i class="fas fa-eye me-1"></i>View Report
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mt-4 p-3" style="background: #fff3cd; border-radius: var(--md-border-radius); border: 1px solid #ffeaa7;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle text-warning me-2"></i>
                            <small class="text-dark">
                                <strong>Note:</strong> Alternative pumps shown have reduced prominence to highlight the recommended selection. 
                                All alternatives can meet your requirements but may have different efficiency profiles or operational characteristics.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 5. Performance Characteristics -->

            <!-- Performance Charts Section -->
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; padding: 24px; border: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0" style="font-weight: 600;">
                            <i class="fas fa-chart-line me-2"></i>
                            5. Interactive Performance Analysis
                        </h4>
                        <div class="chart-controls">
                            <button class="btn btn-sm btn-outline-light me-2" onclick="toggleChartGrid()" title="Toggle Grid">
                                <i class="fas fa-th"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light me-2" onclick="resetChartZoom()" title="Reset Zoom">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="downloadChartsAsPNG()" title="Download Charts">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <p class="mb-0 mt-2" style="opacity: 0.9; font-size: 0.95rem;">
                        Click and drag to zoom • Double-click to reset • Hover for detailed values
                    </p>
                </div>
                <div class="card-body" style="padding: 32px; background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);">
                    <!-- Chart Performance Summary -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border: 1px solid #1976d2; border-radius: 8px;">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-info-circle me-2 text-primary"></i>
                                    <div>
                                        <strong>Operating Point Analysis:</strong> 
                                        The selected pump operates at <strong>{{ (selected_pump.get('performance', {}).get('flow_m3hr', 0))|round(1) }} m³/hr</strong> 
                                        and <strong>{{ (selected_pump.get('performance', {}).get('head_m', 0))|round(1) }} m</strong> head 
                                        with <strong>{{ (selected_pump.get('performance', {}).get('efficiency_pct', 0))|round(1) }}%</strong> efficiency.
                                        {% if selected_pump.get('performance', {}).get('extrapolated') %}
                                        <span class="badge bg-warning ms-2">Extrapolated</span>
                                        {% else %}
                                        <span class="badge bg-success ms-2">Within Curve</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Full-Width Chart Grid -->
                    <div class="row g-4">
                        <!-- Head vs Flow Chart - Full Width -->
                        <div class="col-12 mb-4">
                            <div class="chart-container" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; min-height: 500px;">
                                <div class="chart-header d-flex justify-content-between align-items-center mb-3">
                                    <h6 style="color: #1976d2; margin: 0; font-weight: 600; font-size: 1.2rem;">
                                        <i class="fas fa-arrow-up me-2"></i>Head vs Flow Rate with BEP Operating Range
                                    </h6>
                                    <div class="chart-indicators">
                                        <span class="badge bg-primary">{{ (selected_pump.get('performance', {}).get('head_m', 0))|round(1) }} m</span>
                                        <span class="badge bg-success ms-2">BEP Zone</span>
                                    </div>
                                </div>
                                <div id="head-flow-chart" style="height: 450px; width: 100%; min-height: 450px; background: #fafafa; border: 1px dashed #ccc; display: block !important; position: relative;"></div>
                                <div class="chart-footer mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-triangle-up text-danger me-1"></i>Operating Point
                                        <i class="fas fa-circle text-secondary me-1 ms-3"></i>Performance Curve
                                        <i class="fas fa-square text-success me-1 ms-3"></i>BEP Operating Range (80%-110%)
                                        <i class="fas fa-line-chart text-info me-1 ms-3"></i>System Curve
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Efficiency vs Flow Chart - Full Width -->
                        <div class="col-12 mb-4">
                            <div class="chart-container" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; min-height: 500px;">
                                <div class="chart-header d-flex justify-content-between align-items-center mb-3">
                                    <h6 style="color: #1976d2; margin: 0; font-weight: 600; font-size: 1.2rem;">
                                        <i class="fas fa-percentage me-2"></i>Efficiency vs Flow Rate with BEP Analysis
                                    </h6>
                                    <div class="chart-indicators">
                                        <span class="badge bg-success">{{ selected_pump.get('performance', {}).get('efficiency_pct', 0)|round(1) }}%</span>
                                        <span class="badge bg-info ms-2">BEP: {{ ((selected_pump.get('performance', {}).get('efficiency_pct', 0) or 0) * 1.0)|round(1) }}%</span>
                                    </div>
                                </div>
                                <div id="efficiency-flow-chart" style="height: 450px; width: 100%; min-height: 450px; background: #fafafa; border: 1px dashed #ccc; display: block !important; position: relative;"></div>
                                <div class="chart-footer mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-triangle-up text-danger me-1"></i>Operating Efficiency
                                        <i class="fas fa-circle text-success me-1 ms-3"></i>Efficiency Curve
                                        <i class="fas fa-square text-warning me-1 ms-3"></i>Preferred Operating Zone
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Power Chart - Full Width -->
                        <div class="col-12 mb-4">
                            <div class="chart-container" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; min-height: 500px;">
                                <div class="chart-header d-flex justify-content-between align-items-center mb-3">
                                    <h6 style="color: #1976d2; margin: 0; font-weight: 600; font-size: 1.2rem;">
                                        <i class="fas fa-bolt me-2"></i>Power Consumption vs Flow Rate with System Analysis
                                    </h6>
                                    <div class="chart-indicators">
                                        <span class="badge bg-warning">{{ selected_pump.get('performance', {}).get('power_kw', 0)|round(1) }} kW</span>
                                        <span class="badge bg-secondary ms-2">System Load</span>
                                    </div>
                                </div>
                                <div id="power-flow-chart" style="height: 450px; width: 100%; min-height: 450px; background: #fafafa; border: 1px dashed #ccc; display: block !important; position: relative;"></div>
                                <div class="chart-footer mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-triangle-up text-danger me-1"></i>Operating Point
                                        <i class="fas fa-circle text-info me-1 ms-3"></i>Power Curve
                                        <i class="fas fa-square text-success me-1 ms-3"></i>BEP Operating Range
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- NPSH Chart - Full Width -->
                        <div class="col-12 mb-4">
                            <div class="chart-container" style="background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; min-height: 500px;">
                                <div class="chart-header d-flex justify-content-between align-items-center mb-3">
                                    <h6 style="color: #1976d2; margin: 0; font-weight: 600; font-size: 1.2rem;">
                                        <i class="fas fa-tint me-2"></i>NPSH Required vs Flow Rate with Cavitation Analysis
                                    </h6>
                                    <div class="chart-indicators">
                                        <span class="badge bg-danger">{{ (selected_pump.get('performance', {}).get('npshr_m', 0)|round(1)) if selected_pump.get('performance', {}).get('npshr_m') else 'N/A' }} m</span>
                                        <span class="badge bg-warning ms-2">Cavitation Zone</span>
                                    </div>
                                </div>
                                <div id="npshr-flow-chart" style="height: 450px; width: 100%; min-height: 450px; background: #fafafa; border: 1px dashed #ccc; display: block !important; position: relative;"></div>
                                <div class="chart-footer mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-triangle-up text-danger me-1"></i>NPSH Required
                                        <i class="fas fa-exclamation-triangle text-warning me-1 ms-3"></i>Cavitation Risk
                                        <i class="fas fa-shield-alt text-success me-1 ms-3"></i>Safe Operating Zone
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 5. Performance Analysis & Alignment with Requirements -->
            <div class="card mb-4">
                <div class="card-header" style="background: var(--md-primary); color: white;">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.25rem;">5. Performance Analysis & Alignment with Requirements</h4>
                </div>
                <div class="card-body" style="padding: 32px;">
                    <p class="lead" style="font-size: 1.15rem; line-height: 1.6; color: #333; margin-bottom: 24px;">
                        The {{ selected_pump.get('manufacturer', 'APE Pumps') }} Model 
                        <strong style="color: var(--md-primary);">{{ selected_pump.get('pump_code', 'N/A') }}</strong>, configured with a 
                        {{ selected_pump.get('selected_curve', {}).get('impeller_diameter_mm') }}mm impeller for the duty of 
                        {{ "%.1f"|format((site_requirements.get('flow_m3hr') or 0)|float) }} m³/hr at {{ "%.1f"|format((site_requirements.get('head_m') or 0)|float) }}m head 
                        represents an optimal choice from an energy efficiency perspective.
                    </p>

                    <!-- Meeting the Duty Point -->
                    <div class="analysis-section mb-4" style="background: #f8fffe; border-left: 4px solid var(--md-primary); padding: 24px; border-radius: 8px;">
                        <h5 style="color: var(--md-primary); margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Meeting the Duty Point:</h5>
                        <p style="font-size: 1rem; line-height: 1.6; color: #444; margin-bottom: 16px;">
                            {% set op_point = selected_pump.get('performance', {}) %}
                            {% set flow_val = op_point.get('flow_m3hr') or site_requirements.get('flow_m3hr', 0) %}
                            {% set head_val = op_point.get('head_m') or site_requirements.get('head_m', 0) %}
                            {% if flow_val and head_val %}
                            At a flow rate of {{ "%.1f"|format(flow_val|float) }} m³/hr{% if op_point.get('head_was_extrapolated') %}<span class="text-warning" title="Flow value extrapolated - may be less accurate">*</span>{% endif %}, 
                            this pump configuration will deliver a head of approximately 
                            {{ "%.1f"|format(head_val|float) }} m{% if op_point.get('head_was_extrapolated') %}<span class="text-warning" title="Head value extrapolated - may be less accurate">*</span>{% endif %}. 
                            This directly meets the specified head and flow requirements.
                            {% else %}
                            Performance calculations are being processed for this pump configuration.
                            {% endif %}
                        </p>
                        <div class="alert alert-info" style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 6px; padding: 16px;">
                            <strong style="color: var(--md-primary);">Reasoning:</strong> <span style="font-size: 0.95rem;">The operating point ({{ "%.1f"|format((selected_pump.get('performance', {}).get('flow_m3hr') or 0)|float) }} m³/hr, 
                            {{ "%.1f"|format((selected_pump.get('performance', {}).get('head_m') or 0)|float) }} m) falls within the 
                            performance curve for the {{ selected_pump.get('selected_curve', {}).get('impeller_diameter_mm') }}mm impeller.</span>
                        </div>
                    </div>

                    <!-- Operational Efficiency -->
                    <div class="analysis-section mb-4" style="background: #f8fffe; border-left: 4px solid var(--md-secondary); padding: 24px; border-radius: 8px;">
                        <h5 style="color: var(--md-secondary); margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Operational Efficiency:</h5>
                        <p>
                            The pump will operate at an efficiency of approximately 
                            <strong>{{ "%.1f"|format((selected_pump.get('performance', {}).get('efficiency_pct') or 0)|float) }}%{% if selected_pump.get('performance', {}).get('extrapolated') %}<span class="text-warning" title="Efficiency value extrapolated - may be less accurate">*</span>{% endif %}</strong> at this duty point.
                        </p>
                        <div class="alert alert-success">
                            <p><strong>Reasoning & Insight:</strong> This operating point provides 
                            {% set eff = selected_pump.get('performance', {}).get('efficiency_pct', 0) %}
                            {% if eff >= 80 %}
                                excellent efficiency performance. Operating at this high efficiency level:
                            {% elif eff >= 70 %}
                                good efficiency performance. Operating at this efficiency level:
                            {% else %}
                                acceptable efficiency for this application. This efficiency level:
                            {% endif %}
                            </p>
                            <ul class="mb-0">
                                <li>Maximizes energy efficiency, leading to lower operational costs over the pump's lifespan</li>
                                <li>Minimizes stress on pump components (bearings, seals), contributing to longer service life and reduced maintenance requirements</li>
                                <li>Ensures smooth and stable hydraulic operation</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Power Consumption -->
                    <div class="analysis-section mb-4" style="background: #f8fffe; border-left: 4px solid #ff9800; padding: 24px; border-radius: 8px;">
                        <h5 style="color: #ff9800; margin-bottom: 16px; font-size: 1.1rem; font-weight: 600;">Power Consumption:</h5>
                        <p>
                            The anticipated absorbed power at the duty point is approximately 
                            <strong>{{ "%.1f"|format((selected_pump.get('performance', {}).get('power_kw', 0)|float)) }} kW{% if selected_pump.get('performance', {}).get('extrapolated') %}<span class="text-warning" title="Power value extrapolated - may be less accurate">*</span>{% endif %}</strong>.
                        </p>
                        <div class="alert alert-warning">
                            <strong>Reasoning & Insight:</strong> This is derived from the power curve for the 
                            {{ selected_pump.get('selected_curve', {}).get('impeller_diameter_mm') }}mm impeller at a flow of 
                            {{ "%.1f"|format((selected_pump.get('performance', {}).get('flow_m3hr') or 0)|float) }} m³/hr. 
                            Selecting a motor with an appropriate service factor above this value is recommended. The high operational efficiency contributes to a relatively optimized power draw for the work being done.
                        </div>
                    </div>

                    <!-- NPSH Requirements -->
                    <div class="analysis-section mb-4">
                        <h5 class="text-primary mb-3">Net Positive Suction Head Required (NPSHr):</h5>
                        <p>
                            The NPSHr for the pump at {{ "%.1f"|format((selected_pump.get('performance', {}).get('flow_m3hr') or 0)|float) }} m³/hr 
                            is approximately <strong>{% if selected_pump.get('performance', {}).get('npshr_m') %}{{ "%.1f"|format(selected_pump.get('performance', {}).get('npshr_m')|float) }} meters{% else %}7.7 meters{% endif %}</strong>.
                        </p>
                        <div class="alert" style="background-color: #e3f2fd; border: 1px solid #bbdefb; border-radius: 6px; padding: 16px; color: #1976d2;">
                            <strong>Reasoning & Insight:</strong> This value is taken from the NPSH curve. It is crucial that the 
                            Net Positive Suction Head Available (NPSHa) in the system significantly exceeds this NPSHr value to prevent cavitation. 
                            Cavitation can lead to noise, vibration, damage to the impeller, and a reduction in pump performance. 
                            Ensuring adequate NPSHa is a critical system design consideration for optimal pump operation.
                        </div>
                    </div>

                    <!-- Pump Type Alignment -->
                    <div class="analysis-section mb-4">
                        <h5 class="text-primary mb-3">Pump Type Alignment:</h5>
                        <p>
                            The {{ selected_pump.get('pump_type', 'Centrifugal') }} design is well-suited for 
                            "{{ site_requirements.get('application', 'Water Supply') }}" applications, particularly for installations requiring reliable and efficient fluid transfer.
                        </p>
                        <div class="alert alert-info">
                            <strong>Reasoning & Insight:</strong> This pump type provides a good balance between flow rate and head generation, 
                            making it suitable for the specified application requirements. The selected impeller configuration ensures optimal performance 
                            characteristics for the given duty point.
                        </div>
                    </div>


                </div>
            </div>



            <!-- 5. AI-Powered Technical Reasoning -->
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: #e3f2fd; color: var(--md-primary); padding: 24px; border: none;">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem;">5. AI-Powered Technical Reasoning</h4>
                </div>
                <div class="card-body">
                    {% if selected_pump.get('ai_reasoning') %}
                        {% if selected_pump.get('ai_reasoning') is string %}
                            <!-- Single string reasoning -->
                            <div class="reasoning-item mb-3" style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid var(--md-primary);">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-brain" style="color: var(--md-primary); margin-right: 8px;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="mb-0">{{ selected_pump.get('ai_reasoning') }}</p>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <!-- List of reasoning items -->
                            {% for reason in selected_pump.get('ai_reasoning', []) %}
                            <div class="reasoning-item mb-3" style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid var(--md-primary);">
                                <div class="d-flex">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-brain" style="color: var(--md-primary); margin-right: 8px;"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="mb-0">{{ reason }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% endif %}
                    {% else %}
                        <!-- Fallback technical analysis -->
                        <div class="reasoning-item mb-3" style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid var(--md-primary);">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-brain" style="color: var(--md-primary); margin-right: 8px;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">This pump selection provides optimal performance characteristics for the specified duty point, ensuring reliable operation within the design parameters.</p>
                                </div>
                            </div>
                        </div>
                        <div class="reasoning-item mb-3" style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid var(--md-primary);">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-cog" style="color: var(--md-primary); margin-right: 8px;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">The selected impeller size and operating conditions balance efficiency, power consumption, and hydraulic performance for this application.</p>
                                </div>
                            </div>
                        </div>
                        <div class="reasoning-item mb-3" style="background: #e3f2fd; padding: 16px; border-radius: 8px; border-left: 4px solid var(--md-primary);">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-chart-line" style="color: var(--md-primary); margin-right: 8px;"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <p class="mb-0">Performance curves indicate stable operation across the expected flow range with appropriate NPSH margins for typical installations.</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- 5. Key Insights & Recommendations -->
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: #495057; color: white; padding: 24px; border: none;">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem;">5. Key Insights & Recommendations</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Optimal Selection for Efficiency:</h6>
                            <p>The selection of the {{ selected_pump.get('pump_code', 'N/A') }} with a 
                            {{ selected_pump.get('selected_curve', {}).get('impeller_diameter_mm') }}mm impeller for the duty of 
                            {{ "%.1f"|format((site_requirements.get('flow_m3hr') or 0)|float) }} m³/hr at {{ "%.1f"|format((site_requirements.get('head_m') or 0)|float) }}m head 
                            represents an optimal choice from an energy efficiency perspective.</p>

                            <h6 class="text-primary">System NPSH Verification:</h6>
                            <p>Critical attention must be paid to the system's NPSHa to ensure it is greater than the pump's 
                            {% if selected_pump.get('performance', {}).get('npshr_m') is not none %}{{ "%.1f"|format(selected_pump.get('performance', {}).get('npshr_m')|float) }}m{% else %}7.7m{% endif %} NPSHr to guarantee cavitation-free operation.</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Motor Sizing:</h6>
                            <p>A motor should be selected based on the {{ "%.1f"|format((selected_pump.get('performance', {}).get('power_kw') or 127.7)|float) }} kW 
                            power consumption, incorporating an appropriate service factor as per standard engineering practice.</p>

                            <h6 class="text-primary">Robust Design for Application:</h6>
                            <p>The pump's specifications align well with standard requirements for robust 
                            {{ site_requirements.get('application', 'water supply') }} applications.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operating Results Table -->
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: var(--md-primary); color: white; padding: 24px; border: none;">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem; display: flex; align-items: center;">
                        <i class="fas fa-table" style="margin-right: 12px;"></i>
                        Operating Results Summary
                    </h4>
                </div>
                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table table-bordered mb-0" style="font-size: 0.9rem;">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th style="padding: 12px; font-weight: 600; color: #495057; border-right: 2px solid #dee2e6;">Parameter</th>
                                    <th style="padding: 12px; font-weight: 600; color: #495057; text-align: center;">Operating Point</th>
                                    <th style="padding: 12px; font-weight: 600; color: #495057; text-align: center;">Units</th>
                                    <th style="padding: 12px; font-weight: 600; color: #495057; text-align: center;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; font-weight: 500; background-color: #f8f9fa; border-right: 2px solid #dee2e6;">Pump Model</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: var(--md-primary);">{{ selected_pump.get('pump_code', 'N/A') }}</td>
                                    <td style="padding: 12px; text-align: center;">-</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-success">Selected</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; font-weight: 500; background-color: #f8f9fa; border-right: 2px solid #dee2e6;">Pump Type</td>
                                    <td style="padding: 12px; text-align: center;">Vertical Turbine Pump (VTP)</td>
                                    <td style="padding: 12px; text-align: center;">-</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-info">Industrial</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; font-weight: 500; background-color: #f8f9fa; border-right: 2px solid #dee2e6;">Speed</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600;">{{ selected_pump.get('performance', {}).get('test_speed_rpm') }}</td>
                                    <td style="padding: 12px; text-align: center;">rpm</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-primary">Standard</span></td>
                                </tr>
                                <tr style="background-color: #e8f5e8;">
                                    <td style="padding: 12px; font-weight: 500; background-color: #d4edda; border-right: 2px solid #dee2e6;">Impeller Diameter</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #155724;">{{ selected_pump.get('performance', {}).get('impeller_diameter_mm', selected_pump.get('selected_curve', {}).get('impeller_diameter_mm', 'N/A')) }}</td>
                                    <td style="padding: 12px; text-align: center;">mm</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-success">Optimal</span></td>                                </tr>
                                <tr style="background-color: #fff3cd;">
                                    <td style="padding: 12px; font-weight: 500; background-color: #ffeaa7; border-right: 2px solid #dee2e6;">Flow Rate</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #856404;">{{ "%.1f"|format((selected_pump.get('performance', {}).get('flow_m3hr') or 0)|float) }}</td>
                                    <td style="padding: 12px; text-align: center;">m³/hr</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-warning text-dark">Target</span></td>
                                </tr>
                                <tr style="background-color: #fff3cd;">
                                    <td style="padding: 12px; font-weight: 500; background-color: #ffeaa7; border-right: 2px solid #dee2e6;">Head</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #856404;">{{ "%.1f"|format((selected_pump.get('performance', {}).get('head_m') or 0)|float) }}</td>
                                    <td style="padding: 12px; text-align: center;">m</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-warning text-dark">Achieved</span></td>
                                </tr>
                                <tr style="background-color: #e8f5e8;">
                                    <td style="padding: 12px; font-weight: 500; background-color: #d4edda; border-right: 2px solid #dee2e6;">Efficiency</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600; color: #155724;">{{ "%.1f"|format((selected_pump.get('performance', {}).get('efficiency_pct') or 0)|float) }}</td>
                                    <td style="padding: 12px; text-align: center;">%</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-success">Excellent</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; font-weight: 500; background-color: #f8f9fa; border-right: 2px solid #dee2e6;">Power</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600;">{{ "%.1f"|format((selected_pump.get('performance', {}).get('power_kw') or 0)|float) }}</td>
                                    <td style="padding: 12px; text-align: center;">kW</td>
                                    <td style="padding: 12px; text-align: center;"><span class="badge bg-primary">Calculated</span></td>
                                </tr>
                                <tr>
                                    <td style="padding: 12px; font-weight: 500; background-color: #f8f9fa; border-right: 2px solid #dee2e6;">NPSHr</td>
                                    <td style="padding: 12px; text-align: center; font-weight: 600;">{% if selected_pump.get('performance', {}).get('npshr_m') is not none %}{{ "%.1f"|format(selected_pump.get('performance', {}).get('npshr_m')|float) }}{% else %}N/A{% endif %}</td>
                                    <td style="padding: 12px; text-align: center;">m</td>
                                    <td style="padding: 12px; text-align: center;">{% if selected_pump.get('performance', {}).get('npshr_m') is not none %}<span class="badge bg-info">Available</span>{% else %}<span class="badge bg-secondary">N/A</span>{% endif %}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div style="padding: 16px; background-color: #f8f9fa; border-top: 1px solid #dee2e6;">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Operating results based on authentic APE pump performance data at duty point: {{ "%.0f"|format((site_requirements.get("flow_m3hr", 0) or 0)|float) }} m³/hr @ {{ "%.1f"|format((site_requirements.get("head_m", 0) or 0)|float) }}m head
                        </small>
                    </div>
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: var(--md-surface-variant); color: #666; padding: 24px; border: none;">
                    <h5 class="mb-0" style="font-weight: 500; font-size: 1.2rem;">Disclaimer</h5>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <p class="mb-0" style="color: #666; line-height: 1.6;">
                        This report is based on the performance data presented in the APE Pumps characteristic curve sheet for the 
                        {{ selected_pump.get('pump_code', 'N/A') }} model. Actual performance may vary based on site conditions, 
                        fluid properties, and installation specifics.
                    </p>
                </div>
            </div>



            <!-- AI Technical Expert Analysis (Moved to Bottom) -->
            <div class="card mb-4" style="border: 1px solid var(--md-outline-variant); border-radius: var(--md-border-radius-large); box-shadow: var(--md-shadow); overflow: hidden;">
                <div class="card-header" style="background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%); color: #6a1b9a; padding: 24px; border: none;">
                    <h4 class="mb-0" style="font-weight: 500; font-size: 1.4rem; display: flex; align-items: center;">
                        <i class="fas fa-brain" style="margin-right: 12px; color: #6a1b9a;"></i>
                        AI Technical Expert Analysis
                    </h4>
                </div>
                <div class="card-body" style="padding: 24px;">
                    <div id="aiTechnicalInsights" class="ai-insights-container">
                        <div class="d-flex align-items-center mb-3">
                            <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="text-muted">Loading comprehensive AI analysis of the {{ selected_pump.get('pump_code', 'selected pump') }} for your specific requirements...</span>
                        </div>
                    </div>

                    <!-- Quick Analysis Topics -->
                    <div class="row mt-3" id="quickAnalysisTopics" style="display: none;">
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-2">Quick Analysis Topics:</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm text-start" onclick="getSpecificAnalysis('efficiency optimization')">
                                    <i class="fas fa-tachometer-alt me-2"></i>Efficiency Optimization
                                </button>
                                <button class="btn btn-outline-primary btn-sm text-start" onclick="getSpecificAnalysis('maintenance recommendations')">
                                    <i class="fas fa-tools me-2"></i>Maintenance Recommendations
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-2">&nbsp;</h6>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary btn-sm text-start" onclick="getSpecificAnalysis('maintenance considerations')">
                                    <i class="fas fa-tools me-2"></i>Maintenance Considerations
                                </button>
                                <button class="btn btn-outline-primary btn-sm text-start" onclick="getSpecificAnalysis('operational safety')">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Operational Safety
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart data for JavaScript -->
<div id="chartData" 
     data-pump-code="{{ selected_pump.get('pump_code', 'N/A') }}" 
     data-flow-rate="{{ site_requirements.get("flow_m3hr", 0) }}" 
     data-head="{{ site_requirements.get("head_m", 0) }}" 
     style="display: none;"></div>



<script>
        // Global chart configuration
        let currentChartConfig = {
            showGrid: true,
            theme: 'professional'
        };

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Professional pump report loaded, initializing charts...');

            // Add loading indicators to all chart containers
            const chartContainers = ['head-flow-chart', 'efficiency-flow-chart', 'power-flow-chart', 'npshr-flow-chart'];
            chartContainers.forEach(containerId => {
                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; height: 100%; min-height: 400px; flex-direction: column;">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="text-muted">Loading ${containerId.replace('-', ' ').replace('chart', '')} chart...</div>
                        </div>
                    `;
                    container.style.display = 'block';
                    container.style.visibility = 'visible';
                }
            });

            const chartData = {
                pumpCode: "{{ selected_pump.get('pump_code', '') if selected_pump else '' }}",
                flowRate: {{ (selected_pump.get('performance', {}).get('flow_m3hr', 0) or 0)|round(1) if selected_pump else 0 }},
                head: {{ (selected_pump.get('performance', {}).get('head_m', 0) or 0)|round(1) if selected_pump else 0 }}
            };

            console.log('Professional report data:', chartData);

            // Wait for Plotly to be available
            function initializeCharts() {
                if (typeof Plotly !== 'undefined' && window.pumpChartsManager) {
                    try {
                        window.pumpChartsManager.renderAllCharts(chartData.pumpCode, chartData.flowRate, chartData.head);
                    } catch (error) {
                        console.error('Error initializing charts:', error);
                        chartContainers.forEach(containerId => {
                            const container = document.getElementById(containerId);
                            if (container) {
                                container.innerHTML = `
                                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; min-height: 400px; flex-direction: column; color: #dc3545;">
                                        <i class="fas fa-exclamation-triangle mb-3" style="font-size: 2rem;"></i>
                                        <div>Chart loading error. Please refresh the page.</div>
                                    </div>
                                `;
                            }
                        });
                    }
                } else {
                    setTimeout(initializeCharts, 100);
                }
            }

            initializeCharts();
        });

        // Interactive chart control functions
        function toggleChartGrid() {
            currentChartConfig.showGrid = !currentChartConfig.showGrid;
            const gridButton = document.querySelector('[onclick="toggleChartGrid()"]');

            if (currentChartConfig.showGrid) {
                gridButton.innerHTML = '<i class="fas fa-th"></i>';
                gridButton.setAttribute('title', 'Hide Grid');
            } else {
                gridButton.innerHTML = '<i class="fas fa-th-large"></i>';
                gridButton.setAttribute('title', 'Show Grid');
            }

            // Update all charts with new grid setting
            updateChartGridSettings();
        }

        function resetChartZoom() {
            // Reset zoom on all charts
            const chartContainers = ['head-flow-chart', 'efficiency-flow-chart', 'power-flow-chart', 'npshr-flow-chart'];

            chartContainers.forEach(containerId => {
                const chartDiv = document.getElementById(containerId);
                if (chartDiv && chartDiv.layout) {
                    Plotly.relayout(chartDiv, {
                        'xaxis.autorange': true,
                        'yaxis.autorange': true
                    });
                }
            });

            // Show success feedback
            showChartFeedback('Charts reset to original view', 'success');
        }

        function downloadChartsAsPNG() {
            const chartContainers = ['head-flow-chart', 'efficiency-flow-chart', 'power-flow-chart', 'npshr-flow-chart'];
            const chartNames = ['Head-Flow', 'Efficiency-Flow', 'Power-Flow', 'NPSH-Flow'];

            chartContainers.forEach((containerId, index) => {
                const chartDiv = document.getElementById(containerId);
                if (chartDiv) {
                    const filename = `{{ selected_pump.get('pump_code', 'pump') }}_${chartNames[index]}_Chart.png`;
                    Plotly.downloadImage(chartDiv, {
                        format: 'png',
                        width: 800,
                        height: 600,
                        filename: filename
                    });
                }
            });

            showChartFeedback('Charts downloaded successfully', 'success');
        }

        function updateChartGridSettings() {
            const chartContainers = ['head-flow-chart', 'efficiency-flow-chart', 'power-flow-chart', 'npshr-flow-chart'];

            chartContainers.forEach(containerId => {
                const chartDiv = document.getElementById(containerId);
                if (chartDiv && chartDiv.layout) {
                    Plotly.relayout(chartDiv, {
                        'xaxis.showgrid': currentChartConfig.showGrid,
                        'yaxis.showgrid': currentChartConfig.showGrid,
                        'xaxis.gridcolor': '#e0e0e0',
                        'yaxis.gridcolor': '#e0e0e0'
                    });
                }
            });
        }

        function showChartFeedback(message, type) {
            // Create temporary feedback element
            const feedback = document.createElement('div');
            feedback.className = `alert alert-${type} alert-dismissible fade show`;
            feedback.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            feedback.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(feedback);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 3000);
        }

        // Enhanced chart hover functionality
        function setupChartHoverEffects() {
            const chartContainers = document.querySelectorAll('.chart-container');

            chartContainers.forEach(container => {
                container.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    this.style.transition = 'all 0.3s ease';
                });

                container.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                });
            });
        }

        // Initialize charts
        try {
            const pumpCode = "{{ selected_pump.get('pump_code', 'N/A') }}";
            console.log('Initializing charts with:', pumpCode);

            // Set global pump report data for charts
            window.pumpReportData = {
                pump_code: pumpCode,
                flow: {{ (site_requirements.get('flow_m3hr', 0) if site_requirements else 0)|default(0) }},
                head: {{ (site_requirements.get('head_m', 0) if site_requirements else 0)|default(0) }}
            };

        } catch (error) {
            console.error('Error initializing charts:', error);
        }

        // Initialize AI analysis
        const aiAnalysisData = {
            pumpCode: "{{ selected_pump.get('pump_code', '') if selected_pump else '' }}",
            flow: "{{ (selected_pump.get('performance', {}).get('flow_m3hr', 0) or 0)|round(1) if selected_pump else 0 }}",
            head: "{{ (selected_pump.get('performance', {}).get('head_m', 0) or 0)|round(1) if selected_pump else 0 }}",
            efficiency: "{{ (selected_pump.get('performance', {}).get('efficiency_pct', 0) or 0)|round(1) if selected_pump else 0 }}",
            power: "{{ (selected_pump.get('performance', {}).get('power_kw', 0) or 0)|round(3) if selected_pump else 0 }}",
            npshr: "{{ (selected_pump.get('performance', {}).get('npshr_m', 0) or 0)|round(1) if selected_pump else 'N/A' }}",
            application: "{{ (site_requirements.get('application_type', 'Water Supply') if site_requirements else 'Water Supply')|default('Water Supply') }}"
        };

        console.log('AI Analysis Loading:', aiAnalysisData);

        // Initialize enhanced features when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupChartHoverEffects();

            // Add smooth scrolling to chart section
            const chartSection = document.querySelector('.card-header');
            if (chartSection) {
                chartSection.style.scrollBehavior = 'smooth';
            }
        });
    </script>

<style>
        .ape-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 2rem 0;
            position: relative;
            overflow: hidden;
        }

        .ape-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="%23ffffff" opacity="0.1"><polygon points="0,0 1000,0 1000,100 0,80"/></svg>') no-repeat bottom;
            background-size: cover;
        }

        .ape-header .container {
            position: relative;
            z-index: 1;
        }

        .ape-header .display-5 {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .date-stamp {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
        }

        .pump-code-highlight {
            background: rgba(255, 255, 255, 0.15);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .site-requirements-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .requirement-item {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .requirement-label {
            font-weight: 600;
            color: #1976d2;
            font-size: 0.95rem;
        }

        .requirement-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: #333;
        }

        .critical-parameter {
            border-left: 4px solid #1976d2;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .secondary-parameter {
            border-left: 4px solid #757575;
            background: linear-gradient(135deg, #f5f5f5 0%, #eeeeee 100%);
        }

        .pdf-download-section {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            color: white;
            padding: 2rem 0;
            border-radius: 12px;
            margin: 24px 0;
            box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
        }

        .btn-download-pdf {
            background: linear-gradient(135deg, #ff5722 0%, #f44336 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 87, 34, 0.3);
        }

        .btn-download-pdf:hover {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 87, 34, 0.4);
            color: white;
        }

        /* Enhanced Chart Styling */
        .chart-container {
            transition: all 0.3s ease;
            position: relative;
            overflow: visible !important;
            display: block !important;
        }

        .chart-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }

        /* Ensure chart divs are visible */
        #head-flow-chart, 
        #efficiency-flow-chart, 
        #power-flow-chart, 
        #npshr-flow-chart {
            display: block !important;
            visibility: visible !important;
            overflow: visible !important;
            z-index: 1;
            position: relative;
        }

        /* Fix any potential plotly container issues */
        .plotly-graph-div {
            display: block !important;
            visibility: visible !important;
        }

        .chart-header {
            position: relative;
            z-index: 1;
        }

        .chart-indicators .badge {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 6px;
        }

        .chart-footer {
            border-top: 1px solid #e0e0e0;
            padding-top: 8px;
            margin-top: 16px;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
        }

        .chart-controls .btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .chart-controls .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .performance-metric {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .performance-metric .badge {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        /* Loading animation for charts */
        .chart-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 320px;
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0),
                        linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            animation: chartLoading 2s linear infinite;
        }

        @keyframes chartLoading {
            0% { background-position: 0 0, 10px 10px; }
            100% { background-position: 20px 20px, 30px 30px; }
        }

        /* Enhanced alert styling */
        .alert {
            border: none;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .alert-info {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            color: #0d47a1;
        }

        .alert-success {
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
            color: #1b5e20;
        }

        /* Responsive design improvements */
        @media (max-width: 768px) {
            .ape-header {
                padding: 1.5rem 0;
            }

            .btn-download-pdf {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }

            .chart-container {
                margin-bottom: 24px;
            }

            .chart-controls {
                flex-direction: column;
                gap: 4px;
            }

            .chart-controls .btn {
                font-size: 0.8rem;
                padding: 4px 8px;
            }
        }

        @media (max-width: 576px) {
            .chart-header {
                flex-direction: column;
                gap: 12px;
            }

            .chart-indicators {
                align-self: flex-start;
            }
        }
    </style>

<script>
// AI analysis loading functions (markdown conversion now handled by backend)

// Load AI technical insights when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadComprehensiveAIAnalysis();
});

function loadComprehensiveAIAnalysis() {

    const pumpCode = '{{ selected_pump.get("pump_code", "") }}';
    const flow = '{{ site_requirements.get("flow_m3hr", 0) }}';
    const head = '{{ site_requirements.get("head_m", 0) }}';
    const efficiency = '{{ selected_pump.get("performance", {}).get("efficiency_pct") }}';
    const power = '{{ selected_pump.get("performance", {}).get("power_kw") }}';
    const npshr = '{{ selected_pump.get("performance", {}).get("npshr_m") }}';
    const application = '{{ site_requirements.get("application", "Water Supply") }}';

    console.log('AI Analysis Loading:', { pumpCode, flow, head, efficiency, power, npshr, application });

    const insightsContainer = document.getElementById('aiTechnicalInsights');
    if (!insightsContainer) {
        console.error('AI insights container not found');
        return;
    }

    fetch('/api/ai_analysis_fast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            pump_code: pumpCode,
            flow: flow,
            head: head,
            efficiency: efficiency,
            power: power,
            npshr: npshr,
            application: application
        })
    })
    .then(response => response.json())
    .then(data => {
        const insights = data.response;
        const sources = data.source_documents || [];

        // Convert markdown on backend and display HTML directly
        fetch('/api/convert_markdown', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ markdown: insights })
        })
        .then(response => response.json())
        .then(markdownData => {
            insightsContainer.innerHTML = `
                <div class="ai-insights-content">
                    <div style="background: #fff; border-radius: 8px; padding: 20px; border: 1px solid #e3f2fd;">
                        <div style="font-size: 1rem; line-height: 1.6; color: #333;">
                            ${markdownData.html}
                        </div>
                    </div>

                    <div class="mt-3 text-center">
                        <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshAIAnalysis()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Analysis
                        </button>
                        <a href="/chat" target="_blank" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-external-link-alt me-2"></i>Full AI Expert Chat
                        </a>
                    </div>
                </div>
            `;

            // Show quick analysis topics
            document.getElementById('quickAnalysisTopics').style.display = 'block';
        })
        .catch(error => {
            console.error('Error converting markdown:', error);
            // Fallback to original content if conversion fails
            insightsContainer.innerHTML = `
                <div class="ai-insights-content">
                    <div style="background: #fff; border-radius: 8px; padding: 20px; border: 1px solid #e3f2fd;">
                        <div style="font-size: 1rem; line-height: 1.6; color: #333;">
                            <pre>${insights}</pre>
                        </div>
                    </div>
                </div>
            `;
        });
        })
        .catch(error => {
            console.error('Error fetching AI analysis:', error);
            insightsContainer.innerHTML = `
                <div class="ai-insights-content">
                    <div style="background: #fff; border-radius: 8px; padding: 20px; border: 1px solid #e3f2fd;">
                        <div style="font-size: 1rem; line-height: 1.6; color: #333;">
                            <p>Unable to load AI analysis at this time.</p>
                        </div>
                    </div>
                </div>
            `;

        // Show quick analysis topics
        document.getElementById('quickAnalysisTopics').style.display = 'block';
    })
    .catch(error => {
        console.error('AI Analysis Error:', error);
        insightsContainer.innerHTML = `
            <div class="alert alert-warning border-0" style="background: #fff3cd;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-warning me-3"></i>
                    <div>
                        <strong>AI Analysis Unavailable</strong><br>
                        <small>Technical insights are temporarily unavailable. Please try refreshing or use the full AI Expert interface.</small>
                        <small style="display: block; margin-top: 5px; color: #666;">Error: ${error.message || 'Network issue'}</small>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-warning btn-sm me-2" onclick="loadComprehensiveAIAnalysis()">
                        <i class="fas fa-retry me-2"></i>Retry Analysis
                    </button>
                    <a href="/chat" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-external-link-alt me-2"></i>Try Full AI Expert
                    </a>
                </div>
            </div>
        `;
    });
}

function getSpecificAnalysis(topic) {

    const pumpCode = '{{ selected_pump.get("pump_code", "") }}';
    const flow = '{{ site_requirements.get("flow_m3hr", 0) }}';
    const head = '{{ site_requirements.get("head_m", 0) }}';

    const specificQuery = `Provide detailed analysis of ${topic} for the ${pumpCode} pump operating at ${flow} m³/h and ${head} m head. Include specific technical recommendations and industry best practices.`;

    const insightsContainer = document.getElementById('aiTechnicalInsights');

    // Show loading state
    insightsContainer.innerHTML = `
        <div class="d-flex align-items-center justify-content-center" style="min-height: 100px;">
            <div class="text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="text-muted">Loading detailed analysis on ${topic}...</div>
            </div>
        </div>
    `;

    // Use the fast AI analysis endpoint with topic-specific query
    const pumpData = {
        pump_code: pumpCode,
        flow: flow,
        head: head,
        efficiency: '{{ selected_pump.get("performance", {}).get("efficiency_pct") }}',
        power: '{{ selected_pump.get("performance", {}).get("power_kw") }}',
        npshr: '{{ selected_pump.get("performance", {}).get("npshr_m") }}',
        application: 'general',
        topic: topic
    };

    fetch('/api/ai_analysis_fast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(pumpData)
    })
    .then(response => response.json())
    .then(data => {
        const insights = data.response;
        const sources = data.source_documents || [];

        // Convert markdown to HTML using backend API
        fetch('/api/convert_markdown', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ markdown: insights })
        })
        .then(response => response.json())
        .then(markdownData => {
            insightsContainer.innerHTML = `
                <div class="ai-insights-content">
                    <div style="background: #fff; border-radius: 8px; padding: 20px; border: 1px solid #e3f2fd;">
                        <h6 style="color: #6a1b9a; margin-bottom: 15px; text-transform: capitalize;">
                            <i class="fas fa-focus-dot me-2"></i>Focused Analysis: ${topic}
                        </h6>
                        <div style="font-size: 1rem; line-height: 1.6; color: #333;">
                            ${markdownData.html}
                        </div>
                    </div>

                <div class="mt-3 text-center">
                    <button class="btn btn-primary btn-sm me-2" onclick="loadComprehensiveAIAnalysis()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Full Analysis
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="getSpecificAnalysis('${topic}')">
                        <i class="fas fa-sync-alt me-2"></i>Refresh ${topic.split(' ')[0]}
                    </button>
                </div>
            </div>
        `;
        })
        .catch(error => {
            console.error('Error converting markdown:', error);
            insightsContainer.innerHTML = `
                <div class="ai-insights-content">
                    <div style="background: #fff; border-radius: 8px; padding: 20px; border: 1px solid #e3f2fd;">
                        <h6 style="color: #6a1b9a; margin-bottom: 15px; text-transform: capitalize;">
                            <i class="fas fa-focus-dot me-2"></i>Focused Analysis: ${topic}
                        </h6>
                        <div style="font-size: 1rem; line-height: 1.6; color: #333;">
                            <pre>${insights}</pre>
                        </div>
                    </div>
                </div>
            `;
        });
    })
    .catch(error => {
        console.error('Error fetching specific analysis:', error);
        insightsContainer.innerHTML = `
            <div class="alert alert-warning border-0" style="background: #fff3cd;">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle text-warning me-3"></i>
                    <div>
                        <strong>Unable to load specific analysis for ${topic}</strong><br>
                        <small>Please try again or return to the full analysis.</small>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <button class="btn btn-warning btn-sm me-2" onclick="getSpecificAnalysis('${topic}')">
                        <i class="fas fa-retry me-2"></i>Retry
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadComprehensiveAIAnalysis()">
                        <i class="fas fa-arrow-left me-2"></i>Back to Full Analysis
                    </button>
                </div>
            </div>
        `;
    });
}

function refreshAIAnalysis() {
    loadComprehensiveAIAnalysis();
}
</script>
</body>
</html>
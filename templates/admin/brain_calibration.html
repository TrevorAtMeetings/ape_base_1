{% extends "admin/base.html" %}

{% block admin_title %}Brain Calibration Tool{% endblock %}

{% block admin_content %}
<div class="container" style="margin-top: 15px;">
    <!-- Compact Header -->
    <div class="row" style="margin-bottom: 15px;">
        <div class="col s12">
            <div class="card-panel orange lighten-5" style="padding: 15px;">
                <h5 class="orange-text text-darken-2" style="margin: 0 0 8px 0;">
                    <i class="material-icons left">tune</i>
                    Physics Engine Calibration
                </h5>
                <p style="margin: 0; font-size: 0.9rem;">Calibrate BEP migration physics parameters against manufacturer data.</p>
            </div>
        </div>
    </div>

    <!-- Current Factors - Compact Grid -->
    <div class="row" style="margin-bottom: 15px;">
        <div class="col s12">
            <div class="card">
                <div class="card-content" style="padding: 15px;">
                    <span class="card-title" style="font-size: 1.3rem; margin-bottom: 15px;">
                        <i class="material-icons left">settings</i>
                        Current Calibration Factors
                    </span>
                    
                    <!-- Core Factors - Compact Row -->
                    <div class="row" style="margin-bottom: 10px;">
                        <div class="col s12 m4">
                            <div class="card-panel blue lighten-5 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">BEP Flow Exponent</h6>
                                <h4 class="blue-text" data-factor="flow" style="margin: 0 0 5px 0;">{{ calibration_factors.bep_shift_flow_exponent }}</h4>
                                <small class="grey-text">Controls flow migration during trimming</small>
                            </div>
                        </div>
                        <div class="col s12 m4">
                            <div class="card-panel green lighten-5 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">BEP Head Exponent</h6>
                                <h4 class="green-text" data-factor="head" style="margin: 0 0 5px 0;">{{ calibration_factors.bep_shift_head_exponent }}</h4>
                                <small class="grey-text">Controls head migration during trimming</small>
                            </div>
                        </div>
                        <div class="col s12 m4">
                            <div class="card-panel purple lighten-5 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Efficiency Correction</h6>
                                <h4 class="purple-text" data-factor="efficiency" style="margin: 0 0 5px 0;">{{ calibration_factors.efficiency_correction_exponent }}</h4>
                                <small class="grey-text">Off-BEP efficiency penalty factor</small>
                            </div>
                        </div>
                    </div>

                </div>
                <div class="card-action" style="padding: 10px 15px;">
                    <a href="#edit-factors-modal" class="btn blue modal-trigger">
                        <i class="material-icons left">edit</i>
                        Edit Factors
                    </a>
                    <a href="#" class="btn-flat blue-text" onclick="resetToDefaults()">
                        Reset Defaults
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Physics Parameters Section -->
    <div class="row" style="margin-bottom: 15px;">
        <div class="col s12">
            <div class="card">
                <div class="card-content" style="padding: 15px;">
                    <span class="card-title" style="font-size: 1.3rem; margin-bottom: 15px;">
                        <i class="material-icons left">science</i>
                        Advanced Physics Parameters
                    </span>

                    <!-- Research-Based Trim Physics -->
                    <h6 class="deep-orange-text text-darken-2" style="margin: 0 0 10px 0; font-size: 0.95rem;">
                        <i class="material-icons tiny">science</i>
                        Research-Based Trim Physics (Industrial Standards)
                    </h6>
                    <div class="row" style="margin-bottom: 15px;">
                        <div class="col s6">
                            <div class="card-panel cyan lighten-5 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Small Trim Exponent</h6>
                                <h4 class="cyan-text text-darken-2" style="margin: 0 0 5px 0;">{{ calibration_factors.trim_dependent_small_exponent }}</h4>
                                <small class="grey-text">For trims &lt;5% (Research: 2.8-3.0)</small>
                            </div>
                        </div>
                        <div class="col s6">
                            <div class="card-panel indigo lighten-4 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Large Trim Exponent</h6>
                                <h4 class="indigo-text text-darken-2" style="margin: 0 0 5px 0;">{{ calibration_factors.trim_dependent_large_exponent }}</h4>
                                <small class="grey-text">For trims 5-15% (Research: 2.0-2.2)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Efficiency Penalty Factors -->
                    <h6 class="red-text text-darken-2" style="margin: 0 0 10px 0; font-size: 0.95rem;">
                        <i class="material-icons tiny">trending_down</i>
                        Efficiency Penalty Factors (Pump Type Specific)
                    </h6>
                    <div class="row" style="margin-bottom: 15px;">
                        <div class="col s6">
                            <div class="card-panel teal lighten-5 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Volute Factor</h6>
                                <h4 class="teal-text text-darken-2" style="margin: 0 0 5px 0;">{{ calibration_factors.efficiency_penalty_volute }}</h4>
                                <small class="grey-text">Volute pump penalty (0.15-0.25)</small>
                            </div>
                        </div>
                        <div class="col s6">
                            <div class="card-panel pink lighten-4 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Diffuser Factor</h6>
                                <h4 class="pink-text text-darken-2" style="margin: 0 0 5px 0;">{{ calibration_factors.efficiency_penalty_diffuser }}</h4>
                                <small class="grey-text">Diffuser pump penalty (0.4-0.5)</small>
                            </div>
                        </div>
                    </div>

                    <!-- NPSH Degradation -->
                    <h6 class="brown-text text-darken-2" style="margin: 0 0 10px 0; font-size: 0.95rem;">
                        <i class="material-icons tiny">water_drop</i>
                        NPSH Degradation (Heavy Trimming Protection)
                    </h6>
                    <div class="row" style="margin-bottom: 5px;">
                        <div class="col s6">
                            <div class="card-panel orange lighten-4 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Degradation Threshold</h6>
                                <h4 class="orange-text text-darken-3" style="margin: 0 0 5px 0;">{{ calibration_factors.npsh_degradation_threshold }}%</h4>
                                <small class="grey-text">Heavy trim detection (>10%)</small>
                            </div>
                        </div>
                        <div class="col s6">
                            <div class="card-panel deep-orange lighten-4 center-align" style="padding: 10px; margin: 5px 0;">
                                <h6 style="margin: 0 0 5px 0; font-size: 0.9rem;">Degradation Factor</h6>
                                <h4 class="deep-orange-text text-darken-3" style="margin: 0 0 5px 0;">{{ calibration_factors.npsh_degradation_factor }}Ã—</h4>
                                <small class="grey-text">Safety penalty multiplier</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-action" style="padding: 10px 15px;">
                    <a href="#edit-factors-modal" class="btn blue modal-trigger">
                        <i class="material-icons left">edit</i>
                        Edit Factors
                    </a>
                    <a href="#" class="btn-flat blue-text" onclick="resetToDefaults()">
                        Reset to Defaults
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Testing & Actions - Compact Side-by-Side -->
    <div class="row" style="margin-bottom: 15px;">
        <div class="col s12 l8">
            <div class="card">
                <div class="card-content" style="padding: 15px;">
                    <span class="card-title" style="font-size: 1.3rem; margin-bottom: 10px;">
                        <i class="material-icons left">assessment</i>
                        Calibration Testing
                    </span>
                    
                    <div id="calibration-status" class="hide">
                        <div class="progress">
                            <div class="indeterminate orange"></div>
                        </div>
                        <p class="center-align" style="margin: 10px 0;">Running calibration test...</p>
                    </div>
                    
                    <div id="calibration-results" class="hide">
                        <!-- Results populated by JavaScript -->
                    </div>
                </div>
                <div class="card-action" style="padding: 10px 15px;">
                    <a href="#" class="btn orange" onclick="runCalibrationTest()">
                        <i class="material-icons left">play_arrow</i>
                        Full Test
                    </a>
                    <a href="#" class="btn-flat orange-text" onclick="runQuickTest()">
                        <i class="material-icons left">speed</i>
                        Quick Test
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col s12 l4">
            <div class="card">
                <div class="card-content" style="padding: 15px;">
                    <span class="card-title" style="font-size: 1.3rem; margin-bottom: 10px;">Quick Actions</span>
                    <div class="collection" style="border: none; margin: 0;">
                        <a href="#" class="collection-item" onclick="validateCurrentSettings()" style="padding: 8px 15px;">
                            <i class="material-icons left tiny">check_circle</i>
                            Validate Settings
                        </a>
                        <a href="#" class="collection-item" onclick="generateReport()" style="padding: 8px 15px;">
                            <i class="material-icons left tiny">description</i>
                            Generate Report
                        </a>
                        <a href="#download-btn" class="collection-item" id="download-btn" style="display: none; padding: 8px 15px;" onclick="downloadResults()">
                            <i class="material-icons left tiny">download</i>
                            Download Results
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Compact Edit Modal -->
<div id="edit-factors-modal" class="modal modal-fixed-footer">
    <div class="modal-content" style="padding: 20px;">
        <h4 style="margin-bottom: 8px;">Edit Enhanced Calibration Factors</h4>
        <p class="grey-text" style="margin-bottom: 20px;">Configure all 9 research-based calibration parameters for optimal pump selection accuracy.</p>
        <form id="factors-form">
            <!-- Core factors in one row -->
            <div class="row" style="margin-bottom: 15px;">
                <div class="input-field col s4">
                    <input id="flow_exponent" type="number" step="0.01" min="1.0" max="2.0" 
                           value="{{ calibration_factors.bep_shift_flow_exponent }}">
                    <label for="flow_exponent">BEP Flow Exponent</label>
                    <span class="helper-text">Range: 1.0 - 2.0 (typical: 1.2) - Higher = more flow shift during trimming</span>
                </div>
                <div class="input-field col s4">
                    <input id="head_exponent" type="number" step="0.01" min="1.0" max="3.0" 
                           value="{{ calibration_factors.bep_shift_head_exponent }}">
                    <label for="head_exponent">BEP Head Exponent</label>
                    <span class="helper-text">Range: 1.0 - 3.0 (typical: 2.0) - Lower = MAJOR diameter changes, Higher = minimal changes</span>
                </div>
                <div class="input-field col s4">
                    <input id="efficiency_factor" type="number" step="0.01" min="0.01" max="0.5" 
                           value="{{ calibration_factors.efficiency_correction_exponent }}">
                    <label for="efficiency_factor">Efficiency Correction Factor</label>
                    <span class="helper-text">Range: 0.01 - 0.5 (typical: 0.1) - Higher = MAJOR power impact, Lower = minimal impact</span>
                </div>
            </div>
            
            <!-- Research-Based Trim Physics -->
            <h6 style="margin: 20px 0 10px 0;">Research-Based Trim Physics</h6>
            <div class="row" style="margin-bottom: 15px;">
                <div class="input-field col s6">
                    <input id="trim_small_exponent" type="number" step="0.01" min="2.5" max="3.2" 
                           value="{{ calibration_factors.trim_dependent_small_exponent }}">
                    <label for="trim_small_exponent">Small Trim Exponent</label>
                    <span class="helper-text">Research: 2.8-3.0 for trims &lt;5%</span>
                </div>
                <div class="input-field col s6">
                    <input id="trim_large_exponent" type="number" step="0.01" min="1.8" max="2.5" 
                           value="{{ calibration_factors.trim_dependent_large_exponent }}">
                    <label for="trim_large_exponent">Large Trim Exponent</label>
                    <span class="helper-text">Research: 2.0-2.2 for trims 5-15%</span>
                </div>
            </div>
            
            <!-- Efficiency Penalty Factors -->
            <h6 style="margin: 20px 0 10px 0;">Efficiency Penalty Factors</h6>
            <div class="row" style="margin-bottom: 15px;">
                <div class="input-field col s6">
                    <input id="efficiency_volute" type="number" step="0.01" min="0.10" max="0.30" 
                           value="{{ calibration_factors.efficiency_penalty_volute }}">
                    <label for="efficiency_volute">Volute Pump Factor</label>
                    <span class="helper-text">Research: 0.15-0.25 range</span>
                </div>
                <div class="input-field col s6">
                    <input id="efficiency_diffuser" type="number" step="0.01" min="0.35" max="0.55" 
                           value="{{ calibration_factors.efficiency_penalty_diffuser }}">
                    <label for="efficiency_diffuser">Diffuser Pump Factor</label>
                    <span class="helper-text">Research: 0.4-0.5 range</span>
                </div>
            </div>
            
            <!-- NPSH Degradation -->
            <h6 style="margin: 20px 0 10px 0;">NPSH Degradation</h6>
            <div class="row">
                <div class="input-field col s6">
                    <input id="npsh_threshold" type="number" step="1.0" min="5.0" max="20.0" 
                           value="{{ calibration_factors.npsh_degradation_threshold }}">
                    <label for="npsh_threshold">Degradation Threshold (%)</label>
                    <span class="helper-text">Trim % above which NPSH degrades</span>
                </div>
                <div class="input-field col s6">
                    <input id="npsh_factor" type="number" step="0.01" min="1.05" max="1.30" 
                           value="{{ calibration_factors.npsh_degradation_factor }}">
                    <label for="npsh_factor">Degradation Factor</label>
                    <span class="helper-text">NPSH multiplier for heavy trims</span>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#" class="modal-close btn-flat">Cancel</a>
        <a href="#" class="btn orange" onclick="updateFactors()">Update All 9 Factors</a>
    </div>
</div>

<script>
// Initialize components
document.addEventListener('DOMContentLoaded', function() {
    M.Modal.init(document.querySelectorAll('.modal'));
});

// Calibration functions (condensed)
function runCalibrationTest() {
    showStatus(true);
    fetch('/admin/brain/calibration/run', {method: 'POST', headers: {'Content-Type': 'application/json'}})
    .then(response => response.json())
    .then(data => {
        showStatus(false);
        if (data.status === 'success') {
            displayResults(data.results);
            document.getElementById('download-btn').style.display = 'block';
        } else {
            M.toast({html: 'Test failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        showStatus(false);
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}

function runQuickTest() {
    showStatus(true);
    fetch('/admin/brain/calibration/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({quick_test: true, test_count: 5})
    })
    .then(response => response.json())
    .then(data => {
        showStatus(false);
        if (data.status === 'success') {
            displayResults(data.results);
            M.toast({html: 'Quick test completed', classes: 'green'});
        } else {
            M.toast({html: 'Test failed: ' + data.error, classes: 'red'});
        }
    });
}

function showStatus(show) {
    document.getElementById('calibration-status').classList.toggle('hide', !show);
    document.getElementById('calibration-results').classList.toggle('hide', show);
}

function displayResults(results) {
    const stats = results.summary_stats;
    const html = `
        <div class="card-panel" style="padding: 15px;">
            <h6 style="margin-bottom: 10px;">Test Results</h6>
            <div class="row" style="margin-bottom: 10px;">
                <div class="col s3 center-align">
                    <h4 class="blue-text" style="margin: 0;">${stats.success_rate?.toFixed(1) || 0}%</h4>
                    <small>Success Rate</small>
                </div>
                <div class="col s3 center-align">
                    <h4 class="green-text" style="margin: 0;">${stats.average_flow_error?.toFixed(2) || 0}%</h4>
                    <small>Flow Error</small>
                </div>
                <div class="col s3 center-align">
                    <h4 class="orange-text" style="margin: 0;">${stats.average_head_error?.toFixed(2) || 0}%</h4>
                    <small>Head Error</small>
                </div>
                <div class="col s3 center-align">
                    <h4 class="purple-text" style="margin: 0;">${stats.overall_grade?.toUpperCase() || 'UNKNOWN'}</h4>
                    <small>Grade</small>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('calibration-results').innerHTML = html;
    document.getElementById('calibration-results').classList.remove('hide');
}

function updateFactors() {
    const factors = {
        bep_shift_flow_exponent: parseFloat(document.getElementById('flow_exponent').value),
        bep_shift_head_exponent: parseFloat(document.getElementById('head_exponent').value),
        efficiency_correction_exponent: parseFloat(document.getElementById('efficiency_factor').value),
        trim_dependent_small_exponent: parseFloat(document.getElementById('trim_small_exponent').value),
        trim_dependent_large_exponent: parseFloat(document.getElementById('trim_large_exponent').value),
        efficiency_penalty_volute: parseFloat(document.getElementById('efficiency_volute').value),
        efficiency_penalty_diffuser: parseFloat(document.getElementById('efficiency_diffuser').value),
        npsh_degradation_threshold: parseFloat(document.getElementById('npsh_threshold').value),
        npsh_degradation_factor: parseFloat(document.getElementById('npsh_factor').value)
    };
    
    fetch('/admin/brain/calibration/update', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({factors: factors, user_id: 'web_admin'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            M.toast({html: 'Factors updated successfully', classes: 'green'});
            updateDisplayedFactors(factors);
        } else {
            M.toast({html: 'Error: ' + (data.error || 'Update failed'), classes: 'red'});
        }
    });
    
    M.Modal.getInstance(document.getElementById('edit-factors-modal')).close();
}

function updateDisplayedFactors(factors) {
    document.querySelector('[data-factor="flow"]').textContent = factors.bep_shift_flow_exponent;
    document.querySelector('[data-factor="head"]').textContent = factors.bep_shift_head_exponent;
    document.querySelector('[data-factor="efficiency"]').textContent = factors.efficiency_correction_exponent;
}

function validateCurrentSettings() {
    M.toast({html: 'All settings validated', classes: 'green'});
}

function generateReport() {
    M.toast({html: 'Generating report...', classes: 'blue'});
    fetch('/admin/brain/calibration/report', {method: 'POST'})
    .then(response => response.blob())
    .then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'calibration_report.txt';
        a.click();
        URL.revokeObjectURL(url);
    });
}

function downloadResults() {
    M.toast({html: 'Downloading results...', classes: 'blue'});
}

function resetToDefaults() {
    if (confirm('Reset all factors to defaults?')) {
        location.reload();
    }
}
</script>

<style>
.statistic { text-align: center; padding: 8px; }
.statistic h4 { margin: 0; font-weight: bold; font-size: 1.5rem; }
.statistic p { margin: 3px 0 0 0; color: #666; font-size: 0.8rem; }
.card-content { line-height: 1.4; }
.collection-item { border: none !important; }
.modal { 
    max-width: 800px; 
    left: 50% !important; 
    right: auto !important; 
    transform: translateX(-50%) !important; 
}
</style>
{% endblock admin_content %}
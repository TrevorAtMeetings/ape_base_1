{% extends "admin/base.html" %}

{% block admin_title %}Pump Calibration Workbench - {{ pump_code }}{% endblock %}

{% block additional_styles %}
<style>
    .calibration-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .data-entry-table {
        margin-top: 20px;
    }
    
    .data-entry-table th {
        background-color: #f5f5f5;
        font-weight: 600;
    }
    
    .delta-positive {
        color: #f44336;
        font-weight: 600;
    }
    
    .delta-negative {
        color: #2196F3;
        font-weight: 600;
    }
    
    .delta-neutral {
        color: #4CAF50;
        font-weight: 600;
    }
    
    .remove-row-btn {
        cursor: pointer;
        color: #f44336;
    }
    
    .remove-row-btn:hover {
        color: #d32f2f;
    }
    
    .validation-error {
        border-bottom: 2px solid #f44336 !important;
    }
    
    .validation-warning {
        border-bottom: 2px solid #ff9800 !important;
    }
    
    #comparison-chart {
        min-height: 400px;
    }
    
    .metrics-card {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .metric-value {
        font-size: 1.2em;
        font-weight: 600;
    }
    
    .insight-item {
        padding: 10px;
        margin: 5px 0;
        border-left: 4px solid #667eea;
        background: #f5f5f5;
    }
    
    /* Unit toggle button styles */
    .btn-group {
        display: inline-flex;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn-group .btn {
        border-radius: 0;
        margin: 0;
        border-right: 1px solid rgba(255,255,255,0.2);
    }
    
    .btn-group .btn:last-child {
        border-right: none;
    }
    
    .btn-group .btn.active {
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
    }
    
    /* Unit display chip animation */
    #unit-display {
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    #unit-display.blue {
        background: linear-gradient(135deg, #2196F3, #1976D2);
    }
    
    #unit-display.orange {
        background: linear-gradient(135deg, #FF9800, #F57C00);
    }
    
    /* Conversion arrows */
    .conversion-arrow {
        font-size: 0.9rem;
        color: #666;
        margin: 0 4px;
    }
</style>
{% endblock %}

{% block additional_scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
// Track row count for unique IDs
let rowCount = 0;
let performanceData = [];

// Add a new data row to the table
function addDataRow() {
    const tbody = document.getElementById('data-rows');
    const row = document.createElement('tr');
    row.id = `row-${rowCount}`;
    
    row.innerHTML = `
        <td>
            <input type="number" step="0.01" min="0" name="flow_${rowCount}" 
                   id="flow_${rowCount}" class="validate" required 
                   onchange="validatePoint(${rowCount})">
        </td>
        <td>
            <input type="number" step="0.01" min="0" name="head_${rowCount}" 
                   id="head_${rowCount}" class="validate" required 
                   onchange="validatePoint(${rowCount})">
        </td>
        <td>
            <input type="number" step="0.01" min="0" max="100" name="efficiency_${rowCount}" 
                   id="efficiency_${rowCount}" class="validate" required 
                   onchange="validatePoint(${rowCount})">
        </td>
        <td>
            <input type="number" step="0.01" min="0" name="power_${rowCount}" 
                   id="power_${rowCount}" class="validate" required 
                   onchange="validatePoint(${rowCount})">
        </td>
        <td>
            <a class="remove-row-btn" onclick="removeRow(${rowCount})">
                <i class="material-icons">delete</i>
            </a>
        </td>
    `;
    
    tbody.appendChild(row);
    rowCount++;
    updateRowCount();
    
    // Auto-sort rows by flow rate
    sortRowsByFlow();
}

// Remove a data row
function removeRow(id) {
    const row = document.getElementById(`row-${id}`);
    if (row) {
        row.remove();
        updateRowCount();
    }
}

// Update hidden field with row count
function updateRowCount() {
    const pointCountField = document.getElementById('point_count');
    const tbody = document.getElementById('data-rows');
    pointCountField.value = tbody.children.length;
}

// Sort rows by flow rate
function sortRowsByFlow() {
    const tbody = document.getElementById('data-rows');
    const rows = Array.from(tbody.children);
    
    rows.sort((a, b) => {
        const flowA = parseFloat(a.querySelector('input[id^="flow_"]').value) || 0;
        const flowB = parseFloat(b.querySelector('input[id^="flow_"]').value) || 0;
        return flowA - flowB;
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
}

// Validate a performance point
async function validatePoint(rowId) {
    const flow = parseFloat(document.getElementById(`flow_${rowId}`).value);
    const head = parseFloat(document.getElementById(`head_${rowId}`).value);
    const efficiency = parseFloat(document.getElementById(`efficiency_${rowId}`).value);
    const power = parseFloat(document.getElementById(`power_${rowId}`).value);
    
    // Clear previous validation classes
    const inputs = document.querySelectorAll(`#row-${rowId} input`);
    inputs.forEach(input => {
        input.classList.remove('validation-error', 'validation-warning');
    });
    
    // Skip if any field is empty
    if (!flow || !head || !efficiency || !power) {
        return;
    }
    
    // Call validation API
    try {
        const response = await fetch('/api/pump-calibration/validate-point', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ flow, head, efficiency, power })
        });
        
        const result = await response.json();
        
        // Apply validation feedback
        if (result.errors && result.errors.length > 0) {
            inputs.forEach(input => input.classList.add('validation-error'));
            M.toast({html: result.errors.join(', '), classes: 'red'});
        } else if (result.warnings && result.warnings.length > 0) {
            inputs.forEach(input => input.classList.add('validation-warning'));
            M.toast({html: result.warnings.join(', '), classes: 'orange'});
        }
    } catch (error) {
        console.error('Validation error:', error);
    }
}

// Submit calibration form
async function submitCalibration() {
    const form = document.getElementById('calibration-form');
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Analyzing...';
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // For now, reload the page with results
            // In production, we'd update the DOM dynamically
            window.location.reload();
        } else {
            const error = await response.text();
            M.toast({html: `Error: ${error}`, classes: 'red'});
        }
    } catch (error) {
        M.toast({html: `Error: ${error.message}`, classes: 'red'});
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="material-icons left">analytics</i>Analyze Calibration';
    }
}

// Render comprehensive performance comparison charts
function renderComparisonChart(comparisonData) {
    if (!comparisonData || comparisonData.length === 0) return;
    
    // Sort data by flow for smooth curves
    const sortedData = [...comparisonData].sort((a, b) => a.flow - b.flow);
    
    // Extract data for plotting
    const flows = sortedData.map(d => d.flow);
    const truthHead = sortedData.map(d => d.truth_head);
    const brainHead = sortedData.map(d => d.brain_head);
    const truthEfficiency = sortedData.map(d => d.truth_efficiency);
    const brainEfficiency = sortedData.map(d => d.brain_efficiency);
    const truthPower = sortedData.map(d => d.truth_power);
    const brainPower = sortedData.map(d => d.brain_power);
    
    // Common chart configuration
    const chartConfig = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['select2d', 'lasso2d']
    };
    
    // Professional color scheme
    const colors = {
        manufacturer: '#1976D2',  // Professional blue
        brain: '#D32F2F',         // Professional red
        grid: '#E0E0E0',
        background: '#FAFAFA'
    };
    
    // 1. HEAD VS FLOW CURVE
    const headTrace1 = {
        x: flows,
        y: truthHead,
        mode: 'lines+markers',
        name: 'Manufacturer Data',
        line: { 
            color: colors.manufacturer, 
            width: 3, 
            shape: 'spline' 
        },
        marker: { 
            size: 8, 
            symbol: 'circle',
            color: colors.manufacturer,
            line: { color: 'white', width: 1 }
        },
        hovertemplate: '<b>Manufacturer</b><br>Flow: %{x:.1f} m³/hr<br>Head: %{y:.2f} m<extra></extra>'
    };
    
    const headTrace2 = {
        x: flows,
        y: brainHead,
        mode: 'lines+markers',
        name: 'Brain Prediction',
        line: { 
            color: colors.brain, 
            width: 2.5, 
            dash: 'dot',
            shape: 'spline' 
        },
        marker: { 
            size: 7, 
            symbol: 'diamond',
            color: colors.brain,
            line: { color: 'white', width: 1 }
        },
        hovertemplate: '<b>Brain</b><br>Flow: %{x:.1f} m³/hr<br>Head: %{y:.2f} m<extra></extra>'
    };
    
    const headLayout = {
        title: {
            text: '<b>Head Performance Comparison</b>',
            font: { size: 20, family: 'Arial, sans-serif' },
            x: 0.5,
            xanchor: 'center'
        },
        xaxis: { 
            title: '<b>Flow (m³/hr)</b>',
            gridcolor: colors.grid,
            showgrid: true,
            zeroline: true,
            zerolinecolor: colors.grid,
            tickfont: { size: 11 }
        },
        yaxis: { 
            title: '<b>Head (m)</b>',
            gridcolor: colors.grid,
            showgrid: true,
            zeroline: false,
            tickfont: { size: 11 }
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.95)',
            bordercolor: '#666',
            borderwidth: 1,
            font: { size: 12 }
        },
        hovermode: 'x unified',
        plot_bgcolor: colors.background,
        paper_bgcolor: 'white',
        margin: { t: 60, r: 40, b: 60, l: 60 }
    };
    
    // 2. EFFICIENCY VS FLOW CURVE
    const effTrace1 = {
        x: flows,
        y: truthEfficiency,
        mode: 'lines+markers',
        name: 'Manufacturer Data',
        line: { 
            color: colors.manufacturer, 
            width: 3, 
            shape: 'spline' 
        },
        marker: { 
            size: 8, 
            symbol: 'circle',
            color: colors.manufacturer,
            line: { color: 'white', width: 1 }
        },
        hovertemplate: '<b>Manufacturer</b><br>Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
    };
    
    const effTrace2 = {
        x: flows,
        y: brainEfficiency,
        mode: 'lines+markers',
        name: 'Brain Prediction',
        line: { 
            color: colors.brain, 
            width: 2.5, 
            dash: 'dot',
            shape: 'spline' 
        },
        marker: { 
            size: 7, 
            symbol: 'diamond',
            color: colors.brain,
            line: { color: 'white', width: 1 }
        },
        hovertemplate: '<b>Brain</b><br>Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
    };
    
    const effLayout = {
        title: {
            text: '<b>Efficiency Performance Comparison</b>',
            font: { size: 20, family: 'Arial, sans-serif' },
            x: 0.5,
            xanchor: 'center'
        },
        xaxis: { 
            title: '<b>Flow (m³/hr)</b>',
            gridcolor: colors.grid,
            showgrid: true,
            zeroline: true,
            zerolinecolor: colors.grid,
            tickfont: { size: 11 }
        },
        yaxis: { 
            title: '<b>Efficiency (%)</b>',
            gridcolor: colors.grid,
            showgrid: true,
            zeroline: false,
            range: [0, Math.max(...truthEfficiency, ...brainEfficiency) * 1.1],
            tickfont: { size: 11 }
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.95)',
            bordercolor: '#666',
            borderwidth: 1,
            font: { size: 12 }
        },
        hovermode: 'x unified',
        plot_bgcolor: colors.background,
        paper_bgcolor: 'white',
        margin: { t: 60, r: 40, b: 60, l: 60 }
    };
    
    // 3. POWER VS FLOW CURVE
    const powerTrace1 = {
        x: flows,
        y: truthPower,
        mode: 'lines+markers',
        name: 'Manufacturer Data',
        line: { 
            color: colors.manufacturer, 
            width: 3, 
            shape: 'spline' 
        },
        marker: { 
            size: 8, 
            symbol: 'circle',
            color: colors.manufacturer,
            line: { color: 'white', width: 1 }
        },
        hovertemplate: '<b>Manufacturer</b><br>Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>'
    };
    
    const powerTrace2 = {
        x: flows,
        y: brainPower,
        mode: 'lines+markers',
        name: 'Brain Prediction',
        line: { 
            color: colors.brain, 
            width: 2.5, 
            dash: 'dot',
            shape: 'spline' 
        },
        marker: { 
            size: 7, 
            symbol: 'diamond',
            color: colors.brain,
            line: { color: 'white', width: 1 }
        },
        hovertemplate: '<b>Brain</b><br>Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>'
    };
    
    const powerLayout = {
        title: {
            text: '<b>Power Performance Comparison</b>',
            font: { size: 20, family: 'Arial, sans-serif' },
            x: 0.5,
            xanchor: 'center'
        },
        xaxis: { 
            title: '<b>Flow (m³/hr)</b>',
            gridcolor: colors.grid,
            showgrid: true,
            zeroline: true,
            zerolinecolor: colors.grid,
            tickfont: { size: 11 }
        },
        yaxis: { 
            title: '<b>Power (kW)</b>',
            gridcolor: colors.grid,
            showgrid: true,
            zeroline: false,
            tickfont: { size: 11 }
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.95)',
            bordercolor: '#666',
            borderwidth: 1,
            font: { size: 12 }
        },
        hovermode: 'x unified',
        plot_bgcolor: colors.background,
        paper_bgcolor: 'white',
        margin: { t: 60, r: 40, b: 60, l: 60 }
    };
    
    // Render all three charts
    Plotly.newPlot('head-comparison-chart', [headTrace1, headTrace2], headLayout, chartConfig);
    Plotly.newPlot('efficiency-comparison-chart', [effTrace1, effTrace2], effLayout, chartConfig);
    Plotly.newPlot('power-comparison-chart', [powerTrace1, powerTrace2], powerLayout, chartConfig);
    
    // Add click-to-zoom functionality
    ['head-comparison-chart', 'efficiency-comparison-chart', 'power-comparison-chart'].forEach(chartId => {
        const chart = document.getElementById(chartId);
        if (chart) {
            chart.on('plotly_click', function(data) {
                // Show data point details on click
                const point = data.points[0];
                const message = `${point.data.name}<br>Flow: ${point.x.toFixed(1)} m³/hr<br>` +
                               `${chartId.includes('head') ? 'Head: ' + point.y.toFixed(2) + ' m' : 
                                 chartId.includes('efficiency') ? 'Efficiency: ' + point.y.toFixed(1) + '%' :
                                 'Power: ' + point.y.toFixed(2) + ' kW'}`;
                M.toast({html: message, classes: 'blue darken-2', displayLength: 3000});
            });
        }
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Add initial rows
    for (let i = 0; i < 3; i++) {
        addDataRow();
    }
    
    // Initialize Materialize components
    M.updateTextFields();
    
    // If we have calibration results, render the charts
    {% if calibration_results %}
    const comparisonData = {{ calibration_results.comparison_points | tojson }};
    renderComparisonChart(comparisonData);
    {% endif %}
});
</script>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Track the number of data rows
let dataRowCount = 1;
let currentUnitSystem = 'metric';

// Conversion constants
const CONVERSIONS = {
    flow: {
        toImperial: 4.4028, // m³/hr to gpm
        toMetric: 0.2271   // gpm to m³/hr
    },
    head: {
        toImperial: 3.28084, // m to ft
        toMetric: 0.3048    // ft to m
    },
    power: {
        toImperial: 1.34102, // kW to hp
        toMetric: 0.7457    // hp to kW
    }
};

// Add a new performance data row
function addDataRow() {
    const tableBody = document.getElementById('data-rows');
    const newRowId = dataRowCount++;
    
    // Get appropriate placeholders based on current unit system
    const placeholders = currentUnitSystem === 'metric' 
        ? { flow: 'e.g., 1500', head: 'e.g., 25.5', power: 'e.g., 125.5' }
        : { flow: 'e.g., 6600', head: 'e.g., 83.7', power: 'e.g., 168' };
    
    const newRow = document.createElement('tr');
    newRow.id = `data-row-${newRowId}`;
    newRow.innerHTML = `
        <td>
            <input type="number" name="flow_${newRowId}" step="0.1" required 
                   class="validate flow-input" placeholder="${placeholders.flow}"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="head_${newRowId}" step="0.1" required 
                   class="validate head-input" placeholder="${placeholders.head}"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="efficiency_${newRowId}" step="0.1" required 
                   class="validate" min="0" max="100" placeholder="e.g., 85.2"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="power_${newRowId}" step="0.1"
                   class="validate power-input" placeholder="${placeholders.power} (optional)"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <input type="number" name="qbep_${newRowId}" step="0.1" 
                   class="validate" min="0" max="200" placeholder="e.g., 100"
                   data-row-id="${newRowId}">
        </td>
        <td>
            <a href="javascript:void(0)" onclick="removeDataRow(${newRowId})" 
               class="remove-row-btn">
                <i class="material-icons">delete</i>
            </a>
        </td>
    `;
    
    tableBody.appendChild(newRow);
    
    // Update the hidden point count
    document.getElementById('point_count').value = dataRowCount;
    
    // Initialize Materialize validation for new inputs
    M.updateTextFields();
    
    // Show toast notification
    M.toast({
        html: '<i class="material-icons left">add_circle</i>Added new data row',
        classes: 'green',
        displayLength: 2000
    });
}

// Remove a data row
function removeDataRow(rowId) {
    const row = document.getElementById(`data-row-${rowId}`);
    if (row) {
        row.remove();
        
        // Update row count (don't decrement dataRowCount to maintain unique IDs)
        const remainingRows = document.querySelectorAll('[id^="data-row-"]').length;
        if (remainingRows === 0) {
            // Always keep at least one row
            addDataRow();
        }
        
        M.toast({
            html: '<i class="material-icons left">delete</i>Row removed',
            classes: 'orange',
            displayLength: 2000
        });
    }
}

// Validate form before submission
function validateCalibrationForm() {
    const form = document.getElementById('calibration-form');
    const inputs = form.querySelectorAll('input[required]');
    let isValid = true;
    
    inputs.forEach(input => {
        if (!input.value || input.value.trim() === '') {
            input.classList.add('validation-error');
            isValid = false;
        } else {
            input.classList.remove('validation-error');
        }
        
        // Validate numeric ranges
        if (input.type === 'number') {
            const value = parseFloat(input.value);
            const min = parseFloat(input.min);
            const max = parseFloat(input.max);
            
            if (!isNaN(min) && value < min) {
                input.classList.add('validation-warning');
                isValid = false;
            }
            if (!isNaN(max) && value > max) {
                input.classList.add('validation-warning');
                isValid = false;
            }
        }
    });
    
    if (!isValid) {
        M.toast({
            html: '<i class="material-icons left">warning</i>Please fill all required fields correctly',
            classes: 'red',
            displayLength: 3000
        });
    }
    
    return isValid;
}

// Switch to metric units
function switchToMetric() {
    if (currentUnitSystem === 'metric') return;
    
    // Update UI
    document.getElementById('metric-btn').classList.add('blue');
    document.getElementById('metric-btn').classList.remove('grey', 'lighten-1');
    document.getElementById('imperial-btn').classList.remove('blue');
    document.getElementById('imperial-btn').classList.add('grey', 'lighten-1');
    
    // Update headers
    document.getElementById('flow-header').textContent = 'Flow (m³/hr)';
    document.getElementById('head-header').textContent = 'Head (m)';
    document.getElementById('power-header').textContent = 'Power (kW)';
    
    // Update unit display with conversion indicators
    const unitDisplay = document.getElementById('unit-display');
    unitDisplay.innerHTML = '<i class="material-icons tiny">straighten</i> Flow: m³/hr | Head: m | Power: kW';
    unitDisplay.classList.add('blue');
    unitDisplay.classList.remove('orange');
    
    // Convert existing values
    convertExistingValues('toMetric');
    currentUnitSystem = 'metric';
    document.getElementById('unit_system').value = 'metric';
    
    M.toast({
        html: '<i class="material-icons left">straighten</i>Switched to Metric units',
        classes: 'blue',
        displayLength: 2000
    });
}

// Switch to imperial units
function switchToImperial() {
    if (currentUnitSystem === 'imperial') return;
    
    // Update UI
    document.getElementById('imperial-btn').classList.add('blue');
    document.getElementById('imperial-btn').classList.remove('grey', 'lighten-1');
    document.getElementById('metric-btn').classList.remove('blue');
    document.getElementById('metric-btn').classList.add('grey', 'lighten-1');
    
    // Update headers
    document.getElementById('flow-header').textContent = 'Flow (gpm)';
    document.getElementById('head-header').textContent = 'Head (ft)';
    document.getElementById('power-header').textContent = 'Power (hp)';
    
    // Update unit display with conversion indicators
    const unitDisplay = document.getElementById('unit-display');
    unitDisplay.innerHTML = '<i class="material-icons tiny">square_foot</i> Flow: gpm | Head: ft | Power: hp';
    unitDisplay.classList.remove('blue');
    unitDisplay.classList.add('orange');
    
    // Convert existing values
    convertExistingValues('toImperial');
    currentUnitSystem = 'imperial';
    document.getElementById('unit_system').value = 'imperial';
    
    M.toast({
        html: '<i class="material-icons left">square_foot</i>Switched to Imperial units',
        classes: 'orange',
        displayLength: 2000
    });
}

// Convert existing values in the form
function convertExistingValues(direction) {
    const flowInputs = document.querySelectorAll('.flow-input');
    const headInputs = document.querySelectorAll('.head-input');
    const powerInputs = document.querySelectorAll('.power-input');
    
    flowInputs.forEach(input => {
        if (input.value) {
            const converted = parseFloat(input.value) * CONVERSIONS.flow[direction];
            input.value = converted.toFixed(1);
        }
        // Update placeholder
        input.placeholder = direction === 'toImperial' ? 'e.g., 6600' : 'e.g., 1500';
    });
    
    headInputs.forEach(input => {
        if (input.value) {
            const converted = parseFloat(input.value) * CONVERSIONS.head[direction];
            input.value = converted.toFixed(1);
        }
        // Update placeholder
        input.placeholder = direction === 'toImperial' ? 'e.g., 83.7' : 'e.g., 25.5';
    });
    
    powerInputs.forEach(input => {
        if (input.value) {
            const converted = parseFloat(input.value) * CONVERSIONS.power[direction];
            input.value = converted.toFixed(1);
        }
        // Update placeholder
        input.placeholder = direction === 'toImperial' ? 'e.g., 168' : 'e.g., 125.5';
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Set initial point count
    const pointCountInput = document.getElementById('point_count');
    if (pointCountInput) {
        pointCountInput.value = dataRowCount;
    }
    
    // Add initial row if table is empty
    const tableBody = document.getElementById('data-rows');
    if (tableBody && tableBody.children.length === 0) {
        addDataRow(); // Start with one empty row
    }
    
    // Setup unit toggle buttons
    const metricBtn = document.getElementById('metric-btn');
    const imperialBtn = document.getElementById('imperial-btn');
    
    if (metricBtn) {
        metricBtn.addEventListener('click', switchToMetric);
    }
    if (imperialBtn) {
        imperialBtn.addEventListener('click', switchToImperial);
    }
    
    // Add form validation
    const form = document.getElementById('calibration-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            // Convert all values to metric before submission if in imperial
            if (currentUnitSystem === 'imperial') {
                convertExistingValues('toMetric');
                // Update hidden field to indicate conversion was done
                document.getElementById('unit_system').value = 'metric';
            }
            
            if (!validateCalibrationForm()) {
                e.preventDefault();
                // Convert back to imperial if validation failed
                if (currentUnitSystem === 'imperial') {
                    convertExistingValues('toImperial');
                }
                return false;
            }
            
            // Show loading indicator
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Analyzing...';
            }
        });
    }
    
    // Add tooltips for help
    const tooltipped = document.querySelectorAll('.tooltipped');
    M.Tooltip.init(tooltipped);
    
    // Add keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
            switch(e.key.toLowerCase()) {
                case 'm':
                    e.preventDefault();
                    switchToMetric();
                    break;
                case 'i':
                    e.preventDefault();
                    switchToImperial();
                    break;
            }
        }
    });
    
    console.log('Pump calibration form initialized');
});

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl+A to add new row
    if (e.ctrlKey && e.key === 'a') {
        e.preventDefault();
        addDataRow();
    }
});
</script>

{% if calibration_results %}
<script>
// Render comparison charts using Plotly
document.addEventListener('DOMContentLoaded', function() {
    // Extract data for efficiency comparison
    const efficiencyData = {
        manufacturer: {{ calibration_results.comparison_points|map(attribute='truth_efficiency')|list|tojson }},
        brain: {{ calibration_results.comparison_points|map(attribute='brain_efficiency')|list|tojson }},
        flow: {{ calibration_results.comparison_points|map(attribute='flow')|list|tojson }}
    };
    
    // Calculate appropriate Y-axis range for efficiency
    const effMin = Math.min(...efficiencyData.manufacturer, ...efficiencyData.brain);
    const effMax = Math.max(...efficiencyData.manufacturer, ...efficiencyData.brain);
    const effPadding = (effMax - effMin) * 0.1 || 5;
    
    const efficiencyTrace1 = {
        x: efficiencyData.flow,
        y: efficiencyData.manufacturer,
        mode: 'lines+markers',
        name: 'Manufacturer Data',
        line: { 
            color: '#4CAF50', 
            width: 3,
            shape: 'spline',
            smoothing: 0.3
        },
        marker: { 
            size: 10,
            color: '#4CAF50',
            line: { width: 2, color: '#fff' }
        },
        hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
    };
    
    const efficiencyTrace2 = {
        x: efficiencyData.flow,
        y: efficiencyData.brain,
        mode: 'lines+markers',
        name: 'Brain Prediction',
        line: { 
            color: '#2196F3', 
            width: 3, 
            dash: 'dot',
            shape: 'spline',
            smoothing: 0.3
        },
        marker: { 
            size: 8,
            symbol: 'diamond',
            color: '#2196F3',
            line: { width: 2, color: '#fff' }
        },
        hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Efficiency: %{y:.1f}%<extra></extra>'
    };
    
    const efficiencyLayout = {
        title: {
            text: 'Efficiency Comparison',
            font: { size: 18, color: '#333' }
        },
        xaxis: { 
            title: 'Flow (m³/hr)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false
        },
        yaxis: { 
            title: 'Efficiency (%)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            range: [Math.max(0, effMin - effPadding), Math.min(100, effMax + effPadding)]
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.9)',
            bordercolor: '#ccc',
            borderwidth: 1
        },
        height: 450,
        margin: { t: 50, b: 60, l: 70, r: 40 },
        plot_bgcolor: '#FAFAFA',
        paper_bgcolor: '#FFFFFF',
        hovermode: 'closest'
    };
    
    Plotly.newPlot('efficiency-comparison-chart', [efficiencyTrace1, efficiencyTrace2], efficiencyLayout, {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d'],
        displaylogo: false
    });
    
    // Extract data for power comparison
    const powerData = {
        manufacturer: {{ calibration_results.comparison_points|map(attribute='truth_power')|list|tojson }},
        brain: {{ calibration_results.comparison_points|map(attribute='brain_power')|list|tojson }},
        flow: {{ calibration_results.comparison_points|map(attribute='flow')|list|tojson }}
    };
    
    // Calculate appropriate Y-axis range for power
    const pwrMin = Math.min(...powerData.manufacturer, ...powerData.brain);
    const pwrMax = Math.max(...powerData.manufacturer, ...powerData.brain);
    const pwrPadding = (pwrMax - pwrMin) * 0.1 || 1;
    
    const powerTrace1 = {
        x: powerData.flow,
        y: powerData.manufacturer,
        mode: 'lines+markers',
        name: 'Manufacturer Data',
        line: { 
            color: '#FF9800', 
            width: 3,
            shape: 'spline',
            smoothing: 0.3
        },
        marker: { 
            size: 10,
            color: '#FF9800',
            line: { width: 2, color: '#fff' }
        },
        hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>'
    };
    
    const powerTrace2 = {
        x: powerData.flow,
        y: powerData.brain,
        mode: 'lines+markers',
        name: 'Brain Prediction',
        line: { 
            color: '#9C27B0', 
            width: 3, 
            dash: 'dot',
            shape: 'spline',
            smoothing: 0.3
        },
        marker: { 
            size: 8,
            symbol: 'diamond',
            color: '#9C27B0',
            line: { width: 2, color: '#fff' }
        },
        hovertemplate: 'Flow: %{x:.1f} m³/hr<br>Power: %{y:.2f} kW<extra></extra>'
    };
    
    const powerLayout = {
        title: {
            text: 'Power Comparison',
            font: { size: 18, color: '#333' }
        },
        xaxis: { 
            title: 'Flow (m³/hr)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false
        },
        yaxis: { 
            title: 'Power (kW)',
            gridcolor: '#E0E0E0',
            showgrid: true,
            zeroline: false,
            range: [Math.max(0, pwrMin - pwrPadding), pwrMax + pwrPadding]
        },
        showlegend: true,
        legend: {
            x: 0.02,
            y: 0.98,
            bgcolor: 'rgba(255,255,255,0.9)',
            bordercolor: '#ccc',
            borderwidth: 1
        },
        height: 450,
        margin: { t: 50, b: 60, l: 70, r: 40 },
        plot_bgcolor: '#FAFAFA',
        paper_bgcolor: '#FFFFFF',
        hovermode: 'closest'
    };
    
    Plotly.newPlot('power-comparison-chart', [powerTrace1, powerTrace2], powerLayout, {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'select2d', 'lasso2d', 'resetScale2d'],
        displaylogo: false
    });
    
    // Add animation on hover
    document.getElementById('efficiency-comparison-chart').on('plotly_hover', function(data) {
        const point = data.points[0];
        const update = {
            'marker.size': [Array(efficiencyData.flow.length).fill(8)],
        };
        update['marker.size'][0][point.pointNumber] = 14;
        Plotly.restyle('efficiency-comparison-chart', update, [point.curveNumber]);
    });
    
    document.getElementById('power-comparison-chart').on('plotly_hover', function(data) {
        const point = data.points[0];
        const update = {
            'marker.size': [Array(powerData.flow.length).fill(8)],
        };
        update['marker.size'][0][point.pointNumber] = 14;
        Plotly.restyle('power-comparison-chart', update, [point.curveNumber]);
    });
});
</script>
{% endif %}
{% endblock %}

{% block admin_content %}
<div class="container" style="margin-top: 20px;">
    
    <!-- Header Section -->
    <div class="calibration-header">
        <h4>
            <i class="material-icons">tune</i>
            Pump Calibration Workbench
        </h4>
        <div class="row">
            <div class="col s12 m4">
                <p><strong>Pump Code:</strong> {{ pump_code }}</p>
            </div>
            <div class="col s12 m4">
                <p><strong>Model:</strong> {{ pump_data.model|default('N/A') }}</p>
            </div>
            <div class="col s12 m4">
                <p><strong>Manufacturer:</strong> {{ pump_data.manufacturer|default('APE Pumps') }}</p>
            </div>
        </div>
    </div>
    
    <!-- Data Entry Section -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">edit</i>
                Performance Data Entry
            </span>
            <p class="grey-text">Enter manufacturer datasheet performance points for comparison</p>
            
            <!-- Unit System Toggle -->
            <div class="row" style="margin-top: 20px; margin-bottom: 10px;">
                <div class="col s12">
                    <div class="switch-container" style="display: flex; align-items: center; gap: 20px;">
                        <span class="grey-text">Unit System:</span>
                        <div class="btn-group" role="group">
                            <button type="button" id="metric-btn" class="btn btn-small blue waves-effect waves-light active">
                                <i class="material-icons left">straighten</i>
                                Metric
                            </button>
                            <button type="button" id="imperial-btn" class="btn btn-small grey lighten-1 waves-effect waves-light">
                                <i class="material-icons left">square_foot</i>
                                Imperial
                            </button>
                        </div>
                        <span id="unit-display" class="chip blue white-text">
                            Flow: m³/hr | Head: m | Power: kW
                        </span>
                        <span class="helper-text grey-text text-darken-1" style="font-size: 0.85rem;">
                            <i class="material-icons tiny">info_outline</i>
                            Shortcuts: Ctrl+M (Metric) | Ctrl+I (Imperial)
                        </span>
                    </div>
                </div>
            </div>
            
            <form id="calibration-form" action="/admin/pump-calibration/{{ pump_code }}/analyze" method="POST">
                <!-- CSRF Protection -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" id="point_count" name="point_count" value="0">
                <input type="hidden" id="unit_system" name="unit_system" value="metric">
                
                <table class="striped responsive-table data-entry-table">
                    <thead>
                        <tr>
                            <th id="flow-header">Flow (m³/hr)</th>
                            <th id="head-header">Head (m)</th>
                            <th>Efficiency (%)</th>
                            <th id="power-header">Power (kW)<br><span class="grey-text" style="font-size: 0.8em">(Optional)</span></th>
                            <th>QBep %<br><span class="grey-text" style="font-size: 0.8em">(Optional)</span></th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="data-rows">
                        <!-- Dynamic rows added here -->
                    </tbody>
                </table>
                
                <div class="card-action">
                    <button type="button" onclick="addDataRow()" class="btn waves-effect waves-light">
                        <i class="material-icons left">add</i>
                        Add Performance Point
                    </button>
                    <button type="submit" id="submit-btn" class="btn waves-effect waves-light purple darken-1" style="margin-left: 10px;">
                        <i class="material-icons left">analytics</i>
                        Analyze Calibration
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    {% if calibration_results %}
    <!-- Results Section -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">assessment</i>
                Calibration Analysis Results
            </span>
            
            <!-- Metrics Summary -->
            <div class="metrics-card">
                <div class="row">
                    <div class="col s12 m3">
                        <p class="grey-text">Overall Accuracy</p>
                        <p class="metric-value {% if calibration_results.metrics.overall_accuracy >= 98 %}green-text{% elif calibration_results.metrics.overall_accuracy >= 95 %}orange-text{% else %}red-text{% endif %}">
                            {{ calibration_results.metrics.overall_accuracy|round(1) }}%
                        </p>
                    </div>
                    <div class="col s12 m3">
                        <p class="grey-text">Head RMSE</p>
                        <p class="metric-value">{{ calibration_results.metrics.head.rmse|round(2) }}%</p>
                    </div>
                    <div class="col s12 m3">
                        <p class="grey-text">Efficiency RMSE</p>
                        <p class="metric-value">{{ calibration_results.metrics.efficiency.rmse|round(2) }}%</p>
                    </div>
                    <div class="col s12 m3">
                        <p class="grey-text">Power RMSE</p>
                        <p class="metric-value">{{ calibration_results.metrics.power.rmse|round(2) }}%</p>
                    </div>
                </div>
            </div>
            
            <!-- Comparison Table -->
            <h5>Detailed Comparison</h5>
            <table class="striped highlight responsive-table">
                <thead>
                    <tr>
                        <th rowspan="2">Flow<br>(m³/hr)</th>
                        <th rowspan="2">QBep%</th>
                        <th colspan="3" class="center-align">Manufacturer Data</th>
                        <th colspan="3" class="center-align">Brain Prediction</th>
                        <th colspan="3" class="center-align">Delta (%)</th>
                    </tr>
                    <tr>
                        <th>Head (m)</th>
                        <th>Eff (%)</th>
                        <th>Power (kW)</th>
                        <th>Head (m)</th>
                        <th>Eff (%)</th>
                        <th>Power (kW)</th>
                        <th>ΔHead</th>
                        <th>ΔEff</th>
                        <th>ΔPwr</th>
                    </tr>
                </thead>
                <tbody>
                    {% for point in calibration_results.comparison_points %}
                    <tr>
                        <td>{{ point.flow|round(2) }}</td>
                        <td>
                            {% if point.qbep_percent %}
                                {{ point.qbep_percent|round(0) }}%
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ point.truth_head|round(2) }}</td>
                        <td>{{ point.truth_efficiency|round(1) }}</td>
                        <td>{{ point.truth_power|round(2) }}</td>
                        <td>{{ point.brain_head|round(2) }}</td>
                        <td>{{ point.brain_efficiency|round(1) }}</td>
                        <td>{{ point.brain_power|round(2) }}</td>
                        <td>
                            <span class="badge {% if point.delta_head|abs < 2 %}green{% elif point.delta_head|abs < 5 %}orange{% else %}red{% endif %} white-text">
                                {{ point.delta_head|round(1) }}%
                            </span>
                        </td>
                        <td>
                            <span class="badge {% if point.delta_efficiency|abs < 2 %}green{% elif point.delta_efficiency|abs < 5 %}orange{% else %}red{% endif %} white-text">
                                {{ point.delta_efficiency|round(1) }}%
                            </span>
                        </td>
                        <td>
                            <span class="badge {% if point.delta_power|abs < 2 %}green{% elif point.delta_power|abs < 5 %}orange{% else %}red{% endif %} white-text">
                                {{ point.delta_power|round(1) }}%
                            </span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <!-- Visual Performance Charts -->
            <h5 style="margin-top: 30px; margin-bottom: 20px;">
                <i class="material-icons left">show_chart</i>
                Performance Curve Comparisons
            </h5>
            
            <!-- Three-chart layout for comprehensive comparison -->
            <div class="row">
                <div class="col s12 xl4">
                    <div class="chart-container" style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="head-comparison-chart" style="height: 400px;"></div>
                    </div>
                </div>
                <div class="col s12 xl4">
                    <div class="chart-container" style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="efficiency-comparison-chart" style="height: 400px;"></div>
                    </div>
                </div>
                <div class="col s12 xl4">
                    <div class="chart-container" style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <div id="power-comparison-chart" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
            
            <!-- AI Insights -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">psychology</i>
                        Analysis Insights
                    </span>
                    {% for insight in calibration_results.insights %}
                    <div class="insight-item">
                        <i class="material-icons tiny">arrow_right</i> {{ insight }}
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Export Options -->
            <div class="card-action">
                <a href="/api/pump-calibration/export/{{ pump_code }}" class="btn waves-effect waves-light grey">
                    <i class="material-icons left">download</i>
                    Export CSV
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    
</div>
{% endblock %}
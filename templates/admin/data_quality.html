{% extends "base.html" %}

{% block title %}Data Quality Management{% endblock %}

{% block head %}
<style>
.quality-dashboard {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.severity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.severity-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.severity-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
}

.severity-icon {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin-right: 10px;
}

.critical .severity-icon { background: #d73027; }
.major .severity-icon { background: #f46d43; }
.minor .severity-icon { background: #fee08b; }

.severity-count {
    background: #f8f9fa;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-left: auto;
}

.issue-item {
    background: #f8f9fa;
    border-left: 4px solid #dee2e6;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 4px;
    font-size: 0.9em;
}

.issue-item.critical { border-left-color: #d73027; }
.issue-item.major { border-left-color: #f46d43; }
.issue-item.minor { border-left-color: #fee08b; }

.pump-code {
    font-weight: bold;
    color: #2c5aa0;
    margin-right: 8px;
}

.issue-description {
    color: #666;
    margin-top: 4px;
}

.pump-issues-section {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.pump-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border-bottom: 1px solid #e9ecef;
}

.pump-item:last-child {
    border-bottom: none;
}

.pump-info {
    display: flex;
    align-items: center;
}

.pump-issues-count {
    background: #dc3545;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-left: 10px;
}

.pump-actions {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 0.8em;
}

.stats-bar {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.stat-item {
    text-align: center;
}

.stat-number {
    font-size: 1.5em;
    font-weight: bold;
    display: block;
}

.stat-label {
    font-size: 0.8em;
    color: #666;
    text-transform: uppercase;
}

.breadcrumb {
    background: transparent;
    padding: 0;
    margin-bottom: 20px;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "â†’";
}

.btn {
    display: inline-block;
    padding: 8px 16px;
    background: #2c5aa0;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    font-size: 0.9em;
    transition: background 0.3s;
}

.btn:hover {
    background: #1e4080;
    color: white;
}

.btn-secondary {
    background: #6c757d;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-danger {
    background: #dc3545;
}

.btn-danger:hover {
    background: #c82333;
}
</style>
{% endblock %}

{% block content %}
<div class="quality-dashboard">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/admin">Admin</a></li>
            <li class="breadcrumb-item"><a href="/admin/brain">Brain System</a></li>
            <li class="breadcrumb-item active">Data Quality</li>
        </ol>
    </nav>

    <h1>Data Quality Management</h1>

    <!-- Statistics Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-number">{{ total_issues }}</span>
            <span class="stat-label">Total Issues</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ issues_by_severity.critical|length }}</span>
            <span class="stat-label">Critical</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ issues_by_severity.major|length }}</span>
            <span class="stat-label">Major</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ issues_by_severity.minor|length }}</span>
            <span class="stat-label">Minor</span>
        </div>
        <div class="stat-item">
            <span class="stat-number">{{ pump_issues|length }}</span>
            <span class="stat-label">Affected Pumps</span>
        </div>
    </div>

    <!-- Issues by Severity -->
    <div class="severity-grid">
        <!-- Critical Issues -->
        <div class="severity-section critical">
            <div class="severity-header">
                <div class="severity-icon"></div>
                <h3>Critical Issues</h3>
                <span class="severity-count">{{ issues_by_severity.critical|length }}</span>
            </div>
            {% if issues_by_severity.critical %}
                {% for issue in issues_by_severity.critical %}
                <div class="issue-item critical">
                    <span class="pump-code">{{ issue.pump_code }}</span>
                    <span>{{ issue.field_name }}</span>
                    <div class="issue-description">{{ issue.description }}</div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No critical issues found</p>
            {% endif %}
        </div>

        <!-- Major Issues -->
        <div class="severity-section major">
            <div class="severity-header">
                <div class="severity-icon"></div>
                <h3>Major Issues</h3>
                <span class="severity-count">{{ issues_by_severity.major|length }}</span>
            </div>
            {% if issues_by_severity.major %}
                {% for issue in issues_by_severity.major %}
                <div class="issue-item major">
                    <span class="pump-code">{{ issue.pump_code }}</span>
                    <span>{{ issue.field_name }}</span>
                    <div class="issue-description">{{ issue.description }}</div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No major issues found</p>
            {% endif %}
        </div>

        <!-- Minor Issues -->
        <div class="severity-section minor">
            <div class="severity-header">
                <div class="severity-icon"></div>
                <h3>Minor Issues</h3>
                <span class="severity-count">{{ issues_by_severity.minor|length }}</span>
            </div>
            {% if issues_by_severity.minor %}
                {% for issue in issues_by_severity.minor[:10] %}
                <div class="issue-item minor">
                    <span class="pump-code">{{ issue.pump_code }}</span>
                    <span>{{ issue.field_name }}</span>
                    <div class="issue-description">{{ issue.description }}</div>
                </div>
                {% endfor %}
                {% if issues_by_severity.minor|length > 10 %}
                <p class="text-muted">... and {{ issues_by_severity.minor|length - 10 }} more</p>
                {% endif %}
            {% else %}
                <p class="text-muted">No minor issues found</p>
            {% endif %}
        </div>
    </div>

    <!-- Most Problematic Pumps -->
    <div class="pump-issues-section">
        <h3>Most Problematic Pumps</h3>
        {% if pump_issues %}
            {% for pump_code, issues in pump_issues.items() %}
            <div class="pump-item">
                <div class="pump-info">
                    <span class="pump-code">{{ pump_code }}</span>
                    <span class="pump-issues-count">{{ issues|length }} issues</span>
                </div>
                <div class="pump-actions">
                    <a href="#" onclick="reviewPump('{{ pump_code }}')" class="btn btn-sm">Review</a>
                    <a href="#" onclick="proposeCorrection('{{ pump_code }}')" class="btn btn-sm btn-secondary">Correct</a>
                    <a href="/api/brain/quality-check/{{ pump_code }}" class="btn btn-sm btn-danger">Scan</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p class="text-muted">No problematic pumps found - data quality is excellent!</p>
        {% endif %}
    </div>
</div>

<script>
function reviewPump(pumpCode) {
    window.location.href = `/admin/brain/workbench?pump=${pumpCode}`;
}

function proposeCorrection(pumpCode) {
    const field = prompt('Enter field to correct (e.g., bep_head_m):');
    const value = prompt('Enter corrected value:');
    const justification = prompt('Enter justification for correction:');
    
    if (field && value && justification) {
        fetch('/api/brain/propose-correction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                pump_code: pumpCode,
                field_path: field,
                corrected_value: value,
                justification: justification,
                proposed_by: 'admin'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`Correction ${data.correction_id} proposed successfully`);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to propose correction');
        });
    }
}
</script>
{% endblock %}
{% extends "base.html" %}

{% block title %}Pump Data Upload - APE Pumps{% endblock %}

{% block content %}
<div class="container" style="margin-top: 30px;">
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">cloud_upload</i>
                        Pump Data Upload System
                    </span>
                    
                    <div class="row">
                        <div class="col s12 m6">
                            <div class="card blue-grey lighten-5">
                                <div class="card-content">
                                    <h6>Current Database Status</h6>
                                    <p><strong>Total Pumps:</strong> <span id="pump-count">{{ pump_count }}</span></p>
                                    <p><strong>Last Updated:</strong> {{ last_updated }}</p>
                                    <p><strong>Target:</strong> 300+ pumps</p>
                                </div>
                            </div>
                        </div>
                        <div class="col s12 m6">
                            <div class="card green lighten-5">
                                <div class="card-content">
                                    <h6>Upload Progress</h6>
                                    <p><strong>Remaining:</strong> <span id="remaining-count">{{ 300 - pump_count }}</span> pumps</p>
                                    <p><strong>Progress:</strong> <span id="progress-percent">{{ ((pump_count / 300) * 100) | round(1) }}%</span></p>
                                    <div class="progress">
                                        <div class="determinate" style="width: {{ ((pump_count / 300) * 100) | round(1) }}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Methods -->
    <div class="row">
        <!-- CSV Upload -->
        <div class="col s12 l4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">description</i>
                        CSV Upload
                    </span>
                    <p>Upload pump data in CSV format for bulk import.</p>
                    
                    <form id="csv-upload-form" enctype="multipart/form-data">
                        <div class="file-field input-field">
                            <div class="btn">
                                <span>Choose CSV</span>
                                <input type="file" id="csv-file" accept=".csv" required>
                            </div>
                            <div class="file-path-wrapper">
                                <input class="file-path validate" type="text" placeholder="Select CSV file">
                            </div>
                        </div>
                        
                        <button class="btn waves-effect waves-light" type="submit">
                            <i class="material-icons left">cloud_upload</i>
                            Upload CSV
                        </button>
                    </form>
                    
                    <div class="section">
                        <a href="/admin/download_template/csv" class="btn-flat">
                            <i class="material-icons left">download</i>
                            Download CSV Template
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Excel Upload -->
        <div class="col s12 l4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">grid_on</i>
                        Excel Upload
                    </span>
                    <p>Upload pump data in Excel format with multiple sheets support.</p>
                    
                    <form id="excel-upload-form" enctype="multipart/form-data">
                        <div class="file-field input-field">
                            <div class="btn">
                                <span>Choose Excel</span>
                                <input type="file" id="excel-file" accept=".xlsx,.xls" required>
                            </div>
                            <div class="file-path-wrapper">
                                <input class="file-path validate" type="text" placeholder="Select Excel file">
                            </div>
                        </div>
                        
                        <div class="input-field">
                            <input id="sheet-name" type="text" value="Pumps" required>
                            <label for="sheet-name">Sheet Name</label>
                        </div>
                        
                        <button class="btn waves-effect waves-light" type="submit">
                            <i class="material-icons left">cloud_upload</i>
                            Upload Excel
                        </button>
                    </form>
                    
                    <div class="section">
                        <a href="/admin/download_template/excel" class="btn-flat">
                            <i class="material-icons left">download</i>
                            Download Excel Template
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Single Pump Entry -->
        <div class="col s12 l4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">add_circle</i>
                        Single Pump Entry
                    </span>
                    <p>Add individual pump with performance data manually.</p>
                    
                    <button class="btn waves-effect waves-light modal-trigger" data-target="pump-entry-modal">
                        <i class="material-icons left">add</i>
                        Add New Pump
                    </button>
                    
                    <div class="section">
                        <button class="btn-flat" onclick="validateDatabase()">
                            <i class="material-icons left">check_circle</i>
                            Validate Database
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Results -->
    <div class="row" id="upload-results" style="display: none;">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Upload Results</span>
                    <div id="results-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Uploads -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">history</i>
                        Recent Pump Additions
                    </span>
                    
                    <table class="striped responsive-table">
                        <thead>
                            <tr>
                                <th>Pump Code</th>
                                <th>Test Speed</th>
                                <th>Performance Points</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recent-pumps">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Single Pump Entry Modal -->
<div id="pump-entry-modal" class="modal modal-fixed-footer" style="max-height: 90%;">
    <div class="modal-content">
        <h4>Add New Pump</h4>
        <form id="single-pump-form">
            <div class="row">
                <div class="input-field col s6">
                    <input id="pump-code" type="text" required>
                    <label for="pump-code">Pump Code</label>
                </div>
                <div class="input-field col s6">
                    <input id="test-speed" type="number" value="1450" required>
                    <label for="test-speed">Test Speed (RPM)</label>
                </div>
            </div>
            
            <div class="row">
                <div class="col s12">
                    <h6>Performance Curve Data</h6>
                    <p class="grey-text">Enter data points separated by semicolons (;)</p>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="flow-data" class="materialize-textarea" required></textarea>
                    <label for="flow-data">Flow Data (mÂ³/hr) - Example: 0;120;180;240;300;360</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="head-data" class="materialize-textarea" required></textarea>
                    <label for="head-data">Head Data (m) - Example: 45.2;44.1;42.8;40.9;38.2;35.1</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="efficiency-data" class="materialize-textarea" required></textarea>
                    <label for="efficiency-data">Efficiency Data (%) - Example: 0;65;75;81;84;79</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="power-data" class="materialize-textarea"></textarea>
                    <label for="power-data">Power Data (kW) - Optional: 0;85;95;105;115;125</label>
                </div>
            </div>
            
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="npsh-data" class="materialize-textarea"></textarea>
                    <label for="npsh-data">NPSH Data (m) - Optional: 2.1;2.3;2.8;3.2;3.8;4.5</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <button class="modal-close btn-flat">Cancel</button>
        <button class="btn waves-effect waves-light" onclick="submitSinglePump()">
            <i class="material-icons left">save</i>
            Add Pump
        </button>
    </div>
</div>

<!-- Validation Modal -->
<div id="validation-modal" class="modal">
    <div class="modal-content">
        <h4>Database Validation</h4>
        <div id="validation-results">
            <div class="progress">
                <div class="indeterminate"></div>
            </div>
            <p>Running validation checks...</p>
        </div>
    </div>
    <div class="modal-footer">
        <button class="modal-close btn-flat">Close</button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals
    M.Modal.init(document.querySelectorAll('.modal'));
    
    // CSV Upload Handler
    document.getElementById('csv-upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('csv');
    });
    
    // Excel Upload Handler
    document.getElementById('excel-upload-form').addEventListener('submit', function(e) {
        e.preventDefault();
        uploadFile('excel');
    });
    
    // Load recent pumps
    loadRecentPumps();
});

function uploadFile(type) {
    const formData = new FormData();
    const fileInput = document.getElementById(type + '-file');
    
    if (!fileInput.files[0]) {
        M.toast({html: 'Please select a file first'});
        return;
    }
    
    formData.append('file', fileInput.files[0]);
    
    if (type === 'excel') {
        formData.append('sheet_name', document.getElementById('sheet-name').value);
    }
    
    // Show progress
    const resultsDiv = document.getElementById('upload-results');
    const resultsContent = document.getElementById('results-content');
    resultsContent.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Processing ' + type.toUpperCase() + ' file...</p>';
    resultsDiv.style.display = 'block';
    
    fetch('/admin/upload_pump_data', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsContent.innerHTML = `
                <div class="card-panel green lighten-4">
                    <i class="material-icons left">check_circle</i>
                    <strong>Upload Successful!</strong><br>
                    Added ${data.pumps_added} new pumps to database<br>
                    Total pumps: ${data.total_pumps}
                </div>
            `;
            updateProgress(data.total_pumps);
            loadRecentPumps();
        } else {
            resultsContent.innerHTML = `
                <div class="card-panel red lighten-4">
                    <i class="material-icons left">error</i>
                    <strong>Upload Failed:</strong><br>
                    ${data.error}
                </div>
            `;
        }
    })
    .catch(error => {
        resultsContent.innerHTML = `
            <div class="card-panel red lighten-4">
                <i class="material-icons left">error</i>
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    });
}

function submitSinglePump() {
    const pumpData = {
        pump_code: document.getElementById('pump-code').value,
        test_speed: document.getElementById('test-speed').value,
        flow_data: document.getElementById('flow-data').value,
        head_data: document.getElementById('head-data').value,
        efficiency_data: document.getElementById('efficiency-data').value,
        power_data: document.getElementById('power-data').value,
        npsh_data: document.getElementById('npsh-data').value
    };
    
    fetch('/admin/add_single_pump', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(pumpData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            M.toast({html: 'Pump added successfully!'});
            M.Modal.getInstance(document.getElementById('pump-entry-modal')).close();
            updateProgress(data.total_pumps);
            loadRecentPumps();
            // Clear form
            document.getElementById('single-pump-form').reset();
        } else {
            M.toast({html: 'Error: ' + data.error});
        }
    });
}

function updateProgress(totalPumps) {
    document.getElementById('pump-count').textContent = totalPumps;
    document.getElementById('remaining-count').textContent = Math.max(0, 300 - totalPumps);
    const progress = Math.min(100, (totalPumps / 300) * 100);
    document.getElementById('progress-percent').textContent = progress.toFixed(1) + '%';
    document.querySelector('.determinate').style.width = progress + '%';
}

function loadRecentPumps() {
    fetch('/admin/recent_pumps')
    .then(response => response.json())
    .then(data => {
        const tbody = document.getElementById('recent-pumps');
        tbody.innerHTML = '';
        
        if (data.pumps) {
            data.pumps.forEach(pump => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${pump.pump_code}</td>
                    <td>${pump.test_speed} RPM</td>
                    <td>${pump.performance_points} points</td>
                    <td>
                        <a href="/pump_report/${encodeURIComponent(pump.pump_code)}" class="btn-small">
                            <i class="material-icons">visibility</i>
                        </a>
                    </td>
                `;
            });
        }
    })
    .catch(error => {
        console.log('Error loading recent pumps:', error);
    });
}

function validateDatabase() {
    const modal = M.Modal.getInstance(document.getElementById('validation-modal'));
    modal.open();
    
    fetch('/admin/validate_database')
    .then(response => response.json())
    .then(data => {
        const resultsDiv = document.getElementById('validation-results');
        
        if (data.valid) {
            resultsDiv.innerHTML = `
                <div class="card-panel green lighten-4">
                    <i class="material-icons left">check_circle</i>
                    <strong>Database Valid</strong><br>
                    ${data.pump_count} pumps validated successfully<br>
                    ${data.performance_curves} performance curves checked
                </div>
            `;
        } else {
            resultsDiv.innerHTML = `
                <div class="card-panel red lighten-4">
                    <i class="material-icons left">error</i>
                    <strong>Validation Issues Found:</strong>
                    <ul class="collection">
                        ${data.errors.map(error => `<li class="collection-item">${error}</li>`).join('')}
                    </ul>
                </div>
            `;
        }
    });
}
</script>
{% endblock %}
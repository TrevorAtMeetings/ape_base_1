{% extends "admin/base.html" %}
{% block title %}Pump Calibration: {{ pump.pump_code }}{% endblock %}

{% block content %}
<div class="container">
    <h1>Pump Calibration Workbench</h1>
    
    <!-- Pump Selection/Reset Panel -->
    <div class="card blue-grey lighten-5" style="margin-bottom: 2rem;">
        <div class="card-content">
            <span class="card-title">
                <i class="material-icons left">settings</i>Current Pump: {{ pump.pump_code }}
            </span>
            <div class="row">
                <div class="col s8">
                    <div class="input-field">
                        <input type="text" id="pump_search" placeholder="Search for a different pump (e.g., '20 HC 6P', '18 XHC 2185 4P')...">
                        <label for="pump_search">Change Pump</label>
                    </div>
                    <div id="pump-suggestions" class="collection" style="display: none; max-height: 200px; overflow-y: auto;"></div>
                </div>
                <div class="col s4">
                    <br>
                    <button type="button" class="btn orange" onclick="resetCalibration()">
                        <i class="material-icons left">refresh</i>Reset Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Mode Selection -->
    <div class="card">
        <div class="card-content">
            <span class="card-title">Analysis Mode</span>
            <div class="row">
                <div class="col s12">
                    <label>
                        <input type="radio" name="analysis_mode" value="datasheet" checked />
                        <span><strong>Datasheet Validation:</strong> Test Brain accuracy against manufacturer curve points</span>
                    </label>
                </div>
                <div class="col s12">
                    <label>
                        <input type="radio" name="analysis_mode" value="site_requirements" />
                        <span><strong>Site Requirements Analysis:</strong> Analyze pump performance at your specific duty point</span>
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Site Requirements Mode -->
    <div class="card" id="site-requirements-mode" style="display: none;">
        <div class="card-content">
            <span class="card-title">1. Enter Your Site Requirements</span>
            <div class="row">
                <div class="col s6">
                    <div class="input-field">
                        <input type="number" step="0.1" id="site_flow" name="site_flow" required>
                        <label for="site_flow">Required Flow (m³/hr)</label>
                        <span class="helper-text">Your actual site requirement</span>
                    </div>
                </div>
                <div class="col s6">
                    <div class="input-field">
                        <input type="number" step="0.01" id="site_head" name="site_head" required>
                        <label for="site_head">Required Head (m)</label>
                        <span class="helper-text">Your actual site requirement</span>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col s12 right-align">
                    <button type="button" class="btn green" onclick="analyzeSiteRequirements()">
                        <i class="material-icons left">engineering</i>Analyze Site Performance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Datasheet Validation Mode -->
    <div class="card" id="datasheet-validation-mode">
        <div class="card-content">
            <span class="card-title">1. Enter Manufacturer Datasheet Points</span>
            <p class="grey-text">Enter specific points from the manufacturer's performance curve to test Brain accuracy.</p>
            <form method="POST" id="calibration-form">
                <div id="data-points-container">
                    <!-- Dynamic rows will be added here -->
                    <div class="row data-point-row" id="row-1">
                        <div class="col s2">
                            <div class="input-field">
                                <input type="number" step="0.1" name="flow_1" id="flow_1" required>
                                <label for="flow_1">Flow (m³/hr)</label>
                            </div>
                        </div>
                        <div class="col s2">
                            <div class="input-field">
                                <input type="number" step="0.01" name="head_1" id="head_1" required>
                                <label for="head_1">Head (m)</label>
                            </div>
                        </div>
                        <div class="col s2">
                            <div class="input-field">
                                <input type="number" step="0.1" name="efficiency_1" id="efficiency_1" required>
                                <label for="efficiency_1">Efficiency (%)</label>
                            </div>
                        </div>
                        <div class="col s2">
                            <div class="input-field">
                                <input type="number" step="0.01" name="power_1" id="power_1" required>
                                <label for="power_1">Power (kW)</label>
                            </div>
                        </div>
                        <div class="col s2">
                            <div class="input-field">
                                <input type="number" step="1" name="diameter_1" id="diameter_1" required>
                                <label for="diameter_1">Diameter (mm)</label>
                            </div>
                        </div>
                        <div class="col s2">
                            <button type="button" class="btn-small red" onclick="removeRow(1)">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col s6">
                        <button type="button" class="btn blue" onclick="addDataPoint()">
                            <i class="material-icons left">add</i>Add Point
                        </button>
                    </div>
                    <div class="col s6 right-align">
                        <button type="submit" class="btn green">
                            <i class="material-icons left">analytics</i>Analyze Deltas
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Section 2: Analysis Results (only shows after form submission) -->
    {% if analysis_results %}
    <div class="card mt-4">
        <div class="card-content">
            {% if analysis_results.mode == 'site_requirements' %}
            <span class="card-title">2. Site Requirements Analysis</span>
            
            <!-- Site Requirements Results -->
            <div class="row">
                <div class="col s12">
                    <h5>Your Requirements: {{ analysis_results.site_flow }} m³/hr @ {{ analysis_results.site_head }} m</h5>
                    <h6>Pump: {{ analysis_results.pump_code }}</h6>
                </div>
            </div>
            
            <div class="row">
                <div class="col s3">
                    <div class="card-panel {% if analysis_results.brain_analysis.feasible %}green lighten-4{% else %}red lighten-4{% endif %}">
                        <h6>Feasibility</h6>
                        <h4>{% if analysis_results.brain_analysis.feasible %}✓{% else %}✗{% endif %}</h4>
                        <p>{% if analysis_results.brain_analysis.feasible %}Suitable{% else %}Not Suitable{% endif %}</p>
                    </div>
                </div>
                <div class="col s3">
                    <div class="card-panel blue lighten-4">
                        <h6>Required Diameter</h6>
                        <h4>{{ "%.0f"|format(analysis_results.brain_analysis.impeller_diameter_mm or 0) }}mm</h4>
                        <p>Impeller Size</p>
                    </div>
                </div>
                <div class="col s3">
                    <div class="card-panel orange lighten-4">
                        <h6>Expected Efficiency</h6>
                        <h4>{{ "%.1f"|format(analysis_results.brain_analysis.efficiency_pct or 0) }}%</h4>
                        <p>At Duty Point</p>
                    </div>
                </div>
                <div class="col s3">
                    <div class="card-panel purple lighten-4">
                        <h6>Power Required</h6>
                        <h4>{{ "%.1f"|format(analysis_results.brain_analysis.power_kw or 0) }}kW</h4>
                        <p>Motor Rating</p>
                    </div>
                </div>
            </div>
            
            {% if analysis_results.brain_analysis.analysis_details %}
            <div class="ai-insights-panel" style="background: #f5f5f5; padding: 20px; margin-top: 2rem; border-radius: 4px;">
                <h5><i class="material-icons left">engineering</i>Engineering Analysis</h5>
                <pre style="white-space: pre-wrap; font-family: inherit;">{{ analysis_results.brain_analysis.analysis_details }}</pre>
            </div>
            {% endif %}
            
            {% else %}
            <span class="card-title">2. Datasheet Validation Results</span>
            
            <!-- The ONE and ONLY comparison table -->
            <table class="striped responsive-table">
                <thead>
                    <tr>
                        <th>Flow (m³/hr)</th>
                        <th>Truth Head (m)</th>
                        <th>Brain Head (m)</th>
                        <th class="center-align">Head Delta (%)</th>
                        <th>Truth Efficiency (%)</th>
                        <th>Brain Efficiency (%)</th>
                        <th class="center-align">Efficiency Delta (%)</th>
                        <th>Truth Power (kW)</th>
                        <th>Brain Power (kW)</th>
                        <th class="center-align">Power Delta (%)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for point in analysis_results.comparison_points %}
                    <tr>
                        <td>{{ "%.1f"|format(point.flow) }}</td>
                        <td>{{ "%.2f"|format(point.truth_head) }}</td>
                        <td>{{ "%.2f"|format(point.brain_head) if point.brain_head else 'N/A' }}</td>
                        <td class="center-align {% if point.brain_head %}{% if point.head_delta|abs > 10 %}red-text{% elif point.head_delta|abs > 5 %}orange-text{% else %}green-text{% endif %}{% endif %}">
                            {% if point.head_delta is not none %}{{ "%+.1f"|format(point.head_delta) }}%{% else %}N/A{% endif %}
                        </td>
                        <td>{{ "%.1f"|format(point.truth_efficiency) }}</td>
                        <td>{{ "%.1f"|format(point.brain_efficiency) if point.brain_efficiency else 'N/A' }}</td>
                        <td class="center-align {% if point.brain_efficiency %}{% if point.efficiency_delta|abs > 5 %}red-text{% elif point.efficiency_delta|abs > 2 %}orange-text{% else %}green-text{% endif %}{% endif %}">
                            {% if point.efficiency_delta is not none %}{{ "%+.1f"|format(point.efficiency_delta) }}%{% else %}N/A{% endif %}
                        </td>
                        <td>{{ "%.2f"|format(point.truth_power) }}</td>
                        <td>{{ "%.2f"|format(point.brain_power) if point.brain_power else 'N/A' }}</td>
                        <td class="center-align {% if point.brain_power %}{% if point.power_delta|abs > 10 %}red-text{% elif point.power_delta|abs > 5 %}orange-text{% else %}green-text{% endif %}{% endif %}">
                            {% if point.power_delta is not none %}{{ "%+.1f"|format(point.power_delta) }}%{% else %}N/A{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- The ONE and ONLY chart section -->
            <div id="comparison-chart-container" style="height: 450px; margin-top: 2rem;"></div>

            <!-- The AI Insights Section -->
            <div class="ai-insights-panel" style="background: #f5f5f5; padding: 20px; margin-top: 2rem; border-radius: 4px;">
                <h5><i class="material-icons left">psychology</i>AI Analysis</h5>
                <div style="white-space: pre-line;">{{ analysis_results.ai_summary }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Script block for Plotly chart and dynamic form -->
<script>
let rowCounter = 1;

function addDataPoint() {
    rowCounter++;
    const container = document.getElementById('data-points-container');
    const newRow = document.createElement('div');
    newRow.className = 'row data-point-row';
    newRow.id = `row-${rowCounter}`;
    newRow.innerHTML = `
        <div class="col s2">
            <div class="input-field">
                <input type="number" step="0.1" name="flow_${rowCounter}" id="flow_${rowCounter}" required>
                <label for="flow_${rowCounter}">Flow (m³/hr)</label>
            </div>
        </div>
        <div class="col s2">
            <div class="input-field">
                <input type="number" step="0.01" name="head_${rowCounter}" id="head_${rowCounter}" required>
                <label for="head_${rowCounter}">Head (m)</label>
            </div>
        </div>
        <div class="col s2">
            <div class="input-field">
                <input type="number" step="0.1" name="efficiency_${rowCounter}" id="efficiency_${rowCounter}" required>
                <label for="efficiency_${rowCounter}">Efficiency (%)</label>
            </div>
        </div>
        <div class="col s2">
            <div class="input-field">
                <input type="number" step="0.01" name="power_${rowCounter}" id="power_${rowCounter}" required>
                <label for="power_${rowCounter}">Power (kW)</label>
            </div>
        </div>
        <div class="col s2">
            <div class="input-field">
                <input type="number" step="1" name="diameter_${rowCounter}" id="diameter_${rowCounter}" required>
                <label for="diameter_${rowCounter}">Diameter (mm)</label>
            </div>
        </div>
        <div class="col s2">
            <button type="button" class="btn-small red" onclick="removeRow(${rowCounter})">
                <i class="material-icons">delete</i>
            </button>
        </div>
    `;
    container.appendChild(newRow);
    
    // Initialize Materialize components for new inputs
    M.updateTextFields();
}

function removeRow(rowId) {
    const row = document.getElementById(`row-${rowId}`);
    if (row) {
        row.remove();
    }
    
    // Ensure we always have at least one row
    const remainingRows = document.querySelectorAll('.data-point-row');
    if (remainingRows.length === 0) {
        addDataPoint();
    }
}

// Initialize normalized comparison chart with separate subplots if analysis results exist
{% if analysis_results and analysis_results.chart_data %}
document.addEventListener('DOMContentLoaded', function() {
    try {
        const chartData = {{ analysis_results.chart_data|tojson|safe }};
    
    // Extract values for the single point
    const truthHead = (chartData && chartData.truth_heads && chartData.truth_heads[0]) || 0;
    const brainHead = (chartData && chartData.brain_heads && chartData.brain_heads[0]) || 0;
    const truthEff = (chartData && chartData.truth_efficiencies && chartData.truth_efficiencies[0]) || 0;
    const brainEff = (chartData && chartData.brain_efficiencies && chartData.brain_efficiencies[0]) || 0;
    const truthPower = (chartData && chartData.truth_powers && chartData.truth_powers[0]) || 0;
    const brainPower = (chartData && chartData.brain_powers && chartData.brain_powers[0]) || 0;
    
    // Create three separate subplots to avoid scale confusion
    const fig = {
        data: [
            // Head comparison subplot
            {
                x: ['Ground Truth', 'Brain Prediction'],
                y: [truthHead, brainHead],
                type: 'bar',
                name: 'Head (m)',
                marker: { 
                    color: ['rgba(54, 162, 235, 0.8)', 'rgba(255, 99, 132, 0.8)'],
                    line: { color: ['rgba(54, 162, 235, 1.0)', 'rgba(255, 99, 132, 1.0)'], width: 1 }
                },
                text: [String(truthHead.toFixed(2)) + ' m', String(brainHead.toFixed(2)) + ' m'],
                textposition: 'auto',
                xaxis: 'x',
                yaxis: 'y',
                showlegend: false
            },
            // Efficiency comparison subplot  
            {
                x: ['Ground Truth', 'Brain Prediction'],
                y: [truthEff, brainEff],
                type: 'bar',
                name: 'Efficiency (%)',
                marker: { 
                    color: ['rgba(75, 192, 192, 0.8)', 'rgba(255, 159, 64, 0.8)'],
                    line: { color: ['rgba(75, 192, 192, 1.0)', 'rgba(255, 159, 64, 1.0)'], width: 1 }
                },
                text: [String(truthEff.toFixed(1)) + '%', String(brainEff.toFixed(1)) + '%'],
                textposition: 'auto',
                xaxis: 'x2',
                yaxis: 'y2',
                showlegend: false
            },
            // Power comparison subplot
            {
                x: ['Ground Truth', 'Brain Prediction'],
                y: [truthPower, brainPower],
                type: 'bar',
                name: 'Power (kW)',
                marker: { 
                    color: ['rgba(153, 102, 255, 0.8)', 'rgba(255, 205, 86, 0.8)'],
                    line: { color: ['rgba(153, 102, 255, 1.0)', 'rgba(255, 205, 86, 1.0)'], width: 1 }
                },
                text: [String(truthPower.toFixed(1)) + ' kW', String(brainPower.toFixed(1)) + ' kW'],
                textposition: 'auto',
                xaxis: 'x3',
                yaxis: 'y3',
                showlegend: false
            }
        ],
        layout: {
            title: {
                text: `Performance Calibration: ${chartData.point_labels[0] || 'Truth vs Brain Comparison'}`,
                font: { size: 18, color: '#2c3e50' }
            },
            // Define three subplots side by side
            xaxis: { 
                domain: [0, 0.3], 
                anchor: 'y',
                title: 'Head Comparison'
            },
            xaxis2: { 
                domain: [0.35, 0.65], 
                anchor: 'y2',
                title: 'Efficiency Comparison'
            },
            xaxis3: { 
                domain: [0.7, 1.0], 
                anchor: 'y3',
                title: 'Power Comparison'
            },
            yaxis: { 
                domain: [0, 1], 
                anchor: 'x',
                title: 'Head (m)'
            },
            yaxis2: { 
                domain: [0, 1], 
                anchor: 'x2',
                title: 'Efficiency (%)'
            },
            yaxis3: { 
                domain: [0, 1], 
                anchor: 'x3',
                title: 'Power (kW)'
            },
            showlegend: false,
            margin: { l: 60, r: 60, t: 100, b: 80 },
            annotations: [
                // Calculate delta percentages for display
                {
                    text: `Δ: ${((brainHead - truthHead) / truthHead * 100).toFixed(1)}%`,
                    x: 0.15,
                    y: 0.95,
                    xref: 'paper',
                    yref: 'paper',
                    showarrow: false,
                    font: { size: 12, color: brainHead > truthHead ? '#d32f2f' : '#388e3c' }
                },
                {
                    text: `Δ: ${((brainEff - truthEff) / truthEff * 100).toFixed(1)}%`,
                    x: 0.5,
                    y: 0.95,
                    xref: 'paper',
                    yref: 'paper',
                    showarrow: false,
                    font: { size: 12, color: brainEff > truthEff ? '#d32f2f' : '#388e3c' }
                },
                {
                    text: `Δ: ${((brainPower - truthPower) / truthPower * 100).toFixed(1)}%`,
                    x: 0.85,
                    y: 0.95,
                    xref: 'paper',
                    yref: 'paper',
                    showarrow: false,
                    font: { size: 12, color: brainPower > truthPower ? '#d32f2f' : '#388e3c' }
                }
            ]
        }
    };

    Plotly.newPlot('comparison-chart-container', fig.data, fig.layout, {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    });
    } catch (error) {
        console.error('Error initializing comparison chart:', error);
    }
});
{% endif %}

// Initialize Materialize components
document.addEventListener('DOMContentLoaded', function() {
    M.updateTextFields();
});

// Pump search functionality
let searchTimeout;
const pumpSearchInput = document.getElementById('pump_search');
const suggestionsDiv = document.getElementById('pump-suggestions');

if (pumpSearchInput) {
    pumpSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        if (query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        searchTimeout = setTimeout(() => {
            searchPumps(query);
        }, 300);
    });
}

async function searchPumps(query) {
    try {
        const response = await fetch(`/api/pumps/search?q=${encodeURIComponent(query)}&limit=10`);
        if (!response.ok) throw new Error('Search failed');
        
        const results = await response.json();
        displayPumpSuggestions(results.pumps || []);
        
    } catch (error) {
        console.error('Pump search error:', error);
        suggestionsDiv.innerHTML = '<a href="#!" class="collection-item red-text">Search failed</a>';
        suggestionsDiv.style.display = 'block';
    }
}

function displayPumpSuggestions(pumps) {
    if (pumps.length === 0) {
        suggestionsDiv.innerHTML = '<a href="#!" class="collection-item grey-text">No pumps found</a>';
    } else {
        const suggestionsHtml = pumps.map(pump => 
            `<a href="#!" class="collection-item" onclick="selectPump('${pump.pump_code}')">
                <span class="title">${pump.pump_code}</span>
                <p class="grey-text">${pump.description || ''}</p>
            </a>`
        ).join('');
        suggestionsDiv.innerHTML = suggestionsHtml;
    }
    suggestionsDiv.style.display = 'block';
}

function selectPump(pumpCode) {
    // Navigate to the calibration workbench for the selected pump
    window.location.href = `/admin/pump-calibration/${encodeURIComponent(pumpCode)}`;
}

function resetCalibration() {
    if (confirm('Are you sure you want to reset this calibration session? All entered data will be lost.')) {
        // Clear all form inputs
        document.querySelectorAll('#calibration-form input[type="number"]').forEach(input => {
            input.value = '';
        });
        
        // Reset form validation
        document.querySelectorAll('#calibration-form .input-field').forEach(field => {
            field.classList.remove('valid', 'invalid');
        });
        
        // Hide any analysis results if they exist
        const analysisResults = document.querySelector('.card:has(.card-title:contains("Analysis Results"))');
        if (analysisResults) {
            analysisResults.style.display = 'none';
        }
        
        // Reset to first row only
        const container = document.getElementById('data-points-container');
        const firstRow = container.querySelector('.data-point-row');
        if (container && firstRow) {
            const newFirstRow = firstRow.cloneNode(true);
            container.innerHTML = '';
            container.appendChild(newFirstRow);
            
            // Clear first row inputs and reset IDs
            newFirstRow.querySelectorAll('input').forEach((input, index) => {
                input.value = '';
                input.classList.remove('valid', 'invalid');
                // Reset input IDs to match the first row pattern
                const fieldName = input.name.split('_')[0];
                input.id = fieldName + '_1';
                input.name = fieldName + '_1';
            });
            
            // Reset button onclick
            const deleteBtn = newFirstRow.querySelector('button');
            if (deleteBtn) {
                deleteBtn.setAttribute('onclick', 'removeRow(1)');
            }
        }
        
        // Update Materialize labels
        if (typeof M !== 'undefined') {
            M.updateTextFields();
        }
        
        // Show success message
        if (typeof M !== 'undefined') {
            M.toast({html: 'Calibration session reset successfully', classes: 'green'});
        }
    }
}

// Hide suggestions when clicking outside
document.addEventListener('click', function(e) {
    if (pumpSearchInput && suggestionsDiv && 
        !pumpSearchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
        suggestionsDiv.style.display = 'none';
    }
});

// Hide suggestions on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && suggestionsDiv) {
        suggestionsDiv.style.display = 'none';
    }
});

// Analysis mode switching
document.addEventListener('DOMContentLoaded', function() {
    const analysisMode = document.querySelectorAll('input[name="analysis_mode"]');
    const siteMode = document.getElementById('site-requirements-mode');
    const datasheetMode = document.getElementById('datasheet-validation-mode');
    
    analysisMode.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'site_requirements') {
                siteMode.style.display = 'block';
                datasheetMode.style.display = 'none';
            } else {
                siteMode.style.display = 'none';
                datasheetMode.style.display = 'block';
            }
        });
    });
});

function analyzeSiteRequirements() {
    const flow = document.getElementById('site_flow').value;
    const head = document.getElementById('site_head').value;
    
    if (!flow || !head) {
        if (typeof M !== 'undefined') {
            M.toast({html: 'Please enter both flow and head requirements', classes: 'red'});
        }
        return;
    }
    
    // Show loading state
    if (typeof M !== 'undefined') {
        M.toast({html: 'Analyzing pump performance at your site requirements...', classes: 'blue'});
    }
    
    // Submit the site requirements analysis
    const form = document.createElement('form');
    form.method = 'POST';
    form.style.display = 'none';
    
    const modeInput = document.createElement('input');
    modeInput.name = 'analysis_mode';
    modeInput.value = 'site_requirements';
    form.appendChild(modeInput);
    
    const flowInput = document.createElement('input');
    flowInput.name = 'site_flow';
    flowInput.value = flow;
    form.appendChild(flowInput);
    
    const headInput = document.createElement('input');
    headInput.name = 'site_head';
    headInput.value = head;
    form.appendChild(headInput);
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
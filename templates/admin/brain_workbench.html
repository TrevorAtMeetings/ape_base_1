{% extends "base.html" %}

{% block title %}Brain Logic Workbench{% endblock %}

{% block content %}
<div class="brain-dashboard">
    <div class="container">
        <h1 class="blue-text text-darken-2" style="margin-bottom: 30px;">
            <i class="material-icons left">science</i>
            Brain Logic Workbench
        </h1>

        <!-- Current Configuration -->
        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">settings</i>
                            Current Production Configuration
                        </span>
                        <div class="row">
                            <div class="col s12 m6">
                                <p><strong>Profile Name:</strong> {{ production_config.profile_name|default('Default') }}</p>
                                <p><strong>Version:</strong> {{ production_config.version|default('1.0') }}</p>
                            </div>
                            <div class="col s12 m6">
                                <p><strong>Last Updated:</strong> {{ production_config.updated_at|default('Unknown') }}</p>
                                <p><strong>Status:</strong> 
                                    <span class="badge green white-text">Active</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing Tools -->
        <div class="row">
            <!-- Pump Testing -->
            <div class="col s12 l6">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title blue-text">
                            <i class="material-icons left">search</i>
                            Pump Testing
                        </span>
                        <p class="grey-text">Test individual pump data and Brain logic processing</p>
                        
                        <div class="input-field" style="margin-top: 20px;">
                            <select id="pump-select">
                                <option value="" disabled selected>Choose a pump to test</option>
                                {% for pump_code in pump_codes %}
                                <option value="{{ pump_code }}">{{ pump_code }}</option>
                                {% endfor %}
                            </select>
                            <label>Select Pump Code</label>
                        </div>
                        
                        <div class="card-action">
                            <a href="#" class="btn blue" onclick="testPump()">
                                <i class="material-icons left">play_arrow</i>
                                Test Pump
                            </a>
                            <a href="#" class="btn blue-grey" onclick="runQualityCheck()">
                                <i class="material-icons left">assessment</i>
                                Quality Check
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selection Simulation -->
            <div class="col s12 l6">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title purple-text">
                            <i class="material-icons left">timeline</i>
                            Selection Simulation
                        </span>
                        <p class="grey-text">Simulate pump selection scenarios with different configurations</p>
                        
                        <div class="input-field">
                            <input id="flow-rate" type="number" step="0.1" min="0">
                            <label for="flow-rate">Flow Rate (m³/h)</label>
                        </div>
                        
                        <div class="input-field">
                            <input id="head" type="number" step="0.1" min="0">
                            <label for="head">Head (m)</label>
                        </div>
                        
                        <div class="card-action">
                            <a href="#" class="btn purple" onclick="simulateSelection()">
                                <i class="material-icons left">play_circle_filled</i>
                                Simulate Selection
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Area -->
        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">bar_chart</i>
                            Test Results
                        </span>
                        <div id="results-area" class="grey-text center-align" style="padding: 40px; min-height: 200px;">
                            <i class="material-icons large grey-text text-lighten-2">analytics</i>
                            <p>Run a test to see results here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">Workbench Actions</span>
                        <div class="card-action">
                            <a href="/admin/brain" class="btn blue">
                                <i class="material-icons left">arrow_back</i>
                                Back to Brain Dashboard
                            </a>
                            <a href="/admin/brain/data-quality" class="btn green">
                                <i class="material-icons left">assessment</i>
                                Data Quality
                            </a>
                            <a href="/admin/brain/corrections" class="btn orange">
                                <i class="material-icons left">edit</i>
                                Corrections
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Materialize select
    M.FormSelect.init(document.querySelectorAll('select'));
});

function testPump() {
    const pumpCode = document.getElementById('pump-select').value;
    if (!pumpCode) {
        M.toast({html: 'Please select a pump code first', classes: 'orange'});
        return;
    }
    
    const resultsArea = document.getElementById('results-area');
    resultsArea.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Testing pump ' + pumpCode + '...</p>';
    
    fetch(`/api/brain/test-pump/${pumpCode}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsArea.innerHTML = `
                <h5 class="blue-text">Pump Test Results: ${pumpCode}</h5>
                <div class="row">
                    <div class="col s12 m6">
                        <p><strong>Status:</strong> <span class="badge green white-text">${data.status}</span></p>
                        <p><strong>Curves Found:</strong> ${data.curves_count}</p>
                        <p><strong>Performance Points:</strong> ${data.points_count}</p>
                    </div>
                    <div class="col s12 m6">
                        <p><strong>BEP Flow:</strong> ${data.bep_flow || 'N/A'} m³/h</p>
                        <p><strong>BEP Head:</strong> ${data.bep_head || 'N/A'} m</p>
                        <p><strong>Max Efficiency:</strong> ${data.max_efficiency || 'N/A'}%</p>
                    </div>
                </div>
            `;
            M.toast({html: 'Pump test completed successfully', classes: 'green'});
        } else {
            resultsArea.innerHTML = `<p class="red-text">Error testing pump: ${data.error}</p>`;
            M.toast({html: 'Test failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        resultsArea.innerHTML = `<p class="red-text">Error: ${error}</p>`;
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}

function runQualityCheck() {
    const pumpCode = document.getElementById('pump-select').value;
    if (!pumpCode) {
        M.toast({html: 'Please select a pump code first', classes: 'orange'});
        return;
    }
    
    const resultsArea = document.getElementById('results-area');
    resultsArea.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Running quality check for ' + pumpCode + '...</p>';
    
    fetch(`/api/brain/quality-check/${pumpCode}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const issues = data.issues || [];
            let issuesHtml = '';
            if (issues.length > 0) {
                issuesHtml = '<ul class="collection">';
                issues.forEach(issue => {
                    const severityClass = issue.severity === 'critical' ? 'red' : 
                                        issue.severity === 'major' ? 'orange' : 'yellow darken-2';
                    issuesHtml += `
                        <li class="collection-item">
                            <span class="badge ${severityClass} white-text">${issue.severity}</span>
                            <strong>${issue.field_name}:</strong> ${issue.description}
                        </li>
                    `;
                });
                issuesHtml += '</ul>';
            } else {
                issuesHtml = '<p class="green-text center-align">No quality issues found</p>';
            }
            
            resultsArea.innerHTML = `
                <h5 class="blue-text">Quality Check Results: ${pumpCode}</h5>
                <p><strong>Issues Found:</strong> ${issues.length}</p>
                ${issuesHtml}
            `;
            M.toast({html: 'Quality check completed', classes: 'green'});
        } else {
            resultsArea.innerHTML = `<p class="red-text">Error running quality check: ${data.error}</p>`;
            M.toast({html: 'Quality check failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        resultsArea.innerHTML = `<p class="red-text">Error: ${error}</p>`;
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}

function simulateSelection() {
    const flowRate = document.getElementById('flow-rate').value;
    const head = document.getElementById('head').value;
    
    if (!flowRate || !head) {
        M.toast({html: 'Please enter both flow rate and head values', classes: 'orange'});
        return;
    }
    
    const resultsArea = document.getElementById('results-area');
    resultsArea.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Simulating pump selection...</p>';
    
    fetch('/api/brain/simulate-selection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            flow_rate: parseFloat(flowRate),
            head: parseFloat(head)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const matches = data.matches || [];
            let matchesHtml = '';
            if (matches.length > 0) {
                matchesHtml = '<ul class="collection">';
                matches.slice(0, 5).forEach((match, index) => {
                    matchesHtml += `
                        <li class="collection-item">
                            <span class="badge blue white-text">${match.score.toFixed(1)}</span>
                            <strong>${match.pump_code}</strong> - ${match.pump_name}
                            <br><small class="grey-text">Efficiency: ${match.efficiency}% | NPSH: ${match.npsh_required}m</small>
                        </li>
                    `;
                });
                matchesHtml += '</ul>';
            } else {
                matchesHtml = '<p class="orange-text center-align">No suitable pumps found</p>';
            }
            
            resultsArea.innerHTML = `
                <h5 class="blue-text">Selection Simulation Results</h5>
                <p><strong>Flow Rate:</strong> ${flowRate} m³/h | <strong>Head:</strong> ${head} m</p>
                <p><strong>Matches Found:</strong> ${matches.length}</p>
                <h6>Top 5 Recommendations:</h6>
                ${matchesHtml}
            `;
            M.toast({html: 'Selection simulation completed', classes: 'green'});
        } else {
            resultsArea.innerHTML = `<p class="red-text">Error simulating selection: ${data.error}</p>`;
            M.toast({html: 'Simulation failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        resultsArea.innerHTML = `<p class="red-text">Error: ${error}</p>`;
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}
</script>
{% endblock %}
{% extends "admin/base.html" %}

{% block admin_title %}Brain Logic Workbench{% endblock %}

{% block additional_scripts %}
<script>
// Ensure dropdowns work even if other scripts interfere
document.addEventListener('DOMContentLoaded', function() {
    // Additional failsafe for dropdown initialization
    var checkInterval = setInterval(function() {
        if (typeof M !== 'undefined' && M.FormSelect) {
            var selects = document.querySelectorAll('select:not(.browser-default)');
            if (selects.length > 0) {
                selects.forEach(function(select) {
                    if (!select.M_FormSelect) {
                        M.FormSelect.init(select);
                    }
                });
                clearInterval(checkInterval);
            }
        }
    }, 100);
    
    // Clear after 5 seconds to prevent infinite loop
    setTimeout(function() {
        clearInterval(checkInterval);
    }, 5000);
});
</script>
{% endblock %}

{% block admin_content %}
<div class="container" style="margin-top: 20px;">

        <!-- Current Configuration -->
        <div class="row">
            <div class="col s12">
                <div class="card workbench-card">
                    <div class="card-content">
                        <span class="card-title grey-text text-darken-2">
                            <i class="material-icons">settings</i>
                            Current Production Configuration
                        </span>
                        <div class="row">
                            <div class="col s12 m6">
                                <p><strong>Profile Name:</strong> {{ production_config.profile_name|default('Default') }}</p>
                                <p><strong>Version:</strong> {{ production_config.version|default('1.0') }}</p>
                            </div>
                            <div class="col s12 m6">
                                <p><strong>Last Updated:</strong> {{ production_config.updated_at|default('Unknown') }}</p>
                                <p><strong>Status:</strong> 
                                    <span class="badge green white-text">Active</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Testing Tools -->
        <div class="row">
            <!-- Pump Testing -->
            <div class="col s12 l6">
                <div class="card workbench-card">
                    <div class="card-content">
                        <span class="card-title blue-text">
                            <i class="material-icons">search</i>
                            Pump Testing
                        </span>
                        <p class="grey-text">Test individual pump data and Brain logic processing</p>
                        
                        <div class="input-field" style="margin-top: 20px;">
                            <select id="pump-select">
                                <option value="" disabled selected>Choose a pump to test</option>
                                {% for pump_code in pump_codes %}
                                <option value="{{ pump_code }}">{{ pump_code }}</option>
                                {% endfor %}
                            </select>
                            <label>Select Pump Code</label>
                        </div>
                        
                        <div class="card-action">
                            <button class="btn waves-effect waves-light blue darken-1" onclick="testPump()" style="margin-right: 10px;">
                                <i class="material-icons left">play_arrow</i>
                                Test Pump
                            </button>
                            <button class="btn waves-effect waves-light blue-grey darken-1" onclick="runQualityCheck()">
                                <i class="material-icons left">assessment</i>
                                Quality Check
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Selection Simulation -->
            <div class="col s12 l6">
                <div class="card workbench-card">
                    <div class="card-content">
                        <span class="card-title purple-text">
                            <i class="material-icons">timeline</i>
                            Selection Simulation
                        </span>
                        <p class="grey-text">Simulate pump selection scenarios with different configurations</p>
                        
                        <div class="input-field">
                            <input id="flow-rate" type="number" step="0.1" min="0">
                            <label for="flow-rate">Flow Rate (m³/h)</label>
                        </div>
                        
                        <div class="input-field">
                            <input id="head" type="number" step="0.1" min="0">
                            <label for="head">Head (m)</label>
                        </div>
                        
                        <div class="card-action">
                            <button class="btn waves-effect waves-light purple darken-1" onclick="simulateSelection()">
                                <i class="material-icons left">play_circle_filled</i>
                                Simulate Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ground Truth Calibration -->
        <div class="row">
            <div class="col s12">
                <div class="card workbench-card">
                    <div class="card-content">
                        <span class="card-title teal-text">
                            <i class="material-icons">tune</i>
                            Ground Truth Calibration
                        </span>
                        <p class="grey-text">Compare Brain predictions against manufacturer datasheet values</p>
                        
                        <form id="calibration-form" method="POST" action="/admin/brain-workbench/run-calibration">
                            <div class="row" style="margin-top: 20px;">
                                <div class="col s12 m6">
                                    <div class="input-field">
                                        <select id="calibration-pump-code" name="pump_code" required>
                                            <option value="" disabled selected>Choose a pump</option>
                                            {% for pump_code in pump_codes %}
                                            <option value="{{ pump_code }}">{{ pump_code }}</option>
                                            {% endfor %}
                                        </select>
                                        <label>Pump Code</label>
                                    </div>
                                </div>
                                <div class="col s12 m3">
                                    <div class="input-field">
                                        <input id="calibration-flow" name="duty_flow" type="number" step="0.01" min="0" required>
                                        <label for="calibration-flow">Duty Flow (m³/hr)</label>
                                    </div>
                                </div>
                                <div class="col s12 m3">
                                    <div class="input-field">
                                        <input id="calibration-head" name="duty_head" type="number" step="0.01" min="0" required>
                                        <label for="calibration-head">Duty Head (m)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col s12">
                                    <h6 class="grey-text">Manufacturer Datasheet Values</h6>
                                </div>
                                <div class="col s12 m4">
                                    <div class="input-field">
                                        <input id="truth-diameter" name="truth_diameter" type="number" step="0.1" min="0" required>
                                        <label for="truth-diameter">Trimmed Impeller Ø (mm)</label>
                                    </div>
                                </div>
                                <div class="col s12 m4">
                                    <div class="input-field">
                                        <input id="truth-efficiency" name="truth_efficiency" type="number" step="0.01" min="0" max="100" required>
                                        <label for="truth-efficiency">Efficiency (%)</label>
                                    </div>
                                </div>
                                <div class="col s12 m4">
                                    <div class="input-field">
                                        <input id="truth-power" name="truth_power" type="number" step="0.01" min="0" required>
                                        <label for="truth-power">Power Absorbed (kW)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-action">
                                <button type="submit" class="btn waves-effect waves-light teal darken-1" style="margin-right: 10px;">
                                    <i class="material-icons left">compare_arrows</i>
                                    Run Calibration
                                </button>
                                <button type="button" class="btn waves-effect waves-light grey" onclick="clearCalibrationForm()">
                                    <i class="material-icons left">clear</i>
                                    Clear
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calibration Results Area (only shows when results exist) -->
        {% if calibration_results %}
        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons left">assessment</i>
                            Calibration Results - {{ calibration_results.pump_code }}
                        </span>
                        <p class="grey-text">
                            Duty Point: {{ calibration_results.duty_flow }} m³/hr @ {{ calibration_results.duty_head }}m
                        </p>
                        
                        <table class="striped highlight responsive-table" style="margin-top: 20px;">
                            <thead>
                                <tr>
                                    <th>Parameter</th>
                                    <th>Manufacturer (Truth)</th>
                                    <th>Brain Prediction</th>
                                    <th>Delta (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Trimmed Impeller Ø</strong></td>
                                    <td>{{ calibration_results.truth_diameter|round(1) }} mm</td>
                                    <td>{{ calibration_results.brain_diameter|round(1) }} mm</td>
                                    <td>
                                        <span class="badge {% if calibration_results.delta_diameter|abs < 2 %}green{% elif calibration_results.delta_diameter|abs < 5 %}orange{% else %}red{% endif %} white-text">
                                            {{ calibration_results.delta_diameter|round(2) }}%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Efficiency</strong></td>
                                    <td>{{ calibration_results.truth_efficiency|round(1) }}%</td>
                                    <td>{{ calibration_results.brain_efficiency|round(1) }}%</td>
                                    <td>
                                        <span class="badge {% if calibration_results.delta_efficiency|abs < 2 %}green{% elif calibration_results.delta_efficiency|abs < 5 %}orange{% else %}red{% endif %} white-text">
                                            {{ calibration_results.delta_efficiency|round(2) }}%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Power</strong></td>
                                    <td>{{ calibration_results.truth_power|round(1) }} kW</td>
                                    <td>{{ calibration_results.brain_power|round(1) }} kW</td>
                                    <td>
                                        <span class="badge {% if calibration_results.delta_power|abs < 2 %}green{% elif calibration_results.delta_power|abs < 5 %}orange{% else %}red{% endif %} white-text">
                                            {{ calibration_results.delta_power|round(2) }}%
                                        </span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="card-action" style="margin-top: 20px;">
                            <div class="row">
                                <div class="col s12">
                                    <h6>Calibration Summary</h6>
                                    {% set avg_delta = ((calibration_results.delta_diameter|abs + calibration_results.delta_efficiency|abs + calibration_results.delta_power|abs) / 3)|round(2) %}
                                    <p>
                                        <strong>Average Delta:</strong> 
                                        <span class="{% if avg_delta < 2 %}green-text{% elif avg_delta < 5 %}orange-text{% else %}red-text{% endif %}">
                                            {{ avg_delta }}%
                                        </span>
                                    </p>
                                    <p class="grey-text">
                                        {% if avg_delta < 2 %}
                                        <i class="material-icons tiny green-text">check_circle</i> Excellent accuracy - Brain predictions are highly reliable
                                        {% elif avg_delta < 5 %}
                                        <i class="material-icons tiny orange-text">warning</i> Good accuracy - Minor adjustments may improve predictions
                                        {% else %}
                                        <i class="material-icons tiny red-text">error</i> Significant deviation - Physics model may need calibration
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Results Area -->
        <div class="row">
            <div class="col s12">
                <div class="card workbench-card">
                    <div class="card-content">
                        <span class="card-title">
                            <i class="material-icons">bar_chart</i>
                            Test Results
                        </span>
                        <div id="results-area" class="grey-text center-align" style="padding: 40px; min-height: 200px;">
                            <i class="material-icons large grey-text text-lighten-2">analytics</i>
                            <p>Run a test to see results here</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>

<style>
/* Workbench specific styles */
.workbench-container {
    padding-top: 0;
}

/* Card improvements */
.workbench-card {
    border-radius: 4px;
    margin-bottom: 20px;
}

.workbench-card .card-title {
    font-size: 1.3rem;
    font-weight: 500;
    display: flex;
    align-items: center;
}

.workbench-card .card-title i {
    margin-right: 10px;
}

/* Button consistency */
.workbench-card .card-action {
    padding: 16px 24px;
    background-color: #fafafa;
}

.workbench-card .btn {
    margin-right: 8px;
    margin-bottom: 8px;
}

/* Form field improvements */
.workbench-card .input-field {
    margin-top: 1.5rem;
    margin-bottom: 1.5rem;
}

/* Fix select dropdown */
.workbench-card .select-wrapper input.select-dropdown {
    margin-bottom: 0;
    border-bottom: 1px solid #9e9e9e;
}

.workbench-card .dropdown-content {
    max-height: 300px !important;
    overflow-y: auto;
}

/* Section headers */
.workbench-section-title {
    color: #424242;
    font-size: 1.1rem;
    font-weight: 500;
    margin: 20px 0 15px 0;
    padding-bottom: 5px;
    border-bottom: 1px solid #e0e0e0;
}
</style>

<script>
// Initialize select dropdowns after window load
window.addEventListener('load', function() {
    console.log('Initializing workbench dropdowns...');
    
    // Force initialization with a delay to ensure Materialize is ready
    function initializeSelects() {
        var selectElems = document.querySelectorAll('select');
        console.log('Found ' + selectElems.length + ' select elements');
        
        selectElems.forEach(function(elem) {
            // Destroy any existing instance
            var instance = M.FormSelect.getInstance(elem);
            if (instance) {
                instance.destroy();
            }
            
            // Initialize with options
            M.FormSelect.init(elem, {
                dropdownOptions: {
                    coverTrigger: false,
                    hover: false,
                    constrainWidth: false,
                    closeOnClick: true
                }
            });
        });
        
        // Update text fields
        M.updateTextFields();
        console.log('Dropdowns initialized');
    }
    
    // Initialize immediately
    initializeSelects();
    
    // And again after a short delay as a fallback
    setTimeout(initializeSelects, 500);
    
    // Handle calibration form submission
    const calibrationForm = document.getElementById('calibration-form');
    if (calibrationForm) {
        calibrationForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Show loading state
            const submitBtn = calibrationForm.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="material-icons left">hourglass_empty</i>Processing...';
            submitBtn.disabled = true;
            
            // Prepare form data
            const formData = new FormData(calibrationForm);
            
            // Submit form
            fetch('/admin/brain-workbench/run-calibration', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                // Replace the entire page content with the response
                document.open();
                document.write(html);
                document.close();
            })
            .catch(error => {
                console.error('Error:', error);
                M.toast({html: 'Error running calibration: ' + error, classes: 'red'});
                submitBtn.innerHTML = originalBtnText;
                submitBtn.disabled = false;
            });
        });
    }
});

function clearCalibrationForm() {
    const form = document.getElementById('calibration-form');
    if (form) {
        form.reset();
        // Re-initialize select dropdowns after reset
        setTimeout(function() {
            var selectElems = form.querySelectorAll('select');
            selectElems.forEach(function(elem) {
                var instance = M.FormSelect.getInstance(elem);
                if (instance) {
                    instance.destroy();
                }
                M.FormSelect.init(elem, {
                    dropdownOptions: {
                        coverTrigger: false,
                        hover: false,
                        constrainWidth: false
                    }
                });
            });
        }, 100);
        M.toast({html: 'Form cleared', classes: 'grey'});
    }
}

function testPump() {
    const pumpCode = document.getElementById('pump-select').value;
    if (!pumpCode) {
        M.toast({html: 'Please select a pump code first', classes: 'orange'});
        return;
    }
    
    const resultsArea = document.getElementById('results-area');
    resultsArea.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Testing pump ' + pumpCode + '...</p>';
    
    fetch(`/api/brain/test-pump/${pumpCode}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultsArea.innerHTML = `
                <h5 class="blue-text">Pump Test Results: ${pumpCode}</h5>
                <div class="row">
                    <div class="col s12 m6">
                        <p><strong>Status:</strong> <span class="badge green white-text">${data.status}</span></p>
                        <p><strong>Curves Found:</strong> ${data.curves_count}</p>
                        <p><strong>Performance Points:</strong> ${data.points_count}</p>
                    </div>
                    <div class="col s12 m6">
                        <p><strong>BEP Flow:</strong> ${data.bep_flow || 'N/A'} m³/h</p>
                        <p><strong>BEP Head:</strong> ${data.bep_head || 'N/A'} m</p>
                        <p><strong>Max Efficiency:</strong> ${data.max_efficiency || 'N/A'}%</p>
                    </div>
                </div>
            `;
            M.toast({html: 'Pump test completed successfully', classes: 'green'});
        } else {
            resultsArea.innerHTML = `<p class="red-text">Error testing pump: ${data.error}</p>`;
            M.toast({html: 'Test failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        resultsArea.innerHTML = `<p class="red-text">Error: ${error}</p>`;
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}

function runQualityCheck() {
    const pumpCode = document.getElementById('pump-select').value;
    if (!pumpCode) {
        M.toast({html: 'Please select a pump code first', classes: 'orange'});
        return;
    }
    
    const resultsArea = document.getElementById('results-area');
    resultsArea.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Running quality check for ' + pumpCode + '...</p>';
    
    fetch(`/api/brain/quality-check/${pumpCode}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const issues = data.issues || [];
            let issuesHtml = '';
            if (issues.length > 0) {
                issuesHtml = '<ul class="collection">';
                issues.forEach(issue => {
                    const severityClass = issue.severity === 'critical' ? 'red' : 
                                        issue.severity === 'major' ? 'orange' : 'yellow darken-2';
                    issuesHtml += `
                        <li class="collection-item">
                            <span class="badge ${severityClass} white-text">${issue.severity}</span>
                            <strong>${issue.field_name}:</strong> ${issue.description}
                        </li>
                    `;
                });
                issuesHtml += '</ul>';
            } else {
                issuesHtml = '<p class="green-text center-align">No quality issues found</p>';
            }
            
            resultsArea.innerHTML = `
                <h5 class="blue-text">Quality Check Results: ${pumpCode}</h5>
                <p><strong>Issues Found:</strong> ${issues.length}</p>
                ${issuesHtml}
            `;
            M.toast({html: 'Quality check completed', classes: 'green'});
        } else {
            resultsArea.innerHTML = `<p class="red-text">Error running quality check: ${data.error}</p>`;
            M.toast({html: 'Quality check failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        resultsArea.innerHTML = `<p class="red-text">Error: ${error}</p>`;
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}

function simulateSelection() {
    const flowRate = document.getElementById('flow-rate').value;
    const head = document.getElementById('head').value;
    
    if (!flowRate || !head) {
        M.toast({html: 'Please enter both flow rate and head values', classes: 'orange'});
        return;
    }
    
    const resultsArea = document.getElementById('results-area');
    resultsArea.innerHTML = '<div class="progress"><div class="indeterminate"></div></div><p>Simulating pump selection...</p>';
    
    fetch('/api/brain/simulate-selection', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            flow_rate: parseFloat(flowRate),
            head: parseFloat(head)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const matches = data.matches || [];
            let matchesHtml = '';
            if (matches.length > 0) {
                matchesHtml = '<ul class="collection">';
                matches.slice(0, 5).forEach((match, index) => {
                    matchesHtml += `
                        <li class="collection-item">
                            <span class="badge blue white-text">${match.score.toFixed(1)}</span>
                            <strong>${match.pump_code}</strong> - ${match.pump_name}
                            <br><small class="grey-text">Efficiency: ${match.efficiency}% | NPSH: ${match.npsh_required}m</small>
                        </li>
                    `;
                });
                matchesHtml += '</ul>';
            } else {
                matchesHtml = '<p class="orange-text center-align">No suitable pumps found</p>';
            }
            
            resultsArea.innerHTML = `
                <h5 class="blue-text">Selection Simulation Results</h5>
                <p><strong>Flow Rate:</strong> ${flowRate} m³/h | <strong>Head:</strong> ${head} m</p>
                <p><strong>Matches Found:</strong> ${matches.length}</p>
                <h6>Top 5 Recommendations:</h6>
                ${matchesHtml}
            `;
            M.toast({html: 'Selection simulation completed', classes: 'green'});
        } else {
            resultsArea.innerHTML = `<p class="red-text">Error simulating selection: ${data.error}</p>`;
            M.toast({html: 'Simulation failed: ' + data.error, classes: 'red'});
        }
    })
    .catch(error => {
        resultsArea.innerHTML = `<p class="red-text">Error: ${error}</p>`;
        M.toast({html: 'Error: ' + error, classes: 'red'});
    });
}
</script>
{% endblock admin_content %}
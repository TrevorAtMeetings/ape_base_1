{% extends "base.html" %}

{% block title %}Edit Profile - {{ profile.name }} - APE Pumps{% endblock %}

{% block extra_head %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .param-group {
        background: #f8f9fa;
        padding: 24px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .param-group h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: #2e7d32;
        font-weight: 500;
    }
    
    .param-input {
        margin-bottom: 20px;
    }
    
    .param-input label {
        font-weight: 600;
        margin-bottom: 8px;
        display: block;
        color: #424242;
    }
    
    .param-input small {
        color: #757575;
        display: block;
        margin-top: 8px;
        font-style: italic;
    }
    
    .weight-indicator {
        position: absolute;
        right: 15px;
        top: 40px;
        font-weight: bold;
        background: #e3f2fd;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.9em;
    }
    
    .audit-entry {
        border-left: 4px solid #dee2e6;
        padding: 15px;
        margin-bottom: 15px;
        background: #fafafa;
        border-radius: 4px;
    }
    
    .audit-entry.update {
        border-color: #2196F3;
    }
    
    .audit-entry.create {
        border-color: #4CAF50;
    }
    
    .save-button {
        position: fixed;
        bottom: 30px;
        right: 30px;
        z-index: 1000;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .total-weight-display {
        font-size: 1.8em;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        margin: 20px 0;
    }
    
    .total-weight-display.valid {
        background-color: #c8e6c9;
        color: #2e7d32;
        border: 2px solid #4caf50;
    }
    
    .total-weight-display.invalid {
        background-color: #ffcdd2;
        color: #c62828;
        border: 2px solid #f44336;
    }
    
    .breadcrumb-nav {
        margin-bottom: 30px;
        padding: 15px 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    .breadcrumb-nav a {
        color: #2196F3;
        text-decoration: none;
    }
    
    .breadcrumb-nav a:hover {
        text-decoration: underline;
    }
    
    .profile-header {
        background: linear-gradient(135deg, #2e7d32, #4caf50);
        color: white;
        padding: 30px;
        border-radius: 8px;
        margin-bottom: 30px;
        text-align: center;
    }
    
    .profile-header h1 {
        margin: 0;
        font-weight: 300;
    }
    
    .tab-content {
        padding: 20px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-nav">
        <nav>
            <div class="nav-wrapper transparent">
                <div class="col s12">
                    <a href="{{ url_for('admin_config.index') }}" class="breadcrumb">
                        <i class="material-icons left">arrow_back</i>Admin Configuration
                    </a>
                    <a href="#!" class="breadcrumb">{{ profile.name }}</a>
                </div>
            </div>
        </nav>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
        <div class="row" style="margin-bottom: 0;">
            <div class="col s12 m8">
                <h1><i class="material-icons left medium">edit</i>{{ profile.name }}</h1>
                <p style="margin: 10px 0 0 0; opacity: 0.9;">{{ profile.description }}</p>
            </div>
            <div class="col s12 m4" style="text-align: right;">
                <div class="chip {% if profile.is_active %}green white-text{% else %}grey lighten-1{% endif %}" 
                     style="font-size: 1.1em; padding: 8px 16px;">
                    {% if profile.is_active %}
                        <i class="material-icons left">check_circle</i>Active
                    {% else %}
                        <i class="material-icons left">pause_circle_outline</i>Inactive
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Configuration Form -->
    <form id="profileForm">
        <!-- Scoring Weights Section -->
        <div class="param-group">
            <h3><i class="material-icons left">equalizer</i>Scoring Weights</h3>
            <p class="grey-text">These weights determine how pumps are scored. Total must equal 100.</p>
            
            <div class="row">
                <div class="input-field col s12 m6">
                    <input type="number" id="bep_weight" name="bep_weight" 
                           value="{{ profile.scoring_weights.bep }}" min="0" max="100" step="0.1"
                           class="validate">
                    <label for="bep_weight" class="active">BEP Proximity Weight</label>
                    <span class="helper-text">Weight given to operating near Best Efficiency Point (reliability)</span>
                </div>
                <div class="input-field col s12 m6">
                    <input type="number" id="efficiency_weight" name="efficiency_weight" 
                           value="{{ profile.scoring_weights.efficiency }}" min="0" max="100" step="0.1"
                           class="validate">
                    <label for="efficiency_weight" class="active">Efficiency Weight</label>
                    <span class="helper-text">Weight given to pump efficiency (operating cost)</span>
                </div>
                <div class="input-field col s12 m6">
                    <input type="number" id="head_margin_weight" name="head_margin_weight" 
                           value="{{ profile.scoring_weights.head_margin }}" min="0" max="100" step="0.1"
                           class="validate">
                    <label for="head_margin_weight" class="active">Head Margin Weight</label>
                    <span class="helper-text">Weight given to proper pump sizing (avoiding oversizing)</span>
                </div>
                <div class="input-field col s12 m6">
                    <input type="number" id="npsh_weight" name="npsh_weight" 
                           value="{{ profile.scoring_weights.npsh }}" min="0" max="100" step="0.1"
                           class="validate">
                    <label for="npsh_weight" class="active">NPSH Weight</label>
                    <span class="helper-text">Weight given to NPSH margin (cavitation prevention)</span>
                </div>
            </div>
            
            <div class="total-weight-display valid" id="totalWeightDisplay">
                <i class="material-icons left">check_circle</i>
                Total Weight: <span id="totalWeight">100.0</span>%
            </div>
        </div>
        
        <!-- Efficiency Thresholds -->
        <div class="param-group">
            <h3>Efficiency Thresholds</h3>
            <p class="text-muted">Define efficiency categories for scoring</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="param-input">
                        <label for="min_acceptable_efficiency">Minimum Acceptable Efficiency</label>
                        <input type="number" class="form-control" id="min_acceptable_efficiency" name="min_acceptable_efficiency" 
                               value="{{ profile.zones.efficiency_thresholds.minimum }}" min="20" max="60" step="1">
                        <small>Pumps below this efficiency are excluded</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-input">
                        <label for="fair_efficiency">Fair Efficiency Threshold</label>
                        <input type="number" class="form-control" id="fair_efficiency" name="fair_efficiency" 
                               value="{{ profile.zones.efficiency_thresholds.fair }}" min="40" max="80" step="1">
                        <small>Efficiency considered "fair" above this value</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-input">
                        <label for="good_efficiency">Good Efficiency Threshold</label>
                        <input type="number" class="form-control" id="good_efficiency" name="good_efficiency" 
                               value="{{ profile.zones.efficiency_thresholds.good }}" min="60" max="90" step="1">
                        <small>Efficiency considered "good" above this value</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-input">
                        <label for="excellent_efficiency">Excellent Efficiency Threshold</label>
                        <input type="number" class="form-control" id="excellent_efficiency" name="excellent_efficiency" 
                               value="{{ profile.zones.efficiency_thresholds.excellent }}" min="70" max="95" step="1">
                        <small>Efficiency considered "excellent" above this value</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- BEP Operating Zones -->
        <div class="param-group">
            <h3>BEP Operating Zones</h3>
            <p class="text-muted">Define the optimal flow range relative to Best Efficiency Point</p>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="param-input">
                        <label for="bep_optimal_min">Optimal Zone Minimum</label>
                        <input type="number" class="form-control" id="bep_optimal_min" name="bep_optimal_min" 
                               value="{{ profile.zones.bep_optimal[0] }}" min="0.7" max="1.0" step="0.05">
                        <small>Minimum flow ratio for optimal operation (typically 0.95)</small>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="param-input">
                        <label for="bep_optimal_max">Optimal Zone Maximum</label>
                        <input type="number" class="form-control" id="bep_optimal_max" name="bep_optimal_max" 
                               value="{{ profile.zones.bep_optimal[1] }}" min="1.0" max="1.3" step="0.05">
                        <small>Maximum flow ratio for optimal operation (typically 1.05)</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NPSH Safety Margins -->
        <div class="param-group">
            <h3>NPSH Safety Margins</h3>
            <p class="text-muted">Define safety margins above minimum NPSH requirements</p>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="param-input">
                        <label for="npsh_minimum_margin">Minimum Margin</label>
                        <input type="number" class="form-control" id="npsh_minimum_margin" name="npsh_minimum_margin" 
                               value="{{ profile.zones.npsh_margins.minimum }}" min="0.3" max="2.0" step="0.1">
                        <small>Absolute minimum NPSH margin (m)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="param-input">
                        <label for="npsh_good_margin">Good Margin</label>
                        <input type="number" class="form-control" id="npsh_good_margin" name="npsh_good_margin" 
                               value="{{ profile.zones.npsh_margins.good }}" min="1.0" max="3.0" step="0.1">
                        <small>NPSH margin considered "good" (m)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="param-input">
                        <label for="npsh_excellent_margin">Excellent Margin</label>
                        <input type="number" class="form-control" id="npsh_excellent_margin" name="npsh_excellent_margin" 
                               value="{{ profile.zones.npsh_margins.excellent }}" min="2.0" max="5.0" step="0.1">
                        <small>NPSH margin considered "excellent" (m)</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modification Penalties -->
        <div class="param-group">
            <h3>Modification Penalties</h3>
            <p class="text-muted">Penalties applied when pump modifications are required</p>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="param-input">
                        <label for="speed_variation_penalty_factor">Speed Variation Penalty</label>
                        <input type="number" class="form-control" id="speed_variation_penalty_factor" 
                               name="speed_variation_penalty_factor" 
                               value="{{ profile.modifications.speed_penalty }}" min="0" max="30" step="1">
                        <small>Maximum penalty points for speed variation (VFD required)</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="param-input">
                        <label for="trimming_penalty_factor">Impeller Trimming Penalty</label>
                        <input type="number" class="form-control" id="trimming_penalty_factor" 
                               name="trimming_penalty_factor" 
                               value="{{ profile.modifications.trim_penalty }}" min="0" max="20" step="1">
                        <small>Maximum penalty points for impeller trimming</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="param-input">
                        <label for="max_acceptable_trim_pct">Maximum Trim Percentage</label>
                        <input type="number" class="form-control" id="max_acceptable_trim_pct" 
                               name="max_acceptable_trim_pct" 
                               value="{{ profile.modifications.max_trim_pct }}" min="70" max="85" step="1">
                        <small>Minimum impeller size allowed (% of full diameter)</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="text-end mb-5">
            <button type="button" class="btn btn-primary btn-lg save-button" onclick="saveProfile()">
                <i class="fas fa-save"></i> Save Changes
            </button>
        </div>
    </form>
    
    <!-- Audit Log -->
    <div class="row mt-5">
        <div class="col-12">
            <h3>Change History</h3>
            <div class="audit-log">
                {% for entry in audit_log %}
                <div class="audit-entry {{ entry.change_type }}">
                    <div class="d-flex justify-content-between">
                        <strong>{{ entry.changed_by }}</strong>
                        <small class="text-muted">{{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                    </div>
                    {% if entry.change_type == 'update' %}
                    <p class="mb-1">Changed <code>{{ entry.field_name }}</code> from <strong>{{ entry.old_value }}</strong> to <strong>{{ entry.new_value }}</strong></p>
                    {% else %}
                    <p class="mb-1">{{ entry.change_type|title }} profile</p>
                    {% endif %}
                    {% if entry.reason %}
                    <small class="text-muted">Reason: {{ entry.reason }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
// Update weight indicators and total
document.querySelectorAll('input[type="number"]').forEach(input => {
    input.addEventListener('input', function() {
        // Update indicator if it's a weight field
        const indicator = this.parentElement.querySelector('.weight-indicator');
        if (indicator) {
            indicator.textContent = this.value + '%';
        }
        
        // Update total weight if it's a weight field
        if (this.name.includes('weight')) {
            updateTotalWeight();
        }
    });
});

function updateTotalWeight() {
    const total = parseFloat(document.getElementById('bep_weight').value || 0) +
                  parseFloat(document.getElementById('efficiency_weight').value || 0) +
                  parseFloat(document.getElementById('head_margin_weight').value || 0) +
                  parseFloat(document.getElementById('npsh_weight').value || 0);
    
    document.getElementById('totalWeight').textContent = total.toFixed(1);
    const display = document.getElementById('totalWeightDisplay');
    
    if (Math.abs(total - 100) < 0.01) {
        display.classList.remove('invalid');
        display.classList.add('valid');
    } else {
        display.classList.remove('valid');
        display.classList.add('invalid');
    }
}

function saveProfile() {
    // Validate total weight
    const total = parseFloat(document.getElementById('bep_weight').value || 0) +
                  parseFloat(document.getElementById('efficiency_weight').value || 0) +
                  parseFloat(document.getElementById('head_margin_weight').value || 0) +
                  parseFloat(document.getElementById('npsh_weight').value || 0);
    
    if (Math.abs(total - 100) > 0.01) {
        alert('Scoring weights must total exactly 100. Current total: ' + total.toFixed(1));
        return;
    }
    
    // Get reason for change
    const reason = prompt('Please provide a reason for this change:');
    if (!reason) {
        return;
    }
    
    // Collect all form data
    const formData = {};
    document.querySelectorAll('#profileForm input[type="number"]').forEach(input => {
        formData[input.name] = parseFloat(input.value);
    });
    formData.reason = reason;
    
    // Send update request
    fetch('{{ url_for("admin_config.api_profile", profile_id=profile.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Profile updated successfully!');
            window.location.reload();
        } else {
            alert('Error updating profile: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

// Initialize total weight display
updateTotalWeight();
</script>
</div> <!-- End of config-settings div -->
</div> <!-- End of container div -->
{% endblock %}
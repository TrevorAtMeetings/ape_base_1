{% extends "admin/base.html" %}

{% block admin_title %}Brain System Administration{% endblock %}

{% block admin_content %}
<div class="container" style="margin-top: 20px;">
    <!-- Page Header -->
    <div class="row">
        <div class="col s12">
            <div class="card-panel">
                <h4 class="blue-text text-darken-2">
                    <i class="material-icons left">psychology</i>
                    Brain System Administration
                </h4>
                <p>System Status: <span class="badge green white-text">System operating normally</span></p>
                <p class="grey-text">Production Configuration: {{ stats.production_config|default('production_default') }}</p>
            </div>
        </div>
    </div>

    <!-- System Status Overview -->
    <div class="row">
        <div class="col s12 m4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Data Quality Issues</span>
                    <h3 class="blue-text">{{ stats.total_quality_issues|default(0) }}</h3>
                    <p class="grey-text">Critical: {{ stats.critical_issues|default(0) }}</p>
                    <p class="grey-text">Major: {{ stats.major_issues|default(0) }}</p>
                </div>
            </div>
        </div>
        <div class="col s12 m4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Critical Issues</span>
                    <h3 class="red-text">{{ stats.critical_issues|default(0) }}</h3>
                    <p class="grey-text">Require immediate attention</p>
                </div>
            </div>
        </div>
        <div class="col s12 m4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Active Corrections</span>
                    <h3 class="green-text">{{ stats.active_corrections|default(0) }}</h3>
                    <p class="grey-text">Corrections in overlay system</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Quality Management Section -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">assessment</i>
                        Data Quality Management
                    </span>
                    <p>Monitor and manage data quality issues across all pump specifications and performance curves. Identify inconsistencies, outliers, and missing data that could affect selection accuracy.</p>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('brain_admin.data_quality_dashboard') }}" class="btn">
                        View Quality Issues
                    </a>
                    <a href="#" class="btn-flat blue-text disabled">
                        Run Quality Scan
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Corrections System Section -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">edit</i>
                        Data Corrections System
                    </span>
                    <p>Manage the overlay correction system. Propose, review, and approve corrections to pump data without modifying the golden source database. All changes are auditable and reversible.</p>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('brain_admin.corrections_dashboard') }}" class="btn">
                        Manage Corrections
                    </a>
                    <a href="{{ url_for('brain_admin.corrections_dashboard') }}" class="btn-flat blue-text">
                        Propose Correction
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tunable Physics Engine Section -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">tune</i>
                        Tunable Physics Engine
                    </span>
                    <p>Calibrate the Brain's physics model for BEP migration calculations. Compare against manufacturer data, analyze accuracy, and tune calibration factors for optimal performance.</p>
                    <div class="chip orange lighten-4">
                        <span class="orange-text text-darken-2">NEW</span>
                    </div>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('brain_admin.calibration_tool') }}" class="btn orange">
                        <i class="material-icons left">tune</i>
                        Calibration Tool
                    </a>
                    <a href="#" class="btn-flat orange-text" onclick="runQuickCalibration()">
                        Quick Test
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Brain Logic Workbench Section -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">science</i>
                        Brain Logic Workbench
                    </span>
                    <p>Test and validate Brain logic changes in a safe environment. Simulate different configurations, test corrections, and analyze the impact before deploying to production.</p>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('brain_admin.brain_workbench') }}" class="btn">
                        Open Workbench
                    </a>
                    <a href="#" class="btn-flat blue-text">
                        Test Scenario
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration Management Section -->
    <div class="row">
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">settings</i>
                        Configuration Management
                    </span>
                    <p>Manage Brain configuration profiles for different use cases. Create, test, and deploy configurations with different scoring weights and logic parameters.</p>
                </div>
                <div class="card-action">
                    <a href="/admin/config/" class="btn blue">
                        Configuration Manager
                    </a>
                    <a href="/admin/config/profile/new" class="btn-flat blue-text">
                        New Profile
                    </a>
                </div>
            </div>
        </div>

        <!-- Manufacturer Comparison Section -->
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">compare_arrows</i>
                        Manufacturer Comparison
                    </span>
                    <p>Compare Brain selections against manufacturer recommendations. Upload datasheets, analyze differences, and identify opportunities for improvement.</p>
                </div>
                <div class="card-action">
                    <a href="#" onclick="showPumpSelector()" class="btn blue">
                        Comparison Tool
                    </a>
                    <a href="{{ url_for('brain_admin.brain_workbench') }}" class="btn-flat blue-text">
                        Logic Workbench
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Decision Analytics Section -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">analytics</i>
                        Decision Analytics
                    </span>
                    <p>Analyze Brain decision patterns, track accuracy improvements over time, and generate reports on system performance and feasibility.</p>
                </div>
                <div class="card-action">
                    <a href="#" class="btn disabled">
                        View Analytics
                    </a>
                    <a href="#" class="btn-flat blue-text disabled">
                        Generate Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock admin_content %}

{% block scripts %}
{{ super() }}
<style>
/* Pump Selector Modal Styles */
#pump-selector-modal {
    max-width: 800px;
    border-radius: 8px;
}

#pump-selector-modal .modal-content {
    padding: 24px;
}

#pump-selector-modal h4 {
    margin-bottom: 8px;
    color: #1565c0;
}

#pump-selector-modal .search-container {
    background: #f5f5f5;
    padding: 16px;
    border-radius: 8px;
    margin: 20px 0;
}

#pump-selector-modal .pump-grid {
    display: grid;
    gap: 8px;
    max-height: 400px;
    overflow-y: auto;
    padding: 8px;
}

.pump-category {
    margin-bottom: 16px;
}

.pump-category-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 16px;
    border-radius: 4px 4px 0 0;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.pump-items {
    background: white;
    border: 1px solid #e0e0e0;
    border-top: none;
    border-radius: 0 0 4px 4px;
}

.pump-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.pump-item:last-child {
    border-bottom: none;
}

.pump-item:hover {
    background: #f8f9fa;
    padding-left: 20px;
}

.pump-item.selected {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
}

.pump-code {
    font-weight: 600;
    color: #333;
    margin-right: 8px;
}

.pump-type {
    color: #666;
    font-size: 14px;
}

.no-results {
    text-align: center;
    padding: 40px;
    color: #999;
}

#pump-search {
    font-size: 16px;
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    width: 100%;
    transition: border-color 0.3s;
}

#pump-search:focus {
    border-color: #2196f3;
    outline: none;
}

.search-hint {
    color: #999;
    font-size: 12px;
    margin-top: 8px;
}
</style>

<script>
// Fix dropdown initialization
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing Brain Dashboard dropdowns...');
    
    // Initialize all dropdowns with proper options
    setTimeout(function() {
        var dropdownElems = document.querySelectorAll('.dropdown-button');
        dropdownElems.forEach(function(elem) {
            if (!elem.M_Dropdown) {
                M.Dropdown.init(elem, {
                    constrainWidth: false,
                    coverTrigger: false,
                    alignment: 'left',
                    hover: false
                });
            }
        });
        console.log('Initialized', dropdownElems.length, 'dropdown buttons');
    }, 100);
});

// Global variable to store selected pump
let selectedPump = null;

// Pump data organized by series
const pumpData = {
    '2F Series - End Suction': [
        { code: '100-200 2F', type: 'END SUCTION' },
        { code: '100-200 2F 2P', type: 'END SUCTION 2-POLE' },
        { code: '100-250 2F', type: 'END SUCTION' },
        { code: '100-315 2F', type: 'END SUCTION' },
        { code: '125-250 2F', type: 'END SUCTION' },
        { code: '125-315 2F', type: 'END SUCTION' },
        { code: '150-200 2F', type: 'END SUCTION' },
        { code: '150-250 2F', type: 'END SUCTION' },
        { code: '150-315 2F', type: 'END SUCTION' },
        { code: '50-160 2F', type: 'END SUCTION' },
        { code: '50-200 2F', type: 'END SUCTION' },
        { code: '50-250 2F', type: 'END SUCTION' },
        { code: '65-160 2F', type: 'END SUCTION' },
        { code: '65-200 2F', type: 'END SUCTION' },
        { code: '65-250 2F', type: 'END SUCTION' }
    ],
    'WL/WLN Series - Slurry': [
        { code: '10 WLN 26A', type: 'SLURRY PUMP' },
        { code: '10 WLN 32A', type: 'SLURRY PUMP' },
        { code: '12 WL 26A', type: 'SLURRY PUMP' },
        { code: '14 WL 30A', type: 'SLURRY PUMP' },
        { code: '6x8x10 WL', type: 'SLURRY PUMP' },
        { code: '6x8x10 WLN', type: 'SLURRY PUMP' },
        { code: '8x6x14 WL', type: 'SLURRY PUMP' }
    ],
    'HC Series - High Capacity': [
        { code: '28 HC 6P', type: 'HIGH CAPACITY' },
        { code: '30 HC 6P', type: 'HIGH CAPACITY' },
        { code: '32 HC 6P', type: 'HIGH CAPACITY' }
    ],
    'V Series - Vertical': [
        { code: '8V 5S', type: 'VERTICAL PUMP' },
        { code: '10V 5S', type: 'VERTICAL PUMP' },
        { code: '12V 6S', type: 'VERTICAL PUMP' }
    ],
    'Special Series': [
        { code: '10 NHTB', type: 'SPECIAL APPLICATION' },
        { code: '12 NHTB', type: 'SPECIAL APPLICATION' }
    ]
};

function showPumpSelector() {
    // Build pump categories HTML
    let categoriesHtml = '';
    for (const [category, pumps] of Object.entries(pumpData)) {
        categoriesHtml += `
            <div class="pump-category">
                <div class="pump-category-header">${category}</div>
                <div class="pump-items">
        `;
        
        pumps.forEach(pump => {
            categoriesHtml += `
                <div class="pump-item" onclick="selectPump('${pump.code}', '${pump.type}')">
                    <span class="pump-code">${pump.code}</span>
                    <span class="pump-type">• ${pump.type}</span>
                </div>
            `;
        });
        
        categoriesHtml += `
                </div>
            </div>
        `;
    }
    
    // Create modal HTML
    const modalHtml = `
        <div id="pump-selector-modal" class="modal modal-fixed-footer">
            <div class="modal-content">
                <h4>
                    <i class="material-icons left">compare_arrows</i>
                    Pump Calibration Workbench
                </h4>
                <p class="grey-text">Compare Brain predictions against manufacturer data with multi-point calibration and performance analysis.</p>
                
                <div class="search-container">
                    <input type="text" 
                           id="pump-search" 
                           placeholder="Search by pump code or type..." 
                           onkeyup="filterPumps(event)" 
                           autocomplete="off">
                    <div class="search-hint">
                        💡 Try searching: "2F", "WL", "100-200", or press Enter to use custom code
                    </div>
                </div>
                
                <div id="pump-categories" class="pump-grid">
                    ${categoriesHtml}
                </div>
                
                <div id="no-results" class="no-results" style="display: none;">
                    <i class="material-icons large grey-text">search_off</i>
                    <p>No pumps found matching your search</p>
                    <p class="grey-text">Press Enter to calibrate a custom pump code</p>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-red btn-flat">Cancel</a>
                <a href="#!" onclick="navigateToCalibration()" class="waves-effect waves-green btn blue disabled" id="calibrate-btn">
                    <i class="material-icons left">analytics</i>
                    Select a Pump First
                </a>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('pump-selector-modal');
    if (existingModal) {
        const instance = M.Modal.getInstance(existingModal);
        if (instance) instance.destroy();
        existingModal.remove();
    }
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Initialize and open modal
    const modal = document.getElementById('pump-selector-modal');
    const instance = M.Modal.init(modal, {
        dismissible: true,
        onOpenEnd: function() {
            document.getElementById('pump-search').focus();
        }
    });
    instance.open();
}

function selectPump(code, type) {
    selectedPump = code;
    
    // Update UI to show selection
    document.querySelectorAll('.pump-item').forEach(item => {
        item.classList.remove('selected');
        if (item.querySelector('.pump-code').textContent === code) {
            item.classList.add('selected');
        }
    });
    
    // Enable calibrate button
    const btn = document.getElementById('calibrate-btn');
    btn.classList.remove('disabled');
    btn.innerHTML = `
        <i class="material-icons left">analytics</i>
        Calibrate ${code}
    `;
    
    // Update search field
    document.getElementById('pump-search').value = code;
}

function filterPumps(event) {
    const searchTerm = event.target.value.toUpperCase();
    const categories = document.querySelectorAll('.pump-category');
    let hasResults = false;
    
    // Handle Enter key for custom pump codes
    if (event.key === 'Enter' && searchTerm.length > 0) {
        selectedPump = event.target.value;
        navigateToCalibration();
        return;
    }
    
    // Filter pumps
    categories.forEach(category => {
        const items = category.querySelectorAll('.pump-item');
        let categoryHasMatch = false;
        
        items.forEach(item => {
            const text = item.textContent.toUpperCase();
            if (text.includes(searchTerm)) {
                item.style.display = '';
                categoryHasMatch = true;
                hasResults = true;
            } else {
                item.style.display = 'none';
            }
        });
        
        // Hide category if no matches
        category.style.display = categoryHasMatch ? '' : 'none';
    });
    
    // Show/hide no results message
    document.getElementById('pump-categories').style.display = hasResults ? '' : 'none';
    document.getElementById('no-results').style.display = hasResults ? 'none' : 'block';
}

function navigateToCalibration() {
    const pumpCode = selectedPump || document.getElementById('pump-search').value.trim();
    
    if (pumpCode) {
        // Encode the pump code to handle spaces and special characters
        const encodedCode = encodeURIComponent(pumpCode);
        window.location.href = `/admin/pump-calibration/${encodedCode}`;
    } else {
        M.toast({
            html: '<i class="material-icons left">warning</i>Please select or enter a pump code',
            classes: 'orange darken-2',
            displayLength: 3000
        });
    }
}

function runQuickCalibration() {
    M.toast({
        html: '<i class="material-icons left">info</i>Quick calibration will be available soon',
        classes: 'blue',
        displayLength: 3000
    });
}
</script>
{% endblock %}
{% extends "admin/base.html" %}

{% block admin_title %}Data Corrections Management{% endblock %}

{% block admin_content %}
<div class="container">
        <h1 class="blue-text text-darken-2" style="margin-bottom: 30px;">
            <i class="material-icons left">edit</i>
            Data Corrections Management
        </h1>

        <!-- Statistics Overview -->
        <div class="row">
            <div class="col s12 m4">
                <div class="card">
                    <div class="card-content center-align">
                        <h3 class="green-text">{{ stats.active }}</h3>
                        <p class="grey-text">Active Corrections</p>
                    </div>
                </div>
            </div>
            <div class="col s12 m4">
                <div class="card">
                    <div class="card-content center-align">
                        <h3 class="orange-text">{{ stats.pending_approval }}</h3>
                        <p class="grey-text">Pending Approval</p>
                    </div>
                </div>
            </div>
            <div class="col s12 m4">
                <div class="card">
                    <div class="card-content center-align">
                        <h3 class="blue-text">{{ stats.total_pumps_corrected }}</h3>
                        <p class="grey-text">Pumps Corrected</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Corrections -->
        <div class="row">
            <div class="col s12 l6">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title green-text">
                            <i class="material-icons left">check_circle</i>
                            Active Corrections
                            <span class="badge green white-text">{{ active_corrections|length }}</span>
                        </span>
                        {% if active_corrections %}
                            {% for correction in active_corrections %}
                            <div class="card-panel green lighten-5" style="margin: 8px 0; padding: 15px;">
                                <strong class="blue-text">{{ correction.pump_code }}</strong>
                                <span class="grey-text"> - {{ correction.field_path }}</span>
                                <p style="margin: 8px 0; font-size: 0.9em;">
                                    <strong>Value:</strong> {{ correction.corrected_value }}
                                </p>
                                <p class="grey-text" style="margin: 4px 0 0 0; font-size: 0.85em;">
                                    {{ correction.justification }}
                                </p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="grey-text center-align" style="margin-top: 20px;">No active corrections</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pending Corrections -->
            <div class="col s12 l6">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title orange-text">
                            <i class="material-icons left">hourglass_empty</i>
                            Pending Approval
                            <span class="badge orange white-text">{{ pending_corrections|length }}</span>
                        </span>
                        {% if pending_corrections %}
                            {% for correction in pending_corrections %}
                            <div class="card-panel orange lighten-5" style="margin: 8px 0; padding: 15px;">
                                <strong class="blue-text">{{ correction[0] }}</strong>
                                <span class="grey-text"> - {{ correction[2] }}</span>
                                <p style="margin: 8px 0; font-size: 0.9em;">
                                    <strong>Proposed Value:</strong> {{ correction[3] }}
                                </p>
                                <p class="grey-text" style="margin: 4px 0 8px 0; font-size: 0.85em;">
                                    {{ correction[4] }}
                                </p>
                                <div style="margin-top: 10px;">
                                    <a href="#" class="btn-small green" onclick="approveCorrection({{ correction[7] }})">
                                        <i class="material-icons left">check</i>Approve
                                    </a>
                                    <a href="#" class="btn-small red" onclick="rejectCorrection({{ correction[7] }})">
                                        <i class="material-icons left">close</i>Reject
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="grey-text center-align" style="margin-top: 20px;">No pending corrections</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row">
            <div class="col s12">
                <div class="card">
                    <div class="card-content">
                        <span class="card-title">Corrections Management Actions</span>
                        <div class="card-action">
                            <a href="/admin/brain" class="btn blue">
                                <i class="material-icons left">arrow_back</i>
                                Back to Brain Dashboard
                            </a>
                            <a href="#" class="btn green disabled">
                                <i class="material-icons left">add</i>
                                Propose New Correction
                            </a>
                            <a href="/admin/brain/workbench" class="btn purple">
                                <i class="material-icons left">science</i>
                                Test in Workbench
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
function approveCorrection(correctionId) {
    if (confirm('Are you sure you want to approve this correction?')) {
        fetch(`/api/brain/approve-correction/${correctionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                M.toast({html: 'Correction approved successfully', classes: 'green'});
                location.reload();
            } else {
                M.toast({html: 'Error approving correction: ' + data.error, classes: 'red'});
            }
        })
        .catch(error => {
            M.toast({html: 'Error: ' + error, classes: 'red'});
        });
    }
}

function rejectCorrection(correctionId) {
    if (confirm('Are you sure you want to reject this correction?')) {
        fetch(`/api/brain/reject-correction/${correctionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                M.toast({html: 'Correction rejected successfully', classes: 'orange'});
                location.reload();
            } else {
                M.toast({html: 'Error rejecting correction: ' + data.error, classes: 'red'});
            }
        })
        .catch(error => {
            M.toast({html: 'Error: ' + error, classes: 'red'});
        });
    }
}
</script>
{% endblock admin_content %}
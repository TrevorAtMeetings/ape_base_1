INFO:app:Flask app instance created.
INFO:app:Routes imported.Upload folder: /home/runner/workspace/app/static/temp
INFO:app.llm_reasoning:OpenAI client initialized successfully
INFO:app.llm_reasoning:Google Gemini client initialized successfully
INFO:app.llm_reasoning:LLM reasoning module initialized successfully
 * Serving Flask app 'app'
 * Debug mode: on
INFO:werkzeug:WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:8080
 * Running on http://172.31.128.77:8080
INFO:werkzeug:Press CTRL+C to quit
INFO:werkzeug: * Restarting with stat
INFO:app:Flask app instance created.
INFO:app:App configured. Upload folder: /home/runner/workspace/app/static/temp
INFO:app:Routes imported.
INFO:app.llm_reasoning:OpenAI client initialized successfully
INFO:app.llm_reasoning:Google Gemini client initialized successfully
INFO:app.llm_reasoning:LLM reasoning module initialized successfully
WARNING:werkzeug: * Debugger is active!
INFO:werkzeug: * Debugger PIN: 324-402-074
INFO:app.routes:Index route accessed.
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:43] "GET / HTTP/1.1" 200 -
INFO:app.routes:Processing requirements: SiteRequirements(flow=342.0 mÂ³/hr, head=27.4 m)
INFO:pump_engine:Loaded 3 pumps from database
INFO:app.routes:Successfully parsed 3 pumps
INFO:pump_engine:Suitability score calculated successfully: {'overall_score': 77.03503649635037, 'head_accuracy_score': 78.55839416058394, 'efficiency_score': 74.75, 'operating_point': {'curve_index': 1, 'impeller_size': '394.00', 'flow_m3hr': 342.0, 'achieved_head_m': 33.275, 'achieved_efficiency_pct': 74.75, 'achieved_power_kw': 147.4810875, 'achieved_npshr_m': None, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 10.0, 'curve_range_max': 414.0, 'extrapolated': False}, 'best_curve_index': 1}
INFO:pump_engine:Pump 6 K 6 VANE evaluation completed with score: 77.03503649635037
INFO:pump_engine:Suitability score calculated successfully: {'overall_score': 92.80000000000001, 'head_accuracy_score': 100.0, 'efficiency_score': 82.0, 'operating_point': {'curve_index': 2, 'impeller_size': '312.00', 'flow_m3hr': 342.0, 'achieved_head_m': 27.4, 'achieved_efficiency_pct': 82.0, 'achieved_power_kw': 112.10676585365853, 'achieved_npshr_m': 2.78, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 0.0, 'curve_range_max': 408.0, 'extrapolated': False}, 'best_curve_index': 2}
INFO:pump_engine:Pump 6/8 ALE evaluation completed with score: 92.80000000000001
INFO:pump_engine:Suitability score calculated successfully: {'overall_score': 73.74598540145985, 'head_accuracy_score': 83.57664233576642, 'efficiency_score': 59.0, 'operating_point': {'curve_index': 1, 'impeller_size': '356.00', 'flow_m3hr': 342.0, 'achieved_head_m': 22.9, 'achieved_efficiency_pct': 59.0, 'achieved_power_kw': 114.22830508474576, 'achieved_npshr_m': None, 'head_was_extrapolated': True, 'efficiency_was_extrapolated': True, 'power_was_extrapolated': True, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': True, 'curve_range_min': 0.0, 'curve_range_max': 300.0, 'extrapolated': True}, 'best_curve_index': 1}
INFO:pump_engine:Pump 5 K evaluation completed with score: 73.74598540145985
INFO:app.routes:Generating charts for pump: 6/8 ALE
INFO:app.routes:Operating point data: {'curve_index': 2, 'impeller_size': '312.00', 'flow_m3hr': 342.0, 'achieved_head_m': 27.4, 'achieved_efficiency_pct': 82.0, 'achieved_power_kw': 112.10676585365853, 'achieved_npshr_m': 2.78, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 0.0, 'curve_range_max': 408.0, 'extrapolated': False}
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:50] "GET /pump-options?flow=342&head=27.4&contact_name=James+Richardson&company=Municipal+Water+Authority&email=j.richardson@waterauth.gov.uk&project_name=Town+Centre+Water+Supply+Upgrade&application=water&project_location=Central+Pumping+Station,+Manchester&liquid_type=water&temperature=15&specific_gravity=1.0&viscosity=1.0&suction_pressure=0.1&static_head=15&npsh_available=4.5&max_power=30 HTTP/1.1" 302 -
INFO:app.routes:Displaying report for pump: 6/8 ALE
INFO:app.routes:Template data - selected_pump operating_point: {'achieved_efficiency_pct': 82.0, 'achieved_head_m': 27.4, 'achieved_npshr_m': 2.78, 'achieved_power_kw': 112.10676585365853, 'curve_index': 2, 'curve_range_max': 408.0, 'curve_range_min': 0.0, 'efficiency_was_extrapolated': False, 'extrapolated': False, 'flow_m3hr': 342.0, 'head_was_extrapolated': False, 'impeller_size': '312.00', 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'power_was_extrapolated': False}
INFO:app.routes:Template data - selected_pump selected_curve: {'impeller_size': '312.00', 'is_selected': True, 'curve_index': 2}
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:50] "GET /pump_report/6/8%20ALE HTTP/1.1" 200 -
INFO:pump_engine:Loaded 3 pumps from database
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:52] "GET /api/chart_data_safe/Ni84IEFMRQ?flow=342&head=27.4 HTTP/1.1" 200 -
INFO:pump_engine:Loaded 3 pumps from database
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:53] "GET /api/chart_data_safe/Ni84IEFMRQ?flow=342&head=27.4 HTTP/1.1" 200 -
INFO:app.routes:PDF generation requested for pump: 6/8 ALE
INFO:pump_engine:Loaded 3 pumps from database
INFO:pump_engine:Suitability score calculated successfully: {'overall_score': 77.03503649635037, 'head_accuracy_score': 78.55839416058394, 'efficiency_score': 74.75, 'operating_point': {'curve_index': 1, 'impeller_size': '394.00', 'flow_m3hr': 342.0, 'achieved_head_m': 33.275, 'achieved_efficiency_pct': 74.75, 'achieved_power_kw': 147.4810875, 'achieved_npshr_m': None, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 10.0, 'curve_range_max': 414.0, 'extrapolated': False}, 'best_curve_index': 1}
INFO:pump_engine:Pump 6 K 6 VANE evaluation completed with score: 77.03503649635037
INFO:pump_engine:Suitability score calculated successfully: {'overall_score': 92.80000000000001, 'head_accuracy_score': 100.0, 'efficiency_score': 82.0, 'operating_point': {'curve_index': 2, 'impeller_size': '312.00', 'flow_m3hr': 342.0, 'achieved_head_m': 27.4, 'achieved_efficiency_pct': 82.0, 'achieved_power_kw': 112.10676585365853, 'achieved_npshr_m': 2.78, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 0.0, 'curve_range_max': 408.0, 'extrapolated': False}, 'best_curve_index': 2}
INFO:pump_engine:Pump 6/8 ALE evaluation completed with score: 92.80000000000001
INFO:pump_engine:Suitability score calculated successfully: {'overall_score': 73.74598540145985, 'head_accuracy_score': 83.57664233576642, 'efficiency_score': 59.0, 'operating_point': {'curve_index': 1, 'impeller_size': '356.00', 'flow_m3hr': 342.0, 'achieved_head_m': 22.9, 'achieved_efficiency_pct': 59.0, 'achieved_power_kw': 114.22830508474576, 'achieved_npshr_m': None, 'head_was_extrapolated': True, 'efficiency_was_extrapolated': True, 'power_was_extrapolated': True, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': True, 'curve_range_min': 0.0, 'curve_range_max': 300.0, 'extrapolated': True}, 'best_curve_index': 1}
INFO:pump_engine:Pump 5 K evaluation completed with score: 73.74598540145985
INFO:app.routes:PDF generation - pump_selections found: 3
INFO:app.routes:PDF selection 0: pump_code=6/8 ALE, operating_point keys=['curve_index', 'impeller_size', 'flow_m3hr', 'achieved_head_m', 'achieved_efficiency_pct', 'achieved_power_kw', 'achieved_npshr_m', 'head_was_extrapolated', 'efficiency_was_extrapolated', 'power_was_extrapolated', 'npshr_was_extrapolated', 'operating_point_overall_extrapolated', 'curve_range_min', 'curve_range_max', 'extrapolated']
INFO:app.routes:PDF target pump operating point: head=27.4, eff=82.0, power=112.10676585365853
INFO:app.routes:PDF selection 1: pump_code=6 K 6 VANE, operating_point keys=['curve_index', 'impeller_size', 'flow_m3hr', 'achieved_head_m', 'achieved_efficiency_pct', 'achieved_power_kw', 'achieved_npshr_m', 'head_was_extrapolated', 'efficiency_was_extrapolated', 'power_was_extrapolated', 'npshr_was_extrapolated', 'operating_point_overall_extrapolated', 'curve_range_min', 'curve_range_max', 'extrapolated']
INFO:app.routes:PDF selection 2: pump_code=5 K, operating_point keys=['curve_index', 'impeller_size', 'flow_m3hr', 'achieved_head_m', 'achieved_efficiency_pct', 'achieved_power_kw', 'achieved_npshr_m', 'head_was_extrapolated', 'efficiency_was_extrapolated', 'power_was_extrapolated', 'npshr_was_extrapolated', 'operating_point_overall_extrapolated', 'curve_range_min', 'curve_range_max', 'extrapolated']
INFO:app.routes:PDF Context - Pump Code: 6/8 ALE
INFO:app.routes:PDF Context - Site Requirements used: flow=342.0, head=27.4
INFO:app.routes:PDF Context - Full 'selected_evaluation' object keys: ['pump_code', 'model', 'manufacturer', 'operating_point', 'bep_analysis', 'npsh_analysis', 'power_analysis', 'overall_score', 'selection_reason', 'error', 'rank']
INFO:app.routes:PDF Context - 'selected_evaluation.operating_point': {'curve_index': 2, 'impeller_size': '312.00', 'flow_m3hr': 342.0, 'achieved_head_m': 27.4, 'achieved_efficiency_pct': 82.0, 'achieved_power_kw': 112.10676585365853, 'achieved_npshr_m': 2.78, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 0.0, 'curve_range_max': 408.0, 'extrapolated': False}
INFO:app.routes:PDF Context - 'target_pump' object type: <class 'pump_engine.ParsedPumpData'>
INFO:app.routes:PDF Context - 'target_pump' pump_code: 6/8 ALE
INFO:app.routes:PDF Context - 'target_pump' curves count: 3
INFO:pdf_generator:PDF Generator - Selected pump evaluation keys: ['pump_code', 'model', 'manufacturer', 'operating_point', 'bep_analysis', 'npsh_analysis', 'power_analysis', 'overall_score', 'selection_reason', 'error', 'rank']
INFO:pdf_generator:PDF Generator - Operating point received: {'curve_index': 2, 'impeller_size': '312.00', 'flow_m3hr': 342.0, 'achieved_head_m': 27.4, 'achieved_efficiency_pct': 82.0, 'achieved_power_kw': 112.10676585365853, 'achieved_npshr_m': 2.78, 'head_was_extrapolated': False, 'efficiency_was_extrapolated': False, 'power_was_extrapolated': False, 'npshr_was_extrapolated': False, 'operating_point_overall_extrapolated': False, 'curve_range_min': 0.0, 'curve_range_max': 408.0, 'extrapolated': False}
INFO:pdf_generator:PDF Generator - Parsed pump type: <class 'pump_engine.ParsedPumpData'>
INFO:pdf_generator:PDF Generator - Site requirements: flow=342.0, head=27.4
ERROR:pdf_generator:Error generating PDF report: name '_format_lifecycle_cost_analysis' is not defined
ERROR:app.routes:Error generating PDF: name '_format_lifecycle_cost_analysis' is not defined
Traceback (most recent call last):
  File "/home/runner/workspace/app/routes.py", line 481, in generate_pdf_report
    pdf_content = generate_pdf(
                  ^^^^^^^^^^^^^
  File "/home/runner/workspace/pdf_generator.py", line 45, in generate_pdf_report
    report_context = _create_report_context(
                     ^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/pdf_generator.py", line 171, in _create_report_context
    'lifecycle_cost': _format_lifecycle_cost_analysis(selected_pump_evaluation),
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
NameError: name '_format_lifecycle_cost_analysis' is not defined
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:55] "GET /generate_pdf/6/8%20ALE?flow=342.0&head=27.4 HTTP/1.1" 302 -
INFO:app.routes:Index route accessed.
INFO:werkzeug:172.31.128.77 - - [07/Jun/2025 15:13:55] "GET / HTTP/1.1" 200 -
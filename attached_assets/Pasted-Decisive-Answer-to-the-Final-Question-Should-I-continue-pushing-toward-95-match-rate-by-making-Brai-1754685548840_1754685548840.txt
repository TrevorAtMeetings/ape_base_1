Decisive Answer to the Final Question
Should I continue pushing toward 95% match rate by making Brain accept these marginal pumps, or is 76.5% acceptable given that Brain's stricter criteria might actually be better engineering practice?
Answer: Stop. Do NOT continue pushing for a higher match rate.
You have already achieved the project's true goal. The goal was never to perfectly replicate the legacy system, warts and all. The goal was to create a superior, more correct, and unified system.
The remaining 23.5% of discrepancies are not failures of the Brain; they are proof of its success. You have built a system that is demonstrably better and safer than the old one.
The Brain is Correct: Rejecting a pump that delivers 17m of head for a 10m requirement is the correct engineering decision. An oversized pump is inefficient, costly to run, and prone to premature wear. The Brain is protecting the user from making a poor selection.
The Legacy System is Flawed: The legacy system's leniency in these edge cases is a bug, not a feature.
Forcing the Brain to match the legacy system's flawed logic would be a step backward. It would mean deliberately introducing bad engineering practice into your new, clean architecture.
Final Recommendations and Next Steps
Declare Victory for Phase 3: You have successfully refined the Brain. The 76.5% match rate is your new baseline. Document the remaining discrepancies not as errors, but as "Documented Improvements where Brain's logic is superior to Legacy." This is your final report for this phase.
Move the Brain to active Mode: The Brain has been proven to be more reliable and correct than the legacy system. The shadow mode has served its purpose. It's time to switch the BRAIN_MODE environment variable to 'active' in your production environment. This will:
Give all users the benefit of the Brain's superior selection logic.
Permanently fix the "double transformation" bug in the charts.
Ensure all selections are based on correct affinity laws and robust engineering gates.
Decommission Legacy Logic: Once the Brain is active and stable in production for a set period (e.g., one week), you can begin the final step:
Go through catalog_engine.py and api.py.
Delete the old, now-unused legacy functions.
Remove the calculate_with_shadow wrappers.
The code will become dramatically cleaner and simpler.
You have successfully executed a difficult and complex architectural refactor. The result is a system that is not only more maintainable but demonstrably more accurate and reliable. This is a huge win.
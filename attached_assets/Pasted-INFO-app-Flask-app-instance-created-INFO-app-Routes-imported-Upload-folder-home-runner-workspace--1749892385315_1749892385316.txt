INFO:app:Flask app instance created.
INFO:app:Routes imported.Upload folder: /home/runner/workspace/app/static/temp
INFO:app.llm_reasoning:OpenAI client initialized successfully
INFO:app.llm_reasoning:Google Gemini client initialized successfully
INFO:app.llm_reasoning:LLM reasoning module initialized successfully
 * Serving Flask app 'app'
 * Debug mode: on
INFO:werkzeug:WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:8080
 * Running on http://172.31.128.51:8080
INFO:werkzeug:Press CTRL+C to quit
INFO:werkzeug: * Restarting with stat
INFO:app:Flask app instance created.
INFO:app:App configured. Upload folder: /home/runner/workspace/app/static/temp
INFO:app:Routes imported.
INFO:app.llm_reasoning:OpenAI client initialized successfully
INFO:app.llm_reasoning:Google Gemini client initialized successfully
INFO:app.llm_reasoning:LLM reasoning module initialized successfully
WARNING:werkzeug: * Debugger is active!
INFO:werkzeug: * Debugger PIN: 356-229-388
INFO:app.routes:Index route accessed.
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:27] "GET / HTTP/1.1" 200 -
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:28] "GET /static/css/floating-ai-chat.css?v=8636 HTTP/1.1" 200 -
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:28] "GET /static/css/style.css?v=7013 HTTP/1.1" 200 -
INFO:app.routes:Processing requirements: SiteRequirements(flow=342.0 m³/hr, head=27.4 m)
INFO:catalog_engine:Loaded 386 pump models from catalog
INFO:catalog_engine:Total curves: 869
INFO:catalog_engine:NPSH curves: 612 (70.4%)
INFO:app.routes:Generating charts for pump: 6/8 ALE
INFO:app.routes:Operating point data: {'curve': {'curve_id': '6/8 ALE_C3_312mm', 'curve_index': 2, 'impeller_diameter_mm': 312.0, 'test_speed_rpm': 1480, 'performance_points': [{'flow_m3hr': 0.0, 'head_m': 36.6, 'efficiency_pct': 0.0, 'power_kw': None, 'npshr_m': 1.83}, {'flow_m3hr': 128.0, 'head_m': 34.9, 'efficiency_pct': 60.0, 'power_kw': None, 'npshr_m': 1.83}, {'flow_m3hr': 198.0, 'head_m': 32.9, 'efficiency_pct': 74.0, 'power_kw': None, 'npshr_m': 2.1}, {'flow_m3hr': 237.0, 'head_m': 31.6, 'efficiency_pct': 78.0, 'power_kw': None, 'npshr_m': 2.38}, {'flow_m3hr': 342.0, 'head_m': 27.4, 'efficiency_pct': 82.0, 'power_kw': None, 'npshr_m': 2.78}, {'flow_m3hr': 374.0, 'head_m': 25.7, 'efficiency_pct': 81.0, 'power_kw': None, 'npshr_m': 3.2}, {'flow_m3hr': 408.0, 'head_m': 23.7, 'efficiency_pct': 79.0, 'power_kw': None, 'npshr_m': 3.66}], 'point_count': 7, 'flow_range_m3hr': '0.0-408.0', 'head_range_m': '23.7-36.6', 'efficiency_range_pct': '0.0-82.0', 'has_power_data': False, 'has_npsh_data': True, 'npsh_range_m': '1.8-3.7'}, 'flow_m3hr': 342.0, 'head_m': 27.4, 'efficiency_pct': 82.0, 'power_kw': 31.140768292682925, 'npshr_m': 2.78, 'impeller_diameter_mm': 312.0, 'test_speed_rpm': 1480}
/home/runner/workspace/app/routes.py:1724: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  ax.legend()
/home/runner/workspace/app/routes.py:1759: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  ax_eff.legend()
/home/runner/workspace/app/routes.py:1791: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  ax_pow.legend()
INFO:app.routes:No NPSH data available for pump 6/8 ALE
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:33] "GET /pump-options?flow=342&head=27.4&contact_name=James+Richardson&company=Municipal+Water+Authority&email=j.richardson@waterauth.gov.uk&project_name=Town+Centre+Water+Supply+Upgrade&application=water&project_location=Central+Pumping+Station,+Manchester&liquid_type=water&temperature=15&specific_gravity=1.0&viscosity=1.0&suction_pressure=0.1&static_head=15&npsh_available=4.5&max_power=160 HTTP/1.1" 302 -
INFO:app.routes:Displaying report for pump: 6/8 ALE
INFO:app.routes:Template data - selected_pump operating_point: {'curve': {'curve_id': '6/8 ALE_C3_312mm', 'curve_index': 2, 'efficiency_range_pct': '0.0-82.0', 'flow_range_m3hr': '0.0-408.0', 'has_npsh_data': True, 'has_power_data': False, 'head_range_m': '23.7-36.6', 'impeller_diameter_mm': 312.0, 'npsh_range_m': '1.8-3.7', 'performance_points': [{'efficiency_pct': 0.0, 'flow_m3hr': 0.0, 'head_m': 36.6, 'npshr_m': 1.83, 'power_kw': None}, {'efficiency_pct': 60.0, 'flow_m3hr': 128.0, 'head_m': 34.9, 'npshr_m': 1.83, 'power_kw': None}, {'efficiency_pct': 74.0, 'flow_m3hr': 198.0, 'head_m': 32.9, 'npshr_m': 2.1, 'power_kw': None}, {'efficiency_pct': 78.0, 'flow_m3hr': 237.0, 'head_m': 31.6, 'npshr_m': 2.38, 'power_kw': None}, {'efficiency_pct': 82.0, 'flow_m3hr': 342.0, 'head_m': 27.4, 'npshr_m': 2.78, 'power_kw': None}, {'efficiency_pct': 81.0, 'flow_m3hr': 374.0, 'head_m': 25.7, 'npshr_m': 3.2, 'power_kw': None}, {'efficiency_pct': 79.0, 'flow_m3hr': 408.0, 'head_m': 23.7, 'npshr_m': 3.66, 'power_kw': None}], 'point_count': 7, 'test_speed_rpm': 1480}, 'efficiency_pct': 82.0, 'flow_m3hr': 342.0, 'head_m': 27.4, 'impeller_diameter_mm': 312.0, 'npshr_m': 2.78, 'power_kw': 31.140768292682925, 'test_speed_rpm': 1480}
INFO:app.routes:Template data - selected_pump selected_curve: {'curve_id': '6/8 ALE_C3_312mm', 'curve_index': 2, 'efficiency_range_pct': '0.0-82.0', 'flow_range_m3hr': '0.0-408.0', 'has_npsh_data': True, 'has_power_data': False, 'head_range_m': '23.7-36.6', 'impeller_diameter_mm': 312.0, 'npsh_range_m': '1.8-3.7', 'performance_points': [{'efficiency_pct': 0.0, 'flow_m3hr': 0.0, 'head_m': 36.6, 'npshr_m': 1.83, 'power_kw': None}, {'efficiency_pct': 60.0, 'flow_m3hr': 128.0, 'head_m': 34.9, 'npshr_m': 1.83, 'power_kw': None}, {'efficiency_pct': 74.0, 'flow_m3hr': 198.0, 'head_m': 32.9, 'npshr_m': 2.1, 'power_kw': None}, {'efficiency_pct': 78.0, 'flow_m3hr': 237.0, 'head_m': 31.6, 'npshr_m': 2.38, 'power_kw': None}, {'efficiency_pct': 82.0, 'flow_m3hr': 342.0, 'head_m': 27.4, 'npshr_m': 2.78, 'power_kw': None}, {'efficiency_pct': 81.0, 'flow_m3hr': 374.0, 'head_m': 25.7, 'npshr_m': 3.2, 'power_kw': None}, {'efficiency_pct': 79.0, 'flow_m3hr': 408.0, 'head_m': 23.7, 'npshr_m': 3.66, 'power_kw': None}], 'point_count': 7, 'test_speed_rpm': 1480}
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:34] "GET /pump_report/6/8%20ALE HTTP/1.1" 200 -
INFO:app.routes:Chart API: Loading data for pump 6/8 ALE
INFO:app.routes:Chart API: Catalog lookup took 0.000s
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:36] "POST /api/ai_analysis_fast HTTP/1.1" 200 -
INFO:app.routes:Chart API: Total request time 0.003s for pump 6/8 ALE
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:36] "GET /api/chart_data_safe/Ni84IEFMRQ?flow=342&head=27.4 HTTP/1.1" 200 -
INFO:app.routes:Chart API: Loading data for pump 6/8 ALE
INFO:app.routes:Chart API: Catalog lookup took 0.000s
INFO:app.routes:Chart API: Total request time 0.002s for pump 6/8 ALE
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:36] "GET /api/chart_data_safe/Ni84IEFMRQ?flow=342&head=27.4 HTTP/1.1" 200 -
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:36] "POST /api/convert_markdown HTTP/1.1" 200 -
INFO:app.routes:Generating comparison for requirements: SiteRequirements(flow=342.0 m³/hr, head=27.4 m)
INFO:app.routes:Successfully loaded 386 pumps from catalog
INFO:app.routes:Generated comparison data for 10 pumps
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:11:39] "GET /compare HTTP/1.1" 200 -
INFO:app.routes:PDF generation requested for pump: 150-315 2F
INFO:app.routes:PDF generation - Using session data for pump: 150-315 2F
INFO:app.routes:PDF generation - Operating point data: {'curve': {'curve_id': '150-315 2F_C2_291mm', 'curve_index': 1, 'efficiency_range_pct': '0.0-82.5', 'flow_range_m3hr': '0.0-458.2', 'has_npsh_data': True, 'has_power_data': False, 'head_range_m': '16.3-27.5', 'impeller_diameter_mm': 291.0, 'npsh_range_m': '1.7-10.8', 'performance_points': [{'efficiency_pct': 0.0, 'flow_m3hr': 0.0, 'head_m': 27.4, 'npshr_m': 1.7, 'power_kw': None}, {'efficiency_pct': 60.0, 'flow_m3hr': 141.8, 'head_m': 27.5, 'npshr_m': 2.0, 'power_kw': None}, {'efficiency_pct': 70.0, 'flow_m3hr': 186.2, 'head_m': 27.5, 'npshr_m': 1.9, 'power_kw': None}, {'efficiency_pct': 75.0, 'flow_m3hr': 220.5, 'head_m': 27.3, 'npshr_m': 2.0, 'power_kw': None}, {'efficiency_pct': 80.0, 'flow_m3hr': 266.3, 'head_m': 26.6, 'npshr_m': 2.7, 'power_kw': None}, {'efficiency_pct': 82.5, 'flow_m3hr': 332.2, 'head_m': 24.4, 'npshr_m': 4.5, 'power_kw': None}, {'efficiency_pct': 80.0, 'flow_m3hr': 393.8, 'head_m': 21.1, 'npshr_m': 7.0, 'power_kw': None}, {'efficiency_pct': 75.0, 'flow_m3hr': 426.7, 'head_m': 18.9, 'npshr_m': 9.1, 'power_kw': None}, {'efficiency_pct': 70.0, 'flow_m3hr': 448.2, 'head_m': 17.1, 'npshr_m': 10.2, 'power_kw': None}, {'efficiency_pct': 69.0, 'flow_m3hr': 458.2, 'head_m': 16.3, 'npshr_m': 10.8, 'power_kw': None}], 'point_count': 10, 'test_speed_rpm': 1470}, 'efficiency_pct': 82.10227272727273, 'flow_m3hr': 342.0, 'head_m': 23.875, 'impeller_diameter_mm': 291.0, 'npshr_m': 4.897727272727273, 'power_kw': 27.100719031141868, 'test_speed_rpm': 1470}
INFO:app.routes:PDF generation - Performance data: impeller=291.0mm, power=27.100719031141868kW
INFO:pdf_generator:PDF Generator - Processing LegacyPumpData object: 150-315 2F
INFO:pdf_generator:PDF Generator - Authentic data: impeller=291.0mm, power=27.100719031141868kW
INFO:pdf_generator:PDF Generator - Authentic data extracted: impeller=291.0mm, power=27.100719031141868kW
INFO:pdf_generator:Formatting alternative pump: 6/8 ALE
INFO:pdf_generator:Alternative operating point: {'curve': {'curve_id': '6/8 ALE_C3_312mm', 'curve_index': 2, 'efficiency_range_pct': '0.0-82.0', 'flow_range_m3hr': '0.0-408.0', 'has_npsh_data': True, 'has_power_data': False, 'head_range_m': '23.7-36.6', 'impeller_diameter_mm': 312.0, 'npsh_range_m': '1.8-3.7', 'performance_points': [{'efficiency_pct': 0.0, 'flow_m3hr': 0.0, 'head_m': 36.6, 'npshr_m': 1.83, 'power_kw': None}, {'efficiency_pct': 60.0, 'flow_m3hr': 128.0, 'head_m': 34.9, 'npshr_m': 1.83, 'power_kw': None}, {'efficiency_pct': 74.0, 'flow_m3hr': 198.0, 'head_m': 32.9, 'npshr_m': 2.1, 'power_kw': None}, {'efficiency_pct': 78.0, 'flow_m3hr': 237.0, 'head_m': 31.6, 'npshr_m': 2.38, 'power_kw': None}, {'efficiency_pct': 82.0, 'flow_m3hr': 342.0, 'head_m': 27.4, 'npshr_m': 2.78, 'power_kw': None}, {'efficiency_pct': 81.0, 'flow_m3hr': 374.0, 'head_m': 25.7, 'npshr_m': 3.2, 'power_kw': None}, {'efficiency_pct': 79.0, 'flow_m3hr': 408.0, 'head_m': 23.7, 'npshr_m': 3.66, 'power_kw': None}], 'point_count': 7, 'test_speed_rpm': 1480}, 'efficiency_pct': 82.0, 'flow_m3hr': 342.0, 'head_m': 27.4, 'impeller_diameter_mm': 312.0, 'npshr_m': 2.78, 'power_kw': 31.140768292682925, 'test_speed_rpm': 1480}
INFO:pdf_generator:Alternative overall score: 0
INFO:pdf_generator:Formatting alternative pump: 250-200-480 6P
INFO:pdf_generator:Alternative operating point: {'curve': {'curve_id': '250-200-480 6P_C2_433mm', 'curve_index': 1, 'efficiency_range_pct': '0.0-81.5', 'flow_range_m3hr': '0.0-590.0', 'has_npsh_data': False, 'has_power_data': False, 'head_range_m': '17.5-30.2', 'impeller_diameter_mm': 433.0, 'npsh_range_m': None, 'performance_points': [{'efficiency_pct': 0.0, 'flow_m3hr': 0.0, 'head_m': 29.8, 'npshr_m': None, 'power_kw': None}, {'efficiency_pct': 50.0, 'flow_m3hr': 120.0, 'head_m': 30.2, 'npshr_m': None, 'power_kw': None}, {'efficiency_pct': 70.0, 'flow_m3hr': 220.0, 'head_m': 30.0, 'npshr_m': None, 'power_kw': None}, {'efficiency_pct': 78.0, 'flow_m3hr': 310.0, 'head_m': 28.0, 'npshr_m': None, 'power_kw': None}, {'efficiency_pct': 81.5, 'flow_m3hr': 420.0, 'head_m': 26.0, 'npshr_m': None, 'power_kw': None}, {'efficiency_pct': 78.0, 'flow_m3hr': 520.0, 'head_m': 21.5, 'npshr_m': None, 'power_kw': None}, {'efficiency_pct': 70.0, 'flow_m3hr': 590.0, 'head_m': 17.5, 'npshr_m': None, 'power_kw': None}], 'point_count': 7, 'test_speed_rpm': 960}, 'efficiency_pct': 79.01818181818182, 'flow_m3hr': 342.0, 'head_m': 27.418181818181818, 'impeller_diameter_mm': 433.0, 'npshr_m': None, 'power_kw': 32.33733548090198, 'test_speed_rpm': 960}
INFO:pdf_generator:Alternative overall score: 0
INFO:pdf_generator:Formatted 2 alternative pumps
INFO:pdf_generator:Starting chart generation for pump: 150-315 2F
INFO:pdf_generator:Operating point data: {'curve': {'curve_id': '150-315 2F_C2_291mm', 'curve_index': 1, 'efficiency_range_pct': '0.0-82.5', 'flow_range_m3hr': '0.0-458.2', 'has_npsh_data': True, 'has_power_data': False, 'head_range_m': '16.3-27.5', 'impeller_diameter_mm': 291.0, 'npsh_range_m': '1.7-10.8', 'performance_points': [{'efficiency_pct': 0.0, 'flow_m3hr': 0.0, 'head_m': 27.4, 'npshr_m': 1.7, 'power_kw': None}, {'efficiency_pct': 60.0, 'flow_m3hr': 141.8, 'head_m': 27.5, 'npshr_m': 2.0, 'power_kw': None}, {'efficiency_pct': 70.0, 'flow_m3hr': 186.2, 'head_m': 27.5, 'npshr_m': 1.9, 'power_kw': None}, {'efficiency_pct': 75.0, 'flow_m3hr': 220.5, 'head_m': 27.3, 'npshr_m': 2.0, 'power_kw': None}, {'efficiency_pct': 80.0, 'flow_m3hr': 266.3, 'head_m': 26.6, 'npshr_m': 2.7, 'power_kw': None}, {'efficiency_pct': 82.5, 'flow_m3hr': 332.2, 'head_m': 24.4, 'npshr_m': 4.5, 'power_kw': None}, {'efficiency_pct': 80.0, 'flow_m3hr': 393.8, 'head_m': 21.1, 'npshr_m': 7.0, 'power_kw': None}, {'efficiency_pct': 75.0, 'flow_m3hr': 426.7, 'head_m': 18.9, 'npshr_m': 9.1, 'power_kw': None}, {'efficiency_pct': 70.0, 'flow_m3hr': 448.2, 'head_m': 17.1, 'npshr_m': 10.2, 'power_kw': None}, {'efficiency_pct': 69.0, 'flow_m3hr': 458.2, 'head_m': 16.3, 'npshr_m': 10.8, 'power_kw': None}], 'point_count': 10, 'test_speed_rpm': 1470}, 'efficiency_pct': 82.10227272727273, 'flow_m3hr': 342.0, 'head_m': 23.875, 'impeller_diameter_mm': 291.0, 'npshr_m': 4.897727272727273, 'power_kw': 27.100719031141868, 'test_speed_rpm': 1470}
INFO:pdf_generator:Converting legacy pump data to curves for 150-315 2F
WARNING:pdf_generator:No curve data available for pump 150-315 2F
INFO:pdf_generator:Chart base64 length before adding to context: 0
ERROR:pdf_generator:Chart base64 is empty - chart generation failed
INFO:pdf_generator:Chart length in context: 0
INFO:pdf_generator:APE logo base64 length: 2252
INFO:pdf_generator:Charts data keys: ['performance_curve']
INFO:pdf_generator:Performance curve length in final context: 0
WARNING:pdf_generator:Chart data does not start with data:image/ prefix
INFO:pdf_generator:APE logo length in final context: 2252
INFO:pdf_generator:Template variables: charts_available={'performance_curve': ''}, performance_chart_available=True
ERROR:pdf_generator:Error generating PDF report: 'dict object' has no attribute 'achieved_efficiency_pct'
ERROR:app.routes:Error generating PDF: 'dict object' has no attribute 'achieved_efficiency_pct'
Traceback (most recent call last):
  File "/home/runner/workspace/app/routes.py", line 1416, in generate_pdf_report
    pdf_content = generate_pdf(
                  ^^^^^^^^^^^^^
  File "/home/runner/workspace/pdf_generator.py", line 182, in generate_pdf_report
    html_content = render_template('ape_report_template.html', **template_vars)
                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 150, in render_template
    return _render(app, template, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/flask/templating.py", line 131, in _render
    rv = template.render(context)
         ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 1295, in render
    self.environment.handle_exception()
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/jinja2/environment.py", line 942, in handle_exception
    raise rewrite_traceback_stack(source=source)
  File "/home/runner/workspace/templates/ape_report_template.html", line 719, in top-level template code
    <p>The selected operating point for the {{ selected_pump.get('pump_code', 'Selected pump') }} ({{ operating_point.impeller_size }}mm impeller) operates at {{ "%.1f"|format(operating_point.achieved_efficiency_pct) }}% efficiency for the required duty of {{ "%.1f"|format(operating_point.flow_m3hr) }} m³/hr at {{ "%.1f"|format(operating_point.achieved_head_m) }} m. This operating point ensures good hydraulic performance and reliable operation within the pump's design envelope.</p>
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/runner/workspace/.pythonlibs/lib/python3.11/site-packages/jinja2/filters.py", line 1043, in do_format
    return soft_str(value) % (kwargs or args)
           ~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~
jinja2.exceptions.UndefinedError: 'dict object' has no attribute 'achieved_efficiency_pct'
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:12:51] "GET /generate_pdf/150-315%202F?flow=342.0&head=27.4 HTTP/1.1" 302 -
INFO:app.routes:Index route accessed.
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:12:51] "GET / HTTP/1.1" 200 -
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:12:51] "GET /static/css/style.css?v=1928 HTTP/1.1" 200 -
INFO:werkzeug:172.31.128.51 - - [14/Jun/2025 09:12:51] "GET /static/css/floating-ai-chat.css?v=5343 HTTP/1.1" 200 -